{"version":3,"sources":["debt.js"],"names":["e","t","n","r","s","o","u","a","require","i","f","Error","code","l","exports","call","length",1,"module","window","angular","undefined","$RouteProvider","inherit","parent","extra","extend","Object","create","pathRegExp","path","opts","insensitive","caseInsensitiveMatch","ret","originalPath","regexp","keys","replace","_","slash","key","option","optional","star","push","name","RegExp","routes","this","when","route","routeCopy","copy","isUndefined","reloadOnSearch","redirectPath","substr","redirectTo","otherwise","params","$get","$rootScope","$location","$routeParams","$q","$injector","$templateRequest","$sce","switchRouteMatcher","on","m","exec","len","val","prepareRoute","$locationEvent","lastRoute","$route","current","preparedRoute","parseRoute","preparedRouteIsUpdateOnly","$$route","equals","pathParams","forceReload","$broadcast","defaultPrevented","preventDefault","commitRoute","nextRoute","isString","interpolate","search","url","then","template","templateUrl","locals","resolve","forEach","value","get","invoke","isDefined","isFunction","getTrustedResourceUrl","loadedTemplateUrl","all","error","match","string","result","split","segment","segmentMatch","join","reload","$evalAsync","updateParams","newParams","$routeMinErr","$on","$RouteParamsProvider","ngViewFactory","$anchorScroll","$animate","restrict","terminal","priority","transclude","link","scope","$element","attr","ctrl","$transclude","cleanupLastView","previousLeaveAnimation","cancel","currentScope","$destroy","currentElement","leave","update","$template","newScope","$new","clone","enter","autoScrollExp","$eval","$emit","onloadExp","autoscroll","onload","ngViewFillContentFactory","$compile","$controller","html","contents","controller","$scope","controllerAs","data","children","ngRouteModule","provider","$$minErr","directive","$inject",2,"./angular-route",3,"addEventListener","applicationCache","location",4,"BalanceSheetCtrl","balanceSheetService","debtService","events","$log","init","refresh","BALANCE_SHEET_UPDATED","vm","balanceSheet","debtsByDebtor","computeDebts","debtComputationError","isBalanced","participations","getNonSettledParticipations","debts","currency","organizeByDebtor","updateSheet","lodash",5,"localStorageService","localStorageData","json","JSON","parse","dateReviver","service","BalanceSheet","save","ReferenceError","throwErrorIfInvalid","jsonString","stringify","exportData","set","loadFromJson","DATE_REGEX","test","Date","exportToJson","createNew","factory","./balance-sheet",6,"Decimal","CurrencyConversionError","filter","pt","expense","settled","reduce","expenses","getPerson","id","persons","find","p","createPerson","options","idSequence","person","Person","createParticipations","each","createParticipation","shareCost","removePerson","toRemove","remove","getParticipations","removeParticipation","getExpense","createExpense","sharing","Expense","removeExpense","getParticipation","criteria","toSeek","Participation","paid","share","participation","currenciesEnabled","exchangeRates","getExchangeRates","cloneDeep","getCurrencies","chain","getExchangeRateCurrencies","concat","getExpenseCurrencies","_this","uniq","sort","er","fixed","variable","map","computedCurrency","addOrUpdateExchangeRate","quotation","validateQuotation","existing","pick","updateBalanceSheetCurrencyIfNeeded","trim","TypeError","isNumber","rate","RangeError","cleanUpCurrency","cleanUpCurrencyPair","currencyPair","removeExchangeRate","updateExpenseCurrenciesIfNeeded","convertCurrency","toConvert","toNumber","EXCHANGE_RATE_DECIMALS","searchPair","inverseQuotation","multiply","divideBy","tryToConvertCurrency","NaN","getConvertibleCurrencies","fromCurrencies","toCurrency","isArray","convertible","c","getNonConvertibleCurrencies","difference","currencies","indexOf","throwErrorIfInvalidExpenseCurrencies","ex","getTotal","participationMapping","_nonSettledParticipations","total","add","_sheet","getCost","getPaid","getSumOfShares","getShare","getBalance","subtract","_myParticipations","other","isNotFunction","negate","pickBy","shareEqually","cost","lastShare","last","getCurrencyConversionFunction","strictConversion","getValue","propName","convert","expenseParticipations","thisValueConverted","originalSum","sum","prt","convertedSum","sumOfConverted","delta","personId","expenseId","importData","max","isNaN","separately","q","isValid","idToEntity","./currency-conversion-error","simple-decimal-money",7,"message","temp","apply","arguments","stack","prototype","constructor","writable","configurable",8,"./balance-sheet-ctrl","./balance-sheet-service","./route-config",9,"config","$stateProvider","state","views","floatingButton",10,"CurrencyListCtrl","$mdDialog","debounce","$watch","openExchangeRateDialog","show","updateExchangeRate","exchangeRate","ExchangeRateDialogCtrl","ok","hide",11,"./currency-list-ctrl",12,13,"DebtAppCtrl","balanceSheetSaveInterval","openCreatePersonDialog","openCreateExpenseDialog","fileService","$state","balanceSheetUpdated","ERROR","handleErrorEvent","findExpensesWithInvalidCurrencies","errorMessage","tryToSave","nonConvertible","messageTemplate","currencyWord","currencyList","balanceSheetCurrency","index","event","dialogResult","createNewSheet","confirmCreateNewSheet","go","loadSheet","files","isSupported","file","readAsText","loadSheetFromJson","exportSheet","saveAsFile","showHelp","close","confirm","title","content","constant",14,"configureLocalStorage","localStorageServiceProvider","setPrefix","configureIcons","$mdIconProvider","iconFiles","iconProps","fileName","iconName","filePath","prop","icon","hrefSanitization","$compileProvider","aHrefSanitizationWhitelist","decorateExceptionHandler","$provide","decorator","$delegate","exception","cause","makeStateAvailableInScope","$stateParams","makeMdMediaAvailableInScope","$mdMedia","run","./appcache-reload","./balance-sheet/currency-conversion-error","./currencies","./debt-app-ctrl","./debts","./expenses","./persons","./utils","angular-local-storage","angular-material","angular-route","angular-ui-router","ng-file-upload",15,"solveDebts","debt","debtorList","debtorIndices","d","debtor","debtorIndex","omit","d1","d2","creditor","localeCompare",16,"debtSolverFactory","solveLinearSystem","solve","balances","computeBalances","isEveryoneBalanced","isSystemBalanced","roles","getDebtorsAndCreditors","linearSystem","createDebtEquations","debtVector","createDebts","b","balance","every","debtors","creditors","A","initMatrix","j","rows","cols","solution","numberOfSolutions","numVars","numberOfVariables","numFreeVars","numberOfFreeVariables","xVector","randomEngine","Random","engines","mt19937","seed","toEliminate","candidates","candidateIdx","integer","splice","isNonNegative","vector","debtorIdx","Math","floor","creditorIdx","amount","random-js",17,"./debt-service","./debt-solver","./lin-eq-solver","./lin-eq-solver-factory",18,19,"input","validate","initialize","coefMatrix","copyMatrix","constVector","copyArray","pivotToEquationMap","equationScale","abscoef","abs","pivotToVariableMap","transformToRowEchelonForm","pivotIdx","knownFreeVariables","maxRatio","bestPivotEquationIndex","rowIdx","colIdx","ratio","currPivotVaribleIdx","newPivotVariableIdx","pivotRowIdx","pivotColIdx","mult","colIndex","reduceRowEchelonForm","pivotIndex","min","div","determineRank","rank","columns","determineNumberOfSolutions","b2IsZero","Number","MAX_VALUE","determineSolution","initArray","numberOfEquations","size","array","slice",20,"open","DialogController",21,"ExpenseDetailCtrl","debtCalculationInterval","$timeout","isParticipant","everyoneParticipates","updateExpense","targetScope","getParticipationMap","sumOfShares","computeDebtsDebounced","setParticipation","confirmRemoveExpense","doRemoveExpense","setCurrency",22,"./create-expense-dialog","./expense-detail-ctrl",23,24,25,"./create-person-dialog","./person-detail-ctrl",26,"PersonDetailCtrl","confirmRemovePerson","role","counterRole","doRemovePerson","updatePerson","debtResult","debtRole",27,28,"$urlRouterProvider",29,"$filter",30,"debounceFactory","func","wait","invokeApply","timer","context","args","Array",31,"$window","blob","deferred","defer","reader","FileReader","onerror","promise","dataArray","Blob","fileSaver","saveAs","blob-polyfill","node-safe-filesaver",32,"focus","iElem","iAttrs","focusExpr","shouldFocus",33,"./balance-filter","./file-service","./focus-directive","./money-filter","./money-input-directive",34,"money",35,"moneyInput","ngModel","render","$valid","formatMoney","$modelValue","$viewValue","handleBlur","$render","$validators","validateMoney","$parsers","parseMoney","$formatters","unshift",36,"tryCatch","expression","errorResult"],"mappings":"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","file":"debt.js","sourcesContent":["(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error(\"Cannot find module '\"+o+\"'\");throw f.code=\"MODULE_NOT_FOUND\",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){\n/**\n * @license AngularJS v1.3.15\n * (c) 2010-2014 Google, Inc. http://angularjs.org\n * License: MIT\n */\n(function(window, angular, undefined) {'use strict';\n\n/**\n * @ngdoc module\n * @name ngRoute\n * @description\n *\n * # ngRoute\n *\n * The `ngRoute` module provides routing and deeplinking services and directives for angular apps.\n *\n * ## Example\n * See {@link ngRoute.$route#example $route} for an example of configuring and using `ngRoute`.\n *\n *\n * <div doc-module-components=\"ngRoute\"></div>\n */\n /* global -ngRouteModule */\nvar ngRouteModule = angular.module('ngRoute', ['ng']).\n                        provider('$route', $RouteProvider),\n    $routeMinErr = angular.$$minErr('ngRoute');\n\n/**\n * @ngdoc provider\n * @name $routeProvider\n *\n * @description\n *\n * Used for configuring routes.\n *\n * ## Example\n * See {@link ngRoute.$route#example $route} for an example of configuring and using `ngRoute`.\n *\n * ## Dependencies\n * Requires the {@link ngRoute `ngRoute`} module to be installed.\n */\nfunction $RouteProvider() {\n  function inherit(parent, extra) {\n    return angular.extend(Object.create(parent), extra);\n  }\n\n  var routes = {};\n\n  /**\n   * @ngdoc method\n   * @name $routeProvider#when\n   *\n   * @param {string} path Route path (matched against `$location.path`). If `$location.path`\n   *    contains redundant trailing slash or is missing one, the route will still match and the\n   *    `$location.path` will be updated to add or drop the trailing slash to exactly match the\n   *    route definition.\n   *\n   *    * `path` can contain named groups starting with a colon: e.g. `:name`. All characters up\n   *        to the next slash are matched and stored in `$routeParams` under the given `name`\n   *        when the route matches.\n   *    * `path` can contain named groups starting with a colon and ending with a star:\n   *        e.g.`:name*`. All characters are eagerly stored in `$routeParams` under the given `name`\n   *        when the route matches.\n   *    * `path` can contain optional named groups with a question mark: e.g.`:name?`.\n   *\n   *    For example, routes like `/color/:color/largecode/:largecode*\\/edit` will match\n   *    `/color/brown/largecode/code/with/slashes/edit` and extract:\n   *\n   *    * `color: brown`\n   *    * `largecode: code/with/slashes`.\n   *\n   *\n   * @param {Object} route Mapping information to be assigned to `$route.current` on route\n   *    match.\n   *\n   *    Object properties:\n   *\n   *    - `controller`  `{(string|function()=}`  Controller fn that should be associated with\n   *      newly created scope or the name of a {@link angular.Module#controller registered\n   *      controller} if passed as a string.\n   *    - `controllerAs`  `{string=}`  A controller alias name. If present the controller will be\n   *      published to scope under the `controllerAs` name.\n   *    - `template`  `{string=|function()=}`  html template as a string or a function that\n   *      returns an html template as a string which should be used by {@link\n   *      ngRoute.directive:ngView ngView} or {@link ng.directive:ngInclude ngInclude} directives.\n   *      This property takes precedence over `templateUrl`.\n   *\n   *      If `template` is a function, it will be called with the following parameters:\n   *\n   *      - `{Array.<Object>}` - route parameters extracted from the current\n   *        `$location.path()` by applying the current route\n   *\n   *    - `templateUrl`  `{string=|function()=}`  path or function that returns a path to an html\n   *      template that should be used by {@link ngRoute.directive:ngView ngView}.\n   *\n   *      If `templateUrl` is a function, it will be called with the following parameters:\n   *\n   *      - `{Array.<Object>}` - route parameters extracted from the current\n   *        `$location.path()` by applying the current route\n   *\n   *    - `resolve` - `{Object.<string, function>=}` - An optional map of dependencies which should\n   *      be injected into the controller. If any of these dependencies are promises, the router\n   *      will wait for them all to be resolved or one to be rejected before the controller is\n   *      instantiated.\n   *      If all the promises are resolved successfully, the values of the resolved promises are\n   *      injected and {@link ngRoute.$route#$routeChangeSuccess $routeChangeSuccess} event is\n   *      fired. If any of the promises are rejected the\n   *      {@link ngRoute.$route#$routeChangeError $routeChangeError} event is fired. The map object\n   *      is:\n   *\n   *      - `key`  `{string}`: a name of a dependency to be injected into the controller.\n   *      - `factory` - `{string|function}`: If `string` then it is an alias for a service.\n   *        Otherwise if function, then it is {@link auto.$injector#invoke injected}\n   *        and the return value is treated as the dependency. If the result is a promise, it is\n   *        resolved before its value is injected into the controller. Be aware that\n   *        `ngRoute.$routeParams` will still refer to the previous route within these resolve\n   *        functions.  Use `$route.current.params` to access the new route parameters, instead.\n   *\n   *    - `redirectTo`  {(string|function())=}  value to update\n   *      {@link ng.$location $location} path with and trigger route redirection.\n   *\n   *      If `redirectTo` is a function, it will be called with the following parameters:\n   *\n   *      - `{Object.<string>}` - route parameters extracted from the current\n   *        `$location.path()` by applying the current route templateUrl.\n   *      - `{string}` - current `$location.path()`\n   *      - `{Object}` - current `$location.search()`\n   *\n   *      The custom `redirectTo` function is expected to return a string which will be used\n   *      to update `$location.path()` and `$location.search()`.\n   *\n   *    - `[reloadOnSearch=true]` - {boolean=} - reload route when only `$location.search()`\n   *      or `$location.hash()` changes.\n   *\n   *      If the option is set to `false` and url in the browser changes, then\n   *      `$routeUpdate` event is broadcasted on the root scope.\n   *\n   *    - `[caseInsensitiveMatch=false]` - {boolean=} - match routes without being case sensitive\n   *\n   *      If the option is set to `true`, then the particular route can be matched without being\n   *      case sensitive\n   *\n   * @returns {Object} self\n   *\n   * @description\n   * Adds a new route definition to the `$route` service.\n   */\n  this.when = function(path, route) {\n    //copy original route object to preserve params inherited from proto chain\n    var routeCopy = angular.copy(route);\n    if (angular.isUndefined(routeCopy.reloadOnSearch)) {\n      routeCopy.reloadOnSearch = true;\n    }\n    if (angular.isUndefined(routeCopy.caseInsensitiveMatch)) {\n      routeCopy.caseInsensitiveMatch = this.caseInsensitiveMatch;\n    }\n    routes[path] = angular.extend(\n      routeCopy,\n      path && pathRegExp(path, routeCopy)\n    );\n\n    // create redirection for trailing slashes\n    if (path) {\n      var redirectPath = (path[path.length - 1] == '/')\n            ? path.substr(0, path.length - 1)\n            : path + '/';\n\n      routes[redirectPath] = angular.extend(\n        {redirectTo: path},\n        pathRegExp(redirectPath, routeCopy)\n      );\n    }\n\n    return this;\n  };\n\n  /**\n   * @ngdoc property\n   * @name $routeProvider#caseInsensitiveMatch\n   * @description\n   *\n   * A boolean property indicating if routes defined\n   * using this provider should be matched using a case insensitive\n   * algorithm. Defaults to `false`.\n   */\n  this.caseInsensitiveMatch = false;\n\n   /**\n    * @param path {string} path\n    * @param opts {Object} options\n    * @return {?Object}\n    *\n    * @description\n    * Normalizes the given path, returning a regular expression\n    * and the original path.\n    *\n    * Inspired by pathRexp in visionmedia/express/lib/utils.js.\n    */\n  function pathRegExp(path, opts) {\n    var insensitive = opts.caseInsensitiveMatch,\n        ret = {\n          originalPath: path,\n          regexp: path\n        },\n        keys = ret.keys = [];\n\n    path = path\n      .replace(/([().])/g, '\\\\$1')\n      .replace(/(\\/)?:(\\w+)([\\?\\*])?/g, function(_, slash, key, option) {\n        var optional = option === '?' ? option : null;\n        var star = option === '*' ? option : null;\n        keys.push({ name: key, optional: !!optional });\n        slash = slash || '';\n        return ''\n          + (optional ? '' : slash)\n          + '(?:'\n          + (optional ? slash : '')\n          + (star && '(.+?)' || '([^/]+)')\n          + (optional || '')\n          + ')'\n          + (optional || '');\n      })\n      .replace(/([\\/$\\*])/g, '\\\\$1');\n\n    ret.regexp = new RegExp('^' + path + '$', insensitive ? 'i' : '');\n    return ret;\n  }\n\n  /**\n   * @ngdoc method\n   * @name $routeProvider#otherwise\n   *\n   * @description\n   * Sets route definition that will be used on route change when no other route definition\n   * is matched.\n   *\n   * @param {Object|string} params Mapping information to be assigned to `$route.current`.\n   * If called with a string, the value maps to `redirectTo`.\n   * @returns {Object} self\n   */\n  this.otherwise = function(params) {\n    if (typeof params === 'string') {\n      params = {redirectTo: params};\n    }\n    this.when(null, params);\n    return this;\n  };\n\n\n  this.$get = ['$rootScope',\n               '$location',\n               '$routeParams',\n               '$q',\n               '$injector',\n               '$templateRequest',\n               '$sce',\n      function($rootScope, $location, $routeParams, $q, $injector, $templateRequest, $sce) {\n\n    /**\n     * @ngdoc service\n     * @name $route\n     * @requires $location\n     * @requires $routeParams\n     *\n     * @property {Object} current Reference to the current route definition.\n     * The route definition contains:\n     *\n     *   - `controller`: The controller constructor as define in route definition.\n     *   - `locals`: A map of locals which is used by {@link ng.$controller $controller} service for\n     *     controller instantiation. The `locals` contain\n     *     the resolved values of the `resolve` map. Additionally the `locals` also contain:\n     *\n     *     - `$scope` - The current route scope.\n     *     - `$template` - The current route template HTML.\n     *\n     * @property {Object} routes Object with all route configuration Objects as its properties.\n     *\n     * @description\n     * `$route` is used for deep-linking URLs to controllers and views (HTML partials).\n     * It watches `$location.url()` and tries to map the path to an existing route definition.\n     *\n     * Requires the {@link ngRoute `ngRoute`} module to be installed.\n     *\n     * You can define routes through {@link ngRoute.$routeProvider $routeProvider}'s API.\n     *\n     * The `$route` service is typically used in conjunction with the\n     * {@link ngRoute.directive:ngView `ngView`} directive and the\n     * {@link ngRoute.$routeParams `$routeParams`} service.\n     *\n     * @example\n     * This example shows how changing the URL hash causes the `$route` to match a route against the\n     * URL, and the `ngView` pulls in the partial.\n     *\n     * <example name=\"$route-service\" module=\"ngRouteExample\"\n     *          deps=\"angular-route.js\" fixBase=\"true\">\n     *   <file name=\"index.html\">\n     *     <div ng-controller=\"MainController\">\n     *       Choose:\n     *       <a href=\"Book/Moby\">Moby</a> |\n     *       <a href=\"Book/Moby/ch/1\">Moby: Ch1</a> |\n     *       <a href=\"Book/Gatsby\">Gatsby</a> |\n     *       <a href=\"Book/Gatsby/ch/4?key=value\">Gatsby: Ch4</a> |\n     *       <a href=\"Book/Scarlet\">Scarlet Letter</a><br/>\n     *\n     *       <div ng-view></div>\n     *\n     *       <hr />\n     *\n     *       <pre>$location.path() = {{$location.path()}}</pre>\n     *       <pre>$route.current.templateUrl = {{$route.current.templateUrl}}</pre>\n     *       <pre>$route.current.params = {{$route.current.params}}</pre>\n     *       <pre>$route.current.scope.name = {{$route.current.scope.name}}</pre>\n     *       <pre>$routeParams = {{$routeParams}}</pre>\n     *     </div>\n     *   </file>\n     *\n     *   <file name=\"book.html\">\n     *     controller: {{name}}<br />\n     *     Book Id: {{params.bookId}}<br />\n     *   </file>\n     *\n     *   <file name=\"chapter.html\">\n     *     controller: {{name}}<br />\n     *     Book Id: {{params.bookId}}<br />\n     *     Chapter Id: {{params.chapterId}}\n     *   </file>\n     *\n     *   <file name=\"script.js\">\n     *     angular.module('ngRouteExample', ['ngRoute'])\n     *\n     *      .controller('MainController', function($scope, $route, $routeParams, $location) {\n     *          $scope.$route = $route;\n     *          $scope.$location = $location;\n     *          $scope.$routeParams = $routeParams;\n     *      })\n     *\n     *      .controller('BookController', function($scope, $routeParams) {\n     *          $scope.name = \"BookController\";\n     *          $scope.params = $routeParams;\n     *      })\n     *\n     *      .controller('ChapterController', function($scope, $routeParams) {\n     *          $scope.name = \"ChapterController\";\n     *          $scope.params = $routeParams;\n     *      })\n     *\n     *     .config(function($routeProvider, $locationProvider) {\n     *       $routeProvider\n     *        .when('/Book/:bookId', {\n     *         templateUrl: 'book.html',\n     *         controller: 'BookController',\n     *         resolve: {\n     *           // I will cause a 1 second delay\n     *           delay: function($q, $timeout) {\n     *             var delay = $q.defer();\n     *             $timeout(delay.resolve, 1000);\n     *             return delay.promise;\n     *           }\n     *         }\n     *       })\n     *       .when('/Book/:bookId/ch/:chapterId', {\n     *         templateUrl: 'chapter.html',\n     *         controller: 'ChapterController'\n     *       });\n     *\n     *       // configure html5 to get links working on jsfiddle\n     *       $locationProvider.html5Mode(true);\n     *     });\n     *\n     *   </file>\n     *\n     *   <file name=\"protractor.js\" type=\"protractor\">\n     *     it('should load and compile correct template', function() {\n     *       element(by.linkText('Moby: Ch1')).click();\n     *       var content = element(by.css('[ng-view]')).getText();\n     *       expect(content).toMatch(/controller\\: ChapterController/);\n     *       expect(content).toMatch(/Book Id\\: Moby/);\n     *       expect(content).toMatch(/Chapter Id\\: 1/);\n     *\n     *       element(by.partialLinkText('Scarlet')).click();\n     *\n     *       content = element(by.css('[ng-view]')).getText();\n     *       expect(content).toMatch(/controller\\: BookController/);\n     *       expect(content).toMatch(/Book Id\\: Scarlet/);\n     *     });\n     *   </file>\n     * </example>\n     */\n\n    /**\n     * @ngdoc event\n     * @name $route#$routeChangeStart\n     * @eventType broadcast on root scope\n     * @description\n     * Broadcasted before a route change. At this  point the route services starts\n     * resolving all of the dependencies needed for the route change to occur.\n     * Typically this involves fetching the view template as well as any dependencies\n     * defined in `resolve` route property. Once  all of the dependencies are resolved\n     * `$routeChangeSuccess` is fired.\n     *\n     * The route change (and the `$location` change that triggered it) can be prevented\n     * by calling `preventDefault` method of the event. See {@link ng.$rootScope.Scope#$on}\n     * for more details about event object.\n     *\n     * @param {Object} angularEvent Synthetic event object.\n     * @param {Route} next Future route information.\n     * @param {Route} current Current route information.\n     */\n\n    /**\n     * @ngdoc event\n     * @name $route#$routeChangeSuccess\n     * @eventType broadcast on root scope\n     * @description\n     * Broadcasted after a route dependencies are resolved.\n     * {@link ngRoute.directive:ngView ngView} listens for the directive\n     * to instantiate the controller and render the view.\n     *\n     * @param {Object} angularEvent Synthetic event object.\n     * @param {Route} current Current route information.\n     * @param {Route|Undefined} previous Previous route information, or undefined if current is\n     * first route entered.\n     */\n\n    /**\n     * @ngdoc event\n     * @name $route#$routeChangeError\n     * @eventType broadcast on root scope\n     * @description\n     * Broadcasted if any of the resolve promises are rejected.\n     *\n     * @param {Object} angularEvent Synthetic event object\n     * @param {Route} current Current route information.\n     * @param {Route} previous Previous route information.\n     * @param {Route} rejection Rejection of the promise. Usually the error of the failed promise.\n     */\n\n    /**\n     * @ngdoc event\n     * @name $route#$routeUpdate\n     * @eventType broadcast on root scope\n     * @description\n     *\n     * The `reloadOnSearch` property has been set to false, and we are reusing the same\n     * instance of the Controller.\n     */\n\n    var forceReload = false,\n        preparedRoute,\n        preparedRouteIsUpdateOnly,\n        $route = {\n          routes: routes,\n\n          /**\n           * @ngdoc method\n           * @name $route#reload\n           *\n           * @description\n           * Causes `$route` service to reload the current route even if\n           * {@link ng.$location $location} hasn't changed.\n           *\n           * As a result of that, {@link ngRoute.directive:ngView ngView}\n           * creates new scope and reinstantiates the controller.\n           */\n          reload: function() {\n            forceReload = true;\n            $rootScope.$evalAsync(function() {\n              // Don't support cancellation of a reload for now...\n              prepareRoute();\n              commitRoute();\n            });\n          },\n\n          /**\n           * @ngdoc method\n           * @name $route#updateParams\n           *\n           * @description\n           * Causes `$route` service to update the current URL, replacing\n           * current route parameters with those specified in `newParams`.\n           * Provided property names that match the route's path segment\n           * definitions will be interpolated into the location's path, while\n           * remaining properties will be treated as query params.\n           *\n           * @param {!Object<string, string>} newParams mapping of URL parameter names to values\n           */\n          updateParams: function(newParams) {\n            if (this.current && this.current.$$route) {\n              newParams = angular.extend({}, this.current.params, newParams);\n              $location.path(interpolate(this.current.$$route.originalPath, newParams));\n              // interpolate modifies newParams, only query params are left\n              $location.search(newParams);\n            } else {\n              throw $routeMinErr('norout', 'Tried updating route when with no current route');\n            }\n          }\n        };\n\n    $rootScope.$on('$locationChangeStart', prepareRoute);\n    $rootScope.$on('$locationChangeSuccess', commitRoute);\n\n    return $route;\n\n    /////////////////////////////////////////////////////\n\n    /**\n     * @param on {string} current url\n     * @param route {Object} route regexp to match the url against\n     * @return {?Object}\n     *\n     * @description\n     * Check if the route matches the current url.\n     *\n     * Inspired by match in\n     * visionmedia/express/lib/router/router.js.\n     */\n    function switchRouteMatcher(on, route) {\n      var keys = route.keys,\n          params = {};\n\n      if (!route.regexp) return null;\n\n      var m = route.regexp.exec(on);\n      if (!m) return null;\n\n      for (var i = 1, len = m.length; i < len; ++i) {\n        var key = keys[i - 1];\n\n        var val = m[i];\n\n        if (key && val) {\n          params[key.name] = val;\n        }\n      }\n      return params;\n    }\n\n    function prepareRoute($locationEvent) {\n      var lastRoute = $route.current;\n\n      preparedRoute = parseRoute();\n      preparedRouteIsUpdateOnly = preparedRoute && lastRoute && preparedRoute.$$route === lastRoute.$$route\n          && angular.equals(preparedRoute.pathParams, lastRoute.pathParams)\n          && !preparedRoute.reloadOnSearch && !forceReload;\n\n      if (!preparedRouteIsUpdateOnly && (lastRoute || preparedRoute)) {\n        if ($rootScope.$broadcast('$routeChangeStart', preparedRoute, lastRoute).defaultPrevented) {\n          if ($locationEvent) {\n            $locationEvent.preventDefault();\n          }\n        }\n      }\n    }\n\n    function commitRoute() {\n      var lastRoute = $route.current;\n      var nextRoute = preparedRoute;\n\n      if (preparedRouteIsUpdateOnly) {\n        lastRoute.params = nextRoute.params;\n        angular.copy(lastRoute.params, $routeParams);\n        $rootScope.$broadcast('$routeUpdate', lastRoute);\n      } else if (nextRoute || lastRoute) {\n        forceReload = false;\n        $route.current = nextRoute;\n        if (nextRoute) {\n          if (nextRoute.redirectTo) {\n            if (angular.isString(nextRoute.redirectTo)) {\n              $location.path(interpolate(nextRoute.redirectTo, nextRoute.params)).search(nextRoute.params)\n                       .replace();\n            } else {\n              $location.url(nextRoute.redirectTo(nextRoute.pathParams, $location.path(), $location.search()))\n                       .replace();\n            }\n          }\n        }\n\n        $q.when(nextRoute).\n          then(function() {\n            if (nextRoute) {\n              var locals = angular.extend({}, nextRoute.resolve),\n                  template, templateUrl;\n\n              angular.forEach(locals, function(value, key) {\n                locals[key] = angular.isString(value) ?\n                    $injector.get(value) : $injector.invoke(value, null, null, key);\n              });\n\n              if (angular.isDefined(template = nextRoute.template)) {\n                if (angular.isFunction(template)) {\n                  template = template(nextRoute.params);\n                }\n              } else if (angular.isDefined(templateUrl = nextRoute.templateUrl)) {\n                if (angular.isFunction(templateUrl)) {\n                  templateUrl = templateUrl(nextRoute.params);\n                }\n                templateUrl = $sce.getTrustedResourceUrl(templateUrl);\n                if (angular.isDefined(templateUrl)) {\n                  nextRoute.loadedTemplateUrl = templateUrl;\n                  template = $templateRequest(templateUrl);\n                }\n              }\n              if (angular.isDefined(template)) {\n                locals['$template'] = template;\n              }\n              return $q.all(locals);\n            }\n          }).\n          // after route change\n          then(function(locals) {\n            if (nextRoute == $route.current) {\n              if (nextRoute) {\n                nextRoute.locals = locals;\n                angular.copy(nextRoute.params, $routeParams);\n              }\n              $rootScope.$broadcast('$routeChangeSuccess', nextRoute, lastRoute);\n            }\n          }, function(error) {\n            if (nextRoute == $route.current) {\n              $rootScope.$broadcast('$routeChangeError', nextRoute, lastRoute, error);\n            }\n          });\n      }\n    }\n\n\n    /**\n     * @returns {Object} the current active route, by matching it against the URL\n     */\n    function parseRoute() {\n      // Match a route\n      var params, match;\n      angular.forEach(routes, function(route, path) {\n        if (!match && (params = switchRouteMatcher($location.path(), route))) {\n          match = inherit(route, {\n            params: angular.extend({}, $location.search(), params),\n            pathParams: params});\n          match.$$route = route;\n        }\n      });\n      // No route matched; fallback to \"otherwise\" route\n      return match || routes[null] && inherit(routes[null], {params: {}, pathParams:{}});\n    }\n\n    /**\n     * @returns {string} interpolation of the redirect path with the parameters\n     */\n    function interpolate(string, params) {\n      var result = [];\n      angular.forEach((string || '').split(':'), function(segment, i) {\n        if (i === 0) {\n          result.push(segment);\n        } else {\n          var segmentMatch = segment.match(/(\\w+)(?:[?*])?(.*)/);\n          var key = segmentMatch[1];\n          result.push(params[key]);\n          result.push(segmentMatch[2] || '');\n          delete params[key];\n        }\n      });\n      return result.join('');\n    }\n  }];\n}\n\nngRouteModule.provider('$routeParams', $RouteParamsProvider);\n\n\n/**\n * @ngdoc service\n * @name $routeParams\n * @requires $route\n *\n * @description\n * The `$routeParams` service allows you to retrieve the current set of route parameters.\n *\n * Requires the {@link ngRoute `ngRoute`} module to be installed.\n *\n * The route parameters are a combination of {@link ng.$location `$location`}'s\n * {@link ng.$location#search `search()`} and {@link ng.$location#path `path()`}.\n * The `path` parameters are extracted when the {@link ngRoute.$route `$route`} path is matched.\n *\n * In case of parameter name collision, `path` params take precedence over `search` params.\n *\n * The service guarantees that the identity of the `$routeParams` object will remain unchanged\n * (but its properties will likely change) even when a route change occurs.\n *\n * Note that the `$routeParams` are only updated *after* a route change completes successfully.\n * This means that you cannot rely on `$routeParams` being correct in route resolve functions.\n * Instead you can use `$route.current.params` to access the new route's parameters.\n *\n * @example\n * ```js\n *  // Given:\n *  // URL: http://server.com/index.html#/Chapter/1/Section/2?search=moby\n *  // Route: /Chapter/:chapterId/Section/:sectionId\n *  //\n *  // Then\n *  $routeParams ==> {chapterId:'1', sectionId:'2', search:'moby'}\n * ```\n */\nfunction $RouteParamsProvider() {\n  this.$get = function() { return {}; };\n}\n\nngRouteModule.directive('ngView', ngViewFactory);\nngRouteModule.directive('ngView', ngViewFillContentFactory);\n\n\n/**\n * @ngdoc directive\n * @name ngView\n * @restrict ECA\n *\n * @description\n * # Overview\n * `ngView` is a directive that complements the {@link ngRoute.$route $route} service by\n * including the rendered template of the current route into the main layout (`index.html`) file.\n * Every time the current route changes, the included view changes with it according to the\n * configuration of the `$route` service.\n *\n * Requires the {@link ngRoute `ngRoute`} module to be installed.\n *\n * @animations\n * enter - animation is used to bring new content into the browser.\n * leave - animation is used to animate existing content away.\n *\n * The enter and leave animation occur concurrently.\n *\n * @scope\n * @priority 400\n * @param {string=} onload Expression to evaluate whenever the view updates.\n *\n * @param {string=} autoscroll Whether `ngView` should call {@link ng.$anchorScroll\n *                  $anchorScroll} to scroll the viewport after the view is updated.\n *\n *                  - If the attribute is not set, disable scrolling.\n *                  - If the attribute is set without value, enable scrolling.\n *                  - Otherwise enable scrolling only if the `autoscroll` attribute value evaluated\n *                    as an expression yields a truthy value.\n * @example\n    <example name=\"ngView-directive\" module=\"ngViewExample\"\n             deps=\"angular-route.js;angular-animate.js\"\n             animations=\"true\" fixBase=\"true\">\n      <file name=\"index.html\">\n        <div ng-controller=\"MainCtrl as main\">\n          Choose:\n          <a href=\"Book/Moby\">Moby</a> |\n          <a href=\"Book/Moby/ch/1\">Moby: Ch1</a> |\n          <a href=\"Book/Gatsby\">Gatsby</a> |\n          <a href=\"Book/Gatsby/ch/4?key=value\">Gatsby: Ch4</a> |\n          <a href=\"Book/Scarlet\">Scarlet Letter</a><br/>\n\n          <div class=\"view-animate-container\">\n            <div ng-view class=\"view-animate\"></div>\n          </div>\n          <hr />\n\n          <pre>$location.path() = {{main.$location.path()}}</pre>\n          <pre>$route.current.templateUrl = {{main.$route.current.templateUrl}}</pre>\n          <pre>$route.current.params = {{main.$route.current.params}}</pre>\n          <pre>$routeParams = {{main.$routeParams}}</pre>\n        </div>\n      </file>\n\n      <file name=\"book.html\">\n        <div>\n          controller: {{book.name}}<br />\n          Book Id: {{book.params.bookId}}<br />\n        </div>\n      </file>\n\n      <file name=\"chapter.html\">\n        <div>\n          controller: {{chapter.name}}<br />\n          Book Id: {{chapter.params.bookId}}<br />\n          Chapter Id: {{chapter.params.chapterId}}\n        </div>\n      </file>\n\n      <file name=\"animations.css\">\n        .view-animate-container {\n          position:relative;\n          height:100px!important;\n          background:white;\n          border:1px solid black;\n          height:40px;\n          overflow:hidden;\n        }\n\n        .view-animate {\n          padding:10px;\n        }\n\n        .view-animate.ng-enter, .view-animate.ng-leave {\n          -webkit-transition:all cubic-bezier(0.250, 0.460, 0.450, 0.940) 1.5s;\n          transition:all cubic-bezier(0.250, 0.460, 0.450, 0.940) 1.5s;\n\n          display:block;\n          width:100%;\n          border-left:1px solid black;\n\n          position:absolute;\n          top:0;\n          left:0;\n          right:0;\n          bottom:0;\n          padding:10px;\n        }\n\n        .view-animate.ng-enter {\n          left:100%;\n        }\n        .view-animate.ng-enter.ng-enter-active {\n          left:0;\n        }\n        .view-animate.ng-leave.ng-leave-active {\n          left:-100%;\n        }\n      </file>\n\n      <file name=\"script.js\">\n        angular.module('ngViewExample', ['ngRoute', 'ngAnimate'])\n          .config(['$routeProvider', '$locationProvider',\n            function($routeProvider, $locationProvider) {\n              $routeProvider\n                .when('/Book/:bookId', {\n                  templateUrl: 'book.html',\n                  controller: 'BookCtrl',\n                  controllerAs: 'book'\n                })\n                .when('/Book/:bookId/ch/:chapterId', {\n                  templateUrl: 'chapter.html',\n                  controller: 'ChapterCtrl',\n                  controllerAs: 'chapter'\n                });\n\n              $locationProvider.html5Mode(true);\n          }])\n          .controller('MainCtrl', ['$route', '$routeParams', '$location',\n            function($route, $routeParams, $location) {\n              this.$route = $route;\n              this.$location = $location;\n              this.$routeParams = $routeParams;\n          }])\n          .controller('BookCtrl', ['$routeParams', function($routeParams) {\n            this.name = \"BookCtrl\";\n            this.params = $routeParams;\n          }])\n          .controller('ChapterCtrl', ['$routeParams', function($routeParams) {\n            this.name = \"ChapterCtrl\";\n            this.params = $routeParams;\n          }]);\n\n      </file>\n\n      <file name=\"protractor.js\" type=\"protractor\">\n        it('should load and compile correct template', function() {\n          element(by.linkText('Moby: Ch1')).click();\n          var content = element(by.css('[ng-view]')).getText();\n          expect(content).toMatch(/controller\\: ChapterCtrl/);\n          expect(content).toMatch(/Book Id\\: Moby/);\n          expect(content).toMatch(/Chapter Id\\: 1/);\n\n          element(by.partialLinkText('Scarlet')).click();\n\n          content = element(by.css('[ng-view]')).getText();\n          expect(content).toMatch(/controller\\: BookCtrl/);\n          expect(content).toMatch(/Book Id\\: Scarlet/);\n        });\n      </file>\n    </example>\n */\n\n\n/**\n * @ngdoc event\n * @name ngView#$viewContentLoaded\n * @eventType emit on the current ngView scope\n * @description\n * Emitted every time the ngView content is reloaded.\n */\nngViewFactory.$inject = ['$route', '$anchorScroll', '$animate'];\nfunction ngViewFactory($route, $anchorScroll, $animate) {\n  return {\n    restrict: 'ECA',\n    terminal: true,\n    priority: 400,\n    transclude: 'element',\n    link: function(scope, $element, attr, ctrl, $transclude) {\n        var currentScope,\n            currentElement,\n            previousLeaveAnimation,\n            autoScrollExp = attr.autoscroll,\n            onloadExp = attr.onload || '';\n\n        scope.$on('$routeChangeSuccess', update);\n        update();\n\n        function cleanupLastView() {\n          if (previousLeaveAnimation) {\n            $animate.cancel(previousLeaveAnimation);\n            previousLeaveAnimation = null;\n          }\n\n          if (currentScope) {\n            currentScope.$destroy();\n            currentScope = null;\n          }\n          if (currentElement) {\n            previousLeaveAnimation = $animate.leave(currentElement);\n            previousLeaveAnimation.then(function() {\n              previousLeaveAnimation = null;\n            });\n            currentElement = null;\n          }\n        }\n\n        function update() {\n          var locals = $route.current && $route.current.locals,\n              template = locals && locals.$template;\n\n          if (angular.isDefined(template)) {\n            var newScope = scope.$new();\n            var current = $route.current;\n\n            // Note: This will also link all children of ng-view that were contained in the original\n            // html. If that content contains controllers, ... they could pollute/change the scope.\n            // However, using ng-view on an element with additional content does not make sense...\n            // Note: We can't remove them in the cloneAttchFn of $transclude as that\n            // function is called before linking the content, which would apply child\n            // directives to non existing elements.\n            var clone = $transclude(newScope, function(clone) {\n              $animate.enter(clone, null, currentElement || $element).then(function onNgViewEnter() {\n                if (angular.isDefined(autoScrollExp)\n                  && (!autoScrollExp || scope.$eval(autoScrollExp))) {\n                  $anchorScroll();\n                }\n              });\n              cleanupLastView();\n            });\n\n            currentElement = clone;\n            currentScope = current.scope = newScope;\n            currentScope.$emit('$viewContentLoaded');\n            currentScope.$eval(onloadExp);\n          } else {\n            cleanupLastView();\n          }\n        }\n    }\n  };\n}\n\n// This directive is called during the $transclude call of the first `ngView` directive.\n// It will replace and compile the content of the element with the loaded template.\n// We need this directive so that the element content is already filled when\n// the link function of another directive on the same element as ngView\n// is called.\nngViewFillContentFactory.$inject = ['$compile', '$controller', '$route'];\nfunction ngViewFillContentFactory($compile, $controller, $route) {\n  return {\n    restrict: 'ECA',\n    priority: -400,\n    link: function(scope, $element) {\n      var current = $route.current,\n          locals = current.locals;\n\n      $element.html(locals.$template);\n\n      var link = $compile($element.contents());\n\n      if (current.controller) {\n        locals.$scope = scope;\n        var controller = $controller(current.controller, locals);\n        if (current.controllerAs) {\n          scope[current.controllerAs] = controller;\n        }\n        $element.data('$ngControllerController', controller);\n        $element.children().data('$ngControllerController', controller);\n      }\n\n      link(scope);\n    }\n  };\n}\n\n\n})(window, window.angular);\n\n},{}],2:[function(require,module,exports){\nrequire('./angular-route');\nmodule.exports = 'ngRoute';\n\n},{\"./angular-route\":1}],3:[function(require,module,exports){\nwindow.addEventListener('load', function() {\r\n  window.applicationCache.addEventListener('updateready', function() {\r\n    window.location.reload();\r\n  }, false);\r\n}, false);\n},{}],4:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar _ = require(\"lodash\");\r\nvar angular = require(\"angular\");\r\n\r\nangular.module(\"debtApp\")\r\n  .controller(\"BalanceSheetCtrl\", BalanceSheetCtrl);\r\n\r\nfunction BalanceSheetCtrl(balanceSheetService, debtService, events, $scope, $log) {\r\n  var vm = this;\r\n  \r\n  vm.init = init;\r\n  vm.refresh = refresh;\r\n  vm.updateSheet = updateSheet;\r\n  \r\n  init();\r\n  \r\n  /////////////////////////////////////////////////////////////\r\n  \r\n  function init() {\r\n    refresh();\r\n    $scope.$on(events.BALANCE_SHEET_UPDATED, vm.refresh);\r\n  }\r\n  \r\n  function refresh() {\r\n    vm.balanceSheet = balanceSheetService.balanceSheet;\r\n    try {\r\n      vm.debtsByDebtor = computeDebts();\r\n      vm.debtComputationError = undefined;\r\n    } catch (e) {\r\n      $log.error(e);\r\n      vm.debtsByDebtor = undefined;\r\n      vm.debtComputationError = \"Cannot compute debts\";\r\n    }\r\n  }\r\n  \r\n  function computeDebts() {\r\n    if (vm.balanceSheet.isBalanced()) {\r\n      var participations = vm.balanceSheet.getNonSettledParticipations();\r\n      var debts = debtService.computeDebts(participations, vm.balanceSheet.currency);\r\n      return debtService.organizeByDebtor(debts);\r\n    } else {\r\n      return undefined;\r\n    }\r\n  }\r\n\r\n  function updateSheet() {\r\n    $scope.$emit(events.BALANCE_SHEET_UPDATED);\r\n  }\r\n}\n},{\"angular\":\"angular\",\"lodash\":\"lodash\"}],5:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\nvar BalanceSheet = require('./balance-sheet');\r\n\r\nangular.module(\"debtApp\")\r\n  .factory(\"balanceSheetService\", balanceSheetService);\r\n\r\nfunction balanceSheetService(localStorageService) {\r\n\r\n  var DATE_REGEX = /\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}\\.\\d{3}Z/; // 2016-04-07T21:00:00.000Z\r\n\r\n  var service = {\r\n    balanceSheet: undefined,\r\n    save: save,\r\n    loadFromJson: loadFromJson,\r\n    exportToJson: exportToJson,\r\n    createNew: createNew,\r\n    init: init\r\n  };\r\n\r\n  return service;\r\n\r\n\r\n  function init() {\r\n    var localStorageData = localStorageService.get(\"balanceSheetData\");\r\n    var data;\r\n    if (localStorageData && localStorageData.json) {\r\n       data = JSON.parse(localStorageData.json, dateReviver);\r\n    } else if (localStorageData) {\r\n      data = localStorageData; // backwards compatibility\r\n    } else {\r\n      data = {};\r\n    }\r\n    service.balanceSheet = new BalanceSheet(data);\r\n  }\r\n\r\n  function save() {\r\n    if (!service.balanceSheet) {\r\n      throw new ReferenceError(\"No balance valid balance sheet\");\r\n    }\r\n    service.balanceSheet.throwErrorIfInvalid();\r\n\r\n    // Store a JSON string in localStorage instead of allowing localStorageService to stringify\r\n    // the data so that we can control date parsing.\r\n    var jsonString = JSON.stringify(service.balanceSheet.exportData());\r\n    localStorageService.set(\"balanceSheetData\", {json: jsonString});\r\n  }\r\n\r\n  function loadFromJson(json) {\r\n    var data = JSON.parse(json, dateReviver);\r\n    var balanceSheet = new BalanceSheet(data);\r\n    balanceSheet.throwErrorIfInvalid();\r\n    service.balanceSheet = balanceSheet;\r\n    save();\r\n  }\r\n\r\n  function dateReviver(key, value) {\r\n    if (typeof value === 'string' && DATE_REGEX.test(value)) {\r\n      return new Date(value);\r\n    }\r\n    return value;\r\n  }\r\n\r\n  function exportToJson() {\r\n    var data = service.balanceSheet.exportData();\r\n    return JSON.stringify(data);\r\n  }\r\n\r\n  function createNew() {\r\n    service.balanceSheet = new BalanceSheet();\r\n    service.save();\r\n  }\r\n\r\n}\r\n\r\n\r\n\n},{\"./balance-sheet\":6,\"angular\":\"angular\"}],6:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar _ = require('lodash');\r\nvar angular = require(\"angular\");\r\nvar Decimal = require(\"simple-decimal-money\");\r\nvar CurrencyConversionError = require(\"./currency-conversion-error\");\r\n\r\nvar BalanceSheet = function(data) {\r\n\r\n  var _this = this;\r\n  var _sheet = this;\r\n\r\n  var EXCHANGE_RATE_DECIMALS = 4;\r\n\r\n  // Data\r\n\r\n  var persons = [];\r\n  var expenses = [];\r\n  var participations = [];\r\n\r\n  var exchangeRates = [];\r\n\r\n  var idSequence = 1;\r\n\r\n  _this.name = \"New sheet\";\r\n  _this.currency = undefined;\r\n  _this.persons = persons;\r\n  _this.expenses = expenses;\r\n  _this.participations = participations;\r\n\r\n  if (data) {\r\n    importData(data);\r\n  }\r\n\r\n  // Methods\r\n\r\n  _this.getNonSettledParticipations = getNonSettledParticipations;\r\n\r\n  _this.isBalanced = isBalanced;\r\n\r\n  _this.getPerson = getPerson;\r\n  _this.createPerson = createPerson;\r\n  _this.removePerson = removePerson;\r\n\r\n  _this.getExpense = getExpense;\r\n  _this.createExpense = createExpense;\r\n  _this.removeExpense = removeExpense;\r\n\r\n  _this.getParticipation = getParticipation;\r\n  _this.createParticipation = createParticipation;\r\n  _this.removeParticipation = removeParticipation;\r\n\r\n  _this.exportData = exportData;\r\n\r\n  _this.isValid = isValid;\r\n  _this.throwErrorIfInvalid = throwErrorIfInvalid;\r\n\r\n  _this.currenciesEnabled = currenciesEnabled;\r\n  _this.getExchangeRates = getExchangeRates;\r\n  _this.getCurrencies = getCurrencies;\r\n  _this.getExpenseCurrencies = getExpenseCurrencies;\r\n  _this.getExchangeRateCurrencies = getExchangeRateCurrencies;\r\n  _this.addOrUpdateExchangeRate = addOrUpdateExchangeRate;\r\n  _this.removeExchangeRate = removeExchangeRate;\r\n  _this.convertCurrency = convertCurrency;\r\n  _this.getConvertibleCurrencies = getConvertibleCurrencies;\r\n  _this.getNonConvertibleCurrencies = getNonConvertibleCurrencies;\r\n  _this.throwErrorIfInvalidExpenseCurrencies = throwErrorIfInvalidExpenseCurrencies;\r\n\r\n  /////////////////////////////////////\r\n\r\n\r\n  function getNonSettledParticipations() {\r\n    return _.filter(participations, function(pt) {\r\n      return !pt.expense.settled;\r\n    });\r\n  }\r\n\r\n  function isBalanced() {\r\n    return _.reduce(expenses, function(isBalanced, e) {\r\n      return isBalanced && (e.settled || e.isBalanced());\r\n    }, true);\r\n  }\r\n\r\n\r\n  function getPerson(id) {\r\n    return _(persons).find(function(p) {\r\n      return p.id == id;\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Creates a person.\r\n   *\r\n   * @param {Object} [data] - Person data\r\n   * @param {String} [data.name=Person <number>] - Person's name\r\n   * @param {Object} [options] - Options for creating a person\r\n   * @param {boolean} [options.createParticipations=true] - Whether the person is set to participate in all existing expenses\r\n   * @returns {Person} - The created Person object\r\n   */\r\n  function createPerson(data, options) {\r\n    data = _.extend({\r\n      name: \"Person \" + (persons.length + 1)\r\n    }, data);\r\n\r\n    options = _.extend({}, options);\r\n\r\n    if (data.id === undefined) {\r\n      data.id = idSequence;\r\n      idSequence = idSequence + 1;\r\n    }\r\n\r\n    var person = new Person(data);\r\n    persons.push(person);\r\n\r\n    if (options.createParticipations === true) {\r\n      _.each(expenses, function(e) {\r\n        if (!e.settled) {\r\n          createParticipation({person: person, expense: e});\r\n          e.shareCost();\r\n        }\r\n      });\r\n    }\r\n\r\n    return person;\r\n  }\r\n\r\n  function removePerson(toRemove) {\r\n    toRemove = getPerson(toRemove.id);\r\n\r\n    if (!toRemove) return;\r\n\r\n    _.remove(persons, function(e) {\r\n      return e.equals(toRemove);\r\n    });\r\n\r\n    _.forEach(toRemove.getParticipations(), function(pt) {\r\n      removeParticipation(pt);\r\n    });\r\n  }\r\n\r\n  function getExpense(id) {\r\n    return _(expenses).find(function(e) {\r\n      return e.id == id;\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Creates an expense.\r\n   *\r\n   * @param {Object} [data] - Expense data\r\n   * @param {String} [data.name=Expense <number>] - Expense's name\r\n   * @param {String} [data.currency] - The currency the expense was paid in\r\n   * @param {Object} [options] - Options for creating an expense\r\n   * @param {boolean} [options.createParticipations=true] - Whether all existing persons are set to participate in the expense\r\n   * @returns {Expense} - The created Expense object\r\n   */\r\n  function createExpense(data, options) {\r\n    data = _.extend({\r\n      name: \"Expense \" + (expenses.length + 1),\r\n      sharing: \"equal\",\r\n      settled: false,\r\n      currency: undefined\r\n    }, data);\r\n\r\n    options = _.extend({}, options);\r\n\r\n    if (data.id === undefined) {\r\n      data.id = idSequence;\r\n      idSequence = idSequence + 1;\r\n    }\r\n\r\n    var expense = new Expense(data);\r\n    expenses.push(expense);\r\n\r\n    if (options.createParticipations === true) {\r\n      _.each(persons, function(p) {\r\n        createParticipation({person: p, expense: expense});\r\n      });\r\n    }\r\n\r\n    return expense;\r\n  }\r\n\r\n  function removeExpense(toRemove) {\r\n    toRemove = getExpense(toRemove.id);\r\n\r\n    if (!toRemove) return;\r\n\r\n    _.remove(expenses, function(e) {\r\n      return e.equals(toRemove);\r\n    });\r\n\r\n    _.forEach(toRemove.getParticipations(), function(pt) {\r\n      removeParticipation(pt);\r\n    });\r\n  }\r\n\r\n\r\n  function getParticipation(criteria) {\r\n    var toSeek = new Participation(criteria);\r\n    return _(participations).find(function(pt) {\r\n      return toSeek.equals(pt);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Creates a participation of a Person to an Expense.\r\n   *\r\n   * @param {Object} data - Participation data\r\n   * @param {Person} data.person - The participant person\r\n   * @param {Expense} data.expense - The expense to participate in\r\n   * @param {number} [data.paid=0] - How much the person has paid for the expense (in the expense currency)\r\n   * @param {number} [data.share=0] - The person's share of the expense's total cost (in the expense currency)\r\n   * @returns {Participation} - The created Participation object\r\n   */\r\n  function createParticipation(data) {\r\n    if (getParticipation(data)) {\r\n      throw new Error(\"Duplicate participation\");\r\n    }\r\n\r\n    data = _.extend({\r\n      paid: 0,\r\n      share: 0\r\n    }, data);\r\n\r\n    var participation = new Participation(data);\r\n    participations.push(participation);\r\n\r\n    participation.expense.shareCost();\r\n\r\n    return participation;\r\n  }\r\n\r\n  function removeParticipation(toRemove) {\r\n    toRemove = getParticipation(toRemove);\r\n\r\n    if (!toRemove) return;\r\n\r\n    _.remove(participations, function(pt) {\r\n      return pt.equals(toRemove);\r\n    });\r\n\r\n    toRemove.expense.shareCost();\r\n  }\r\n\r\n\r\n  /**\r\n   * @returns {boolean} Whether currencies are enabled in this balance sheet\r\n   */\r\n  function currenciesEnabled() {\r\n    return exchangeRates && exchangeRates.length > 0;\r\n  }\r\n  /**\r\n   * @return {string[]} copy of exchange rates in this sheet\r\n   */\r\n  function getExchangeRates() {\r\n    return _.cloneDeep(exchangeRates);\r\n  }\r\n\r\n  /**\r\n   * @return list of currencies in alphabetical order\r\n   */\r\n  function getCurrencies() {\r\n    return _.chain(getExchangeRateCurrencies())\r\n      .concat(getExpenseCurrencies(), _this.currency)\r\n      .uniq()\r\n      .sort()\r\n      .value();\r\n  }\r\n\r\n  function getExchangeRateCurrencies() {\r\n    return _.reduce(exchangeRates, function(result, er) {\r\n      result.push(er.fixed);\r\n      result.push(er.variable);\r\n      return result;\r\n    }, []);\r\n  }\r\n\r\n  function getExpenseCurrencies() {\r\n    return _.map(expenses, function(e) {\r\n      return e.computedCurrency();\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Adds or updates an exchange rate.\r\n   *\r\n   * @param {Object} quotation - The exchange rate object\r\n   * @param {string} quotation.fixed - The fixed currency symbol\r\n   * @param {string} quotation.variable - The variable currency symbol\r\n   * @param {number} quotation.rate - The rate: 1 unit of the fixed currency buys this amount of the variable currency. Must be a positive number with at most 4 decimals.\r\n   */\r\n  function addOrUpdateExchangeRate(quotation) {\r\n    validateQuotation(quotation);\r\n    var existing = _.find(exchangeRates, _.pick(quotation, 'fixed', 'variable'));\r\n    if (existing) {\r\n      _.extend(existing, quotation);\r\n    } else {\r\n      exchangeRates.push(quotation);\r\n    }\r\n    updateBalanceSheetCurrencyIfNeeded();\r\n  }\r\n\r\n  function validateQuotation(quotation) {\r\n    if (!_.isString(quotation.fixed) || _.trim(quotation.fixed) === \"\") {\r\n      throw new TypeError(\"Fixed currency symbol must be a non-empty string\");\r\n    }\r\n    if (!_.isString(quotation.variable) || _.trim(quotation.variable) === \"\") {\r\n      throw new TypeError(\"Variable currency symbol must be a non-empty string\");\r\n    }\r\n    if (!_.isNumber(quotation.rate) || quotation.rate < 0.0001) {\r\n      throw new RangeError(\"Foreign currency rate must be >= 0.0001\");\r\n    }\r\n  }\r\n\r\n  function cleanUpCurrency(currency) {\r\n    if (!currency) {\r\n      return undefined;\r\n    } else if (_.isString(currency) && _.trim(currency).length === 0) {\r\n      return undefined;\r\n    } else {\r\n      return _.trim(currency);\r\n    }\r\n  }\r\n\r\n  function cleanUpCurrencyPair(currencyPair) {\r\n    currencyPair = _.clone(currencyPair);\r\n    currencyPair.fixed = cleanUpCurrency(currencyPair.fixed);\r\n    currencyPair.variable = cleanUpCurrency(currencyPair.variable);\r\n    return currencyPair;\r\n  }\r\n\r\n  /**\r\n   * Removes an exchange rate.\r\n   *\r\n   * @param currencyPair - The currency pair to remove\r\n   * @param {string} currencyPair.fixed - The fixed currency symbol\r\n   * @param {string} currencyPair.variable - The variable currency symbol\r\n   */\r\n  function removeExchangeRate(currencyPair) {\r\n    if (!currencyPair) return;\r\n    currencyPair = cleanUpCurrencyPair(currencyPair);\r\n    _.remove(exchangeRates, _.pick(currencyPair, 'fixed', 'variable'));\r\n    updateBalanceSheetCurrencyIfNeeded();\r\n    updateExpenseCurrenciesIfNeeded();\r\n  }\r\n\r\n  /**\r\n   * Converts a value from one currency to another. Uses the inverse of an exchange\r\n   * rate if an inverse currency pair is found.\r\n   *\r\n   * @param {Object} toConvert - The data object\r\n   * @param {number} toConvert.value - The value to convert\r\n   * @param {string} toConvert.fixed - The currency of the value to be converted\r\n   * @param {string} toConvert.variable - The currency to convert the value to\r\n   * @return {number} - The value in the variable currency\r\n   */\r\n  function convertCurrency(toConvert) {\r\n    var rate;\r\n\r\n    if (!toConvert) {\r\n      throw new CurrencyConversionError(\"Undefined or null conversion data\");\r\n    }\r\n\r\n    toConvert = cleanUpCurrencyPair(toConvert);\r\n\r\n    if (toConvert.fixed == toConvert.variable) {\r\n      return new Decimal(toConvert.value).toNumber();\r\n    }\r\n\r\n    var quotation = _.find(exchangeRates, {fixed: toConvert.fixed, variable: toConvert.variable});\r\n\r\n    if (quotation) {\r\n      rate = new Decimal(quotation.rate, EXCHANGE_RATE_DECIMALS);\r\n    } else {\r\n      var searchPair = {variable: toConvert.fixed, fixed: toConvert.variable};\r\n      var inverseQuotation = _.find(exchangeRates, searchPair);\r\n      if (inverseQuotation) {\r\n        rate = new Decimal(1/inverseQuotation.rate, EXCHANGE_RATE_DECIMALS);\r\n      }\r\n    }\r\n\r\n    if (!rate) {\r\n      throw new CurrencyConversionError(\"Could not find an exchange rate for conversion '\" + toConvert.fixed + \"' -> '\" + toConvert.variable + \"'.\");\r\n    }\r\n\r\n    return new Decimal(toConvert.value*100).multiply(rate).divideBy(100).toNumber();\r\n  }\r\n\r\n  function tryToConvertCurrency(toConvert) {\r\n    try {\r\n      return convertCurrency(toConvert);\r\n    } catch (e) {\r\n      if (e instanceof CurrencyConversionError) {\r\n        return NaN;\r\n      } else {\r\n        throw e;\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns currencies that can be converted to the given currency.\r\n   *\r\n   * @param {string[]} fromCurrencies - Currencies to convert\r\n   * @param {string} toCurrency - Currency to convert to\r\n   * @returns {string[]} - Convertible currencies in fromCurrencies\r\n   */\r\n  function getConvertibleCurrencies(fromCurrencies, toCurrency) {\r\n    if (!_.isArray(fromCurrencies)) {\r\n      return [];\r\n    }\r\n\r\n    var convertible = [];\r\n    _.each(getCurrencies(), function(c) {\r\n      try {\r\n        convertCurrency({fixed: c, variable: toCurrency, value: 1});\r\n        convertible.push(c);\r\n      } catch (e) {}\r\n    });\r\n    return convertible;\r\n  }\r\n\r\n  /**\r\n   * Finds currencies that can not be converted to the given currency.\r\n   *\r\n   * @param {string[]} fromCurrencies - Currencies to convert\r\n   * @param {string} toCurrency - Currency to convert to\r\n   * @returns {string[]} - Non-convertible currencies\r\n   */\r\n  function getNonConvertibleCurrencies(fromCurrencies, toCurrency) {\r\n    return _.difference(fromCurrencies, getConvertibleCurrencies(fromCurrencies, toCurrency));\r\n  }\r\n\r\n\r\n  function updateBalanceSheetCurrencyIfNeeded() {\r\n    var currencies = getExchangeRateCurrencies();\r\n\r\n    if (exchangeRates.length === 0) {\r\n      _this.currency = undefined;\r\n    } else if (_this.currency === undefined || _.indexOf(currencies, _this.currency) === -1) {\r\n      _this.currency = exchangeRates[0].fixed;\r\n    }\r\n  }\r\n\r\n\r\n  function updateExpenseCurrenciesIfNeeded() {\r\n    var currencies = _.concat(getExchangeRateCurrencies(), _this.currency);\r\n    _.each(expenses, function(e) {\r\n      if (_.indexOf(currencies, e.currency) === -1) {\r\n        e.currency = _this.currency;\r\n      }\r\n    });\r\n  }\r\n\r\n  function throwErrorIfInvalidExpenseCurrencies() {\r\n    _.each(expenses, function(expense) {\r\n      try {\r\n        convertCurrency({fixed: expense.computedCurrency(), variable: _this.currency, value: 1});\r\n      } catch (ex) {\r\n        throw new CurrencyConversionError(\"Cannot convert currency '\" + expense.computedCurrency()  + \"' of '\" + expense.name + \"' to balance sheet's currency '\" + _this.currency + \"'\");\r\n      }\r\n    });\r\n  }\r\n\r\n\r\n  /**\r\n   * Creates a Person object.\r\n   *\r\n   * @param {Object} [data] - Initial data\r\n   * @param {number} [data.id] - Id\r\n   * @param {string} [data.name} - Name\r\n   * @constructor\r\n   */\r\n  function Person(data) {\r\n    var _this = this;\r\n\r\n    _.extend(_this, data);\r\n\r\n    // Methods\r\n\r\n    _this.computedCurrency = computedCurrency;\r\n    _this.equals = equals;\r\n    _this.getCost = getCost;\r\n    _this.getSumOfShares = getSumOfShares;\r\n    _this.getBalance = getBalance;\r\n    _this.isBalanced = isBalanced;\r\n    _this.getParticipations = getParticipations;\r\n    _this.exportData = exportData;\r\n\r\n    ///////////////////////////////////////\r\n\r\n    var _myParticipations = _.chain(participations)\r\n      .filter(function(pt) {\r\n        return _this.equals(pt.person);\r\n      });\r\n\r\n    var _nonSettledParticipations = _myParticipations\r\n      .filter(function(pt) {\r\n        return !pt.expense.settled;\r\n      });\r\n\r\n\r\n    function getTotal(participationMapping) {\r\n      return _nonSettledParticipations\r\n        .map(participationMapping)\r\n        .reduce(function(total, value) {\r\n          return total.add(value);\r\n        }, new Decimal(0))\r\n        .value()\r\n        .toNumber();\r\n    }\r\n\r\n    function computedCurrency() {\r\n      return _sheet.currency;\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param {string} [currency] - The currency in which to get the total (default: balance sheet's default currency)\r\n     * @returns {number} - The total amount this person has paid. NaN if cannot convert currency.\r\n     */\r\n    function getCost(currency) {\r\n      currency = currency || _this.computedCurrency();\r\n      return getTotal(function(pt) {\r\n        return pt.getPaid(currency);\r\n      });\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param {string} [currency] - The currency in which to get the total (default: balance sheet's default currency)\r\n     * @returns {number} - This person's total share of all the expenses. NaN if cannot convert currency.\r\n     */\r\n    function getSumOfShares(currency) {\r\n      currency = currency || _this.computedCurrency();\r\n      return getTotal(function(pt) {\r\n        return pt.getShare(currency);\r\n      });\r\n    }\r\n\r\n    /**\r\n     * Checks whether this person's costs and shares sum up to zero, i.e. the person neither\r\n     * owes money nor is owed money by anyone else.\r\n     *\r\n     * @returns {boolean} - Whether this person's costs and shares sum up to zero\r\n     */\r\n    function isBalanced() {\r\n      return getBalance() === 0;\r\n    }\r\n\r\n    /**\r\n     * Computes the difference between the total share and cost paid by this person.\r\n     * If the difference is negative, then the person's share is smaller than the costs\r\n     * she has paid, that is others owe her money.\r\n     *\r\n     * @param {string} [currency] - The currency in which to get the balance (default: balance sheet's default currency)\r\n     * @returns {number} - The difference between the total share and cost paid by this person. NaN if cannot convert currency.\r\n     */\r\n    function getBalance(currency) {\r\n      currency = currency || _this.computedCurrency();\r\n      return new Decimal( getSumOfShares(currency) ).subtract( getCost(currency) ).toNumber();\r\n    }\r\n\r\n    /**\r\n     * @returns {Participation[]} - The expense participations of this person\r\n     */\r\n    function getParticipations() {\r\n      return _myParticipations.value();\r\n    }\r\n\r\n    /**\r\n     * @param {Object} other - Another object\r\n     * @returns {boolean} - True if this person is equal to the other object\r\n     */\r\n    function equals(other) {\r\n      return (other instanceof Person) && (other.id === _this.id);\r\n    }\r\n\r\n    function exportData() {\r\n      var isNotFunction = _.negate(_.isFunction);\r\n      return _.extend(_.pickBy(_this, isNotFunction), {});\r\n    }\r\n\r\n  }\r\n\r\n\r\n  /**\r\n   * An expense.\r\n   *\r\n   * @param {object} [data] - Initial data\r\n   * @param {number} [data.id] - The expense's id\r\n   * @param {string} [data.name] - The expense's name\r\n   * @param {string} [data.sharing] -  The expense's cost sharing mode. Value \"equal\" = share costs equally. All other values mean custom sharing.\r\n   * @param {string} [data.currency] - The expense's currency\r\n   * @constructor\r\n   */\r\n  function Expense(data) {\r\n    var _this = this;\r\n\r\n    // Data\r\n    _.extend(_this, data);\r\n\r\n    // Methods\r\n    _this.computedCurrency = computedCurrency;\r\n    _this.getCost = getCost;\r\n    _this.getSumOfShares = getSumOfShares;\r\n    _this.getBalance = getBalance;\r\n    _this.isBalanced = isBalanced;\r\n    _this.getParticipations = getParticipations;\r\n    _this.shareCost = shareCost;\r\n    _this.equals = equals;\r\n    _this.exportData = exportData;\r\n\r\n    ///////////////////////////////////////\r\n\r\n    var _myParticipations = _.chain(participations).filter(function(p) {\r\n      return _this.equals(p.expense);\r\n    });\r\n\r\n\r\n    function getTotal(participationMapping, currency) {\r\n      var total = _myParticipations\r\n        .map(participationMapping)\r\n        .reduce(function(total, value) {\r\n          return total.add(value);\r\n        }, new Decimal(0))\r\n        .value()\r\n        .toNumber();\r\n\r\n      if (!currency || currency === _this.computedCurrency()) {\r\n        return total;\r\n      } else {\r\n        return tryToConvertCurrency({\r\n          value: total,\r\n          fixed: _this.computedCurrency(),\r\n          variable: currency\r\n        });\r\n      }\r\n    }\r\n\r\n\r\n    /**\r\n     * Gets the currency of this expense used for currency computations.\r\n     *\r\n     * @returns {string} - The currency of this expense\r\n     */\r\n    function computedCurrency() {\r\n      return _this.currency || _sheet.currency;\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param {string} [currency] - Currency in which to get the value. Default is this expense's currency or if undefined, the balance sheet's default currency.\r\n     * @return {number} The cost of this expense. NaN if cannot convert currency.\r\n     */\r\n    function getCost(currency) {\r\n      return getTotal(function(pt) {\r\n        return pt.paid;\r\n      }, currency);\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param {string} [currency] - Currency in which to get the value. Default is this expense's currency or if undefined, the balance sheet's default currency.\r\n     * @return {number} The sum of shares of this expense. NaN if cannot convert currency.\r\n     */\r\n    function getSumOfShares(currency) {\r\n      return getTotal(function(pt) {\r\n        return pt.share;\r\n      }, currency);\r\n    }\r\n\r\n    function isBalanced() {\r\n      return getBalance(_this.computedCurrency()) === 0;\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param {string} [currency] - Currency in which to get the value. Default is this expense's currency or if undefined, the balance sheet's default currency.\r\n     * @return {number} The balance of this expense. NaN if cannot convert currency.\r\n     */\r\n    function getBalance(currency) {\r\n      return new Decimal( getSumOfShares(currency) ).subtract( getCost(currency) ).toNumber();\r\n    }\r\n\r\n    function getParticipations() {\r\n      return _myParticipations.value();\r\n    }\r\n\r\n    function shareCost() {\r\n      if (_this.sharing === \"equal\") {\r\n        shareEqually();\r\n      }\r\n    }\r\n\r\n    function shareEqually() {\r\n      var participations = _this.getParticipations();\r\n      if (participations.length === 0) {\r\n        return;\r\n      }\r\n\r\n      var cost = new Decimal(_this.getCost());\r\n      var share = cost.divideBy(participations.length);\r\n      var lastShare = cost.subtract(share.multiply(participations.length - 1));\r\n\r\n      _.forEach(participations, function(p, i) {\r\n        if (i < participations.length - 1) {\r\n          p.share = share.toNumber();\r\n        }\r\n      });\r\n      _.last(participations).share = lastShare.toNumber();\r\n    }\r\n\r\n    function equals(other) {\r\n      return (other instanceof Expense) && (other.id === _this.id);\r\n    }\r\n\r\n    function exportData() {\r\n      var isNotFunction = _.negate(_.isFunction);\r\n      return _.extend(_.pickBy(_this, isNotFunction));\r\n    }\r\n\r\n  }\r\n\r\n  /**\r\n   * Creates a participation of a Person to an Expense.\r\n   *\r\n   * @param {Object} data - Participation data\r\n   * @param {Person} data.person - The participant person\r\n   * @param {Expense} data.expense - The expense to participate in\r\n   * @param {number} [data.paid=0] - How much the person has paid for the expense (in the expense currency)\r\n   * @param {number} [data.share=0] - The person's share of the expense's total cost (in the expense currency)\r\n   * @constructor\r\n   */\r\n  function Participation(data) {\r\n    var _this = this;\r\n\r\n    if (!data || !data.person || !data.expense) {\r\n      throw new ReferenceError(\"Undefined participation\");\r\n    }\r\n\r\n    // Data\r\n\r\n    _.extend(_this, data);\r\n\r\n    // Methods\r\n\r\n    _this.getPaid = getPaid;\r\n    _this.getShare = getShare;\r\n    _this.equals = equals;\r\n    _this.exportData = exportData;\r\n\r\n    ///////////////////////////////////////\r\n\r\n    function getCurrencyConversionFunction(options) {\r\n      if (options.strictConversion) {\r\n        return convertCurrency;\r\n      } else {\r\n        return tryToConvertCurrency;\r\n      }\r\n    }\r\n\r\n    /**\r\n     * Returns the value of property propName with currency conversion (if applicable) adjusted such\r\n     * that the expense is balanced in the target currency.\r\n     *\r\n     * @param {string} propName - The name of the monetary value property\r\n     * @param {string} currency - The target currency\r\n     * @param {object} options - Currrency conversion options\r\n     * @returns {number} - The property value with currency conversion\r\n     */\r\n    function getValue(propName, currency, options) {\r\n      if (!currency || currency === _this.expense.computedCurrency()) {\r\n        return _this[propName];\r\n      }\r\n\r\n      options = _.extend({strictConversion: false}, options);\r\n      var convert = getCurrencyConversionFunction(options);\r\n      var expenseParticipations = _this.expense.getParticipations();\r\n\r\n      if (_.last(expenseParticipations) === _this) {\r\n\r\n        var thisValueConverted = convert({\r\n          value: _this[propName],\r\n          fixed: _this.expense.computedCurrency(),\r\n          variable: currency\r\n        });\r\n\r\n        var originalSum = _.reduce(expenseParticipations, function(sum, prt) {\r\n          return sum.add(prt[propName]);\r\n        }, new Decimal(0)).toNumber();\r\n\r\n        var convertedSum = convert({\r\n          value: originalSum,\r\n          fixed: _this.expense.computedCurrency(),\r\n          variable: currency\r\n        });\r\n\r\n        var sumOfConverted = _.reduce(expenseParticipations, function(sum, prt) {\r\n          var value = convert({\r\n            value: prt[propName],\r\n            fixed: prt.expense.computedCurrency(),\r\n            variable: currency\r\n          });\r\n          return sum.add(value);\r\n        }, new Decimal(0));\r\n\r\n        var delta = sumOfConverted.subtract(convertedSum);\r\n\r\n        return new Decimal(thisValueConverted).subtract(delta).toNumber();\r\n\r\n      } else {\r\n\r\n        return convert({\r\n          value: _this[propName],\r\n          fixed: _this.expense.computedCurrency(),\r\n          variable: currency\r\n        });\r\n\r\n      }\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param {string} [currency] - Currency in which to get the payment. Default is expense's currency.\r\n     * @param {object} [options] - Options\r\n     * @param {boolean} [options.strictConversion] - True to throw error if currency conversion fails, false to return NaN. Default is false.\r\n     * @return {number} How much the person paid for the expense.\r\n     */\r\n    function getPaid(currency, options) {\r\n      return getValue(\"paid\", currency, options);\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param {string} [currency] - Currency in which to get the share. Default is expense's currency.\r\n     * @param {object} [options] - Options\r\n     * @param {boolean} [options.strictConversion] - True to throw error if currency conversion fails, false to return NaN. Default is false.\r\n     * @return {number} How much the person shares for the expense.\r\n     */\r\n    function getShare(currency, options) {\r\n      return getValue(\"share\", currency, options);\r\n    }\r\n\r\n    function equals(other) {\r\n      return (other instanceof Participation) && _this.expense.equals(other.expense) && _this.person.equals(other.person);\r\n    }\r\n\r\n    function exportData() {\r\n      return {personId: _this.person.id, expenseId: _this.expense.id, paid: _this.paid, share: _this.share};\r\n    }\r\n\r\n  }\r\n\r\n\r\n  function exportData() {\r\n    var isNotFunction = _.negate(_.isFunction);\r\n    var data = _.pickBy(_this, isNotFunction);\r\n    data.persons = _.map(persons, function(p) {\r\n      return p.exportData();\r\n    });\r\n    data.expenses = _.map(expenses, function(e) {\r\n      return e.exportData();\r\n    });\r\n    data.participations = _.map(participations, function(pt) {\r\n      return pt.exportData();\r\n    });\r\n    data.exchangeRates = getExchangeRates();\r\n    return data;\r\n  }\r\n\r\n  function importData(data) {\r\n    idSequence = _([])\r\n        .concat(data.persons)\r\n        .concat(data.expenses)\r\n        .map(\"id\")\r\n        .max() + 1;\r\n    if (_.isNaN(idSequence)) {\r\n      idSequence = 1;\r\n    }\r\n\r\n    var separately = {persons: true, expenses: true, participations: true, exchangeRates: true};\r\n\r\n    _.each(data.exchangeRates, function(q) {\r\n      addOrUpdateExchangeRate(q);\r\n    });\r\n\r\n    _.extend(_this, _.pickBy(data, function(value, key) {\r\n      return !separately[key];\r\n    }));\r\n\r\n    _.each(data.persons, function(p) {\r\n      createPerson(p);\r\n    });\r\n\r\n    _.each(data.expenses, function(e) {\r\n      createExpense(e);\r\n    });\r\n\r\n    _.each(data.participations, function(p) {\r\n      var person = getPerson(p.personId);\r\n      var expense = getExpense(p.expenseId);\r\n      createParticipation({person: person, expense: expense, paid: p.paid, share: p.share});\r\n    });\r\n\r\n    throwErrorIfInvalid();\r\n  }\r\n\r\n  function isValid() {\r\n    try {\r\n      throwErrorIfInvalid();\r\n      return true;\r\n    } catch (e) {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  function throwErrorIfInvalid() {\r\n\r\n    _.each(persons, function(p) {\r\n      if (!_.isNumber(p.id)) {\r\n        throw new Error(\"Person has no id\");\r\n      }\r\n    });\r\n\r\n    _.each(expenses, function(e) {\r\n      if (!_.isNumber(e.id)) {\r\n        throw new Error(\"Expense has no id\");\r\n      }\r\n    });\r\n\r\n    var idToEntity = {};\r\n    _.each(persons, function(p) {\r\n      idToEntity[p.id] = p;\r\n    });\r\n    _.each(expenses, function(e) {\r\n      idToEntity[e.id] = e;\r\n    });\r\n    _.each(participations, function(pt) {\r\n      if (!pt.person) {\r\n        throw new Error(\"Participation has no person\");\r\n      }\r\n      if (!idToEntity[pt.person.id]) {\r\n        throw new Error(\"Participation person is unknown\");\r\n      }\r\n      if (!pt.expense) {\r\n        throw new Error(\"Participation has no expense\");\r\n      }\r\n      if (!idToEntity[pt.expense.id]) {\r\n        throw new Error(\"Participation expense is unknown\");\r\n      }\r\n    });\r\n\r\n  }\r\n\r\n};\r\n\r\n\r\nmodule.exports = BalanceSheet;\n},{\"./currency-conversion-error\":7,\"angular\":\"angular\",\"lodash\":\"lodash\",\"simple-decimal-money\":\"simple-decimal-money\"}],7:[function(require,module,exports){\n\"use strict\";\r\n\r\nfunction CurrencyConversionError(message) {\r\n  var temp = Error.apply(this, arguments);\r\n  //temp.name = this.name = 'CurrencyConversionError';\r\n  this.stack = temp.stack;\r\n  this.message = temp.message;\r\n}\r\n\r\nCurrencyConversionError.prototype = Object.create(Error.prototype, {\r\n  constructor: {\r\n    value: CurrencyConversionError,\r\n    writable: true,\r\n    configurable: true\r\n  }\r\n});\r\n\r\nmodule.exports = CurrencyConversionError;\n},{}],8:[function(require,module,exports){\n\"use strict\";\r\n\r\nrequire(\"./route-config\");\r\nrequire(\"./balance-sheet\");\r\nrequire(\"./balance-sheet-service\");\r\nrequire(\"./balance-sheet-ctrl\");\r\nrequire(\"./currency-conversion-error\");\n},{\"./balance-sheet\":6,\"./balance-sheet-ctrl\":4,\"./balance-sheet-service\":5,\"./currency-conversion-error\":7,\"./route-config\":9}],9:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\n\r\nangular.module(\"debtApp\")\r\n  .config(config);\r\n\r\nfunction config($stateProvider) {\r\n\r\n  $stateProvider\r\n    .state(\"balanceSheet\", {\r\n      url: \"/\",\r\n      views: {\r\n        \"\": {\r\n          templateUrl : \"balance-sheet/balance-sheet.html\",\r\n          controller : \"BalanceSheetCtrl as vm\"\r\n        },\r\n        \"floatingButton\": {\r\n          templateUrl : \"balance-sheet/floating-button.html\"\r\n        }\r\n      }\r\n    });\r\n  \r\n}\n},{\"angular\":\"angular\"}],10:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\nvar _ = require('lodash');\r\n\r\nangular.module(\"debtApp\")\r\n  .controller(\"CurrencyListCtrl\", CurrencyListCtrl)\r\n  .controller(\"ExchangeRateDialogCtrl\", ExchangeRateDialogCtrl);\r\n\r\n\r\nfunction CurrencyListCtrl(balanceSheetService, events, $scope, $mdDialog, debounce, $log) {\r\n  var vm = this;\r\n\r\n  vm.init = init;\r\n  vm.openExchangeRateDialog = openExchangeRateDialog;\r\n  vm.updateExchangeRate = updateExchangeRate;\r\n  vm.removeExchangeRate = removeExchangeRate;\r\n\r\n  init();\r\n\r\n  function init() {\r\n    vm.balanceSheet = balanceSheetService.balanceSheet;\r\n    \r\n    refresh();\r\n\r\n    // Workaround to allow FAB for creating an exchange rate to reside\r\n    // in a different scope (for layout).\r\n    $scope.$watch(function() {\r\n      return balanceSheetService.balanceSheet.getExchangeRates();\r\n    }, debounce(refresh, 50), true);\r\n  }\r\n\r\n  function refresh() {\r\n    vm.exchangeRates = balanceSheetService.balanceSheet.getExchangeRates();\r\n  }\r\n\r\n  function openExchangeRateDialog() {\r\n\r\n    return $mdDialog.show({\r\n      templateUrl: \"currencies/exchange-rate-dialog.html\",\r\n      controller: \"ExchangeRateDialogCtrl as vm\"\r\n    }).then(function(quotation) {\r\n      updateExchangeRate(quotation);\r\n    });\r\n\r\n  }\r\n\r\n  function updateExchangeRate(exchangeRate) {\r\n    try {\r\n      balanceSheetService.balanceSheet.addOrUpdateExchangeRate(exchangeRate);\r\n      $scope.$emit(events.BALANCE_SHEET_UPDATED);\r\n      refresh();\r\n    } catch (e) {\r\n      $log.error(e);\r\n    }\r\n  }\r\n\r\n  function removeExchangeRate(exchangeRate) {\r\n    balanceSheetService.balanceSheet.removeExchangeRate(exchangeRate);\r\n    _.remove(vm.exchangeRates, exchangeRate);\r\n    $scope.$emit(events.BALANCE_SHEET_UPDATED);\r\n    refresh();\r\n  }\r\n\r\n}\r\n\r\nfunction ExchangeRateDialogCtrl($mdDialog) {\r\n  var vm = this;\r\n\r\n  vm.ok = ok;\r\n  vm.cancel = cancel;\r\n  vm.init = init;\r\n\r\n  init();\r\n\r\n  function init() {\r\n    vm.quotation = {};\r\n  }\r\n\r\n  function ok() {\r\n    $mdDialog.hide(vm.quotation);\r\n  }\r\n\r\n  function cancel() {\r\n    $mdDialog.cancel();\r\n  }\r\n\r\n}\n},{\"angular\":\"angular\",\"lodash\":\"lodash\"}],11:[function(require,module,exports){\n\"use strict\";\r\n\r\nrequire(\"./route-config\");\r\nrequire(\"./currency-list-ctrl\");\n},{\"./currency-list-ctrl\":10,\"./route-config\":12}],12:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\n\r\nangular.module(\"debtApp\")\r\n  .config(config);\r\n\r\nfunction config($stateProvider) {\r\n\r\n  $stateProvider\r\n    .state(\"currencies\", {\r\n      url: \"/currencies\",\r\n      views: {\r\n        \"\": {\r\n          controller: \"CurrencyListCtrl as vm\",\r\n          templateUrl: \"currencies/currencies.html\"\r\n        },\r\n        \"floatingButton\": {\r\n          controller: \"CurrencyListCtrl as vm\",\r\n          templateUrl: \"currencies/floating-button.html\"\r\n        }\r\n      }\r\n    })\r\n  ;\r\n  \r\n}\n},{\"angular\":\"angular\"}],13:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\nvar _ = require(\"lodash\");\r\n\r\nangular.module(\"debtApp\")\r\n  .constant(\"balanceSheetSaveInterval\", 500)\r\n  .controller(\"DebtAppCtrl\", DebtAppCtrl);\r\n\r\nfunction DebtAppCtrl(balanceSheetService,\r\n                     debounce,\r\n                     balanceSheetSaveInterval,\r\n                     openCreatePersonDialog,\r\n                     openCreateExpenseDialog,\r\n                     fileService,\r\n                     events,\r\n                     $mdDialog,\r\n                     $state,\r\n                     $scope,\r\n                     $log) {\r\n\r\n  var vm = this;\r\n\r\n  vm.init = init;\r\n  vm.createPerson = createPerson;\r\n  vm.createExpense = createExpense;\r\n  vm.createNewSheet = createNewSheet;\r\n  vm.loadSheet = loadSheet;\r\n  vm.exportSheet = exportSheet;\r\n  vm.balanceSheetUpdated = balanceSheetUpdated;\r\n  vm.showHelp = showHelp;\r\n\r\n  var confirmCreateNewSheet = $mdDialog.confirm()\r\n    .title(\"Create new sheet\")\r\n    .content(\"The current sheet will be discarded. Please consider exporting it first. Continue?\")\r\n    .ok(\"Ok\").cancel(\"Cancel\");\r\n\r\n  init();\r\n\r\n  /////////////////////////////////////////////////////////////\r\n\r\n  function init() {\r\n    $scope.$on(events.BALANCE_SHEET_UPDATED, debounce(function() {\r\n      vm.balanceSheetUpdated();\r\n    }), balanceSheetSaveInterval, $scope, true);\r\n    $scope.$on(events.ERROR, handleErrorEvent);\r\n    balanceSheetService.init();\r\n    vm.balanceSheet = balanceSheetService.balanceSheet;\r\n    findExpensesWithInvalidCurrencies();\r\n  }\r\n\r\n  function balanceSheetUpdated() {\r\n    vm.errorMessage = undefined;\r\n    tryToSave();\r\n    findExpensesWithInvalidCurrencies();\r\n  }\r\n\r\n  function tryToSave() {\r\n    try {\r\n      balanceSheetService.save();\r\n    } catch (e) {\r\n      $log.error(e);\r\n      vm.errorMessage = \"Cannot save: \" + e.message;\r\n    }\r\n  }\r\n\r\n  function findExpensesWithInvalidCurrencies() {\r\n    var nonConvertible = vm.balanceSheet.getNonConvertibleCurrencies(vm.balanceSheet.getExpenseCurrencies(), vm.balanceSheet.currency);\r\n\r\n    if (nonConvertible.length === 0 || vm.errorMessage) {\r\n      return;\r\n    }\r\n    var messageTemplate = _.template(\"Cannot convert <%= currencyWord %> <%= currencyList %> to balance sheet's currency <%= balanceSheetCurrency %>\");\r\n\r\n    var data = {\r\n      currencyWord: nonConvertible.length == 1 ? \"currency\" : \"currencies\",\r\n      currencyList: \"\",\r\n      balanceSheetCurrency: \"'\" + vm.balanceSheet.currency + \"'\"\r\n    };\r\n\r\n    _.each(nonConvertible, function(c, index) {\r\n      data.currencyList = data.currencyList + (index > 0 ? \", \" : \"\") + \"'\" + c + \"'\";\r\n    });\r\n\r\n    vm.errorMessage = messageTemplate(data);\r\n  }\r\n\r\n  function handleErrorEvent(event, error) {\r\n    vm.errorMessage = error.message;\r\n  }\r\n\r\n  function createPerson() {\r\n    openCreatePersonDialog()\r\n      .then(function(dialogResult) {\r\n        balanceSheetService.balanceSheet.createPerson(dialogResult.person, dialogResult.options);\r\n        vm.balanceSheetUpdated();\r\n        $scope.$broadcast(events.BALANCE_SHEET_UPDATED);\r\n      });\r\n  }\r\n\r\n  function createExpense() {\r\n    openCreateExpenseDialog()\r\n      .then(function(dialogResult) {\r\n        balanceSheetService.balanceSheet.createExpense(dialogResult.expense, dialogResult.options);\r\n        vm.balanceSheetUpdated();\r\n        $scope.$broadcast(events.BALANCE_SHEET_UPDATED);\r\n      });\r\n  }\r\n\r\n  function createNewSheet() {\r\n    $mdDialog.show(confirmCreateNewSheet)\r\n      .then(function() {\r\n        balanceSheetService.createNew();\r\n        vm.balanceSheetUpdated();\r\n        $state.go(\"balanceSheet\");\r\n        $scope.$broadcast(events.BALANCE_SHEET_UPDATED);\r\n      });\r\n  }\r\n\r\n  function loadSheet(files) {\r\n    if (!files || !files.length) return;\r\n\r\n    if (!fileService.isSupported()) {\r\n      vm.errorMessage = \"File operations not supported in this browser. Please consider a more modern browser.\";\r\n      return;\r\n    }\r\n\r\n    var file = files[0];\r\n    fileService.readAsText(file)\r\n      .then(function(result) {\r\n        loadSheetFromJson(result);\r\n      })\r\n      .catch(function(e) {\r\n        $log.error(e);\r\n        vm.errorMessage = \"Unable to read file\";\r\n      });\r\n  }\r\n\r\n  function loadSheetFromJson(json) {\r\n    balanceSheetService.loadFromJson(json);\r\n    vm.balanceSheetUpdated();\r\n    $state.go(\"balanceSheet\");\r\n    $scope.$broadcast(events.BALANCE_SHEET_UPDATED);\r\n  }\r\n\r\n  function exportSheet() {\r\n    if (!fileService.isSupported()) {\r\n      vm.errorMessage = \"File operations not supported in this browser. Please consider a more modern browser.\";\r\n      return;\r\n    }\r\n\r\n    var json = balanceSheetService.exportToJson();\r\n    try {\r\n      fileService.saveAsFile([json], balanceSheetService.balanceSheet.name + \".txt\");\r\n    } catch (e) {\r\n      $log.error(e);\r\n      vm.errorMessage = \"Error when saving file\";\r\n    }\r\n  }\r\n\r\n  function showHelp() {\r\n    $mdDialog.show({\r\n      templateUrl: \"help.html\",\r\n      controller: function($scope, $mdDialog) {\r\n        $scope.close = function() {\r\n          $mdDialog.hide();\r\n        };\r\n      }\r\n    });\r\n  }\r\n}\n},{\"angular\":\"angular\",\"lodash\":\"lodash\"}],14:[function(require,module,exports){\n\"use strict\";\r\n\r\nrequire(\"./appcache-reload\");\r\n\r\nvar angular = require(\"angular\");\r\nrequire(\"angular-material\");\r\nrequire(\"angular-route\");\r\nrequire(\"angular-ui-router\");\r\nrequire(\"angular-local-storage\");\r\nrequire(\"ng-file-upload\");\r\n\r\nvar _ = require(\"lodash\");\r\n\r\nangular\r\n  .module(\"debtApp\", [\"ngMaterial\", \"ui.router\", \"LocalStorageModule\", \"ngFileUpload\"])\r\n  .constant(\"events\", {\r\n    BALANCE_SHEET_UPDATED: \"balance sheet updated\",\r\n    ERROR: \"error\"\r\n  })\r\n  .constant(\"debtCalculationInterval\", 500)\r\n  .config(configureLocalStorage)\r\n  .config(configureIcons)\r\n  .config(hrefSanitization)\r\n  .config(decorateExceptionHandler)\r\n  .run(makeStateAvailableInScope)\r\n  .run(makeMdMediaAvailableInScope)\r\n;\r\n\r\nrequire(\"./debt-app-ctrl\");\r\nrequire(\"./route-config\");\r\nrequire(\"./debts\");\r\nrequire(\"./balance-sheet\");\r\nrequire(\"./persons\");\r\nrequire(\"./expenses\");\r\nrequire(\"./utils\");\r\nrequire(\"./currencies\");\r\n\r\nvar CurrencyConversionError = require(\"./balance-sheet/currency-conversion-error\");\r\n\r\nfunction configureLocalStorage(localStorageServiceProvider) {\r\n  localStorageServiceProvider.setPrefix(\"debtApp\");\r\n}\r\n\r\nfunction configureIcons($mdIconProvider) {\r\n\r\n  var iconFiles = [\r\n    'ic_add_24px.svg',\r\n    'ic_attach_money_24px.svg',\r\n    'ic_chevron_right_24px.svg',\r\n    'ic_close_24px.svg',\r\n    'ic_delete_24px.svg',\r\n    'ic_face_24px.svg',\r\n    'ic_home_24px.svg',\r\n    'ic_more_vert_24px.svg',\r\n    'ic_shopping_basket_24px.svg',\r\n    'ic_warning_24px.svg'\r\n  ];\r\n  \r\n  var iconProps = _.map(iconFiles, function(fileName) {\r\n    var iconName = fileName.substr(0, fileName.indexOf('.'));\r\n    return {\r\n      filePath: 'resources/icons/' + fileName,\r\n      iconName: iconName\r\n    };\r\n  });\r\n\r\n  _.each(iconProps, function(prop) {\r\n    $mdIconProvider.icon(prop.iconName, prop.filePath);\r\n  });\r\n\r\n}\r\n\r\nfunction hrefSanitization($compileProvider) {\r\n  $compileProvider.aHrefSanitizationWhitelist(/^(blob||https?):/);\r\n}\r\n\r\nfunction decorateExceptionHandler($provide, events) {\r\n  $provide.decorator('$exceptionHandler', function($delegate, $log, $injector) {\r\n    return function(exception, cause) {\r\n      $delegate(exception, cause);\r\n\r\n      var $rootScope = $injector.get('$rootScope');\r\n      $rootScope.$broadcast(events.ERROR, exception, cause);\r\n\r\n      if (exception instanceof CurrencyConversionError) {\r\n        var $state = $injector.get('$state');\r\n        $state.go(\"currencies\");\r\n      }\r\n\r\n    };\r\n  });\r\n}\r\n\r\n// Injection of $state may trigger a GET, which can show as an \r\n// \"Unexpected request\" error in your test. Workaround is to \r\n// $provide a mock $state to Angular.\r\nfunction makeStateAvailableInScope($rootScope, $state, $stateParams) {\r\n  $rootScope.$state = $state;\r\n  $rootScope.$stateParams = $stateParams;\r\n}\r\n\r\nfunction makeMdMediaAvailableInScope($rootScope, $mdMedia) {\r\n  $rootScope.$mdMedia = $mdMedia;\r\n}\n},{\"./appcache-reload\":3,\"./balance-sheet\":8,\"./balance-sheet/currency-conversion-error\":7,\"./currencies\":11,\"./debt-app-ctrl\":13,\"./debts\":17,\"./expenses\":22,\"./persons\":25,\"./route-config\":28,\"./utils\":33,\"angular\":\"angular\",\"angular-local-storage\":\"angular-local-storage\",\"angular-material\":\"angular-material\",\"angular-route\":2,\"angular-ui-router\":\"angular-ui-router\",\"lodash\":\"lodash\",\"ng-file-upload\":\"ng-file-upload\"}],15:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\nvar _ = require(\"lodash\");\r\n\r\nangular\r\n  .module(\"debtApp\")\r\n    .factory(\"debtService\", debtService);\r\n\r\n\r\nfunction debtService(solveDebts) {\r\n  \r\n  return {\r\n    computeDebts: computeDebts,\r\n    organizeByDebtor: organizeByDebtor\r\n  };\r\n  \r\n  /////////////////////////////////////////\r\n\r\n  function computeDebts(participations, currency) {\r\n    if (currency !== undefined) {\r\n      participations = _.map(participations, function(p) {\r\n        return {\r\n          person: p.person,\r\n          expense: p.expense,\r\n          paid: p.getPaid(currency, {strictConversion: true}),\r\n          share: p.getShare(currency, {strictConversion: true})\r\n        };\r\n      });\r\n    }\r\n\r\n    var debts = solveDebts(participations);\r\n\r\n    if (currency !== undefined) {\r\n      debts = _.map(debts, function(debt) {\r\n        return _.extend(debt, {currency: currency});\r\n      });\r\n    }\r\n\r\n    return debts;\r\n  } \r\n  \r\n  function organizeByDebtor(debts) {\r\n    var debtorList = [];\r\n    var debtorIndices = {};\r\n    \r\n    _.each(debts, function(d) {\r\n      var debtorIndex = debtorIndices[d.debtor.id];\r\n      var debtor;\r\n      if (debtorIndex === undefined) {\r\n        debtorIndex = debtorList.length;\r\n        debtor = {debtor: d.debtor, debts: []};\r\n        debtorList.push(debtor);\r\n        debtorIndices[d.debtor.id] = debtorIndex;\r\n      }\r\n      debtor = debtorList[debtorIndex];\r\n      debtor.debts.push(_.omit(d, \"debtor\")) ;\r\n    });\r\n\r\n    _.each(debtorList, function(d) {\r\n      d.debts.sort(function(d1, d2) {\r\n        return d1.creditor.name.localeCompare(d2.creditor.name);\r\n      });\r\n    });\r\n    debtorList.sort(function(d1, d2) {\r\n      return d1.debtor.name.localeCompare(d2.debtor.name);\r\n    });\r\n    \r\n    return debtorList;\r\n  }\r\n  \r\n}\n},{\"angular\":\"angular\",\"lodash\":\"lodash\"}],16:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\nvar Decimal = require(\"simple-decimal-money\");\r\nvar Random = require(\"random-js\");\r\nvar _ = require(\"lodash\");\r\n\r\nangular\r\n  .module(\"debtApp\")\r\n    .factory(\"solveDebts\", debtSolverFactory);\r\n\r\n\r\n\r\n\r\n/**\r\n * A function that computes debts from given expense participations.\r\n *\r\n * The input is an array of Participation objects in a BalanceSheet.\r\n *\r\n * Returns an array of debts:\r\n * [{debtor: <a Person object>, creditor: <a Person object>, amount: <float; how much the debtor owes the creditor>}, ...]\r\n *\r\n * We form a linear system Ax = b. A is a binary matrix with size (d+c)*(d*c),\r\n * where d is the number of debtors and c is the number of creditors. Columns of A \r\n * are ordered so that x[c*i + j] is the value of the debt owed by debtor i to creditor j.\r\n * \r\n * Elements of b are balances - converted to non-negative - of the debtors and the creditors \r\n * with the following correspondence:\r\n * \r\n * b[0]: first debtor\r\n * ... \r\n * b[d-1]: last debtor\r\n * b[d] = first creditor\r\n * ... \r\n * b[d+c-1] = last creditor\r\n * \r\n * The coefficient matrix A is constructed so that for each person i, we have equation\r\n * where total value of debts to paid by i (if i is a debtor) or to i (if i is a creditor) equals i's \r\n * non-negative balance.\r\n * \r\n * Rows of A indexed between [0, d-1] represent the debtors in the order \r\n * of debtors> list. Rows of A indexed between [d, d+c-1] represent the \r\n * creditors in the order of creditors list.\r\n * \r\n * Ideally, we would like to find the sparsest (most 0's) solution x to Ax = b\r\n * in case the system is underdetermined and has an infinite number of solutions.\r\n * \r\n * This problem, posed as min ||x||_0  s.t. Ax = b, x >= 0, where ||x||_0 is the number\r\n * of non-zero elements, is in general an NP-hard problem. There is some amount of literature\r\n * about the problem (keywords: sparse nonnegative solution of underdetermined linear equations).\r\n * The problem is usually approximated as convex optimization problem by minimizing L1-norm (sum of \r\n * absolute value) instead. One option could be to use the cassowary javascript library.\r\n * \r\n * In this function we find a non-negative x using Gaussian elimination and setting random combinations \r\n * of free variables to zero until we find a non-negative solution.\r\n */\r\nfunction debtSolverFactory(solveLinearSystem) {\r\n  \r\n  return solve;\r\n  \r\n  \r\n  function solve(participations) {\r\n    if (!participations || participations.length === 0) {\r\n      return [];\r\n    }\r\n\r\n    var balances = computeBalances(participations);\r\n    if (isEveryoneBalanced(balances)) {\r\n      return [];\r\n    }\r\n\r\n    if (!isSystemBalanced(balances)) {\r\n      throw new Error(\"Debt system is not balanced\");\r\n    }\r\n\r\n    var roles = getDebtorsAndCreditors(balances);\r\n    var linearSystem = createDebtEquations(roles);\r\n    var debtVector = solveDebts(linearSystem);\r\n    return createDebts(debtVector, roles);\r\n  }\r\n  \r\n  function computeBalances(participations) {\r\n    var balances = {};\r\n    angular.forEach(participations, function(p) {\r\n      var b = balances[p.person.id];\r\n      if (b === undefined) {\r\n        b = {person: p.person, balance: new Decimal(0)};\r\n        balances[p.person.id] = b;\r\n      }\r\n      var paid = new Decimal(p.paid);\r\n      var share = new Decimal(p.share);\r\n      b.balance = b.balance.add(share.subtract(paid));\r\n    });\r\n\r\n    angular.forEach(balances, function(b) {\r\n      b.balance = b.balance.toNumber();\r\n    });\r\n    \r\n    return balances;\r\n  }\r\n  \r\n  function isEveryoneBalanced(balances) {\r\n    return _.every(balances, {balance: 0});\r\n  }\r\n\r\n  function isSystemBalanced(balances) {\r\n    return _.reduce(balances, function(sum, b) {\r\n        return sum.add(b.balance);\r\n    }, new Decimal(0)).toNumber() === 0;\r\n  }\r\n  \r\n  function getDebtorsAndCreditors(balances) {\r\n    var debtors = [];\r\n    var creditors = [];\r\n    \r\n    angular.forEach(balances, function(b) {\r\n      if (b.balance <= 0) {\r\n        creditors.push(b);\r\n      } else {\r\n        debtors.push(b);\r\n      }\r\n    });\r\n    \r\n    return {\r\n      debtors: debtors,\r\n      creditors: creditors\r\n    };\r\n  }\r\n  \r\n  function createDebtEquations(roles) {\r\n    var d = roles.debtors.length;\r\n    var c = roles.creditors.length;\r\n    \r\n    // Right-hand side vector, creditor balances converted to non-negative to allow binary coefficients\r\n    var b = [];\r\n    _.each(roles.debtors, function(debtor, i) {\r\n      b[i] = (new Decimal(debtor.balance)).multiply(100).toNumber();\r\n    });\r\n    _.each(roles.creditors, function(creditor, i) {\r\n      b[d + i] = (new Decimal(creditor.balance)).multiply(-100).toNumber();\r\n    });\r\n    \r\n    // Coefficient matrix\r\n    var A = initMatrix(d + c, d*c); \r\n    \r\n    // Coefficients of equations \"sum of debts paid by debtor = debtor's balance\"\r\n    for (var i = 0; i < d; i++) {\r\n      for (var j = i*c; j < (i+1)*c; j++) {\r\n        A[i][j] = 1;\r\n      }\r\n    }\r\n    \r\n    // Coefficients of equations \"sum debts received by creditor = creditor's balance\"\r\n    for (var i = d; i < c+d; ++i) {\r\n      for (var j = (i-d); j < d*c; j += c) {\r\n        A[i][j] = 1;\r\n      }\r\n    } \r\n    \r\n    return {\r\n      A: A,\r\n      b: b\r\n    };\r\n  }\r\n  \r\n  function initMatrix(rows, cols) {\r\n    var A = [];\r\n    for (var i = 0; i < rows; i++) {\r\n      A[i] = [];\r\n      for (var j = 0; j < cols; j++) {\r\n        A[i][j] = 0;\r\n      }\r\n    }\r\n    return A;\r\n  }\r\n  \r\n  // Solve debts, ensuring a non-negative solution \r\n  function solveDebts(linearSystem) {\r\n    var solution = solveLinearSystem(linearSystem);\r\n    if (solution.numberOfSolutions === 0) {\r\n      throw new Error(\"Debt system has no solutions\");\r\n    }\r\n\r\n\r\n    var numVars = solution.numberOfVariables;\r\n    var numFreeVars = solution.numberOfFreeVariables;\r\n    \r\n    if (numFreeVars === 0) {\r\n      return solution.xVector;\r\n    }\r\n\r\n    // Known seed so we always get the same result from\r\n    // the same system.\r\n    var randomEngine = Random.engines.mt19937();\r\n    randomEngine.seed(20150312);\r\n\r\n    var toEliminate;\r\n    do {\r\n      \r\n      var A = angular.copy(linearSystem.A);\r\n      var b = linearSystem.b;\r\n      \r\n      // Pick random numFreeVars variables for elimination\r\n      \r\n      var candidates = [];\r\n      for (var i = 0; i < numVars; i++) {\r\n        candidates[i] = i;\r\n      }\r\n      \r\n      toEliminate = [];\r\n      for (var i = 0; i < numFreeVars; i++) {\r\n        var candidateIdx = Random.integer(0, candidates.length-1)(randomEngine);\r\n        toEliminate.push(candidates[candidateIdx]);\r\n        candidates.splice(candidateIdx, 1);\r\n      }\r\n      \r\n      // Eliminate the chosen variables by setting their coefficients to zero\r\n      \r\n      for (var i = 0; i < A.length; i++) {\r\n        for (var j = 0; j < toEliminate.length; j++) {\r\n          A[i][toEliminate[j]] = 0;\r\n        }\r\n      }\r\n\r\n      // Solve the updated system\r\n      \r\n      solution = solveLinearSystem({A: A, b: b});\r\n      \r\n    } while (!isNonNegative(solution.xVector));\r\n\r\n    \r\n    return solution.xVector;\r\n  }\r\n  \r\n  function isNonNegative(vector) {\r\n    if (!vector) {\r\n      return false;\r\n    }\r\n    for (var i = 0; i < vector.length; i++) {\r\n      if (vector[i] < 0) {\r\n        return false;\r\n      }\r\n    }\r\n    return true;\r\n  }\r\n  \r\n  function createDebts(debtVector, roles) {\r\n    var debts = [];\r\n\r\n    for (var i = 0; i < debtVector.length; i++) {\r\n      if (debtVector[i] !== 0) {\r\n        var debtorIdx = Math.floor(i/roles.creditors.length);\r\n        var creditorIdx = i - roles.creditors.length*debtorIdx;\r\n        var amount = (new Decimal(debtVector[i])).divideBy(100).toNumber();\r\n        var debt = {debtor: roles.debtors[debtorIdx].person, creditor: roles.creditors[creditorIdx].person, amount: amount};\r\n        debts.push(debt);\r\n      }\r\n    }\r\n    \r\n    return debts;\r\n  }\r\n}  \n},{\"angular\":\"angular\",\"lodash\":\"lodash\",\"random-js\":\"random-js\",\"simple-decimal-money\":\"simple-decimal-money\"}],17:[function(require,module,exports){\n\"use strict\";\r\n\r\nrequire(\"./lin-eq-solver\");\r\nrequire(\"./lin-eq-solver-factory\");\r\nrequire(\"./debt-solver\");\r\nrequire(\"./debt-service\");\n},{\"./debt-service\":15,\"./debt-solver\":16,\"./lin-eq-solver\":19,\"./lin-eq-solver-factory\":18}],18:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar solve = require(\"./lin-eq-solver\");\r\nvar angular = require(\"angular\");\r\n\r\nangular.module(\"debtApp\")\r\n.factory(\"solveLinearSystem\", solveLinearSystem);\r\n\r\nfunction solveLinearSystem() {\r\n  return solve;\r\n}\n},{\"./lin-eq-solver\":19,\"angular\":\"angular\"}],19:[function(require,module,exports){\n\"use strict\";\r\n\r\n\r\nfunction solve(input) {\r\n\t// Internal copies of the linear system and its dimensions\r\n\tvar coefMatrix, constVector, xVector;\r\n\tvar m, n, rank, numberOfSolutions;\r\n\t\r\n\t// With these we can \"virtually\" rearrange the rows and columns\r\n\t// for better numerical stability in the variable elimination phases.\r\n\t// At step i, row index pivotToEquationMap[i] is the pivot equation and\r\n\t// it is used for eliminating variable index pivotToVariableMap[i] from all the\r\n\t// other equations.\r\n\tvar pivotToEquationMap, pivotToVariableMap, equationScale;\r\n\t\r\n\tvalidate();\r\n\tinitialize();\r\n\ttransformToRowEchelonForm();\r\n\treduceRowEchelonForm();\r\n\tdetermineRank();\r\n\tdetermineNumberOfSolutions();\r\n\tdetermineSolution();\r\n\r\n\treturn {\r\n\t\txVector: xVector,\r\n\t\tnumberOfEquations: m,\r\n\t\tnumberOfVariables: n,\r\n\t\trank: rank,\r\n\t\tnumberOfFreeVariables: n - rank,\r\n\t\tnumberOfSolutions: numberOfSolutions\r\n\t};\r\n\t\r\n\t/////////////////////////////////////////////////////////////\r\n\t\r\n\tfunction validate() {\r\n    \tif (!input || !input.A || !input.b) {\r\n    \t\tthrow new TypeError(\"Null matrix A or vector b in system Ax = b\");\r\n    \t}\r\n    \t\r\n    \tif (input.A.length < 1 || input.A[0].length < 1) {\r\n    \t\tthrow new TypeError(\"Matrix A in Ax = b has no rows or no columns\");\r\n    \t}\r\n\t\t\r\n    \tif (input.A.length != input.b.length) {\r\n    \t\tthrow new RangeError(\"The dimensions of the matrix and the constant vector are incompatible\");\r\n    \t}\r\n\t}\r\n\r\n\tfunction initialize() {\r\n\t\tcoefMatrix = copyMatrix(input.A);\r\n\t\tconstVector = copyArray(input.b);\r\n\t\t\r\n\t\tm = coefMatrix.length;\r\n\t\tn = coefMatrix[0].length;\r\n\r\n\t\tpivotToEquationMap = [];\r\n\t\tfor (var i = 0; i < m; i++) {\r\n\t\t\tpivotToEquationMap[i] = i;\r\n\t\t}\r\n\t\t\r\n\t\tequationScale = [];\r\n\t\tfor (var i = 0; i < m; i++) {\r\n\t\t\tequationScale[i] = 0;\r\n\t\t\tfor (var j = 0; j < n; j++) {\r\n\t\t\t\tvar abscoef = Math.abs(coefMatrix[i][j]);\r\n\t\t\t\tif (abscoef > equationScale[i]) {\r\n\t\t\t\t\tequationScale[i] = abscoef;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tpivotToVariableMap = [];\r\n\t\tfor (var j = 0; j < n; j++) {\r\n\t\t\tpivotToVariableMap[j] = j;\r\n\t\t}\r\n\t}\r\n\r\n\tfunction transformToRowEchelonForm() {\r\n\t\tvar pivotIdx = 0; \r\n\t\tvar knownFreeVariables = [];\r\n\t\t\r\n\t\twhile (pivotIdx < m-1) { \r\n\r\n\t\t\t// Choose the best pivot-equation for eliminating variable pivotToVariableMap[pivotIdx] \r\n\t\t\t// from equations equations not yet used as pivot equations.\r\n\t\t\tvar maxRatio = 0;\r\n\t\t\tvar bestPivotEquationIndex = pivotIdx;\r\n\t\t\tfor (var i = pivotIdx; i < m; ++i) {\r\n\t\t\t\tvar rowIdx = pivotToEquationMap[i];\r\n\t\t\t\tvar colIdx = pivotToVariableMap[pivotIdx];\r\n\t\t\t\tvar ratio = Math.abs(coefMatrix[rowIdx][colIdx]/equationScale[rowIdx]);\r\n\t\r\n\t\t\t\tif (ratio > maxRatio) {\r\n\t\t\t\t\tmaxRatio = ratio;\r\n\t\t\t\t\tbestPivotEquationIndex = i;\t\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t// If maxRatio == 0, the coefficient of variable pivotToVariableMap[pivotIdx] is 0 in all the rest of the equations. \r\n\t\t\t// That is pivotToVariableMap[pivotIdx] is a free variable. Find the next suitable variable.\r\n\t\t\tif (maxRatio === 0) {\r\n\t\t\t\tvar currPivotVaribleIdx = pivotToVariableMap[pivotIdx];\r\n\t\t\t\tknownFreeVariables[currPivotVaribleIdx] = true;     \r\n\t\t\t\t\r\n\t\t\t\t// The next one must not be a free variable.\r\n\t\t\t\tvar i = pivotIdx;\r\n\t\t\t\tvar newPivotVariableIdx = currPivotVaribleIdx;\r\n\t\t\t\twhile (newPivotVariableIdx == currPivotVaribleIdx && i < n-1) {\r\n\t\t\t\t\t++i;\r\n\t\t\t\t\tif (!knownFreeVariables[pivotToVariableMap[i]]) {\r\n\t\t\t\t\t\tnewPivotVariableIdx = pivotToVariableMap[i];\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (newPivotVariableIdx != currPivotVaribleIdx) {\r\n\t\t\t\t\tpivotToVariableMap[pivotIdx] = newPivotVariableIdx;\r\n\t\t\t\t\tpivotToVariableMap[i] = currPivotVaribleIdx;\r\n\t\t\t\t\tcontinue;\r\n\t\t\t\t} else { \r\n\t\t\t\t\t// Could not find a suitable variable. This means the row echelon form is ready.\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\r\n\t\t\tvar temp = pivotToEquationMap[pivotIdx];\r\n\t\t\tpivotToEquationMap[pivotIdx] = pivotToEquationMap[bestPivotEquationIndex];\r\n\t\t\tpivotToEquationMap[bestPivotEquationIndex] = temp;     \r\n\t\t\t\r\n\t\t\t// Elimination phase\r\n\t\t\tvar pivotRowIdx = pivotToEquationMap[pivotIdx];\r\n\t\t\tvar pivotColIdx = pivotToVariableMap[pivotIdx];\r\n\t\t\tfor (i = pivotIdx + 1; i < m; ++i) {\r\n\t\t\t\tvar rowIdx = pivotToEquationMap[i];\r\n\t\t\t\tvar mult = coefMatrix[rowIdx][pivotColIdx] / coefMatrix[pivotRowIdx][pivotColIdx];\r\n\r\n\t\t\t\tfor (var j = pivotIdx + 1; j < n; ++j) {\r\n\t\t\t\t\tvar colIndex = pivotToVariableMap[j];\r\n\t\t\t\t\tcoefMatrix[rowIdx][colIndex] = coefMatrix[rowIdx][colIndex] - mult * coefMatrix[pivotRowIdx][colIndex];\r\n\t\t\t\t}\r\n\r\n\t\t\t\tcoefMatrix[rowIdx][pivotColIdx] = 0;\r\n\t\t\t\tconstVector[rowIdx] = constVector[rowIdx] - mult * constVector[pivotRowIdx];\r\n\t\t\t}\r\n\r\n\t\t\tpivotIdx++;\r\n\t\t\t\r\n\t\t}\r\n\t}\r\n\r\n\tfunction reduceRowEchelonForm() {\r\n\t\t// Eliminate pivot variables from previous pivot equations by going through the pivot steps in reverse order.\r\n\t\tvar pivotIndex;\r\n\t\tfor (pivotIndex = Math.min(m, n) - 1; pivotIndex > 0; --pivotIndex) {\r\n\t\t\tvar pivotRowIdx = pivotToEquationMap[pivotIndex];\r\n\t\t\tvar pivotColIdx = pivotToVariableMap[pivotIndex];\r\n\t\t\t\r\n\t\t\tif (coefMatrix[pivotRowIdx][pivotColIdx] === 0) {\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tfor (var i = pivotIndex - 1; i > -1; --i) {\r\n\t\t\t\t\r\n\t\t\t\tvar mult = coefMatrix[pivotToEquationMap[i]][pivotToVariableMap[pivotIndex]]/coefMatrix[pivotToEquationMap[pivotIndex]][pivotToVariableMap[pivotIndex]];\r\n\t\t\t\tfor (var j = 0; j < n; ++j) {\r\n\t\t\t\t\tcoefMatrix[pivotToEquationMap[i]][pivotToVariableMap[j]] -= mult*coefMatrix[pivotToEquationMap[pivotIndex]][pivotToVariableMap[j]];\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tconstVector[pivotToEquationMap[i]] -= mult*constVector[pivotToEquationMap[pivotIndex]];\r\n\t\t\t}            \t\t\r\n\t\t}\r\n\t\t\r\n\t\t// Normalize the coeffients in each row and the rhs value by the coeffient of the pivot variable in the row\r\n\t\tfor (pivotIndex = 0; pivotIndex < Math.min(m, n); ++pivotIndex) {\r\n\t\t\t\r\n\t\t\tif (coefMatrix[pivotToEquationMap[pivotIndex]][pivotToVariableMap[pivotIndex]] === 0) {\r\n\t\t\t\tcontinue; \r\n\t\t\t}\r\n\r\n\t\t\tvar div = coefMatrix[pivotToEquationMap[pivotIndex]][pivotToVariableMap[pivotIndex]];\r\n\t\t\tfor (var j = 0; j < n; ++j) {\r\n\t\t\t\tcoefMatrix[pivotToEquationMap[pivotIndex]][j] = coefMatrix[pivotToEquationMap[pivotIndex]][j]/div;\r\n\t\t\t}\r\n\t\t\tconstVector[pivotToEquationMap[pivotIndex]] = constVector[pivotToEquationMap[pivotIndex]]/div;\r\n\t\t}\r\n\t\t\r\n\t}\r\n\r\n\tfunction determineRank() {\r\n\t\trank = 0;\r\n\t\tvar i,j;\r\n\t\t\r\n\t\tcolumns: \r\n\t\tfor (j=0; j<n; ++j) {\r\n\t\t\trows:\r\n\t\t\tfor (i=0; i<m; ++i) { \r\n\t\t\t\tif (i != j && coefMatrix[pivotToEquationMap[i]][pivotToVariableMap[j]] !== 0) {\r\n\t\t\t\t\tbreak columns;\r\n\t\t\t\t}\r\n\t\t\t\telse if (i == j && coefMatrix[pivotToEquationMap[i]][pivotToVariableMap[j]] != 1) {\r\n\t\t\t\t\tbreak columns;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t++rank;\r\n\t\t}\r\n\t}\r\n\r\n\tfunction determineNumberOfSolutions() {\r\n\t\t\r\n\t\tvar b2IsZero = true;\r\n\r\n\t\tfor (var i = rank; i < m; ++i) {\r\n\t\t\tif (constVector[pivotToEquationMap[i]] !== 0) {\r\n\t\t\t\tb2IsZero = false;\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tif (rank < m && !b2IsZero) {\r\n\t\t\tnumberOfSolutions = 0;\r\n\t\t} else if (rank == n && (rank == m || b2IsZero)) {\r\n\t\t\tnumberOfSolutions = 1;\r\n\t\t} else if (rank < n && (rank == m || b2IsZero)) {\r\n\t\t\tnumberOfSolutions = Number.MAX_VALUE;\r\n\t\t}\r\n\t}\r\n\r\n\tfunction determineSolution() {\r\n\t\tif (numberOfSolutions === 0) {\r\n\t\t\txVector = undefined;\r\n\t\t} else {\r\n\t\t\txVector = initArray(n);\r\n\t\t\tfor (var i = 0; i < rank; ++i) {\r\n\t\t\t\txVector[pivotToVariableMap[i]] = constVector[pivotToEquationMap[i]];\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction initArray(size) {\r\n\t\tvar array = [];\r\n\t\tfor (var i = 0; i < size; i++) {\r\n\t\t\tarray[i] = 0;\r\n\t\t}\r\n\t\treturn array;\r\n\t}\r\n\t\r\nfunction copyArray(input) {\r\n\treturn input.slice();\r\n}\r\n\r\nfunction copyMatrix(input) {\r\n\tvar copy = [];\r\n\tfor (var i = 0; i < input.length; i++) {\r\n\t\tcopy[i] = input[i].slice();\r\n\t}\r\n\treturn copy;\r\n}\r\n\t\r\n\r\nmodule.exports = solve;\n},{}],20:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\n\r\nangular.module(\"debtApp\")\r\n.factory(\"openCreateExpenseDialog\", openCreateExpenseDialog);\r\n\r\n\r\nfunction openCreateExpenseDialog($mdDialog) {\r\n  \r\n  return open;\r\n  \r\n  function open() {\r\n    return $mdDialog.show({\r\n      templateUrl: \"expenses/create-expense-dialog.html\",\r\n      controller: DialogController,\r\n      controllerAs: \"vm\"\r\n    });\r\n  }\r\n  \r\n}\r\n\r\nfunction DialogController($mdDialog) {\r\n  var vm = this;\r\n  \r\n  vm.ok = ok;\r\n  vm.cancel = cancel;\r\n  vm.init = init;\r\n  \r\n  init();\r\n  \r\n  \r\n  function init() {\r\n    vm.expense = {\r\n      name: undefined,\r\n      sharing: \"equal\"\r\n    };\r\n    vm.options = {\r\n      createParticipations: true\r\n    };\r\n  }\r\n\r\n  function ok() {\r\n    $mdDialog.hide({expense: vm.expense, options: vm.options});\r\n  }\r\n  \r\n  function cancel() {\r\n    $mdDialog.cancel();\r\n  }\r\n}\n},{\"angular\":\"angular\"}],21:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar _ = require('lodash');\r\nvar angular = require(\"angular\");\r\n\r\nangular\r\n  .module(\"debtApp\")\r\n  .controller(\"ExpenseDetailCtrl\", ExpenseDetailCtrl);\r\n\r\nfunction ExpenseDetailCtrl(balanceSheetService,\r\n                           debtService,\r\n                           events,\r\n                           debounce,\r\n                           debtCalculationInterval,\r\n                           $mdDialog,\r\n                           $stateParams,\r\n                           $state,\r\n                           $scope,\r\n                           $timeout)\r\n{\r\n  var vm = this;\r\n\r\n  var confirmRemoveExpense = $mdDialog.confirm()\r\n    .content(\"Really delete this expense?\")\r\n    .ok(\"Ok\").cancel(\"Cancel\");\r\n\r\n  var computeDebtsDebounced = debounce(function() {\r\n    $timeout(function() {\r\n      vm.debtsByDebtor = computeDebts();\r\n    });\r\n  }, debtCalculationInterval);\r\n\r\n  vm.init = init;\r\n  vm.setParticipation = setParticipation;\r\n  vm.updateExpense = updateExpense;\r\n  vm.removeExpense = removeExpense;\r\n  vm.setCurrency = setCurrency;\r\n\r\n  init();\r\n\r\n  /////////////////////////////////////////////////////////////\r\n\r\n  function init() {\r\n    vm.balanceSheet = balanceSheetService.balanceSheet;\r\n    vm.expense = vm.balanceSheet.getExpense($stateParams.id);\r\n    vm.isParticipant = {};\r\n    vm.everyoneParticipates = true;\r\n    updateExpense();\r\n\r\n    $scope.$on(events.BALANCE_SHEET_UPDATED, function(event) {\r\n      if (event.targetScope != $scope) {\r\n        vm.updateExpense();\r\n      }\r\n    });\r\n  }\r\n\r\n  function updateExpense() {\r\n    vm.expense.shareCost();\r\n    vm.isParticipant = getParticipationMap();\r\n    vm.cost = vm.expense.getCost();\r\n    vm.sumOfShares = vm.expense.getSumOfShares();\r\n    vm.isBalanced = vm.expense.isBalanced();\r\n    $scope.$emit(events.BALANCE_SHEET_UPDATED);\r\n    computeDebtsDebounced();\r\n  }\r\n\r\n  function getParticipationMap() {\r\n    var map = {};\r\n\r\n    angular.forEach(vm.balanceSheet.persons, function(person) {\r\n      map[person.id] = false;\r\n      angular.forEach(vm.expense.getParticipations(), function(p) {\r\n        if (p.person.equals(person)) {\r\n          map[person.id] = true;\r\n        }\r\n      });\r\n    });\r\n\r\n    return map;\r\n  }\r\n\r\n  function setParticipation(person, isParticipant) {\r\n    if (isParticipant) {\r\n      vm.balanceSheet.createParticipation({expense: vm.expense, person: person});\r\n    } else {\r\n      vm.balanceSheet.removeParticipation({expense: vm.expense, person: person});\r\n    }\r\n    updateExpense();\r\n  }\r\n\r\n  function removeExpense() {\r\n    $mdDialog.show(confirmRemoveExpense)\r\n      .then(doRemoveExpense);\r\n  }\r\n\r\n  function doRemoveExpense() {\r\n    vm.balanceSheet.removeExpense(vm.expense);\r\n    $scope.$emit(events.BALANCE_SHEET_UPDATED);\r\n    $state.go(\"balanceSheet\");\r\n  }\r\n\r\n  function computeDebts() {\r\n    if (vm.expense.isBalanced()) {\r\n      var debts = debtService.computeDebts(vm.expense.getParticipations(), vm.expense.computedCurrency());\r\n      return debtService.organizeByDebtor(debts);\r\n    }\r\n  }\r\n\r\n  function setCurrency(currency) {\r\n    vm.expense.currency = currency;\r\n    $scope.$emit(events.BALANCE_SHEET_UPDATED);\r\n  }\r\n\r\n\r\n}\r\n\n},{\"angular\":\"angular\",\"lodash\":\"lodash\"}],22:[function(require,module,exports){\n\"use strict\";\r\n\r\nrequire(\"./route-config\");\r\nrequire(\"./expense-detail-ctrl\");\r\nrequire(\"./create-expense-dialog\");\n},{\"./create-expense-dialog\":20,\"./expense-detail-ctrl\":21,\"./route-config\":23}],23:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\n\r\nangular.module(\"debtApp\")\r\n\t.config(config);\r\n\r\nfunction config($stateProvider) {\r\n\r\n\t$stateProvider\r\n\t\t.state(\"expense\", {\r\n\t\t\turl: \"/expenses/:id\",\r\n\t\t\tviews: {\r\n\t\t\t\t\"\": {\r\n\t\t\t\t\ttemplateUrl: \"expenses/expense-detail.html\",\r\n\t\t\t\t\tcontroller: \"ExpenseDetailCtrl as vm\"\r\n\t\t\t\t},\r\n\t\t\t\t\"floatingButton\": {\r\n\t\t\t\t\ttemplateUrl: \"expenses/floating-button.html\"\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t})\r\n\t\t;\r\n}\n},{\"angular\":\"angular\"}],24:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\n\r\nangular.module(\"debtApp\")\r\n.factory(\"openCreatePersonDialog\", openCreatePersonDialog);\r\n\r\n\r\nfunction openCreatePersonDialog($mdDialog) {\r\n  \r\n  return open;\r\n  \r\n  function open() {\r\n    return $mdDialog.show({\r\n      templateUrl: \"persons/create-person-dialog.html\",\r\n      controller: DialogController,\r\n      controllerAs: \"vm\"\r\n    });\r\n  }\r\n  \r\n}\r\n\r\nfunction DialogController($mdDialog) {\r\n  var vm = this;\r\n  \r\n  vm.ok = ok;\r\n  vm.cancel = cancel;\r\n  vm.init = init;\r\n  \r\n  init();\r\n  \r\n  \r\n  function init() {\r\n    vm.person = {\r\n      name: undefined\r\n    };\r\n    vm.options = {\r\n      createParticipations: true\r\n    };\r\n  }\r\n\r\n  function ok() {\r\n    $mdDialog.hide({person: vm.person, options: vm.options});\r\n  }\r\n  \r\n  function cancel() {\r\n    $mdDialog.cancel();\r\n  }\r\n}\n},{\"angular\":\"angular\"}],25:[function(require,module,exports){\n\"use strict\";\r\n\r\nrequire(\"./route-config\");\r\nrequire(\"./person-detail-ctrl\");\r\nrequire(\"./create-person-dialog\");\n},{\"./create-person-dialog\":24,\"./person-detail-ctrl\":26,\"./route-config\":27}],26:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\nvar _ = require('lodash');\r\n\r\nangular.module(\"debtApp\")\r\n  .controller(\"PersonDetailCtrl\", PersonDetailCtrl);\r\n\r\nfunction PersonDetailCtrl(balanceSheetService,\r\n                          debtService,\r\n                          events,\r\n                          debounce,\r\n                          debtCalculationInterval,\r\n                          $state,\r\n                          $stateParams,\r\n                          $mdDialog,\r\n                          $scope,\r\n                          $timeout,\r\n                          $log) {\r\n\r\n  var vm = this;\r\n  var confirmRemovePerson;\r\n\r\n  var computeDebtsDebounced = debounce(function() {\r\n    $timeout(function() {\r\n      try {\r\n        var debtResult = computeDebts();\r\n        vm.debtRole = debtResult.role;\r\n        vm.debts = debtResult.debts;\r\n        vm.debtComputationError = undefined;\r\n      } catch (e) {\r\n        $log.error(e);\r\n        vm.debtRole = undefined;\r\n        vm.debts = undefined;\r\n        vm.debtComputationError = \"Cannot compute debts\";\r\n      }\r\n    });\r\n  }, debtCalculationInterval);\r\n\r\n  vm.init = init;\r\n  vm.refresh = refresh;\r\n  vm.updateExpense = updateExpense;\r\n  vm.setParticipation = setParticipation;\r\n  vm.removePerson = removePerson;\r\n  vm.updatePerson = updatePerson;\r\n\r\n  init();\r\n\r\n  function init() {\r\n    vm.balanceSheet = balanceSheetService.balanceSheet;\r\n    vm.person = vm.balanceSheet.getPerson($stateParams.id);\r\n\r\n    refresh();\r\n\r\n    confirmRemovePerson = $mdDialog.confirm()\r\n      .content(\"Really delete this person?\")\r\n      .ok(\"Ok\").cancel(\"Cancel\");\r\n\r\n    $scope.$on(events.BALANCE_SHEET_UPDATED, vm.refresh);\r\n  }\r\n\r\n  function refresh() {\r\n    vm.isParticipant = getParticipationMap();\r\n    vm.cost = vm.person.getCost();\r\n    vm.sumOfShares = vm.person.getSumOfShares();\r\n    vm.balance = vm.person.getBalance();\r\n    computeDebtsDebounced();\r\n  }\r\n\r\n  function getParticipationMap() {\r\n    var map = {};\r\n\r\n    _.forEach(vm.balanceSheet.expenses, function(expense) {\r\n      map[expense.id] = false;\r\n      _.forEach(vm.person.getParticipations(), function(pt) {\r\n        if (pt.expense.equals(expense)) {\r\n          map[expense.id] = true;\r\n        }\r\n      });\r\n    });\r\n\r\n    return map;\r\n  }\r\n\r\n  function updateExpense(expense) {\r\n    expense.shareCost();\r\n    refresh();\r\n    $scope.$emit(events.BALANCE_SHEET_UPDATED);\r\n  }\r\n\r\n  function setParticipation(expense, isParticipant) {\r\n    if (isParticipant) {\r\n      vm.balanceSheet.createParticipation({expense: expense, person: vm.person});\r\n    } else {\r\n      vm.balanceSheet.removeParticipation({expense: expense, person: vm.person});\r\n    }\r\n    vm.updateExpense(expense);\r\n  }\r\n\r\n  function computeDebts() {\r\n    var result = {\r\n      role: undefined,\r\n      debts: undefined\r\n    };\r\n\r\n    if (!vm.balanceSheet.isBalanced()) {\r\n      result.role = \"unbalanced\";\r\n      return result;\r\n    }\r\n\r\n    if (vm.balance > 0) {\r\n      result.role = \"debtor\";\r\n    } else if (vm.balance < 0) {\r\n      result.role = \"creditor\";\r\n    } else if (vm.balance === 0) {\r\n      result.role = \"settled\";\r\n      return result;\r\n    }\r\n\r\n    var counterRole = {\r\n      \"debtor\": \"creditor\",\r\n      \"creditor\": \"debtor\"\r\n    };\r\n\r\n    var debts = debtService.computeDebts(vm.balanceSheet.getNonSettledParticipations(), vm.person.computedCurrency());\r\n    result.debts = _.chain(debts)\r\n      .filter(function(d) {\r\n        return d[result.role].equals(vm.person);\r\n      })\r\n      .map(function(d) {\r\n        return {person: d[counterRole[result.role]], amount: d.amount, currency: d.currency};\r\n      })\r\n      .value();\r\n\r\n    return result;\r\n  }\r\n\r\n  function removePerson() {\r\n    $mdDialog.show(confirmRemovePerson)\r\n      .then(doRemovePerson);\r\n  }\r\n\r\n  function doRemovePerson() {\r\n    vm.balanceSheet.removePerson(vm.person);\r\n    $scope.$emit(events.BALANCE_SHEET_UPDATED);\r\n    $state.go(\"balanceSheet\");\r\n  }\r\n\r\n  function updatePerson() {\r\n    $scope.$emit(events.BALANCE_SHEET_UPDATED);\r\n  }\r\n}\r\n\n},{\"angular\":\"angular\",\"lodash\":\"lodash\"}],27:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\n\r\nangular.module(\"debtApp\")\r\n  .config(config);\r\n\r\nfunction config($stateProvider) {\r\n  $stateProvider\r\n    .state(\"person\", {\r\n      url: \"/persons/:id\",\r\n      views: {\r\n        \"\": {\r\n          templateUrl: \"persons/person-detail.html\",\r\n          controller: \"PersonDetailCtrl as vm\"\r\n        },\r\n        \"floatingButton\": {\r\n          templateUrl: \"persons/floating-button.html\"\r\n        }\r\n      }\r\n\r\n    });\r\n}\n},{\"angular\":\"angular\"}],28:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\n\r\nangular.module(\"debtApp\")\r\n\t.config(config);\r\n\r\nfunction config($urlRouterProvider) {\r\n  \r\n  $urlRouterProvider.otherwise(\"/\");\r\n  \r\n}\n},{\"angular\":\"angular\"}],29:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\nvar _ = require('lodash');\r\n\r\nangular.module(\"debtApp\")\r\n  .filter(\"balance\", balance);\r\n\r\n\r\nfunction balance($filter) {\r\n  return function balance(value) {\r\n    if (!_.isNumber(value) || isNaN(value)) {\r\n      return value;\r\n    }\r\n\r\n    if (value > 0) {\r\n      return \"+\" + $filter(\"number\")(value, \"2\");\r\n    } else {\r\n      return $filter(\"number\")(value, \"2\");\r\n    }\r\n  };\r\n}\n},{\"angular\":\"angular\",\"lodash\":\"lodash\"}],30:[function(require,module,exports){\n\"use strict\";\r\n\r\nangular.module(\"debtApp\")\r\n  .factory(\"debounce\", debounceFactory);\r\n\r\n\r\nfunction debounceFactory($timeout) {\r\n\r\n  return debounce;\r\n\r\n  /**\r\n   * Returns a function, that, as long as it continues to be invoked, will not be triggered.\r\n   * The function will be called after it stops being called for N milliseconds.\r\n   *\r\n   * @param {function} func - The function to \"debouncify\"\r\n   * @param {number} [wait=10] - The time to wait (milliseconds) after the last call until func is called\r\n   * @param {Scope} [scope] - Angular scope to call the function in\r\n   * @param {boolean} [invokeApply=false] - Should the function call trigger $digest\r\n   * @returns {function} - The debounced function\r\n   */\r\n  function debounce(func, wait, scope, invokeApply) {\r\n    var timer;\r\n\r\n    return function debounced() {\r\n      var context = scope,\r\n        args = Array.prototype.slice.call(arguments);\r\n\r\n      $timeout.cancel(timer);\r\n      timer = $timeout(function() {\r\n\r\n        timer = undefined;\r\n        func.apply(context, args);\r\n\r\n      }, wait || 10, invokeApply);\r\n    };\r\n  }\r\n\r\n}\r\n\r\n\r\n\n},{}],31:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\nvar fileSaver = require(\"node-safe-filesaver\");\r\nrequire(\"blob-polyfill\");\r\n\r\nangular.module(\"debtApp\")\r\n  .factory(\"fileService\", fileService);\r\n\r\n\r\nfunction fileService($q, $window) {\r\n\r\n  return {\r\n    readAsText: readAsText,\r\n    saveAsFile: saveAsFile,\r\n    isSupported: isSupported\r\n  };\r\n\r\n  function readAsText(blob) {\r\n    var deferred = $q.defer();\r\n\r\n    var reader = new $window.FileReader();\r\n    reader.onload = function() {\r\n      deferred.resolve(reader.result);\r\n    };\r\n    reader.onerror = function() {\r\n      deferred.resolve(reader.error);\r\n    };\r\n    reader.readAsText(blob);\r\n\r\n    return deferred.promise;\r\n  }\r\n\r\n  function saveAsFile(dataArray, fileName) {\r\n    var blob = new $window.Blob(dataArray, {});\r\n    fileSaver.saveAs(blob, fileName);\r\n  }\r\n\r\n  function isSupported() {\r\n    return $window.FileReader && $window.Blob;\r\n  }\r\n}\n},{\"angular\":\"angular\",\"blob-polyfill\":\"blob-polyfill\",\"node-safe-filesaver\":\"node-safe-filesaver\"}],32:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\n\r\nangular.module(\"debtApp\")\r\n  .directive(\"focus\", focus);\r\n\r\n\r\nfunction focus($timeout) {\r\n  return {\r\n    restrict: \"A\",\r\n    link: function($scope, iElem, iAttrs) {\r\n      var focusExpr = iAttrs.focus || 'true';\r\n      $timeout(function() {\r\n        var shouldFocus = $scope.$eval(focusExpr);\r\n        if (shouldFocus) {\r\n          iElem[0].focus();\r\n        }\r\n      }, 0);\r\n    }\r\n  };\r\n}\n},{\"angular\":\"angular\"}],33:[function(require,module,exports){\n\"use strict\";\r\n\r\nrequire(\"./money-input-directive\");\r\nrequire(\"./balance-filter\");\r\nrequire(\"./money-filter\");\r\nrequire(\"./file-service\");\r\nrequire(\"./focus-directive\");\n},{\"./balance-filter\":29,\"./file-service\":31,\"./focus-directive\":32,\"./money-filter\":34,\"./money-input-directive\":35}],34:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\nvar _ = require('lodash');\r\n\r\n\r\nangular.module(\"debtApp\")\r\n  .filter(\"money\", money);\r\n\r\n\r\nfunction money($filter) {\r\n  return function money(value) {\r\n    if (!_.isNumber(value) || isNaN(value)) {\r\n      return value;\r\n    }\r\n\r\n    return $filter(\"number\")(value, \"2\");\r\n  };\r\n}\n},{\"angular\":\"angular\",\"lodash\":\"lodash\"}],35:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\nvar Decimal = require(\"simple-decimal-money\");\r\n\r\nangular.module(\"debtApp\")\r\n  .directive(\"moneyInput\", moneyInput);\r\n\r\n\r\nfunction moneyInput($filter) {\r\n  return {\r\n    restrict: \"A\",\r\n    require: \"ngModel\",\r\n    link: link\r\n  };\r\n\r\n  function link($scope, iElem, iAttrs, ngModel) {\r\n    ngModel.$validators.money = validateMoney;\r\n    ngModel.$parsers.push(parseMoney);\r\n    ngModel.$formatters.unshift(formatMoney);\r\n\r\n    iElem.on(\"blur\", handleBlur);\r\n    ngModel.$render = render;\r\n\r\n    function render() {\r\n      if (ngModel.$valid) {\r\n        iElem.val(formatMoney(ngModel.$modelValue));\r\n      } else {\r\n        iElem.val(ngModel.$viewValue);\r\n      }\r\n    }\r\n\r\n    function handleBlur() {\r\n      ngModel.$render();\r\n    }\r\n  }\r\n\r\n  function validateMoney(value) {\r\n    if (value < 0) {\r\n      return false;\r\n    } else {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  function formatMoney(value) {\r\n    if (value === undefined || value === null) {\r\n      return \"\";\r\n    } else {\r\n      return $filter(\"number\")(value, 2);\r\n    }\r\n  }\r\n\r\n  function parseMoney(value) {\r\n    return new Decimal(value).toNumber();\r\n  }\r\n\r\n}\r\n\n},{\"angular\":\"angular\",\"simple-decimal-money\":\"simple-decimal-money\"}],36:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\n\r\nangular.module(\"debtApp\")\r\n  .directive(\"tryCatch\", tryCatch);\r\n\r\nfunction tryCatch() {\r\n  return {\r\n    scope: {\r\n      expression: \"&\",\r\n      errorResult: \"@\"\r\n    },\r\n    template: '{{result}}',\r\n    link: link\r\n  };\r\n\r\n  function link($scope) {\r\n    try {\r\n      $scope.result = $scope.expression();\r\n    } catch (e) {\r\n      $scope.result = $scope.errorResult;\r\n    }\r\n  }\r\n}\n},{\"angular\":\"angular\"}]},{},[14,3,4,5,6,7,8,9,10,11,12,13,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36]);\n"],"sourceRoot":".."}