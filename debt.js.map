{"version":3,"sources":["debt.js"],"names":["e","t","n","r","s","o","u","a","require","i","f","Error","code","l","exports","call","length",1,"module","BalanceSheetCtrl","balanceSheetService","debtService","events","$scope","$log","init","refresh","$on","BALANCE_SHEET_UPDATED","vm","balanceSheet","debtsByDebtor","computeDebts","debtComputationError","undefined","error","isBalanced","participations","getNonSettledParticipations","debts","currency","organizeByDebtor","updateSheet","$emit","this","$inject","angular","controller","lodash",2,"localStorageService","data","localStorageData","get","json","JSON","parse","dateReviver","service","BalanceSheet","save","ReferenceError","throwErrorIfInvalid","jsonString","stringify","exportData","set","loadFromJson","key","value","DATE_REGEX","test","Date","exportToJson","createNew","factory","./balance-sheet",3,"_","Decimal","CurrencyConversionError","filter","pt","expense","settled","reduce","expenses","getPerson","id","persons","find","p","createPerson","options","extend","name","idSequence","person","Person","push","createParticipations","each","createParticipation","shareCost","removePerson","toRemove","remove","equals","forEach","getParticipations","removeParticipation","getExpense","createExpense","sharing","Expense","removeExpense","getParticipation","criteria","toSeek","Participation","paid","share","participation","currenciesEnabled","exchangeRates","getExchangeRates","cloneDeep","getCurrencies","chain","getExchangeRateCurrencies","concat","getExpenseCurrencies","_this","uniq","sort","result","er","fixed","variable","map","computedCurrency","addOrUpdateExchangeRate","quotation","validateQuotation","existing","pick","updateBalanceSheetCurrencyIfNeeded","isString","trim","TypeError","isNumber","rate","RangeError","cleanUpCurrency","cleanUpCurrencyPair","currencyPair","clone","removeExchangeRate","updateExpenseCurrenciesIfNeeded","convertCurrency","toConvert","toNumber","EXCHANGE_RATE_DECIMALS","searchPair","inverseQuotation","multiply","divideBy","tryToConvertCurrency","NaN","getConvertibleCurrencies","fromCurrencies","toCurrency","isArray","convertible","c","getNonConvertibleCurrencies","difference","currencies","indexOf","throwErrorIfInvalidExpenseCurrencies","ex","getTotal","participationMapping","_nonSettledParticipations","total","add","_sheet","getCost","getPaid","getSumOfShares","getShare","getBalance","subtract","_myParticipations","other","isNotFunction","negate","isFunction","pickBy","shareEqually","cost","lastShare","last","getCurrencyConversionFunction","strictConversion","getValue","propName","convert","expenseParticipations","thisValueConverted","originalSum","sum","prt","convertedSum","sumOfConverted","delta","personId","expenseId","importData","max","isNaN","separately","q","isValid","idToEntity","./currency-conversion-error","simple-decimal-money",4,"message","temp","apply","arguments","stack","prototype","Object","create","constructor","writable","configurable",5,"./balance-sheet-ctrl","./balance-sheet-service","./route-config",6,"config","$stateProvider","state","url","views","templateUrl","floatingButton",7,"CurrencyListCtrl","$mdDialog","debounce","$watch","openExchangeRateDialog","show","then","updateExchangeRate","exchangeRate","ExchangeRateDialogCtrl","ok","hide","cancel",8,"./currency-list-ctrl",9,10,"DebtAppCtrl","balanceSheetSaveInterval","openCreatePersonDialog","openCreateExpenseDialog","fileService","$state","balanceSheetUpdated","ERROR","handleErrorEvent","findExpensesWithInvalidCurrencies","errorMessage","tryToSave","nonConvertible","messageTemplate","template","currencyWord","currencyList","balanceSheetCurrency","index","event","dialogResult","$broadcast","createNewSheet","confirmCreateNewSheet","go","loadSheet","files","isSupported","file","readAsText","loadSheetFromJson","exportSheet","saveAsFile","showHelp","close","confirm","title","content","constant",11,"configureLocalStorage","localStorageServiceProvider","setPrefix","configureIcons","$mdIconProvider","spriteNames","spriteProps","fileName","filePath","spriteName","prop","iconSet","hrefSanitization","$compileProvider","aHrefSanitizationWhitelist","decorateExceptionHandler","$provide","decorator","$delegate","$injector","exception","cause","$rootScope","makeStateAvailableInScope","$stateParams","makeMdMediaAvailableInScope","$mdMedia","run","./balance-sheet/currency-conversion-error","./currencies","./debt-app-ctrl","./debts","./expenses","./persons","./utils","angular-local-storage","angular-material","angular-route","angular-ui-router","ng-file-upload",12,"solveDebts","debt","debtorList","debtorIndices","d","debtor","debtorIndex","omit","d1","d2","creditor","localeCompare",13,"debtSolverFactory","solveLinearSystem","solve","balances","computeBalances","isEveryoneBalanced","isSystemBalanced","roles","getDebtorsAndCreditors","linearSystem","createDebtEquations","debtVector","createDebts","b","balance","every","debtors","creditors","A","initMatrix","j","rows","cols","solution","numberOfSolutions","numVars","numberOfVariables","numFreeVars","numberOfFreeVariables","xVector","randomEngine","Random","engines","mt19937","seed","toEliminate","copy","candidates","candidateIdx","integer","splice","isNonNegative","vector","debtorIdx","Math","floor","creditorIdx","amount","random-js",14,"./debt-service","./debt-solver","./lin-eq-solver","./lin-eq-solver-factory",15,16,"input","validate","initialize","coefMatrix","copyMatrix","constVector","copyArray","m","pivotToEquationMap","equationScale","abscoef","abs","pivotToVariableMap","transformToRowEchelonForm","pivotIdx","knownFreeVariables","maxRatio","bestPivotEquationIndex","rowIdx","colIdx","ratio","currPivotVaribleIdx","newPivotVariableIdx","pivotRowIdx","pivotColIdx","mult","colIndex","reduceRowEchelonForm","pivotIndex","min","div","determineRank","rank","columns","determineNumberOfSolutions","b2IsZero","Number","MAX_VALUE","determineSolution","initArray","numberOfEquations","size","array","slice",17,"open","DialogController","controllerAs",18,"ExpenseDetailCtrl","debtCalculationInterval","$timeout","isParticipant","everyoneParticipates","updateExpense","targetScope","getParticipationMap","sumOfShares","computeDebtsDebounced","setParticipation","confirmRemoveExpense","doRemoveExpense","setCurrency",19,"./create-expense-dialog","./expense-detail-ctrl",20,21,22,"./create-person-dialog","./person-detail-ctrl",23,"PersonDetailCtrl","confirmRemovePerson","role","counterRole","doRemovePerson","updatePerson","debtResult","debtRole",24,25,"$urlRouterProvider","otherwise",26,"$filter",27,"debounceFactory","func","wait","scope","invokeApply","timer","context","args","Array",28,"$q","$window","blob","deferred","defer","reader","FileReader","onload","resolve","onerror","promise","dataArray","Blob","fileSaver","saveAs","blob-polyfill","node-safe-filesaver",29,"focus","restrict","link","iElem","iAttrs","focusExpr","shouldFocus","$eval","directive",30,"./balance-filter","./file-service","./focus-directive","./money-filter","./money-input-directive",31,"money",32,"moneyInput","ngModel","render","val","$valid","formatMoney","$modelValue","$viewValue","handleBlur","$render","$validators","validateMoney","$parsers","parseMoney","$formatters","unshift","on",33,"tryCatch","expression","errorResult"],"mappings":"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","file":"debt.js","sourcesContent":["(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error(\"Cannot find module '\"+o+\"'\");throw f.code=\"MODULE_NOT_FOUND\",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar _ = require(\"lodash\");\r\nvar angular = require(\"angular\");\r\n\r\nangular.module(\"debtApp\")\r\n  .controller(\"BalanceSheetCtrl\", BalanceSheetCtrl);\r\n\r\nfunction BalanceSheetCtrl(balanceSheetService, debtService, events, $scope, $log) {\r\n  var vm = this;\r\n  \r\n  vm.init = init;\r\n  vm.refresh = refresh;\r\n  vm.updateSheet = updateSheet;\r\n  \r\n  init();\r\n  \r\n  /////////////////////////////////////////////////////////////\r\n  \r\n  function init() {\r\n    refresh();\r\n    $scope.$on(events.BALANCE_SHEET_UPDATED, vm.refresh);\r\n  }\r\n  \r\n  function refresh() {\r\n    vm.balanceSheet = balanceSheetService.balanceSheet;\r\n    try {\r\n      vm.debtsByDebtor = computeDebts();\r\n      vm.debtComputationError = undefined;\r\n    } catch (e) {\r\n      $log.error(e);\r\n      vm.debtsByDebtor = undefined;\r\n      vm.debtComputationError = \"Cannot compute debts\";\r\n    }\r\n  }\r\n  \r\n  function computeDebts() {\r\n    if (vm.balanceSheet.isBalanced()) {\r\n      var participations = vm.balanceSheet.getNonSettledParticipations();\r\n      var debts = debtService.computeDebts(participations, vm.balanceSheet.currency);\r\n      return debtService.organizeByDebtor(debts);\r\n    } else {\r\n      return undefined;\r\n    }\r\n  }\r\n\r\n  function updateSheet() {\r\n    $scope.$emit(events.BALANCE_SHEET_UPDATED);\r\n  }\r\n}\n},{\"angular\":\"angular\",\"lodash\":\"lodash\"}],2:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\nvar BalanceSheet = require('./balance-sheet');\r\n\r\nangular.module(\"debtApp\")\r\n  .factory(\"balanceSheetService\", balanceSheetService);\r\n\r\nfunction balanceSheetService(localStorageService) {\r\n\r\n  var DATE_REGEX = /\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}\\.\\d{3}Z/; // 2016-04-07T21:00:00.000Z\r\n\r\n  var service = {\r\n    balanceSheet: undefined,\r\n    save: save,\r\n    loadFromJson: loadFromJson,\r\n    exportToJson: exportToJson,\r\n    createNew: createNew,\r\n    init: init\r\n  };\r\n\r\n  return service;\r\n\r\n\r\n  function init() {\r\n    var localStorageData = localStorageService.get(\"balanceSheetData\");\r\n    var data;\r\n    if (localStorageData && localStorageData.json) {\r\n       data = JSON.parse(localStorageData.json, dateReviver);\r\n    } else if (localStorageData) {\r\n      data = localStorageData; // backwards compatibility\r\n    } else {\r\n      data = {};\r\n    }\r\n    service.balanceSheet = new BalanceSheet(data);\r\n  }\r\n\r\n  function save() {\r\n    if (!service.balanceSheet) {\r\n      throw new ReferenceError(\"No balance valid balance sheet\");\r\n    }\r\n    service.balanceSheet.throwErrorIfInvalid();\r\n\r\n    // Store a JSON string in localStorage instead of allowing localStorageService to stringify\r\n    // the data so that we can control date parsing.\r\n    var jsonString = JSON.stringify(service.balanceSheet.exportData());\r\n    localStorageService.set(\"balanceSheetData\", {json: jsonString});\r\n  }\r\n\r\n  function loadFromJson(json) {\r\n    var data = JSON.parse(json, dateReviver);\r\n    var balanceSheet = new BalanceSheet(data);\r\n    balanceSheet.throwErrorIfInvalid();\r\n    service.balanceSheet = balanceSheet;\r\n    save();\r\n  }\r\n\r\n  function dateReviver(key, value) {\r\n    if (typeof value === 'string' && DATE_REGEX.test(value)) {\r\n      return new Date(value);\r\n    }\r\n    return value;\r\n  }\r\n\r\n  function exportToJson() {\r\n    var data = service.balanceSheet.exportData();\r\n    return JSON.stringify(data);\r\n  }\r\n\r\n  function createNew() {\r\n    service.balanceSheet = new BalanceSheet();\r\n    service.save();\r\n  }\r\n\r\n}\r\n\r\n\r\n\n},{\"./balance-sheet\":3,\"angular\":\"angular\"}],3:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar _ = require('lodash');\r\nvar angular = require(\"angular\");\r\nvar Decimal = require(\"simple-decimal-money\");\r\nvar CurrencyConversionError = require(\"./currency-conversion-error\");\r\n\r\nvar BalanceSheet = function(data) {\r\n\r\n  var _this = this;\r\n  var _sheet = this;\r\n\r\n  var EXCHANGE_RATE_DECIMALS = 4;\r\n\r\n  // Data\r\n\r\n  var persons = [];\r\n  var expenses = [];\r\n  var participations = [];\r\n\r\n  var exchangeRates = [];\r\n\r\n  var idSequence = 1;\r\n\r\n  _this.name = \"New sheet\";\r\n  _this.currency = undefined;\r\n  _this.persons = persons;\r\n  _this.expenses = expenses;\r\n  _this.participations = participations;\r\n\r\n  if (data) {\r\n    importData(data);\r\n  }\r\n\r\n  // Methods\r\n\r\n  _this.getNonSettledParticipations = getNonSettledParticipations;\r\n\r\n  _this.isBalanced = isBalanced;\r\n\r\n  _this.getPerson = getPerson;\r\n  _this.createPerson = createPerson;\r\n  _this.removePerson = removePerson;\r\n\r\n  _this.getExpense = getExpense;\r\n  _this.createExpense = createExpense;\r\n  _this.removeExpense = removeExpense;\r\n\r\n  _this.getParticipation = getParticipation;\r\n  _this.createParticipation = createParticipation;\r\n  _this.removeParticipation = removeParticipation;\r\n\r\n  _this.exportData = exportData;\r\n\r\n  _this.isValid = isValid;\r\n  _this.throwErrorIfInvalid = throwErrorIfInvalid;\r\n\r\n  _this.currenciesEnabled = currenciesEnabled;\r\n  _this.getExchangeRates = getExchangeRates;\r\n  _this.getCurrencies = getCurrencies;\r\n  _this.getExpenseCurrencies = getExpenseCurrencies;\r\n  _this.getExchangeRateCurrencies = getExchangeRateCurrencies;\r\n  _this.addOrUpdateExchangeRate = addOrUpdateExchangeRate;\r\n  _this.removeExchangeRate = removeExchangeRate;\r\n  _this.convertCurrency = convertCurrency;\r\n  _this.getConvertibleCurrencies = getConvertibleCurrencies;\r\n  _this.getNonConvertibleCurrencies = getNonConvertibleCurrencies;\r\n  _this.throwErrorIfInvalidExpenseCurrencies = throwErrorIfInvalidExpenseCurrencies;\r\n\r\n  /////////////////////////////////////\r\n\r\n\r\n  function getNonSettledParticipations() {\r\n    return _.filter(participations, function(pt) {\r\n      return !pt.expense.settled;\r\n    });\r\n  }\r\n\r\n  function isBalanced() {\r\n    return _.reduce(expenses, function(isBalanced, e) {\r\n      return isBalanced && (e.settled || e.isBalanced());\r\n    }, true);\r\n  }\r\n\r\n\r\n  function getPerson(id) {\r\n    return _(persons).find(function(p) {\r\n      return p.id == id;\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Creates a person.\r\n   *\r\n   * @param {Object} [data] - Person data\r\n   * @param {String} [data.name=Person <number>] - Person's name\r\n   * @param {Object} [options] - Options for creating a person\r\n   * @param {boolean} [options.createParticipations=true] - Whether the person is set to participate in all existing expenses\r\n   * @returns {Person} - The created Person object\r\n   */\r\n  function createPerson(data, options) {\r\n    data = _.extend({\r\n      name: \"Person \" + (persons.length + 1)\r\n    }, data);\r\n\r\n    options = _.extend({}, options);\r\n\r\n    if (data.id === undefined) {\r\n      data.id = idSequence;\r\n      idSequence = idSequence + 1;\r\n    }\r\n\r\n    var person = new Person(data);\r\n    persons.push(person);\r\n\r\n    if (options.createParticipations === true) {\r\n      _.each(expenses, function(e) {\r\n        if (!e.settled) {\r\n          createParticipation({person: person, expense: e});\r\n          e.shareCost();\r\n        }\r\n      });\r\n    }\r\n\r\n    return person;\r\n  }\r\n\r\n  function removePerson(toRemove) {\r\n    toRemove = getPerson(toRemove.id);\r\n\r\n    if (!toRemove) return;\r\n\r\n    _.remove(persons, function(e) {\r\n      return e.equals(toRemove);\r\n    });\r\n\r\n    _.forEach(toRemove.getParticipations(), function(pt) {\r\n      removeParticipation(pt);\r\n    });\r\n  }\r\n\r\n  function getExpense(id) {\r\n    return _(expenses).find(function(e) {\r\n      return e.id == id;\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Creates an expense.\r\n   *\r\n   * @param {Object} [data] - Expense data\r\n   * @param {String} [data.name=Expense <number>] - Expense's name\r\n   * @param {String} [data.currency] - The currency the expense was paid in\r\n   * @param {Object} [options] - Options for creating an expense\r\n   * @param {boolean} [options.createParticipations=true] - Whether all existing persons are set to participate in the expense\r\n   * @returns {Expense} - The created Expense object\r\n   */\r\n  function createExpense(data, options) {\r\n    data = _.extend({\r\n      name: \"Expense \" + (expenses.length + 1),\r\n      sharing: \"equal\",\r\n      settled: false,\r\n      currency: undefined\r\n    }, data);\r\n\r\n    options = _.extend({}, options);\r\n\r\n    if (data.id === undefined) {\r\n      data.id = idSequence;\r\n      idSequence = idSequence + 1;\r\n    }\r\n\r\n    var expense = new Expense(data);\r\n    expenses.push(expense);\r\n\r\n    if (options.createParticipations === true) {\r\n      _.each(persons, function(p) {\r\n        createParticipation({person: p, expense: expense});\r\n      });\r\n    }\r\n\r\n    return expense;\r\n  }\r\n\r\n  function removeExpense(toRemove) {\r\n    toRemove = getExpense(toRemove.id);\r\n\r\n    if (!toRemove) return;\r\n\r\n    _.remove(expenses, function(e) {\r\n      return e.equals(toRemove);\r\n    });\r\n\r\n    _.forEach(toRemove.getParticipations(), function(pt) {\r\n      removeParticipation(pt);\r\n    });\r\n  }\r\n\r\n\r\n  function getParticipation(criteria) {\r\n    var toSeek = new Participation(criteria);\r\n    return _(participations).find(function(pt) {\r\n      return toSeek.equals(pt);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Creates a participation of a Person to an Expense.\r\n   *\r\n   * @param {Object} data - Participation data\r\n   * @param {Person} data.person - The participant person\r\n   * @param {Expense} data.expense - The expense to participate in\r\n   * @param {number} [data.paid=0] - How much the person has paid for the expense (in the expense currency)\r\n   * @param {number} [data.share=0] - The person's share of the expense's total cost (in the expense currency)\r\n   * @returns {Participation} - The created Participation object\r\n   */\r\n  function createParticipation(data) {\r\n    if (getParticipation(data)) {\r\n      throw new Error(\"Duplicate participation\");\r\n    }\r\n\r\n    data = _.extend({\r\n      paid: 0,\r\n      share: 0\r\n    }, data);\r\n\r\n    var participation = new Participation(data);\r\n    participations.push(participation);\r\n\r\n    participation.expense.shareCost();\r\n\r\n    return participation;\r\n  }\r\n\r\n  function removeParticipation(toRemove) {\r\n    toRemove = getParticipation(toRemove);\r\n\r\n    if (!toRemove) return;\r\n\r\n    _.remove(participations, function(pt) {\r\n      return pt.equals(toRemove);\r\n    });\r\n\r\n    toRemove.expense.shareCost();\r\n  }\r\n\r\n\r\n  /**\r\n   * @returns {boolean} Whether currencies are enabled in this balance sheet\r\n   */\r\n  function currenciesEnabled() {\r\n    return exchangeRates && exchangeRates.length > 0;\r\n  }\r\n  /**\r\n   * @return {string[]} copy of exchange rates in this sheet\r\n   */\r\n  function getExchangeRates() {\r\n    return _.cloneDeep(exchangeRates);\r\n  }\r\n\r\n  /**\r\n   * @return list of currencies in alphabetical order\r\n   */\r\n  function getCurrencies() {\r\n    return _.chain(getExchangeRateCurrencies())\r\n      .concat(getExpenseCurrencies(), _this.currency)\r\n      .uniq()\r\n      .sort()\r\n      .value();\r\n  }\r\n\r\n  function getExchangeRateCurrencies() {\r\n    return _.reduce(exchangeRates, function(result, er) {\r\n      result.push(er.fixed);\r\n      result.push(er.variable);\r\n      return result;\r\n    }, []);\r\n  }\r\n\r\n  function getExpenseCurrencies() {\r\n    return _.map(expenses, function(e) {\r\n      return e.computedCurrency();\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Adds or updates an exchange rate.\r\n   *\r\n   * @param {Object} quotation - The exchange rate object\r\n   * @param {string} quotation.fixed - The fixed currency symbol\r\n   * @param {string} quotation.variable - The variable currency symbol\r\n   * @param {number} quotation.rate - The rate: 1 unit of the fixed currency buys this amount of the variable currency. Must be a positive number with at most 4 decimals.\r\n   */\r\n  function addOrUpdateExchangeRate(quotation) {\r\n    validateQuotation(quotation);\r\n    var existing = _.find(exchangeRates, _.pick(quotation, 'fixed', 'variable'));\r\n    if (existing) {\r\n      _.extend(existing, quotation);\r\n    } else {\r\n      exchangeRates.push(quotation);\r\n    }\r\n    updateBalanceSheetCurrencyIfNeeded();\r\n  }\r\n\r\n  function validateQuotation(quotation) {\r\n    if (!_.isString(quotation.fixed) || _.trim(quotation.fixed) === \"\") {\r\n      throw new TypeError(\"Fixed currency symbol must be a non-empty string\");\r\n    }\r\n    if (!_.isString(quotation.variable) || _.trim(quotation.variable) === \"\") {\r\n      throw new TypeError(\"Variable currency symbol must be a non-empty string\");\r\n    }\r\n    if (!_.isNumber(quotation.rate) || quotation.rate < 0.0001) {\r\n      throw new RangeError(\"Foreign currency rate must be >= 0.0001\");\r\n    }\r\n  }\r\n\r\n  function cleanUpCurrency(currency) {\r\n    if (!currency) {\r\n      return undefined;\r\n    } else if (_.isString(currency) && _.trim(currency).length === 0) {\r\n      return undefined;\r\n    } else {\r\n      return _.trim(currency);\r\n    }\r\n  }\r\n\r\n  function cleanUpCurrencyPair(currencyPair) {\r\n    currencyPair = _.clone(currencyPair);\r\n    currencyPair.fixed = cleanUpCurrency(currencyPair.fixed);\r\n    currencyPair.variable = cleanUpCurrency(currencyPair.variable);\r\n    return currencyPair;\r\n  }\r\n\r\n  /**\r\n   * Removes an exchange rate.\r\n   *\r\n   * @param currencyPair - The currency pair to remove\r\n   * @param {string} currencyPair.fixed - The fixed currency symbol\r\n   * @param {string} currencyPair.variable - The variable currency symbol\r\n   */\r\n  function removeExchangeRate(currencyPair) {\r\n    if (!currencyPair) return;\r\n    currencyPair = cleanUpCurrencyPair(currencyPair);\r\n    _.remove(exchangeRates, _.pick(currencyPair, 'fixed', 'variable'));\r\n    updateBalanceSheetCurrencyIfNeeded();\r\n    updateExpenseCurrenciesIfNeeded();\r\n  }\r\n\r\n  /**\r\n   * Converts a value from one currency to another. Uses the inverse of an exchange\r\n   * rate if an inverse currency pair is found.\r\n   *\r\n   * @param {Object} toConvert - The data object\r\n   * @param {number} toConvert.value - The value to convert\r\n   * @param {string} toConvert.fixed - The currency of the value to be converted\r\n   * @param {string} toConvert.variable - The currency to convert the value to\r\n   * @return {number} - The value in the variable currency\r\n   */\r\n  function convertCurrency(toConvert) {\r\n    var rate;\r\n\r\n    if (!toConvert) {\r\n      throw new CurrencyConversionError(\"Undefined or null conversion data\");\r\n    }\r\n\r\n    toConvert = cleanUpCurrencyPair(toConvert);\r\n\r\n    if (toConvert.fixed == toConvert.variable) {\r\n      return new Decimal(toConvert.value).toNumber();\r\n    }\r\n\r\n    var quotation = _.find(exchangeRates, {fixed: toConvert.fixed, variable: toConvert.variable});\r\n\r\n    if (quotation) {\r\n      rate = new Decimal(quotation.rate, EXCHANGE_RATE_DECIMALS);\r\n    } else {\r\n      var searchPair = {variable: toConvert.fixed, fixed: toConvert.variable};\r\n      var inverseQuotation = _.find(exchangeRates, searchPair);\r\n      if (inverseQuotation) {\r\n        rate = new Decimal(1/inverseQuotation.rate, EXCHANGE_RATE_DECIMALS);\r\n      }\r\n    }\r\n\r\n    if (!rate) {\r\n      throw new CurrencyConversionError(\"Could not find an exchange rate for conversion '\" + toConvert.fixed + \"' -> '\" + toConvert.variable + \"'.\");\r\n    }\r\n\r\n    return new Decimal(toConvert.value*100).multiply(rate).divideBy(100).toNumber();\r\n  }\r\n\r\n  function tryToConvertCurrency(toConvert) {\r\n    try {\r\n      return convertCurrency(toConvert);\r\n    } catch (e) {\r\n      if (e instanceof CurrencyConversionError) {\r\n        return NaN;\r\n      } else {\r\n        throw e;\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns currencies that can be converted to the given currency.\r\n   *\r\n   * @param {string[]} fromCurrencies - Currencies to convert\r\n   * @param {string} toCurrency - Currency to convert to\r\n   * @returns {string[]} - Convertible currencies in fromCurrencies\r\n   */\r\n  function getConvertibleCurrencies(fromCurrencies, toCurrency) {\r\n    if (!_.isArray(fromCurrencies)) {\r\n      return [];\r\n    }\r\n\r\n    var convertible = [];\r\n    _.each(getCurrencies(), function(c) {\r\n      try {\r\n        convertCurrency({fixed: c, variable: toCurrency, value: 1});\r\n        convertible.push(c);\r\n      } catch (e) {}\r\n    });\r\n    return convertible;\r\n  }\r\n\r\n  /**\r\n   * Finds currencies that can not be converted to the given currency.\r\n   *\r\n   * @param {string[]} fromCurrencies - Currencies to convert\r\n   * @param {string} toCurrency - Currency to convert to\r\n   * @returns {string[]} - Non-convertible currencies\r\n   */\r\n  function getNonConvertibleCurrencies(fromCurrencies, toCurrency) {\r\n    return _.difference(fromCurrencies, getConvertibleCurrencies(fromCurrencies, toCurrency));\r\n  }\r\n\r\n\r\n  function updateBalanceSheetCurrencyIfNeeded() {\r\n    var currencies = getExchangeRateCurrencies();\r\n\r\n    if (exchangeRates.length === 0) {\r\n      _this.currency = undefined;\r\n    } else if (_this.currency === undefined || _.indexOf(currencies, _this.currency) === -1) {\r\n      _this.currency = exchangeRates[0].fixed;\r\n    }\r\n  }\r\n\r\n\r\n  function updateExpenseCurrenciesIfNeeded() {\r\n    var currencies = _.concat(getExchangeRateCurrencies(), _this.currency);\r\n    _.each(expenses, function(e) {\r\n      if (_.indexOf(currencies, e.currency) === -1) {\r\n        e.currency = _this.currency;\r\n      }\r\n    });\r\n  }\r\n\r\n  function throwErrorIfInvalidExpenseCurrencies() {\r\n    _.each(expenses, function(expense) {\r\n      try {\r\n        convertCurrency({fixed: expense.computedCurrency(), variable: _this.currency, value: 1});\r\n      } catch (ex) {\r\n        throw new CurrencyConversionError(\"Cannot convert currency '\" + expense.computedCurrency()  + \"' of '\" + expense.name + \"' to balance sheet's currency '\" + _this.currency + \"'\");\r\n      }\r\n    });\r\n  }\r\n\r\n\r\n  /**\r\n   * Creates a Person object.\r\n   *\r\n   * @param {Object} [data] - Initial data\r\n   * @param {number} [data.id] - Id\r\n   * @param {string} [data.name} - Name\r\n   * @constructor\r\n   */\r\n  function Person(data) {\r\n    var _this = this;\r\n\r\n    _.extend(_this, data);\r\n\r\n    // Methods\r\n\r\n    _this.computedCurrency = computedCurrency;\r\n    _this.equals = equals;\r\n    _this.getCost = getCost;\r\n    _this.getSumOfShares = getSumOfShares;\r\n    _this.getBalance = getBalance;\r\n    _this.isBalanced = isBalanced;\r\n    _this.getParticipations = getParticipations;\r\n    _this.exportData = exportData;\r\n\r\n    ///////////////////////////////////////\r\n\r\n    var _myParticipations = _.chain(participations)\r\n      .filter(function(pt) {\r\n        return _this.equals(pt.person);\r\n      });\r\n\r\n    var _nonSettledParticipations = _myParticipations\r\n      .filter(function(pt) {\r\n        return !pt.expense.settled;\r\n      });\r\n\r\n\r\n    function getTotal(participationMapping) {\r\n      return _nonSettledParticipations\r\n        .map(participationMapping)\r\n        .reduce(function(total, value) {\r\n          return total.add(value);\r\n        }, new Decimal(0))\r\n        .value()\r\n        .toNumber();\r\n    }\r\n\r\n    function computedCurrency() {\r\n      return _sheet.currency;\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param {string} [currency] - The currency in which to get the total (default: balance sheet's default currency)\r\n     * @returns {number} - The total amount this person has paid. NaN if cannot convert currency.\r\n     */\r\n    function getCost(currency) {\r\n      currency = currency || _this.computedCurrency();\r\n      return getTotal(function(pt) {\r\n        return pt.getPaid(currency);\r\n      });\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param {string} [currency] - The currency in which to get the total (default: balance sheet's default currency)\r\n     * @returns {number} - This person's total share of all the expenses. NaN if cannot convert currency.\r\n     */\r\n    function getSumOfShares(currency) {\r\n      currency = currency || _this.computedCurrency();\r\n      return getTotal(function(pt) {\r\n        return pt.getShare(currency);\r\n      });\r\n    }\r\n\r\n    /**\r\n     * Checks whether this person's costs and shares sum up to zero, i.e. the person neither\r\n     * owes money nor is owed money by anyone else.\r\n     *\r\n     * @returns {boolean} - Whether this person's costs and shares sum up to zero\r\n     */\r\n    function isBalanced() {\r\n      return getBalance() === 0;\r\n    }\r\n\r\n    /**\r\n     * Computes the difference between the total share and cost paid by this person.\r\n     * If the difference is negative, then the person's share is smaller than the costs\r\n     * she has paid, that is others owe her money.\r\n     *\r\n     * @param {string} [currency] - The currency in which to get the balance (default: balance sheet's default currency)\r\n     * @returns {number} - The difference between the total share and cost paid by this person. NaN if cannot convert currency.\r\n     */\r\n    function getBalance(currency) {\r\n      currency = currency || _this.computedCurrency();\r\n      return new Decimal( getSumOfShares(currency) ).subtract( getCost(currency) ).toNumber();\r\n    }\r\n\r\n    /**\r\n     * @returns {Participation[]} - The expense participations of this person\r\n     */\r\n    function getParticipations() {\r\n      return _myParticipations.value();\r\n    }\r\n\r\n    /**\r\n     * @param {Object} other - Another object\r\n     * @returns {boolean} - True if this person is equal to the other object\r\n     */\r\n    function equals(other) {\r\n      return (other instanceof Person) && (other.id === _this.id);\r\n    }\r\n\r\n    function exportData() {\r\n      var isNotFunction = _.negate(_.isFunction);\r\n      return _.extend(_.pickBy(_this, isNotFunction), {});\r\n    }\r\n\r\n  }\r\n\r\n\r\n  /**\r\n   * An expense.\r\n   *\r\n   * @param {object} [data] - Initial data\r\n   * @param {number} [data.id] - The expense's id\r\n   * @param {string} [data.name] - The expense's name\r\n   * @param {string} [data.sharing] -  The expense's cost sharing mode. Value \"equal\" = share costs equally. All other values mean custom sharing.\r\n   * @param {string} [data.currency] - The expense's currency\r\n   * @constructor\r\n   */\r\n  function Expense(data) {\r\n    var _this = this;\r\n\r\n    // Data\r\n    _.extend(_this, data);\r\n\r\n    // Methods\r\n    _this.computedCurrency = computedCurrency;\r\n    _this.getCost = getCost;\r\n    _this.getSumOfShares = getSumOfShares;\r\n    _this.getBalance = getBalance;\r\n    _this.isBalanced = isBalanced;\r\n    _this.getParticipations = getParticipations;\r\n    _this.shareCost = shareCost;\r\n    _this.equals = equals;\r\n    _this.exportData = exportData;\r\n\r\n    ///////////////////////////////////////\r\n\r\n    var _myParticipations = _.chain(participations).filter(function(p) {\r\n      return _this.equals(p.expense);\r\n    });\r\n\r\n\r\n    function getTotal(participationMapping, currency) {\r\n      var total = _myParticipations\r\n        .map(participationMapping)\r\n        .reduce(function(total, value) {\r\n          return total.add(value);\r\n        }, new Decimal(0))\r\n        .value()\r\n        .toNumber();\r\n\r\n      if (!currency || currency === _this.computedCurrency()) {\r\n        return total;\r\n      } else {\r\n        return tryToConvertCurrency({\r\n          value: total,\r\n          fixed: _this.computedCurrency(),\r\n          variable: currency\r\n        });\r\n      }\r\n    }\r\n\r\n\r\n    /**\r\n     * Gets the currency of this expense used for currency computations.\r\n     *\r\n     * @returns {string} - The currency of this expense\r\n     */\r\n    function computedCurrency() {\r\n      return _this.currency || _sheet.currency;\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param {string} [currency] - Currency in which to get the value. Default is this expense's currency or if undefined, the balance sheet's default currency.\r\n     * @return {number} The cost of this expense. NaN if cannot convert currency.\r\n     */\r\n    function getCost(currency) {\r\n      return getTotal(function(pt) {\r\n        return pt.paid;\r\n      }, currency);\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param {string} [currency] - Currency in which to get the value. Default is this expense's currency or if undefined, the balance sheet's default currency.\r\n     * @return {number} The sum of shares of this expense. NaN if cannot convert currency.\r\n     */\r\n    function getSumOfShares(currency) {\r\n      return getTotal(function(pt) {\r\n        return pt.share;\r\n      }, currency);\r\n    }\r\n\r\n    function isBalanced() {\r\n      return getBalance(_this.computedCurrency()) === 0;\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param {string} [currency] - Currency in which to get the value. Default is this expense's currency or if undefined, the balance sheet's default currency.\r\n     * @return {number} The balance of this expense. NaN if cannot convert currency.\r\n     */\r\n    function getBalance(currency) {\r\n      return new Decimal( getSumOfShares(currency) ).subtract( getCost(currency) ).toNumber();\r\n    }\r\n\r\n    function getParticipations() {\r\n      return _myParticipations.value();\r\n    }\r\n\r\n    function shareCost() {\r\n      if (_this.sharing === \"equal\") {\r\n        shareEqually();\r\n      }\r\n    }\r\n\r\n    function shareEqually() {\r\n      var participations = _this.getParticipations();\r\n      if (participations.length === 0) {\r\n        return;\r\n      }\r\n\r\n      var cost = new Decimal(_this.getCost());\r\n      var share = cost.divideBy(participations.length);\r\n      var lastShare = cost.subtract(share.multiply(participations.length - 1));\r\n\r\n      _.forEach(participations, function(p, i) {\r\n        if (i < participations.length - 1) {\r\n          p.share = share.toNumber();\r\n        }\r\n      });\r\n      _.last(participations).share = lastShare.toNumber();\r\n    }\r\n\r\n    function equals(other) {\r\n      return (other instanceof Expense) && (other.id === _this.id);\r\n    }\r\n\r\n    function exportData() {\r\n      var isNotFunction = _.negate(_.isFunction);\r\n      return _.extend(_.pickBy(_this, isNotFunction));\r\n    }\r\n\r\n  }\r\n\r\n  /**\r\n   * Creates a participation of a Person to an Expense.\r\n   *\r\n   * @param {Object} data - Participation data\r\n   * @param {Person} data.person - The participant person\r\n   * @param {Expense} data.expense - The expense to participate in\r\n   * @param {number} [data.paid=0] - How much the person has paid for the expense (in the expense currency)\r\n   * @param {number} [data.share=0] - The person's share of the expense's total cost (in the expense currency)\r\n   * @constructor\r\n   */\r\n  function Participation(data) {\r\n    var _this = this;\r\n\r\n    if (!data || !data.person || !data.expense) {\r\n      throw new ReferenceError(\"Undefined participation\");\r\n    }\r\n\r\n    // Data\r\n\r\n    _.extend(_this, data);\r\n\r\n    // Methods\r\n\r\n    _this.getPaid = getPaid;\r\n    _this.getShare = getShare;\r\n    _this.equals = equals;\r\n    _this.exportData = exportData;\r\n\r\n    ///////////////////////////////////////\r\n\r\n    function getCurrencyConversionFunction(options) {\r\n      if (options.strictConversion) {\r\n        return convertCurrency;\r\n      } else {\r\n        return tryToConvertCurrency;\r\n      }\r\n    }\r\n\r\n    /**\r\n     * Returns the value of property propName with currency conversion (if applicable) adjusted such\r\n     * that the expense is balanced in the target currency.\r\n     *\r\n     * @param {string} propName - The name of the monetary value property\r\n     * @param {string} currency - The target currency\r\n     * @param {object} options - Currrency conversion options\r\n     * @returns {number} - The property value with currency conversion\r\n     */\r\n    function getValue(propName, currency, options) {\r\n      if (!currency || currency === _this.expense.computedCurrency()) {\r\n        return _this[propName];\r\n      }\r\n\r\n      options = _.extend({strictConversion: false}, options);\r\n      var convert = getCurrencyConversionFunction(options);\r\n      var expenseParticipations = _this.expense.getParticipations();\r\n\r\n      if (_.last(expenseParticipations) === _this) {\r\n\r\n        var thisValueConverted = convert({\r\n          value: _this[propName],\r\n          fixed: _this.expense.computedCurrency(),\r\n          variable: currency\r\n        });\r\n\r\n        var originalSum = _.reduce(expenseParticipations, function(sum, prt) {\r\n          return sum.add(prt[propName]);\r\n        }, new Decimal(0)).toNumber();\r\n\r\n        var convertedSum = convert({\r\n          value: originalSum,\r\n          fixed: _this.expense.computedCurrency(),\r\n          variable: currency\r\n        });\r\n\r\n        var sumOfConverted = _.reduce(expenseParticipations, function(sum, prt) {\r\n          var value = convert({\r\n            value: prt[propName],\r\n            fixed: prt.expense.computedCurrency(),\r\n            variable: currency\r\n          });\r\n          return sum.add(value);\r\n        }, new Decimal(0));\r\n\r\n        var delta = sumOfConverted.subtract(convertedSum);\r\n\r\n        return new Decimal(thisValueConverted).subtract(delta).toNumber();\r\n\r\n      } else {\r\n\r\n        return convert({\r\n          value: _this[propName],\r\n          fixed: _this.expense.computedCurrency(),\r\n          variable: currency\r\n        });\r\n\r\n      }\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param {string} [currency] - Currency in which to get the payment. Default is expense's currency.\r\n     * @param {object} [options] - Options\r\n     * @param {boolean} [options.strictConversion] - True to throw error if currency conversion fails, false to return NaN. Default is false.\r\n     * @return {number} How much the person paid for the expense.\r\n     */\r\n    function getPaid(currency, options) {\r\n      return getValue(\"paid\", currency, options);\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param {string} [currency] - Currency in which to get the share. Default is expense's currency.\r\n     * @param {object} [options] - Options\r\n     * @param {boolean} [options.strictConversion] - True to throw error if currency conversion fails, false to return NaN. Default is false.\r\n     * @return {number} How much the person shares for the expense.\r\n     */\r\n    function getShare(currency, options) {\r\n      return getValue(\"share\", currency, options);\r\n    }\r\n\r\n    function equals(other) {\r\n      return (other instanceof Participation) && _this.expense.equals(other.expense) && _this.person.equals(other.person);\r\n    }\r\n\r\n    function exportData() {\r\n      return {personId: _this.person.id, expenseId: _this.expense.id, paid: _this.paid, share: _this.share};\r\n    }\r\n\r\n  }\r\n\r\n\r\n  function exportData() {\r\n    var isNotFunction = _.negate(_.isFunction);\r\n    var data = _.pickBy(_this, isNotFunction);\r\n    data.persons = _.map(persons, function(p) {\r\n      return p.exportData();\r\n    });\r\n    data.expenses = _.map(expenses, function(e) {\r\n      return e.exportData();\r\n    });\r\n    data.participations = _.map(participations, function(pt) {\r\n      return pt.exportData();\r\n    });\r\n    data.exchangeRates = getExchangeRates();\r\n    return data;\r\n  }\r\n\r\n  function importData(data) {\r\n    idSequence = _([])\r\n        .concat(data.persons)\r\n        .concat(data.expenses)\r\n        .map(\"id\")\r\n        .max() + 1;\r\n    if (_.isNaN(idSequence)) {\r\n      idSequence = 1;\r\n    }\r\n\r\n    var separately = {persons: true, expenses: true, participations: true, exchangeRates: true};\r\n\r\n    _.each(data.exchangeRates, function(q) {\r\n      addOrUpdateExchangeRate(q);\r\n    });\r\n\r\n    _.extend(_this, _.pickBy(data, function(value, key) {\r\n      return !separately[key];\r\n    }));\r\n\r\n    _.each(data.persons, function(p) {\r\n      createPerson(p);\r\n    });\r\n\r\n    _.each(data.expenses, function(e) {\r\n      createExpense(e);\r\n    });\r\n\r\n    _.each(data.participations, function(p) {\r\n      var person = getPerson(p.personId);\r\n      var expense = getExpense(p.expenseId);\r\n      createParticipation({person: person, expense: expense, paid: p.paid, share: p.share});\r\n    });\r\n\r\n    throwErrorIfInvalid();\r\n  }\r\n\r\n  function isValid() {\r\n    try {\r\n      throwErrorIfInvalid();\r\n      return true;\r\n    } catch (e) {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  function throwErrorIfInvalid() {\r\n\r\n    _.each(persons, function(p) {\r\n      if (!_.isNumber(p.id)) {\r\n        throw new Error(\"Person has no id\");\r\n      }\r\n    });\r\n\r\n    _.each(expenses, function(e) {\r\n      if (!_.isNumber(e.id)) {\r\n        throw new Error(\"Expense has no id\");\r\n      }\r\n    });\r\n\r\n    var idToEntity = {};\r\n    _.each(persons, function(p) {\r\n      idToEntity[p.id] = p;\r\n    });\r\n    _.each(expenses, function(e) {\r\n      idToEntity[e.id] = e;\r\n    });\r\n    _.each(participations, function(pt) {\r\n      if (!pt.person) {\r\n        throw new Error(\"Participation has no person\");\r\n      }\r\n      if (!idToEntity[pt.person.id]) {\r\n        throw new Error(\"Participation person is unknown\");\r\n      }\r\n      if (!pt.expense) {\r\n        throw new Error(\"Participation has no expense\");\r\n      }\r\n      if (!idToEntity[pt.expense.id]) {\r\n        throw new Error(\"Participation expense is unknown\");\r\n      }\r\n    });\r\n\r\n  }\r\n\r\n};\r\n\r\n\r\nmodule.exports = BalanceSheet;\n},{\"./currency-conversion-error\":4,\"angular\":\"angular\",\"lodash\":\"lodash\",\"simple-decimal-money\":\"simple-decimal-money\"}],4:[function(require,module,exports){\n\"use strict\";\r\n\r\nfunction CurrencyConversionError(message) {\r\n  var temp = Error.apply(this, arguments);\r\n  //temp.name = this.name = 'CurrencyConversionError';\r\n  this.stack = temp.stack;\r\n  this.message = temp.message;\r\n}\r\n\r\nCurrencyConversionError.prototype = Object.create(Error.prototype, {\r\n  constructor: {\r\n    value: CurrencyConversionError,\r\n    writable: true,\r\n    configurable: true\r\n  }\r\n});\r\n\r\nmodule.exports = CurrencyConversionError;\n},{}],5:[function(require,module,exports){\n\"use strict\";\r\n\r\nrequire(\"./route-config\");\r\nrequire(\"./balance-sheet\");\r\nrequire(\"./balance-sheet-service\");\r\nrequire(\"./balance-sheet-ctrl\");\r\nrequire(\"./currency-conversion-error\");\n},{\"./balance-sheet\":3,\"./balance-sheet-ctrl\":1,\"./balance-sheet-service\":2,\"./currency-conversion-error\":4,\"./route-config\":6}],6:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\n\r\nangular.module(\"debtApp\")\r\n  .config(config);\r\n\r\nfunction config($stateProvider) {\r\n\r\n  $stateProvider\r\n    .state(\"balanceSheet\", {\r\n      url: \"/\",\r\n      views: {\r\n        \"\": {\r\n          templateUrl : \"balance-sheet/balance-sheet.html\",\r\n          controller : \"BalanceSheetCtrl as vm\"\r\n        },\r\n        \"floatingButton\": {\r\n          templateUrl : \"balance-sheet/floating-button.html\"\r\n        }\r\n      }\r\n    });\r\n  \r\n}\n},{\"angular\":\"angular\"}],7:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\nvar _ = require('lodash');\r\n\r\nangular.module(\"debtApp\")\r\n  .controller(\"CurrencyListCtrl\", CurrencyListCtrl)\r\n  .controller(\"ExchangeRateDialogCtrl\", ExchangeRateDialogCtrl);\r\n\r\n\r\nfunction CurrencyListCtrl(balanceSheetService, events, $scope, $mdDialog, debounce, $log) {\r\n  var vm = this;\r\n\r\n  vm.init = init;\r\n  vm.openExchangeRateDialog = openExchangeRateDialog;\r\n  vm.updateExchangeRate = updateExchangeRate;\r\n  vm.removeExchangeRate = removeExchangeRate;\r\n\r\n  init();\r\n\r\n  function init() {\r\n    vm.balanceSheet = balanceSheetService.balanceSheet;\r\n    \r\n    refresh();\r\n\r\n    // Workaround to allow FAB for creating an exchange rate to reside\r\n    // in a different scope (for layout).\r\n    $scope.$watch(function() {\r\n      return balanceSheetService.balanceSheet.getExchangeRates();\r\n    }, debounce(refresh, 50), true);\r\n  }\r\n\r\n  function refresh() {\r\n    vm.exchangeRates = balanceSheetService.balanceSheet.getExchangeRates();\r\n  }\r\n\r\n  function openExchangeRateDialog() {\r\n\r\n    return $mdDialog.show({\r\n      templateUrl: \"currencies/exchange-rate-dialog.html\",\r\n      controller: \"ExchangeRateDialogCtrl as vm\"\r\n    }).then(function(quotation) {\r\n      updateExchangeRate(quotation);\r\n    });\r\n\r\n  }\r\n\r\n  function updateExchangeRate(exchangeRate) {\r\n    try {\r\n      balanceSheetService.balanceSheet.addOrUpdateExchangeRate(exchangeRate);\r\n      $scope.$emit(events.BALANCE_SHEET_UPDATED);\r\n      refresh();\r\n    } catch (e) {\r\n      $log.error(e);\r\n    }\r\n  }\r\n\r\n  function removeExchangeRate(exchangeRate) {\r\n    balanceSheetService.balanceSheet.removeExchangeRate(exchangeRate);\r\n    _.remove(vm.exchangeRates, exchangeRate);\r\n    $scope.$emit(events.BALANCE_SHEET_UPDATED);\r\n    refresh();\r\n  }\r\n\r\n}\r\n\r\nfunction ExchangeRateDialogCtrl($mdDialog) {\r\n  var vm = this;\r\n\r\n  vm.ok = ok;\r\n  vm.cancel = cancel;\r\n  vm.init = init;\r\n\r\n  init();\r\n\r\n  function init() {\r\n    vm.quotation = {};\r\n  }\r\n\r\n  function ok() {\r\n    $mdDialog.hide(vm.quotation);\r\n  }\r\n\r\n  function cancel() {\r\n    $mdDialog.cancel();\r\n  }\r\n\r\n}\n},{\"angular\":\"angular\",\"lodash\":\"lodash\"}],8:[function(require,module,exports){\n\"use strict\";\r\n\r\nrequire(\"./route-config\");\r\nrequire(\"./currency-list-ctrl\");\n},{\"./currency-list-ctrl\":7,\"./route-config\":9}],9:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\n\r\nangular.module(\"debtApp\")\r\n  .config(config);\r\n\r\nfunction config($stateProvider) {\r\n\r\n  $stateProvider\r\n    .state(\"currencies\", {\r\n      url: \"/currencies\",\r\n      views: {\r\n        \"\": {\r\n          controller: \"CurrencyListCtrl as vm\",\r\n          templateUrl: \"currencies/currencies.html\"\r\n        },\r\n        \"floatingButton\": {\r\n          controller: \"CurrencyListCtrl as vm\",\r\n          templateUrl: \"currencies/floating-button.html\"\r\n        }\r\n      }\r\n    })\r\n  ;\r\n  \r\n}\n},{\"angular\":\"angular\"}],10:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\nvar _ = require(\"lodash\");\r\n\r\nangular.module(\"debtApp\")\r\n  .constant(\"balanceSheetSaveInterval\", 500)\r\n  .controller(\"DebtAppCtrl\", DebtAppCtrl);\r\n\r\nfunction DebtAppCtrl(balanceSheetService,\r\n                     debounce,\r\n                     balanceSheetSaveInterval,\r\n                     openCreatePersonDialog,\r\n                     openCreateExpenseDialog,\r\n                     fileService,\r\n                     events,\r\n                     $mdDialog,\r\n                     $state,\r\n                     $scope,\r\n                     $log) {\r\n\r\n  var vm = this;\r\n\r\n  vm.init = init;\r\n  vm.createPerson = createPerson;\r\n  vm.createExpense = createExpense;\r\n  vm.createNewSheet = createNewSheet;\r\n  vm.loadSheet = loadSheet;\r\n  vm.exportSheet = exportSheet;\r\n  vm.balanceSheetUpdated = balanceSheetUpdated;\r\n  vm.showHelp = showHelp;\r\n\r\n  var confirmCreateNewSheet = $mdDialog.confirm()\r\n    .title(\"Create new sheet\")\r\n    .content(\"The current sheet will be discarded. Please consider exporting it first. Continue?\")\r\n    .ok(\"Ok\").cancel(\"Cancel\");\r\n\r\n  init();\r\n\r\n  /////////////////////////////////////////////////////////////\r\n\r\n  function init() {\r\n    $scope.$on(events.BALANCE_SHEET_UPDATED, debounce(function() {\r\n      vm.balanceSheetUpdated();\r\n    }), balanceSheetSaveInterval, $scope, true);\r\n    $scope.$on(events.ERROR, handleErrorEvent);\r\n    balanceSheetService.init();\r\n    vm.balanceSheet = balanceSheetService.balanceSheet;\r\n    findExpensesWithInvalidCurrencies();\r\n  }\r\n\r\n  function balanceSheetUpdated() {\r\n    vm.errorMessage = undefined;\r\n    tryToSave();\r\n    findExpensesWithInvalidCurrencies();\r\n  }\r\n\r\n  function tryToSave() {\r\n    try {\r\n      balanceSheetService.save();\r\n    } catch (e) {\r\n      $log.error(e);\r\n      vm.errorMessage = \"Cannot save: \" + e.message;\r\n    }\r\n  }\r\n\r\n  function findExpensesWithInvalidCurrencies() {\r\n    var nonConvertible = vm.balanceSheet.getNonConvertibleCurrencies(vm.balanceSheet.getExpenseCurrencies(), vm.balanceSheet.currency);\r\n\r\n    if (nonConvertible.length === 0 || vm.errorMessage) {\r\n      return;\r\n    }\r\n    var messageTemplate = _.template(\"Cannot convert <%= currencyWord %> <%= currencyList %> to balance sheet's currency <%= balanceSheetCurrency %>\");\r\n\r\n    var data = {\r\n      currencyWord: nonConvertible.length == 1 ? \"currency\" : \"currencies\",\r\n      currencyList: \"\",\r\n      balanceSheetCurrency: \"'\" + vm.balanceSheet.currency + \"'\"\r\n    };\r\n\r\n    _.each(nonConvertible, function(c, index) {\r\n      data.currencyList = data.currencyList + (index > 0 ? \", \" : \"\") + \"'\" + c + \"'\";\r\n    });\r\n\r\n    vm.errorMessage = messageTemplate(data);\r\n  }\r\n\r\n  function handleErrorEvent(event, error) {\r\n    vm.errorMessage = error.message;\r\n  }\r\n\r\n  function createPerson() {\r\n    openCreatePersonDialog()\r\n      .then(function(dialogResult) {\r\n        balanceSheetService.balanceSheet.createPerson(dialogResult.person, dialogResult.options);\r\n        vm.balanceSheetUpdated();\r\n        $scope.$broadcast(events.BALANCE_SHEET_UPDATED);\r\n      });\r\n  }\r\n\r\n  function createExpense() {\r\n    openCreateExpenseDialog()\r\n      .then(function(dialogResult) {\r\n        balanceSheetService.balanceSheet.createExpense(dialogResult.expense, dialogResult.options);\r\n        vm.balanceSheetUpdated();\r\n        $scope.$broadcast(events.BALANCE_SHEET_UPDATED);\r\n      });\r\n  }\r\n\r\n  function createNewSheet() {\r\n    $mdDialog.show(confirmCreateNewSheet)\r\n      .then(function() {\r\n        balanceSheetService.createNew();\r\n        vm.balanceSheetUpdated();\r\n        $state.go(\"balanceSheet\");\r\n        $scope.$broadcast(events.BALANCE_SHEET_UPDATED);\r\n      });\r\n  }\r\n\r\n  function loadSheet(files) {\r\n    if (!files || !files.length) return;\r\n\r\n    if (!fileService.isSupported()) {\r\n      vm.errorMessage = \"File operations not supported in this browser. Please consider a more modern browser.\";\r\n      return;\r\n    }\r\n\r\n    var file = files[0];\r\n    fileService.readAsText(file)\r\n      .then(function(result) {\r\n        loadSheetFromJson(result);\r\n      })\r\n      .catch(function(e) {\r\n        $log.error(e);\r\n        vm.errorMessage = \"Unable to read file\";\r\n      });\r\n  }\r\n\r\n  function loadSheetFromJson(json) {\r\n    balanceSheetService.loadFromJson(json);\r\n    vm.balanceSheetUpdated();\r\n    $state.go(\"balanceSheet\");\r\n    $scope.$broadcast(events.BALANCE_SHEET_UPDATED);\r\n  }\r\n\r\n  function exportSheet() {\r\n    if (!fileService.isSupported()) {\r\n      vm.errorMessage = \"File operations not supported in this browser. Please consider a more modern browser.\";\r\n      return;\r\n    }\r\n\r\n    var json = balanceSheetService.exportToJson();\r\n    try {\r\n      fileService.saveAsFile([json], balanceSheetService.balanceSheet.name + \".txt\");\r\n    } catch (e) {\r\n      $log.error(e);\r\n      vm.errorMessage = \"Error when saving file\";\r\n    }\r\n  }\r\n\r\n  function showHelp() {\r\n    $mdDialog.show({\r\n      templateUrl: \"help.html\",\r\n      controller: function($scope, $mdDialog) {\r\n        $scope.close = function() {\r\n          $mdDialog.hide();\r\n        };\r\n      }\r\n    });\r\n  }\r\n}\n},{\"angular\":\"angular\",\"lodash\":\"lodash\"}],11:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\nrequire(\"angular-material\");\r\nrequire(\"angular-route\");\r\nrequire(\"angular-ui-router\");\r\nrequire(\"angular-local-storage\");\r\nrequire(\"ng-file-upload\");\r\n\r\nvar _ = require(\"lodash\");\r\n\r\nangular\r\n  .module(\"debtApp\", [\"ngMaterial\", \"ui.router\", \"LocalStorageModule\", \"ngFileUpload\"])\r\n  .constant(\"events\", {\r\n    BALANCE_SHEET_UPDATED: \"balance sheet updated\",\r\n    ERROR: \"error\"\r\n  })\r\n  .constant(\"debtCalculationInterval\", 500)\r\n  .config(configureLocalStorage)\r\n  .config(configureIcons)\r\n  .config(hrefSanitization)\r\n  .config(decorateExceptionHandler)\r\n  .run(makeStateAvailableInScope)\r\n  .run(makeMdMediaAvailableInScope)\r\n;\r\n\r\nrequire(\"./debt-app-ctrl\");\r\nrequire(\"./route-config\");\r\nrequire(\"./debts\");\r\nrequire(\"./balance-sheet\");\r\nrequire(\"./persons\");\r\nrequire(\"./expenses\");\r\nrequire(\"./utils\");\r\nrequire(\"./currencies\");\r\n\r\nvar CurrencyConversionError = require(\"./balance-sheet/currency-conversion-error\");\r\n\r\nfunction configureLocalStorage(localStorageServiceProvider) {\r\n  localStorageServiceProvider.setPrefix(\"debtApp\");\r\n}\r\n\r\nfunction configureIcons($mdIconProvider) {\r\n  \r\n  var spriteNames = ['action', 'alert', 'content', 'navigation', 'editor'];\r\n  \r\n  var spriteProps = _.map(spriteNames, function(name) {\r\n    var fileName = 'svg-sprite-' + name + '.svg';\r\n    return {\r\n      filePath: 'resources/icons/' + fileName,\r\n      spriteName: name\r\n    };\r\n  });\r\n\r\n  _.each(spriteProps, function(prop) {\r\n    $mdIconProvider.iconSet(prop.spriteName, prop.filePath);\r\n  });\r\n\r\n}\r\n\r\nfunction hrefSanitization($compileProvider) {\r\n  $compileProvider.aHrefSanitizationWhitelist(/^(blob||https?):/);\r\n}\r\n\r\nfunction decorateExceptionHandler($provide, events) {\r\n  $provide.decorator('$exceptionHandler', function($delegate, $log, $injector) {\r\n    return function(exception, cause) {\r\n      $delegate(exception, cause);\r\n\r\n      var $rootScope = $injector.get('$rootScope');\r\n      $rootScope.$broadcast(events.ERROR, exception, cause);\r\n\r\n      if (exception instanceof CurrencyConversionError) {\r\n        var $state = $injector.get('$state');\r\n        $state.go(\"currencies\");\r\n      }\r\n\r\n    };\r\n  });\r\n}\r\n\r\n// Injection of $state may trigger a GET, which can show as an \r\n// \"Unexpected request\" error in your test. Workaround is to \r\n// $provide a mock $state to Angular.\r\nfunction makeStateAvailableInScope($rootScope, $state, $stateParams) {\r\n  $rootScope.$state = $state;\r\n  $rootScope.$stateParams = $stateParams;\r\n}\r\n\r\nfunction makeMdMediaAvailableInScope($rootScope, $mdMedia) {\r\n  $rootScope.$mdMedia = $mdMedia;\r\n}\n},{\"./balance-sheet\":5,\"./balance-sheet/currency-conversion-error\":4,\"./currencies\":8,\"./debt-app-ctrl\":10,\"./debts\":14,\"./expenses\":19,\"./persons\":22,\"./route-config\":25,\"./utils\":30,\"angular\":\"angular\",\"angular-local-storage\":\"angular-local-storage\",\"angular-material\":\"angular-material\",\"angular-route\":\"angular-route\",\"angular-ui-router\":\"angular-ui-router\",\"lodash\":\"lodash\",\"ng-file-upload\":\"ng-file-upload\"}],12:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\nvar _ = require(\"lodash\");\r\n\r\nangular\r\n  .module(\"debtApp\")\r\n    .factory(\"debtService\", debtService);\r\n\r\n\r\nfunction debtService(solveDebts) {\r\n  \r\n  return {\r\n    computeDebts: computeDebts,\r\n    organizeByDebtor: organizeByDebtor\r\n  };\r\n  \r\n  /////////////////////////////////////////\r\n\r\n  function computeDebts(participations, currency) {\r\n    if (currency !== undefined) {\r\n      participations = _.map(participations, function(p) {\r\n        return {\r\n          person: p.person,\r\n          expense: p.expense,\r\n          paid: p.getPaid(currency, {strictConversion: true}),\r\n          share: p.getShare(currency, {strictConversion: true})\r\n        };\r\n      });\r\n    }\r\n\r\n    var debts = solveDebts(participations);\r\n\r\n    if (currency !== undefined) {\r\n      debts = _.map(debts, function(debt) {\r\n        return _.extend(debt, {currency: currency});\r\n      });\r\n    }\r\n\r\n    return debts;\r\n  } \r\n  \r\n  function organizeByDebtor(debts) {\r\n    var debtorList = [];\r\n    var debtorIndices = {};\r\n    \r\n    _.each(debts, function(d) {\r\n      var debtorIndex = debtorIndices[d.debtor.id];\r\n      var debtor;\r\n      if (debtorIndex === undefined) {\r\n        debtorIndex = debtorList.length;\r\n        debtor = {debtor: d.debtor, debts: []};\r\n        debtorList.push(debtor);\r\n        debtorIndices[d.debtor.id] = debtorIndex;\r\n      }\r\n      debtor = debtorList[debtorIndex];\r\n      debtor.debts.push(_.omit(d, \"debtor\")) ;\r\n    });\r\n\r\n    _.each(debtorList, function(d) {\r\n      d.debts.sort(function(d1, d2) {\r\n        return d1.creditor.name.localeCompare(d2.creditor.name);\r\n      });\r\n    });\r\n    debtorList.sort(function(d1, d2) {\r\n      return d1.debtor.name.localeCompare(d2.debtor.name);\r\n    });\r\n    \r\n    return debtorList;\r\n  }\r\n  \r\n}\n},{\"angular\":\"angular\",\"lodash\":\"lodash\"}],13:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\nvar Decimal = require(\"simple-decimal-money\");\r\nvar Random = require(\"random-js\");\r\nvar _ = require(\"lodash\");\r\n\r\nangular\r\n  .module(\"debtApp\")\r\n    .factory(\"solveDebts\", debtSolverFactory);\r\n\r\n\r\n\r\n\r\n/**\r\n * A function that computes debts from given expense participations.\r\n *\r\n * The input is an array of Participation objects in a BalanceSheet.\r\n *\r\n * Returns an array of debts:\r\n * [{debtor: <a Person object>, creditor: <a Person object>, amount: <float; how much the debtor owes the creditor>}, ...]\r\n *\r\n * We form a linear system Ax = b. A is a binary matrix with size (d+c)*(d*c),\r\n * where d is the number of debtors and c is the number of creditors. Columns of A \r\n * are ordered so that x[c*i + j] is the value of the debt owed by debtor i to creditor j.\r\n * \r\n * Elements of b are balances - converted to non-negative - of the debtors and the creditors \r\n * with the following correspondence:\r\n * \r\n * b[0]: first debtor\r\n * ... \r\n * b[d-1]: last debtor\r\n * b[d] = first creditor\r\n * ... \r\n * b[d+c-1] = last creditor\r\n * \r\n * The coefficient matrix A is constructed so that for each person i, we have equation\r\n * where total value of debts to paid by i (if i is a debtor) or to i (if i is a creditor) equals i's \r\n * non-negative balance.\r\n * \r\n * Rows of A indexed between [0, d-1] represent the debtors in the order \r\n * of debtors> list. Rows of A indexed between [d, d+c-1] represent the \r\n * creditors in the order of creditors list.\r\n * \r\n * Ideally, we would like to find the sparsest (most 0's) solution x to Ax = b\r\n * in case the system is underdetermined and has an infinite number of solutions.\r\n * \r\n * This problem, posed as min ||x||_0  s.t. Ax = b, x >= 0, where ||x||_0 is the number\r\n * of non-zero elements, is in general an NP-hard problem. There is some amount of literature\r\n * about the problem (keywords: sparse nonnegative solution of underdetermined linear equations).\r\n * The problem is usually approximated as convex optimization problem by minimizing L1-norm (sum of \r\n * absolute value) instead. One option could be to use the cassowary javascript library.\r\n * \r\n * In this function we find a non-negative x using Gaussian elimination and setting random combinations \r\n * of free variables to zero until we find a non-negative solution.\r\n */\r\nfunction debtSolverFactory(solveLinearSystem) {\r\n  \r\n  return solve;\r\n  \r\n  \r\n  function solve(participations) {\r\n    if (!participations || participations.length === 0) {\r\n      return [];\r\n    }\r\n\r\n    var balances = computeBalances(participations);\r\n    if (isEveryoneBalanced(balances)) {\r\n      return [];\r\n    }\r\n\r\n    if (!isSystemBalanced(balances)) {\r\n      throw new Error(\"Debt system is not balanced\");\r\n    }\r\n\r\n    var roles = getDebtorsAndCreditors(balances);\r\n    var linearSystem = createDebtEquations(roles);\r\n    var debtVector = solveDebts(linearSystem);\r\n    return createDebts(debtVector, roles);\r\n  }\r\n  \r\n  function computeBalances(participations) {\r\n    var balances = {};\r\n    angular.forEach(participations, function(p) {\r\n      var b = balances[p.person.id];\r\n      if (b === undefined) {\r\n        b = {person: p.person, balance: new Decimal(0)};\r\n        balances[p.person.id] = b;\r\n      }\r\n      var paid = new Decimal(p.paid);\r\n      var share = new Decimal(p.share);\r\n      b.balance = b.balance.add(share.subtract(paid));\r\n    });\r\n\r\n    angular.forEach(balances, function(b) {\r\n      b.balance = b.balance.toNumber();\r\n    });\r\n    \r\n    return balances;\r\n  }\r\n  \r\n  function isEveryoneBalanced(balances) {\r\n    return _.every(balances, {balance: 0});\r\n  }\r\n\r\n  function isSystemBalanced(balances) {\r\n    return _.reduce(balances, function(sum, b) {\r\n        return sum.add(b.balance);\r\n    }, new Decimal(0)).toNumber() === 0;\r\n  }\r\n  \r\n  function getDebtorsAndCreditors(balances) {\r\n    var debtors = [];\r\n    var creditors = [];\r\n    \r\n    angular.forEach(balances, function(b) {\r\n      if (b.balance <= 0) {\r\n        creditors.push(b);\r\n      } else {\r\n        debtors.push(b);\r\n      }\r\n    });\r\n    \r\n    return {\r\n      debtors: debtors,\r\n      creditors: creditors\r\n    };\r\n  }\r\n  \r\n  function createDebtEquations(roles) {\r\n    var d = roles.debtors.length;\r\n    var c = roles.creditors.length;\r\n    \r\n    // Right-hand side vector, creditor balances converted to non-negative to allow binary coefficients\r\n    var b = [];\r\n    _.each(roles.debtors, function(debtor, i) {\r\n      b[i] = (new Decimal(debtor.balance)).multiply(100).toNumber();\r\n    });\r\n    _.each(roles.creditors, function(creditor, i) {\r\n      b[d + i] = (new Decimal(creditor.balance)).multiply(-100).toNumber();\r\n    });\r\n    \r\n    // Coefficient matrix\r\n    var A = initMatrix(d + c, d*c); \r\n    \r\n    // Coefficients of equations \"sum of debts paid by debtor = debtor's balance\"\r\n    for (var i = 0; i < d; i++) {\r\n      for (var j = i*c; j < (i+1)*c; j++) {\r\n        A[i][j] = 1;\r\n      }\r\n    }\r\n    \r\n    // Coefficients of equations \"sum debts received by creditor = creditor's balance\"\r\n    for (var i = d; i < c+d; ++i) {\r\n      for (var j = (i-d); j < d*c; j += c) {\r\n        A[i][j] = 1;\r\n      }\r\n    } \r\n    \r\n    return {\r\n      A: A,\r\n      b: b\r\n    };\r\n  }\r\n  \r\n  function initMatrix(rows, cols) {\r\n    var A = [];\r\n    for (var i = 0; i < rows; i++) {\r\n      A[i] = [];\r\n      for (var j = 0; j < cols; j++) {\r\n        A[i][j] = 0;\r\n      }\r\n    }\r\n    return A;\r\n  }\r\n  \r\n  // Solve debts, ensuring a non-negative solution \r\n  function solveDebts(linearSystem) {\r\n    var solution = solveLinearSystem(linearSystem);\r\n    if (solution.numberOfSolutions === 0) {\r\n      throw new Error(\"Debt system has no solutions\");\r\n    }\r\n\r\n\r\n    var numVars = solution.numberOfVariables;\r\n    var numFreeVars = solution.numberOfFreeVariables;\r\n    \r\n    if (numFreeVars === 0) {\r\n      return solution.xVector;\r\n    }\r\n\r\n    // Known seed so we always get the same result from\r\n    // the same system.\r\n    var randomEngine = Random.engines.mt19937();\r\n    randomEngine.seed(20150312);\r\n\r\n    var toEliminate;\r\n    do {\r\n      \r\n      var A = angular.copy(linearSystem.A);\r\n      var b = linearSystem.b;\r\n      \r\n      // Pick random numFreeVars variables for elimination\r\n      \r\n      var candidates = [];\r\n      for (var i = 0; i < numVars; i++) {\r\n        candidates[i] = i;\r\n      }\r\n      \r\n      toEliminate = [];\r\n      for (var i = 0; i < numFreeVars; i++) {\r\n        var candidateIdx = Random.integer(0, candidates.length-1)(randomEngine);\r\n        toEliminate.push(candidates[candidateIdx]);\r\n        candidates.splice(candidateIdx, 1);\r\n      }\r\n      \r\n      // Eliminate the chosen variables by setting their coefficients to zero\r\n      \r\n      for (var i = 0; i < A.length; i++) {\r\n        for (var j = 0; j < toEliminate.length; j++) {\r\n          A[i][toEliminate[j]] = 0;\r\n        }\r\n      }\r\n\r\n      // Solve the updated system\r\n      \r\n      solution = solveLinearSystem({A: A, b: b});\r\n      \r\n    } while (!isNonNegative(solution.xVector));\r\n\r\n    \r\n    return solution.xVector;\r\n  }\r\n  \r\n  function isNonNegative(vector) {\r\n    if (!vector) {\r\n      return false;\r\n    }\r\n    for (var i = 0; i < vector.length; i++) {\r\n      if (vector[i] < 0) {\r\n        return false;\r\n      }\r\n    }\r\n    return true;\r\n  }\r\n  \r\n  function createDebts(debtVector, roles) {\r\n    var debts = [];\r\n\r\n    for (var i = 0; i < debtVector.length; i++) {\r\n      if (debtVector[i] !== 0) {\r\n        var debtorIdx = Math.floor(i/roles.creditors.length);\r\n        var creditorIdx = i - roles.creditors.length*debtorIdx;\r\n        var amount = (new Decimal(debtVector[i])).divideBy(100).toNumber();\r\n        var debt = {debtor: roles.debtors[debtorIdx].person, creditor: roles.creditors[creditorIdx].person, amount: amount};\r\n        debts.push(debt);\r\n      }\r\n    }\r\n    \r\n    return debts;\r\n  }\r\n}  \n},{\"angular\":\"angular\",\"lodash\":\"lodash\",\"random-js\":\"random-js\",\"simple-decimal-money\":\"simple-decimal-money\"}],14:[function(require,module,exports){\n\"use strict\";\r\n\r\nrequire(\"./lin-eq-solver\");\r\nrequire(\"./lin-eq-solver-factory\");\r\nrequire(\"./debt-solver\");\r\nrequire(\"./debt-service\");\n},{\"./debt-service\":12,\"./debt-solver\":13,\"./lin-eq-solver\":16,\"./lin-eq-solver-factory\":15}],15:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar solve = require(\"./lin-eq-solver\");\r\nvar angular = require(\"angular\");\r\n\r\nangular.module(\"debtApp\")\r\n.factory(\"solveLinearSystem\", solveLinearSystem);\r\n\r\nfunction solveLinearSystem() {\r\n  return solve;\r\n}\n},{\"./lin-eq-solver\":16,\"angular\":\"angular\"}],16:[function(require,module,exports){\n\"use strict\";\r\n\r\n\r\nfunction solve(input) {\r\n\t// Internal copies of the linear system and its dimensions\r\n\tvar coefMatrix, constVector, xVector;\r\n\tvar m, n, rank, numberOfSolutions;\r\n\t\r\n\t// With these we can \"virtually\" rearrange the rows and columns\r\n\t// for better numerical stability in the variable elimination phases.\r\n\t// At step i, row index pivotToEquationMap[i] is the pivot equation and\r\n\t// it is used for eliminating variable index pivotToVariableMap[i] from all the\r\n\t// other equations.\r\n\tvar pivotToEquationMap, pivotToVariableMap, equationScale;\r\n\t\r\n\tvalidate();\r\n\tinitialize();\r\n\ttransformToRowEchelonForm();\r\n\treduceRowEchelonForm();\r\n\tdetermineRank();\r\n\tdetermineNumberOfSolutions();\r\n\tdetermineSolution();\r\n\r\n\treturn {\r\n\t\txVector: xVector,\r\n\t\tnumberOfEquations: m,\r\n\t\tnumberOfVariables: n,\r\n\t\trank: rank,\r\n\t\tnumberOfFreeVariables: n - rank,\r\n\t\tnumberOfSolutions: numberOfSolutions\r\n\t};\r\n\t\r\n\t/////////////////////////////////////////////////////////////\r\n\t\r\n\tfunction validate() {\r\n    \tif (!input || !input.A || !input.b) {\r\n    \t\tthrow new TypeError(\"Null matrix A or vector b in system Ax = b\");\r\n    \t}\r\n    \t\r\n    \tif (input.A.length < 1 || input.A[0].length < 1) {\r\n    \t\tthrow new TypeError(\"Matrix A in Ax = b has no rows or no columns\");\r\n    \t}\r\n\t\t\r\n    \tif (input.A.length != input.b.length) {\r\n    \t\tthrow new RangeError(\"The dimensions of the matrix and the constant vector are incompatible\");\r\n    \t}\r\n\t}\r\n\r\n\tfunction initialize() {\r\n\t\tcoefMatrix = copyMatrix(input.A);\r\n\t\tconstVector = copyArray(input.b);\r\n\t\t\r\n\t\tm = coefMatrix.length;\r\n\t\tn = coefMatrix[0].length;\r\n\r\n\t\tpivotToEquationMap = [];\r\n\t\tfor (var i = 0; i < m; i++) {\r\n\t\t\tpivotToEquationMap[i] = i;\r\n\t\t}\r\n\t\t\r\n\t\tequationScale = [];\r\n\t\tfor (var i = 0; i < m; i++) {\r\n\t\t\tequationScale[i] = 0;\r\n\t\t\tfor (var j = 0; j < n; j++) {\r\n\t\t\t\tvar abscoef = Math.abs(coefMatrix[i][j]);\r\n\t\t\t\tif (abscoef > equationScale[i]) {\r\n\t\t\t\t\tequationScale[i] = abscoef;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tpivotToVariableMap = [];\r\n\t\tfor (var j = 0; j < n; j++) {\r\n\t\t\tpivotToVariableMap[j] = j;\r\n\t\t}\r\n\t}\r\n\r\n\tfunction transformToRowEchelonForm() {\r\n\t\tvar pivotIdx = 0; \r\n\t\tvar knownFreeVariables = [];\r\n\t\t\r\n\t\twhile (pivotIdx < m-1) { \r\n\r\n\t\t\t// Choose the best pivot-equation for eliminating variable pivotToVariableMap[pivotIdx] \r\n\t\t\t// from equations equations not yet used as pivot equations.\r\n\t\t\tvar maxRatio = 0;\r\n\t\t\tvar bestPivotEquationIndex = pivotIdx;\r\n\t\t\tfor (var i = pivotIdx; i < m; ++i) {\r\n\t\t\t\tvar rowIdx = pivotToEquationMap[i];\r\n\t\t\t\tvar colIdx = pivotToVariableMap[pivotIdx];\r\n\t\t\t\tvar ratio = Math.abs(coefMatrix[rowIdx][colIdx]/equationScale[rowIdx]);\r\n\t\r\n\t\t\t\tif (ratio > maxRatio) {\r\n\t\t\t\t\tmaxRatio = ratio;\r\n\t\t\t\t\tbestPivotEquationIndex = i;\t\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t// If maxRatio == 0, the coefficient of variable pivotToVariableMap[pivotIdx] is 0 in all the rest of the equations. \r\n\t\t\t// That is pivotToVariableMap[pivotIdx] is a free variable. Find the next suitable variable.\r\n\t\t\tif (maxRatio === 0) {\r\n\t\t\t\tvar currPivotVaribleIdx = pivotToVariableMap[pivotIdx];\r\n\t\t\t\tknownFreeVariables[currPivotVaribleIdx] = true;     \r\n\t\t\t\t\r\n\t\t\t\t// The next one must not be a free variable.\r\n\t\t\t\tvar i = pivotIdx;\r\n\t\t\t\tvar newPivotVariableIdx = currPivotVaribleIdx;\r\n\t\t\t\twhile (newPivotVariableIdx == currPivotVaribleIdx && i < n-1) {\r\n\t\t\t\t\t++i;\r\n\t\t\t\t\tif (!knownFreeVariables[pivotToVariableMap[i]]) {\r\n\t\t\t\t\t\tnewPivotVariableIdx = pivotToVariableMap[i];\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (newPivotVariableIdx != currPivotVaribleIdx) {\r\n\t\t\t\t\tpivotToVariableMap[pivotIdx] = newPivotVariableIdx;\r\n\t\t\t\t\tpivotToVariableMap[i] = currPivotVaribleIdx;\r\n\t\t\t\t\tcontinue;\r\n\t\t\t\t} else { \r\n\t\t\t\t\t// Could not find a suitable variable. This means the row echelon form is ready.\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\r\n\t\t\tvar temp = pivotToEquationMap[pivotIdx];\r\n\t\t\tpivotToEquationMap[pivotIdx] = pivotToEquationMap[bestPivotEquationIndex];\r\n\t\t\tpivotToEquationMap[bestPivotEquationIndex] = temp;     \r\n\t\t\t\r\n\t\t\t// Elimination phase\r\n\t\t\tvar pivotRowIdx = pivotToEquationMap[pivotIdx];\r\n\t\t\tvar pivotColIdx = pivotToVariableMap[pivotIdx];\r\n\t\t\tfor (i = pivotIdx + 1; i < m; ++i) {\r\n\t\t\t\tvar rowIdx = pivotToEquationMap[i];\r\n\t\t\t\tvar mult = coefMatrix[rowIdx][pivotColIdx] / coefMatrix[pivotRowIdx][pivotColIdx];\r\n\r\n\t\t\t\tfor (var j = pivotIdx + 1; j < n; ++j) {\r\n\t\t\t\t\tvar colIndex = pivotToVariableMap[j];\r\n\t\t\t\t\tcoefMatrix[rowIdx][colIndex] = coefMatrix[rowIdx][colIndex] - mult * coefMatrix[pivotRowIdx][colIndex];\r\n\t\t\t\t}\r\n\r\n\t\t\t\tcoefMatrix[rowIdx][pivotColIdx] = 0;\r\n\t\t\t\tconstVector[rowIdx] = constVector[rowIdx] - mult * constVector[pivotRowIdx];\r\n\t\t\t}\r\n\r\n\t\t\tpivotIdx++;\r\n\t\t\t\r\n\t\t}\r\n\t}\r\n\r\n\tfunction reduceRowEchelonForm() {\r\n\t\t// Eliminate pivot variables from previous pivot equations by going through the pivot steps in reverse order.\r\n\t\tvar pivotIndex;\r\n\t\tfor (pivotIndex = Math.min(m, n) - 1; pivotIndex > 0; --pivotIndex) {\r\n\t\t\tvar pivotRowIdx = pivotToEquationMap[pivotIndex];\r\n\t\t\tvar pivotColIdx = pivotToVariableMap[pivotIndex];\r\n\t\t\t\r\n\t\t\tif (coefMatrix[pivotRowIdx][pivotColIdx] === 0) {\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tfor (var i = pivotIndex - 1; i > -1; --i) {\r\n\t\t\t\t\r\n\t\t\t\tvar mult = coefMatrix[pivotToEquationMap[i]][pivotToVariableMap[pivotIndex]]/coefMatrix[pivotToEquationMap[pivotIndex]][pivotToVariableMap[pivotIndex]];\r\n\t\t\t\tfor (var j = 0; j < n; ++j) {\r\n\t\t\t\t\tcoefMatrix[pivotToEquationMap[i]][pivotToVariableMap[j]] -= mult*coefMatrix[pivotToEquationMap[pivotIndex]][pivotToVariableMap[j]];\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tconstVector[pivotToEquationMap[i]] -= mult*constVector[pivotToEquationMap[pivotIndex]];\r\n\t\t\t}            \t\t\r\n\t\t}\r\n\t\t\r\n\t\t// Normalize the coeffients in each row and the rhs value by the coeffient of the pivot variable in the row\r\n\t\tfor (pivotIndex = 0; pivotIndex < Math.min(m, n); ++pivotIndex) {\r\n\t\t\t\r\n\t\t\tif (coefMatrix[pivotToEquationMap[pivotIndex]][pivotToVariableMap[pivotIndex]] === 0) {\r\n\t\t\t\tcontinue; \r\n\t\t\t}\r\n\r\n\t\t\tvar div = coefMatrix[pivotToEquationMap[pivotIndex]][pivotToVariableMap[pivotIndex]];\r\n\t\t\tfor (var j = 0; j < n; ++j) {\r\n\t\t\t\tcoefMatrix[pivotToEquationMap[pivotIndex]][j] = coefMatrix[pivotToEquationMap[pivotIndex]][j]/div;\r\n\t\t\t}\r\n\t\t\tconstVector[pivotToEquationMap[pivotIndex]] = constVector[pivotToEquationMap[pivotIndex]]/div;\r\n\t\t}\r\n\t\t\r\n\t}\r\n\r\n\tfunction determineRank() {\r\n\t\trank = 0;\r\n\t\tvar i,j;\r\n\t\t\r\n\t\tcolumns: \r\n\t\tfor (j=0; j<n; ++j) {\r\n\t\t\trows:\r\n\t\t\tfor (i=0; i<m; ++i) { \r\n\t\t\t\tif (i != j && coefMatrix[pivotToEquationMap[i]][pivotToVariableMap[j]] !== 0) {\r\n\t\t\t\t\tbreak columns;\r\n\t\t\t\t}\r\n\t\t\t\telse if (i == j && coefMatrix[pivotToEquationMap[i]][pivotToVariableMap[j]] != 1) {\r\n\t\t\t\t\tbreak columns;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t++rank;\r\n\t\t}\r\n\t}\r\n\r\n\tfunction determineNumberOfSolutions() {\r\n\t\t\r\n\t\tvar b2IsZero = true;\r\n\r\n\t\tfor (var i = rank; i < m; ++i) {\r\n\t\t\tif (constVector[pivotToEquationMap[i]] !== 0) {\r\n\t\t\t\tb2IsZero = false;\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tif (rank < m && !b2IsZero) {\r\n\t\t\tnumberOfSolutions = 0;\r\n\t\t} else if (rank == n && (rank == m || b2IsZero)) {\r\n\t\t\tnumberOfSolutions = 1;\r\n\t\t} else if (rank < n && (rank == m || b2IsZero)) {\r\n\t\t\tnumberOfSolutions = Number.MAX_VALUE;\r\n\t\t}\r\n\t}\r\n\r\n\tfunction determineSolution() {\r\n\t\tif (numberOfSolutions === 0) {\r\n\t\t\txVector = undefined;\r\n\t\t} else {\r\n\t\t\txVector = initArray(n);\r\n\t\t\tfor (var i = 0; i < rank; ++i) {\r\n\t\t\t\txVector[pivotToVariableMap[i]] = constVector[pivotToEquationMap[i]];\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction initArray(size) {\r\n\t\tvar array = [];\r\n\t\tfor (var i = 0; i < size; i++) {\r\n\t\t\tarray[i] = 0;\r\n\t\t}\r\n\t\treturn array;\r\n\t}\r\n\t\r\nfunction copyArray(input) {\r\n\treturn input.slice();\r\n}\r\n\r\nfunction copyMatrix(input) {\r\n\tvar copy = [];\r\n\tfor (var i = 0; i < input.length; i++) {\r\n\t\tcopy[i] = input[i].slice();\r\n\t}\r\n\treturn copy;\r\n}\r\n\t\r\n\r\nmodule.exports = solve;\n},{}],17:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\n\r\nangular.module(\"debtApp\")\r\n.factory(\"openCreateExpenseDialog\", openCreateExpenseDialog);\r\n\r\n\r\nfunction openCreateExpenseDialog($mdDialog) {\r\n  \r\n  return open;\r\n  \r\n  function open() {\r\n    return $mdDialog.show({\r\n      templateUrl: \"expenses/create-expense-dialog.html\",\r\n      controller: DialogController,\r\n      controllerAs: \"vm\"\r\n    });\r\n  }\r\n  \r\n}\r\n\r\nfunction DialogController($mdDialog) {\r\n  var vm = this;\r\n  \r\n  vm.ok = ok;\r\n  vm.cancel = cancel;\r\n  vm.init = init;\r\n  \r\n  init();\r\n  \r\n  \r\n  function init() {\r\n    vm.expense = {\r\n      name: undefined,\r\n      sharing: \"equal\"\r\n    };\r\n    vm.options = {\r\n      createParticipations: true\r\n    };\r\n  }\r\n\r\n  function ok() {\r\n    $mdDialog.hide({expense: vm.expense, options: vm.options});\r\n  }\r\n  \r\n  function cancel() {\r\n    $mdDialog.cancel();\r\n  }\r\n}\n},{\"angular\":\"angular\"}],18:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar _ = require('lodash');\r\nvar angular = require(\"angular\");\r\n\r\nangular\r\n  .module(\"debtApp\")\r\n  .controller(\"ExpenseDetailCtrl\", ExpenseDetailCtrl);\r\n\r\nfunction ExpenseDetailCtrl(balanceSheetService,\r\n                           debtService,\r\n                           events,\r\n                           debounce,\r\n                           debtCalculationInterval,\r\n                           $mdDialog,\r\n                           $stateParams,\r\n                           $state,\r\n                           $scope,\r\n                           $timeout)\r\n{\r\n  var vm = this;\r\n\r\n  var confirmRemoveExpense = $mdDialog.confirm()\r\n    .content(\"Really delete this expense?\")\r\n    .ok(\"Ok\").cancel(\"Cancel\");\r\n\r\n  var computeDebtsDebounced = debounce(function() {\r\n    $timeout(function() {\r\n      vm.debtsByDebtor = computeDebts();\r\n    });\r\n  }, debtCalculationInterval);\r\n\r\n  vm.init = init;\r\n  vm.setParticipation = setParticipation;\r\n  vm.updateExpense = updateExpense;\r\n  vm.removeExpense = removeExpense;\r\n  vm.setCurrency = setCurrency;\r\n\r\n  init();\r\n\r\n  /////////////////////////////////////////////////////////////\r\n\r\n  function init() {\r\n    vm.balanceSheet = balanceSheetService.balanceSheet;\r\n    vm.expense = vm.balanceSheet.getExpense($stateParams.id);\r\n    vm.isParticipant = {};\r\n    vm.everyoneParticipates = true;\r\n    updateExpense();\r\n\r\n    $scope.$on(events.BALANCE_SHEET_UPDATED, function(event) {\r\n      if (event.targetScope != $scope) {\r\n        vm.updateExpense();\r\n      }\r\n    });\r\n  }\r\n\r\n  function updateExpense() {\r\n    vm.expense.shareCost();\r\n    vm.isParticipant = getParticipationMap();\r\n    vm.cost = vm.expense.getCost();\r\n    vm.sumOfShares = vm.expense.getSumOfShares();\r\n    vm.isBalanced = vm.expense.isBalanced();\r\n    $scope.$emit(events.BALANCE_SHEET_UPDATED);\r\n    computeDebtsDebounced();\r\n  }\r\n\r\n  function getParticipationMap() {\r\n    var map = {};\r\n\r\n    angular.forEach(vm.balanceSheet.persons, function(person) {\r\n      map[person.id] = false;\r\n      angular.forEach(vm.expense.getParticipations(), function(p) {\r\n        if (p.person.equals(person)) {\r\n          map[person.id] = true;\r\n        }\r\n      });\r\n    });\r\n\r\n    return map;\r\n  }\r\n\r\n  function setParticipation(person, isParticipant) {\r\n    if (isParticipant) {\r\n      vm.balanceSheet.createParticipation({expense: vm.expense, person: person});\r\n    } else {\r\n      vm.balanceSheet.removeParticipation({expense: vm.expense, person: person});\r\n    }\r\n    updateExpense();\r\n  }\r\n\r\n  function removeExpense() {\r\n    $mdDialog.show(confirmRemoveExpense)\r\n      .then(doRemoveExpense);\r\n  }\r\n\r\n  function doRemoveExpense() {\r\n    vm.balanceSheet.removeExpense(vm.expense);\r\n    $scope.$emit(events.BALANCE_SHEET_UPDATED);\r\n    $state.go(\"balanceSheet\");\r\n  }\r\n\r\n  function computeDebts() {\r\n    if (vm.expense.isBalanced()) {\r\n      var debts = debtService.computeDebts(vm.expense.getParticipations(), vm.expense.computedCurrency());\r\n      return debtService.organizeByDebtor(debts);\r\n    }\r\n  }\r\n\r\n  function setCurrency(currency) {\r\n    vm.expense.currency = currency;\r\n    $scope.$emit(events.BALANCE_SHEET_UPDATED);\r\n  }\r\n\r\n\r\n}\r\n\n},{\"angular\":\"angular\",\"lodash\":\"lodash\"}],19:[function(require,module,exports){\n\"use strict\";\r\n\r\nrequire(\"./route-config\");\r\nrequire(\"./expense-detail-ctrl\");\r\nrequire(\"./create-expense-dialog\");\n},{\"./create-expense-dialog\":17,\"./expense-detail-ctrl\":18,\"./route-config\":20}],20:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\n\r\nangular.module(\"debtApp\")\r\n\t.config(config);\r\n\r\nfunction config($stateProvider) {\r\n\r\n\t$stateProvider\r\n\t\t.state(\"expense\", {\r\n\t\t\turl: \"/expenses/:id\",\r\n\t\t\tviews: {\r\n\t\t\t\t\"\": {\r\n\t\t\t\t\ttemplateUrl: \"expenses/expense-detail.html\",\r\n\t\t\t\t\tcontroller: \"ExpenseDetailCtrl as vm\"\r\n\t\t\t\t},\r\n\t\t\t\t\"floatingButton\": {\r\n\t\t\t\t\ttemplateUrl: \"expenses/floating-button.html\"\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t})\r\n\t\t;\r\n}\n},{\"angular\":\"angular\"}],21:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\n\r\nangular.module(\"debtApp\")\r\n.factory(\"openCreatePersonDialog\", openCreatePersonDialog);\r\n\r\n\r\nfunction openCreatePersonDialog($mdDialog) {\r\n  \r\n  return open;\r\n  \r\n  function open() {\r\n    return $mdDialog.show({\r\n      templateUrl: \"persons/create-person-dialog.html\",\r\n      controller: DialogController,\r\n      controllerAs: \"vm\"\r\n    });\r\n  }\r\n  \r\n}\r\n\r\nfunction DialogController($mdDialog) {\r\n  var vm = this;\r\n  \r\n  vm.ok = ok;\r\n  vm.cancel = cancel;\r\n  vm.init = init;\r\n  \r\n  init();\r\n  \r\n  \r\n  function init() {\r\n    vm.person = {\r\n      name: undefined\r\n    };\r\n    vm.options = {\r\n      createParticipations: true\r\n    };\r\n  }\r\n\r\n  function ok() {\r\n    $mdDialog.hide({person: vm.person, options: vm.options});\r\n  }\r\n  \r\n  function cancel() {\r\n    $mdDialog.cancel();\r\n  }\r\n}\n},{\"angular\":\"angular\"}],22:[function(require,module,exports){\n\"use strict\";\r\n\r\nrequire(\"./route-config\");\r\nrequire(\"./person-detail-ctrl\");\r\nrequire(\"./create-person-dialog\");\n},{\"./create-person-dialog\":21,\"./person-detail-ctrl\":23,\"./route-config\":24}],23:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\nvar _ = require('lodash');\r\n\r\nangular.module(\"debtApp\")\r\n  .controller(\"PersonDetailCtrl\", PersonDetailCtrl);\r\n\r\nfunction PersonDetailCtrl(balanceSheetService,\r\n                          debtService,\r\n                          events,\r\n                          debounce,\r\n                          debtCalculationInterval,\r\n                          $state,\r\n                          $stateParams,\r\n                          $mdDialog,\r\n                          $scope,\r\n                          $timeout,\r\n                          $log) {\r\n\r\n  var vm = this;\r\n  var confirmRemovePerson;\r\n\r\n  var computeDebtsDebounced = debounce(function() {\r\n    $timeout(function() {\r\n      try {\r\n        var debtResult = computeDebts();\r\n        vm.debtRole = debtResult.role;\r\n        vm.debts = debtResult.debts;\r\n        vm.debtComputationError = undefined;\r\n      } catch (e) {\r\n        $log.error(e);\r\n        vm.debtRole = undefined;\r\n        vm.debts = undefined;\r\n        vm.debtComputationError = \"Cannot compute debts\";\r\n      }\r\n    });\r\n  }, debtCalculationInterval);\r\n\r\n  vm.init = init;\r\n  vm.refresh = refresh;\r\n  vm.updateExpense = updateExpense;\r\n  vm.setParticipation = setParticipation;\r\n  vm.removePerson = removePerson;\r\n  vm.updatePerson = updatePerson;\r\n\r\n  init();\r\n\r\n  function init() {\r\n    vm.balanceSheet = balanceSheetService.balanceSheet;\r\n    vm.person = vm.balanceSheet.getPerson($stateParams.id);\r\n\r\n    refresh();\r\n\r\n    confirmRemovePerson = $mdDialog.confirm()\r\n      .content(\"Really delete this person?\")\r\n      .ok(\"Ok\").cancel(\"Cancel\");\r\n\r\n    $scope.$on(events.BALANCE_SHEET_UPDATED, vm.refresh);\r\n  }\r\n\r\n  function refresh() {\r\n    vm.isParticipant = getParticipationMap();\r\n    vm.cost = vm.person.getCost();\r\n    vm.sumOfShares = vm.person.getSumOfShares();\r\n    vm.balance = vm.person.getBalance();\r\n    computeDebtsDebounced();\r\n  }\r\n\r\n  function getParticipationMap() {\r\n    var map = {};\r\n\r\n    _.forEach(vm.balanceSheet.expenses, function(expense) {\r\n      map[expense.id] = false;\r\n      _.forEach(vm.person.getParticipations(), function(pt) {\r\n        if (pt.expense.equals(expense)) {\r\n          map[expense.id] = true;\r\n        }\r\n      });\r\n    });\r\n\r\n    return map;\r\n  }\r\n\r\n  function updateExpense(expense) {\r\n    expense.shareCost();\r\n    refresh();\r\n    $scope.$emit(events.BALANCE_SHEET_UPDATED);\r\n  }\r\n\r\n  function setParticipation(expense, isParticipant) {\r\n    if (isParticipant) {\r\n      vm.balanceSheet.createParticipation({expense: expense, person: vm.person});\r\n    } else {\r\n      vm.balanceSheet.removeParticipation({expense: expense, person: vm.person});\r\n    }\r\n    vm.updateExpense(expense);\r\n  }\r\n\r\n  function computeDebts() {\r\n    var result = {\r\n      role: undefined,\r\n      debts: undefined\r\n    };\r\n\r\n    if (!vm.balanceSheet.isBalanced()) {\r\n      result.role = \"unbalanced\";\r\n      return result;\r\n    }\r\n\r\n    if (vm.balance > 0) {\r\n      result.role = \"debtor\";\r\n    } else if (vm.balance < 0) {\r\n      result.role = \"creditor\";\r\n    } else if (vm.balance === 0) {\r\n      result.role = \"settled\";\r\n      return result;\r\n    }\r\n\r\n    var counterRole = {\r\n      \"debtor\": \"creditor\",\r\n      \"creditor\": \"debtor\"\r\n    };\r\n\r\n    var debts = debtService.computeDebts(vm.balanceSheet.getNonSettledParticipations(), vm.person.computedCurrency());\r\n    result.debts = _.chain(debts)\r\n      .filter(function(d) {\r\n        return d[result.role].equals(vm.person);\r\n      })\r\n      .map(function(d) {\r\n        return {person: d[counterRole[result.role]], amount: d.amount, currency: d.currency};\r\n      })\r\n      .value();\r\n\r\n    return result;\r\n  }\r\n\r\n  function removePerson() {\r\n    $mdDialog.show(confirmRemovePerson)\r\n      .then(doRemovePerson);\r\n  }\r\n\r\n  function doRemovePerson() {\r\n    vm.balanceSheet.removePerson(vm.person);\r\n    $scope.$emit(events.BALANCE_SHEET_UPDATED);\r\n    $state.go(\"balanceSheet\");\r\n  }\r\n\r\n  function updatePerson() {\r\n    $scope.$emit(events.BALANCE_SHEET_UPDATED);\r\n  }\r\n}\r\n\n},{\"angular\":\"angular\",\"lodash\":\"lodash\"}],24:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\n\r\nangular.module(\"debtApp\")\r\n  .config(config);\r\n\r\nfunction config($stateProvider) {\r\n  $stateProvider\r\n    .state(\"person\", {\r\n      url: \"/persons/:id\",\r\n      views: {\r\n        \"\": {\r\n          templateUrl: \"persons/person-detail.html\",\r\n          controller: \"PersonDetailCtrl as vm\"\r\n        },\r\n        \"floatingButton\": {\r\n          templateUrl: \"persons/floating-button.html\"\r\n        }\r\n      }\r\n\r\n    });\r\n}\n},{\"angular\":\"angular\"}],25:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\n\r\nangular.module(\"debtApp\")\r\n\t.config(config);\r\n\r\nfunction config($urlRouterProvider) {\r\n  \r\n  $urlRouterProvider.otherwise(\"/\");\r\n  \r\n}\n},{\"angular\":\"angular\"}],26:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\nvar _ = require('lodash');\r\n\r\nangular.module(\"debtApp\")\r\n  .filter(\"balance\", balance);\r\n\r\n\r\nfunction balance($filter) {\r\n  return function balance(value) {\r\n    if (!_.isNumber(value) || isNaN(value)) {\r\n      return value;\r\n    }\r\n\r\n    if (value > 0) {\r\n      return \"+\" + $filter(\"number\")(value, \"2\");\r\n    } else {\r\n      return $filter(\"number\")(value, \"2\");\r\n    }\r\n  };\r\n}\n},{\"angular\":\"angular\",\"lodash\":\"lodash\"}],27:[function(require,module,exports){\n\"use strict\";\r\n\r\nangular.module(\"debtApp\")\r\n  .factory(\"debounce\", debounceFactory);\r\n\r\n\r\nfunction debounceFactory($timeout) {\r\n\r\n  return debounce;\r\n\r\n  /**\r\n   * Returns a function, that, as long as it continues to be invoked, will not be triggered.\r\n   * The function will be called after it stops being called for N milliseconds.\r\n   *\r\n   * @param {function} func - The function to \"debouncify\"\r\n   * @param {number} [wait=10] - The time to wait (milliseconds) after the last call until func is called\r\n   * @param {Scope} [scope] - Angular scope to call the function in\r\n   * @param {boolean} [invokeApply=false] - Should the function call trigger $digest\r\n   * @returns {function} - The debounced function\r\n   */\r\n  function debounce(func, wait, scope, invokeApply) {\r\n    var timer;\r\n\r\n    return function debounced() {\r\n      var context = scope,\r\n        args = Array.prototype.slice.call(arguments);\r\n\r\n      $timeout.cancel(timer);\r\n      timer = $timeout(function() {\r\n\r\n        timer = undefined;\r\n        func.apply(context, args);\r\n\r\n      }, wait || 10, invokeApply);\r\n    };\r\n  }\r\n\r\n}\r\n\r\n\r\n\n},{}],28:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\nvar fileSaver = require(\"node-safe-filesaver\");\r\nrequire(\"blob-polyfill\");\r\n\r\nangular.module(\"debtApp\")\r\n  .factory(\"fileService\", fileService);\r\n\r\n\r\nfunction fileService($q, $window) {\r\n\r\n  return {\r\n    readAsText: readAsText,\r\n    saveAsFile: saveAsFile,\r\n    isSupported: isSupported\r\n  };\r\n\r\n  function readAsText(blob) {\r\n    var deferred = $q.defer();\r\n\r\n    var reader = new $window.FileReader();\r\n    reader.onload = function() {\r\n      deferred.resolve(reader.result);\r\n    };\r\n    reader.onerror = function() {\r\n      deferred.resolve(reader.error);\r\n    };\r\n    reader.readAsText(blob);\r\n\r\n    return deferred.promise;\r\n  }\r\n\r\n  function saveAsFile(dataArray, fileName) {\r\n    var blob = new $window.Blob(dataArray, {});\r\n    fileSaver.saveAs(blob, fileName);\r\n  }\r\n\r\n  function isSupported() {\r\n    return $window.FileReader && $window.Blob;\r\n  }\r\n}\n},{\"angular\":\"angular\",\"blob-polyfill\":\"blob-polyfill\",\"node-safe-filesaver\":\"node-safe-filesaver\"}],29:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\n\r\nangular.module(\"debtApp\")\r\n  .directive(\"focus\", focus);\r\n\r\n\r\nfunction focus($timeout) {\r\n  return {\r\n    restrict: \"A\",\r\n    link: function($scope, iElem, iAttrs) {\r\n      var focusExpr = iAttrs.focus || 'true';\r\n      $timeout(function() {\r\n        var shouldFocus = $scope.$eval(focusExpr);\r\n        if (shouldFocus) {\r\n          iElem[0].focus();\r\n        }\r\n      }, 0);\r\n    }\r\n  };\r\n}\n},{\"angular\":\"angular\"}],30:[function(require,module,exports){\n\"use strict\";\r\n\r\nrequire(\"./money-input-directive\");\r\nrequire(\"./balance-filter\");\r\nrequire(\"./money-filter\");\r\nrequire(\"./file-service\");\r\nrequire(\"./focus-directive\");\n},{\"./balance-filter\":26,\"./file-service\":28,\"./focus-directive\":29,\"./money-filter\":31,\"./money-input-directive\":32}],31:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\nvar _ = require('lodash');\r\n\r\n\r\nangular.module(\"debtApp\")\r\n  .filter(\"money\", money);\r\n\r\n\r\nfunction money($filter) {\r\n  return function money(value) {\r\n    if (!_.isNumber(value) || isNaN(value)) {\r\n      return value;\r\n    }\r\n\r\n    return $filter(\"number\")(value, \"2\");\r\n  };\r\n}\n},{\"angular\":\"angular\",\"lodash\":\"lodash\"}],32:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\nvar Decimal = require(\"simple-decimal-money\");\r\n\r\nangular.module(\"debtApp\")\r\n  .directive(\"moneyInput\", moneyInput);\r\n\r\n\r\nfunction moneyInput($filter) {\r\n  return {\r\n    restrict: \"A\",\r\n    require: \"ngModel\",\r\n    link: link\r\n  };\r\n\r\n  function link($scope, iElem, iAttrs, ngModel) {\r\n    ngModel.$validators.money = validateMoney;\r\n    ngModel.$parsers.push(parseMoney);\r\n    ngModel.$formatters.unshift(formatMoney);\r\n\r\n    iElem.on(\"blur\", handleBlur);\r\n    ngModel.$render = render;\r\n\r\n    function render() {\r\n      if (ngModel.$valid) {\r\n        iElem.val(formatMoney(ngModel.$modelValue));\r\n      } else {\r\n        iElem.val(ngModel.$viewValue);\r\n      }\r\n    }\r\n\r\n    function handleBlur() {\r\n      ngModel.$render();\r\n    }\r\n  }\r\n\r\n  function validateMoney(value) {\r\n    if (value < 0) {\r\n      return false;\r\n    } else {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  function formatMoney(value) {\r\n    if (value === undefined || value === null) {\r\n      return \"\";\r\n    } else {\r\n      return $filter(\"number\")(value, 2);\r\n    }\r\n  }\r\n\r\n  function parseMoney(value) {\r\n    return new Decimal(value).toNumber();\r\n  }\r\n\r\n}\r\n\n},{\"angular\":\"angular\",\"simple-decimal-money\":\"simple-decimal-money\"}],33:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\n\r\nangular.module(\"debtApp\")\r\n  .directive(\"tryCatch\", tryCatch);\r\n\r\nfunction tryCatch() {\r\n  return {\r\n    scope: {\r\n      expression: \"&\",\r\n      errorResult: \"@\"\r\n    },\r\n    template: '{{result}}',\r\n    link: link\r\n  };\r\n\r\n  function link($scope) {\r\n    try {\r\n      $scope.result = $scope.expression();\r\n    } catch (e) {\r\n      $scope.result = $scope.errorResult;\r\n    }\r\n  }\r\n}\n},{\"angular\":\"angular\"}]},{},[11,1,2,3,4,5,6,7,8,9,10,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33]);\n"],"sourceRoot":".."}