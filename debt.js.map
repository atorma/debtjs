{"version":3,"sources":["debt.js"],"names":["e","t","n","r","s","o","u","a","require","i","f","Error","code","l","exports","call","length",1,"module","configureLocalStorage","localStorageServiceProvider","setPrefix","configureIcons","$mdIconProvider","spriteNames","spriteProps","_","map","name","fileName","filePath","spriteName","each","prop","iconSet","hrefSanitization","$compileProvider","aHrefSanitizationWhitelist","makeStateAvailableInScope","$rootScope","$state","$stateParams","angular","constant","BALANCE_SHEET_UPDATED","config","run","$inject","./balance-sheet","./debt-app-ctrl","./debts","./expenses","./persons","./route-config","./utils","angular-local-storage","angular-material","angular-route","angular-ui-router","lodash","ng-file-upload","ng-mfb",2,"BalanceSheetCtrl","balanceSheetService","debtService","events","$scope","init","refresh","$on","vm","balanceSheet","debtsByDebtor","computeDebts","isBalanced","participations","getNonSettledParticipations","debts","organizeByDebtor","undefined","updateSheet","$emit","this","controller",3,"localStorageService","data","get","service","BalanceSheet","error","save","throwErrorIfInvalid","set","exportData","loadFromJson","json","fromJson","exportToJson","toJson","createNew","factory",4,"Decimal","filter","pt","expense","settled","reduce","expenses","getPerson","id","persons","find","p","createPerson","options","extend","idSequence","person","Person","push","createParticipations","createParticipation","shareCost","removePerson","toRemove","remove","equals","forEach","getParticipations","removeParticipation","getExpense","createExpense","sharing","Expense","removeExpense","getParticipation","criteria","toSeek","Participation","paid","share","participation","getCost","_cost","value","toNumber","getSumOfShares","_sumOfShares","_balance","getBalance","_myParticipations","other","_this","chain","_nonSettledParticipations","cost","add","sum","subtract","b","shareEqually","divideBy","lastShare","multiply","last","isNotFunction","negate","isFunction","pick","personId","expenseId","importData","concat","pluck","max","Infinity","separately","key","isValid","isNumber","idToEntity","message","simple-decimal-money",5,"./balance-sheet-ctrl","./balance-sheet-service",6,"$stateProvider","state","url","templateUrl",7,"DebtAppCtrl","balanceSheetSaveCtrlConfig","openCreatePersonDialog","openCreateExpenseDialog","$mdDialog","$mdSidenav","$window","$log","toggleMenu","toggle","createObjectURL","URL","webkitURL","noop","revokeObjectURL","Blob","FileReader","debounce","onBalanceSheetUpdated","wait","errorMessage","debug","updateJsonExportUrl","blob","type","jsonExportUrl","then","dialogResult","$broadcast","createNewSheet","show","confirmCreateNewSheet","go","mainMenu","loadSheet","files","reader","onload","loadSheetFromJson","result","readAsText","confirm","title","content","ok","cancel","./balance-sheet/balance-sheet",8,"solveDebts","debtorList","debtorIndices","d","debtor","debtorIndex","creditor","amount","sort","d1","d2","localeCompare",9,"debtSolverFactory","solveLinearSystem","solve","balances","computeBalances","hasNonZeroBalance","roles","getDebtorsAndCreditors","linearSystem","createDebtEquations","debtVector","createDebts","balance","debtors","creditors","c","A","initMatrix","j","rows","cols","solution","numVars","numberOfVariables","numFreeVars","numberOfFreeVariables","xVector","randomEngine","Random","engines","mt19937","seed","toEliminate","copy","candidates","candidateIdx","integer","splice","isNonNegative","vector","debtorIdx","Math","floor","creditorIdx","debt","random-js",10,"./debt-service","./debt-solver","./lin-eq-solver","./lin-eq-solver-factory",11,12,"input","validate","initialize","coefMatrix","copyMatrix","constVector","copyArray","m","pivotToEquationMap","equationScale","abscoef","abs","pivotToVariableMap","transformToRowEchelonForm","pivotIdx","knownFreeVariables","maxRatio","bestPivotEquationIndex","rowIdx","colIdx","ratio","currPivotVaribleIdx","newPivotVariableIdx","temp","pivotRowIdx","pivotColIdx","mult","colIndex","reduceRowEchelonForm","pivotIndex","min","div","determineRank","rank","columns","determineNumberOfSolutions","b2IsZero","numberOfSolutions","Number","MAX_VALUE","determineSolution","initArray","numberOfEquations","size","array","slice",13,"open","DialogController","controllerAs","hide",14,"ExpenseDetailCtrl","isParticipant","everyoneParticipates","updateExpense","event","targetScope","getParticipationMap","sumOfShares","setParticipation","confirmRemoveExpense","doRemoveExpense",15,"./create-expense-dialog","./expense-detail-ctrl",16,17,"$filter",18,19,"./balance-filter","./create-person-dialog","./person-detail-ctrl",20,"PersonDetailCtrl","confirmRemovePerson","debtResult","debtRole","role","counterRole","doRemovePerson","updatePerson",21,22,"$urlRouterProvider","otherwise",23,"./money-input-directive",24,"moneyInput","link","iElem","iAttrs","ngModel","render","val","$valid","formatMoney","$modelValue","$viewValue","handleBlur","$render","$validators","money","validateMoney","$parsers","parseMoney","$formatters","unshift","on","restrict","directive"],"mappings":"CAAA,QAAUA,GAAEC,EAAEC,EAAEC,GAAG,QAASC,GAAEC,EAAEC,GAAG,IAAIJ,EAAEG,GAAG,CAAC,IAAIJ,EAAEI,GAAG,CAAC,GAAIE,GAAkB,kBAATC,UAAqBA,OAAQ,KAAIF,GAAGC,EAAE,MAAOA,GAAEF,GAAE,EAAI,IAAGI,EAAE,MAAOA,GAAEJ,GAAE,EAAI,IAAIK,GAAE,GAAIC,OAAM,uBAAuBN,EAAE,IAAK,MAAMK,GAAEE,KAAK,mBAAmBF,EAAE,GAAIG,GAAEX,EAAEG,IAAIS,WAAYb,GAAEI,GAAG,GAAGU,KAAKF,EAAEC,QAAQ,SAASd,GAAG,GAAIE,GAAED,EAAEI,GAAG,GAAGL,EAAG,OAAOI,GAAEF,EAAEA,EAAEF,IAAIa,EAAEA,EAAEC,QAAQd,EAAEC,EAAEC,EAAEC,GAAG,MAAOD,GAAEG,GAAGS,QAAkD,IAAI,GAA1CL,GAAkB,kBAATD,UAAqBA,QAAgBH,EAAE,EAAEA,EAAEF,EAAEa,OAAOX,IAAID,EAAED,EAAEE,GAAI,OAAOD,KAAKa,GAAG,SAAST,EAAQU,EAAOJ,GACvd,YA8BA,SAASK,GAAsBC,GAC7BA,EAA4BC,UAAU,WAIxC,QAASC,GAAeC,GAEtB,GAAIC,IAAe,SAAU,QAAS,UAAW,cAE7CC,EAAcC,EAAEC,IAAIH,EAAa,SAASI,GAC5C,GAAIC,GAAW,cAAgBD,EAAO,MACtC,QACEE,SAAU,mBAAqBD,EAC/BE,WAAYH,IAIhBF,GAAEM,KAAKP,EAAa,SAASQ,GAC3BV,EAAgBW,QAAQD,EAAKF,WAAYE,EAAKH,YAMlD,QAASK,GAAiBC,GACxBA,EAAiBC,2BAA2B,oBAO9C,QAASC,GAA0BC,EAAYC,EAAQC,GACrDF,EAAWC,OAASA,EACpBD,EAAWE,aAAeA,EA9D5B,GAAIC,GAAUlC,EAAQ,UACtBA,GAAQ,oBACRA,EAAQ,iBACRA,EAAQ,qBACRA,EAAQ,yBACRA,EAAQ,UACRA,EAAQ,iBAER,IAAIkB,GAAIlB,EAAQ,SAEhBkC,GACGxB,OAAO,WAAY,aAAc,YAAa,qBAAsB,SAAU,iBAC9EyB,SAAS,UACRC,sBAAuB,0BAExBC,OAAO1B,GACP0B,OAAOvB,GACPuB,OAAOV,GACPW,IAAIR,GAEP9B,EAAQ,mBACRA,EAAQ,kBACRA,EAAQ,WACRA,EAAQ,mBACRA,EAAQ,aACRA,EAAQ,cACRA,EAAQ,WAKRW,EAAsB4B,SAAW,+BAmBjCzB,EAAeyB,SAAW,mBAK1BZ,EAAiBY,SAAW,oBAS5BT,EAA0BS,SAAW,aAAc,SAAU,kBAE1DC,kBAAkB,EAAEC,kBAAkB,EAAEC,UAAU,GAAGC,aAAa,GAAGC,YAAY,GAAGC,iBAAiB,GAAGC,UAAU,GAAGZ,QAAU,UAAUa,wBAAwB,wBAAwBC,mBAAmB,mBAAmBC,gBAAgB,gBAAgBC,oBAAoB,oBAAoBC,OAAS,SAASC,iBAAiB,iBAAiBC,SAAS,WAAWC,GAAG,SAAStD,EAAQU,EAAOJ,GAC7Y,YAQA,SAASiD,GAAiBC,EAAqBC,EAAaC,EAAQC,GAWlE,QAASC,KACPC,IACAF,EAAOG,IAAIJ,EAAOtB,sBAAuB2B,EAAGF,SAG9C,QAASA,KACPE,EAAGC,aAAeR,EAAoBQ,aACtCD,EAAGE,cAAgBC,IAGrB,QAASA,KACP,GAAIH,EAAGC,aAAaG,aAAc,CAChC,GAAIC,GAAiBL,EAAGC,aAAaK,8BACjCC,EAAQb,EAAYS,aAAaE,EACrC,OAAOX,GAAYc,iBAAiBD,GAEpC,MAAOE,QAIX,QAASC,KACPd,EAAOe,MAAMhB,EAAOtB,uBA/BtB,GAAI2B,GAAKY,IAETZ,GAAGH,KAAOA,EACVG,EAAGF,QAAUA,EACbE,EAAGU,YAAcA,EAEjBb,IAbF,GACI1B,IADIlC,EAAQ,UACFA,EAAQ,WAEtBkC,GAAQxB,OAAO,WACZkE,WAAW,mBAAoBrB,GAqClCA,EAAiBhB,SAAW,sBAAuB,cAAe,SAAU,YACzEL,QAAU,UAAUiB,OAAS,WAAW0B,GAAG,SAAS7E,EAAQU,EAAOJ,GACtE,YASA,SAASkD,GAAoBsB,GAgB3B,QAASlB,KACP,GAAImB,GAAOD,EAAoBE,IAAI,mBACnC,KACEC,EAAQjB,aAAe,GAAIkB,GAAaH,GACxCE,EAAQE,MAAQX,OAChB,MAAOhF,GACPyF,EAAQE,MAAQ3F,GAIpB,QAAS4F,KACP,IAAKH,EAAQjB,aACX,KAAMiB,GAAQE,KAGhB,KACEF,EAAQjB,aAAaqB,sBACrB,MAAO7F,GAEP,KADAyF,GAAQE,MAAQ3F,EACVA,EAGRsF,EAAoBQ,IAAI,mBAAoBL,EAAQjB,aAAauB,cACjEN,EAAQE,MAAQX,OAGlB,QAASgB,GAAaC,GACpB,GAAIV,GAAO7C,EAAQwD,SAASD,EAC5BR,GAAQjB,aAAe,GAAIkB,GAAaH,GACxCK,IAGF,QAASO,KACP,GAAIZ,GAAOE,EAAQjB,aAAauB,YAChC,OAAOrD,GAAQ0D,OAAOb,GAGxB,QAASc,KACPZ,EAAQjB,aAAe,GAAIkB,GAC3BD,EAAQG,OArDV,GAAIH,IACFjB,aAAcQ,OACdW,MAAOX,OACPY,KAAMA,EACNI,aAAcA,EACdG,aAAcA,EACdE,UAAWA,EACXjC,KAAMA,EAIR,OAFAqB,GAAQrB,OAEDqB,EApBT,GACI/C,IADIlC,EAAQ,UACFA,EAAQ,YAClBkF,EAAelF,EAAQ,kBAE3BkC,GAAQxB,OAAO,WACdoF,QAAQ,sBAAuBtC,GA6DhCA,EAAoBjB,SAAW,yBAI5BC,kBAAkB,EAAEN,QAAU,UAAUiB,OAAS,WAAW4C,GAAG,SAAS/F,EAAQU,EAAOJ,GAC1F,YAEA,IAAIY,GAAIlB,EAAQ,UAEZgG,GADUhG,EAAQ,WACRA,EAAQ,yBAElBkF,EAAe,SAASH,GA8C1B,QAASV,KACP,MAAOnD,GAAE+E,OAAO7B,EAAgB,SAAS8B,GACvC,OAAQA,EAAGC,QAAQC,UAIvB,QAASjC,KACP,MAAOjD,GAAEmF,OAAOC,EAAU,SAASnC,EAAY3E,GAC7C,MAAO2E,KAAe3E,EAAE4G,SAAW5G,EAAE2E,gBACpC,GAIL,QAASoC,GAAUC,GACjB,MAAOtF,GAAEuF,GAASC,KAAK,SAASC,GAC9B,MAAOA,GAAEH,IAAMA,IAKnB,QAASI,GAAa7B,EAAM8B,GAC1B9B,EAAO7D,EAAE4F,QACP1F,KAAM,WAAaqF,EAAQjG,OAAS,IACnCuE,GAEH8B,EAAU3F,EAAE4F,UAAWD,GAEPrC,SAAZO,EAAKyB,KACPzB,EAAKyB,GAAKO,EACVA,GAA0B,EAG5B,IAAIC,GAAS,GAAIC,GAAOlC,EAYxB,OAXA0B,GAAQS,KAAKF,GAETH,EAAQM,wBAAyB,GACnCjG,EAAEM,KAAK8E,EAAU,SAAS9G,GACnBA,EAAE4G,UACLgB,GAAqBJ,OAAQA,EAAQb,QAAS3G,IAC9CA,EAAE6H,eAKDL,EAGT,QAASM,GAAaC,GACpBA,EAAWhB,EAAUgB,EAASf,IAEzBe,IAELrG,EAAEsG,OAAOf,EAAS,SAASjH,GACzB,MAAOA,GAAEiI,OAAOF,KAGlBrG,EAAEwG,QAAQH,EAASI,oBAAqB,SAASzB,GAC/C0B,EAAoB1B,MAIxB,QAAS2B,GAAWrB,GAClB,MAAOtF,GAAEoF,GAAUI,KAAK,SAASlH,GAC/B,MAAOA,GAAEgH,IAAMA,IAInB,QAASsB,GAAc/C,EAAM8B,GAC3B9B,EAAO7D,EAAE4F,QACP1F,KAAM,YAAckF,EAAS9F,OAAS,GACtCuH,QAAS,QACT3B,SAAS,GACRrB,GAEH8B,EAAU3F,EAAE4F,UAAWD,GAEPrC,SAAZO,EAAKyB,KACPzB,EAAKyB,GAAKO,EACVA,GAA0B,EAG5B,IAAIZ,GAAU,GAAI6B,GAAQjD,EAS1B,OARAuB,GAASY,KAAKf,GAEVU,EAAQM,wBAAyB,GACnCjG,EAAEM,KAAKiF,EAAS,SAASE,GACvBS,GAAqBJ,OAAQL,EAAGR,QAASA,MAItCA,EAGT,QAAS8B,GAAcV,GACrBA,EAAWM,EAAWN,EAASf,IAE1Be,IAELrG,EAAEsG,OAAOlB,EAAU,SAAS9G,GAC1B,MAAOA,GAAEiI,OAAOF,KAGlBrG,EAAEwG,QAAQH,EAASI,oBAAqB,SAASzB,GAC/C0B,EAAoB1B,MAKxB,QAASgC,GAAiBC,GACxB,GAAIC,GAAS,GAAIC,GAAcF,EAC/B,OAAOjH,GAAEkD,GAAgBsC,KAAK,SAASR,GACrC,MAAOkC,GAAOX,OAAOvB,KAIzB,QAASkB,GAAoBrC,GAC3B,GAAImD,EAAiBnD,GACnB,KAAM,yBAGRA,GAAO7D,EAAE4F,QACPwB,KAAM,EACNC,MAAO,GACNxD,EAEH,IAAIyD,GAAgB,GAAIH,GAActD,EAKtC,OAJAX,GAAe8C,KAAKsB,GAEpBA,EAAcrC,QAAQkB,YAEfmB,EAGT,QAASZ,GAAoBL,GAC3BA,EAAWW,EAAiBX,GAEvBA,IAELrG,EAAEsG,OAAOpD,EAAgB,SAAS8B,GAChC,MAAOA,GAAGuB,OAAOF,KAGnBA,EAASpB,QAAQkB,aAInB,QAASJ,GAAOlC,GAgDd,QAAS0D,KACP,MAAOC,GAAMC,QAAQC,WAGvB,QAASC,KACP,MAAOC,GAAaH,QAAQC,WAG9B,QAASzE,KACP,MAAuC,KAAhC4E,EAASJ,QAAQC,WAG1B,QAASI,KACP,MAAOD,GAASJ,QAAQC,WAG1B,QAASjB,KACP,MAAOsB,GAAkBN,QAG3B,QAASlB,GAAOyB,GACd,MAAQA,aAAiBjC,IAAYiC,EAAM1C,KAAO2C,EAAM3C,GApE1D,GAAI2C,GAAQxE,IAEZzD,GAAE4F,OAAOqC,EAAOpE,GAIhBoE,EAAM1B,OAASA,EACf0B,EAAMV,QAAUA,EAChBU,EAAMN,eAAiBA,EACvBM,EAAMH,WAAaA,EACnBG,EAAMhF,WAAaA,EACnBgF,EAAMxB,kBAAoBA,CAI1B,IAAIsB,GAAoB/H,EAAEkI,MAAMhF,GAC7B6B,OAAO,SAASC,GACf,MAAOiD,GAAM1B,OAAOvB,EAAGc,UAGvBqC,EAA4BJ,EAC7BhD,OAAO,SAASC,GACf,OAAQA,EAAGC,QAAQC,UAGnBsC,EAAQW,EACTpD,OAAO,SAASC,GACf,OAAQA,EAAGC,QAAQC,UAEpBjF,IAAI,QAAQkF,OAAO,SAASiD,EAAMhB,GACjC,MAAOgB,GAAKC,IAAIjB,IACf,GAAItC,GAAQ,IAEb8C,EAAeO,EAChBlI,IAAI,SAASkF,OAAO,SAASmD,EAAKjB,GACjC,MAAOiB,GAAID,IAAIhB,IACd,GAAIvC,GAAQ,IAEb+C,EAAWM,EACZlI,IAAI,SAAS+E,GACZ,MAAO,IAAKF,GAAQE,EAAGqC,OAAQkB,SAASvD,EAAGoC,QAE5CjC,OAAO,SAASmD,EAAKE,GACpB,MAAOF,GAAID,IAAIG,IACd,GAAI1D,GAAQ,IA8BnB,QAASgC,GAAQjD,GA0Cf,QAAS0D,KACP,MAAOC,GAAMC,QAAQC,WAGvB,QAASC,KACP,MAAOC,GAAaH,QAAQC,WAG9B,QAASzE,KACP,MAAuC,KAAhC4E,EAASJ,QAAQC,WAG1B,QAASI,KACP,MAAOD,GAASJ,QAAQC,WAG1B,QAASjB,KACP,MAAOsB,GAAkBN,QAG3B,QAAStB,KACe,UAAlB8B,EAAMpB,SACR4B,IAIJ,QAASA,KACP,GAAIvF,GAAiB+E,EAAMxB,mBAC3B,IAA8B,IAA1BvD,EAAe5D,OAAnB,CAIA,GAAI8I,GAAO,GAAItD,GAAQmD,EAAMV,WACzBF,EAAQe,EAAKM,SAASxF,EAAe5D,QACrCqJ,EAAYP,EAAKG,SAASlB,EAAMuB,SAAS1F,EAAe5D,OAAS,GAErEU,GAAEwG,QAAQtD,EAAgB,SAASuC,EAAG1G,GAChCA,EAAImE,EAAe5D,OAAS,IAC9BmG,EAAE4B,MAAQA,EAAMK,cAGpB1H,EAAE6I,KAAK3F,GAAgBmE,MAAQsB,EAAUjB,YAG3C,QAASnB,GAAOyB,GACd,MAAQA,aAAiBlB,IAAakB,EAAM1C,KAAO2C,EAAM3C,GAtF3D,GAAI2C,GAAQxE,IAIZzD,GAAE4F,OAAOqC,EAAOpE,GAIhBoE,EAAMV,QAAUA,EAChBU,EAAMN,eAAiBA,EACvBM,EAAMH,WAAaA,EACnBG,EAAMhF,WAAaA,EACnBgF,EAAMxB,kBAAoBA,EAC1BwB,EAAM9B,UAAYA,EAClB8B,EAAM1B,OAASA,CAIf,IAAIwB,GAAoB/H,EAAEkI,MAAMhF,GAAgB6B,OAAO,SAASU,GAC9D,MAAOwC,GAAM1B,OAAOd,EAAER,WAGpBuC,EAAQO,EACT9H,IAAI,QAAQkF,OAAO,SAASiD,EAAMhB,GACjC,MAAOgB,GAAKC,IAAIjB,IACf,GAAItC,GAAQ,IAEb8C,EAAeG,EAChB9H,IAAI,SAASkF,OAAO,SAASmD,EAAKjB,GACjC,MAAOiB,GAAID,IAAIhB,IACd,GAAIvC,GAAQ,IAEb+C,EAAWE,EACZ9H,IAAI,SAAS+E,GACZ,MAAO,IAAKF,GAAQE,EAAGqC,OAAQkB,SAASvD,EAAGoC,QAE5CjC,OAAO,SAASmD,EAAKE,GACpB,MAAOF,GAAID,IAAIG,IACd,GAAI1D,GAAQ,IAsDnB,QAASqC,GAActD,GAkBrB,QAAS0C,GAAOyB,GACd,MAAQA,aAAiBb,IAAkBc,EAAMhD,QAAQsB,OAAOyB,EAAM/C,UAAYgD,EAAMnC,OAAOS,OAAOyB,EAAMlC,QAlB9G,GAAImC,GAAQxE,IAEZ,KAAKI,IAASA,EAAKiC,SAAWjC,EAAKoB,QACjC,KAAM,yBAKRjF,GAAE4F,OAAOnC,KAAMI,GAIfJ,KAAK8C,OAASA,EAWhB,QAASlC,KACP,GAAIyE,GAAgB9I,EAAE+I,OAAO/I,EAAEgJ,YAC3BnF,EAAO7D,EAAEiJ,KAAKhB,EAAOa,EAUzB,OATAjF,GAAK0B,QAAUvF,EAAEC,IAAIsF,EAAS,SAASE,GACrC,MAAOzF,GAAEiJ,KAAKxD,EAAGqD,KAEnBjF,EAAKuB,SAAWpF,EAAEC,IAAImF,EAAU,SAAS9G,GACvC,MAAO0B,GAAEiJ,KAAK3K,EAAGwK,KAEnBjF,EAAKX,eAAiBlD,EAAEC,IAAIiD,EAAgB,SAAS8B,GACnD,OAAQkE,SAAUlE,EAAGc,OAAOR,GAAI6D,UAAWnE,EAAGC,QAAQK,GAAI8B,KAAMpC,EAAGoC,KAAMC,MAAOrC,EAAGqC,SAE9ExD,EAGT,QAASuF,GAAWvF,GAClBgC,EAAa7F,MACRqJ,OAAOxF,EAAK0B,SACZ8D,OAAOxF,EAAKuB,UACZkE,MAAM,MACNC,MAAQ,EACT1D,KAAe2D,EAAAA,KACjB3D,EAAa,EAGf,IAAI4D,IAAclE,SAAS,EAAMH,UAAU,EAAMlC,gBAAgB,EACjElD,GAAE4F,OAAOqC,EAAOjI,EAAEiJ,KAAKpF,EAAM,SAAS4D,EAAOiC,GAC3C,OAAQD,EAAWC,MAGrB1J,EAAEM,KAAKuD,EAAK0B,QAAS,SAASE,GAC5BC,EAAaD,KAGfzF,EAAEM,KAAKuD,EAAKuB,SAAU,SAAS9G,GAC7BsI,EAActI,KAGhB0B,EAAEM,KAAKuD,EAAKX,eAAgB,SAASuC,GACnC,GAAIK,GAAST,EAAUI,EAAEyD,UACrBjE,EAAU0B,EAAWlB,EAAE0D,UAC3BjD,IAAqBJ,OAAQA,EAAQb,QAASA,EAASmC,KAAM3B,EAAE2B,KAAMC,MAAO5B,EAAE4B,UAGhFlD,IAGF,QAASwF,KACP,IAEE,MADAxF,MACO,EACP,MAAO7F,GACP,OAAO,GAIX,QAAS6F,KAEPnE,EAAEM,KAAKiF,EAAS,SAASE,GACvB,IAAKzF,EAAE4J,SAASnE,EAAEH,IAChB,KAAM,IAAIrG,GAAM,sBAIpBe,EAAEM,KAAK8E,EAAU,SAAS9G,GACxB,IAAK0B,EAAE4J,SAAStL,EAAEgH,IAChB,KAAM,IAAIrG,GAAM,sBAIpB,IAAI4K,KACJ7J,GAAEM,KAAKiF,EAAS,SAASE,GACvBoE,EAAWpE,EAAEH,IAAMG,IAErBzF,EAAEM,KAAK8E,EAAU,SAAS9G,GACxBuL,EAAWvL,EAAEgH,IAAMhH,IAErB0B,EAAEM,KAAK4C,EAAgB,SAAS8B,GAC9B,IAAKA,EAAGc,OACN,KAAM,IAAI7G,GAAM,8BAElB,KAAK4K,EAAW7E,EAAGc,OAAOR,IACxB,KAAM,IAAIrG,GAAM,kCAElB,KAAK+F,EAAGC,QACN,KAAM,IAAIhG,GAAM,+BAElB,KAAK4K,EAAW7E,EAAGC,QAAQK,IACzB,KAAM,IAAIrG,GAAM,sCAMtB,QAASA,GAAM6K,GACbrG,KAAKqG,QAAUA,EA7djB,GAAI7B,GAAQxE,KAIR8B,KACAH,KACAlC,KACA2C,EAAa,CAEjBoC,GAAM/H,KAAO,YACb+H,EAAM1C,QAAUA,EAChB0C,EAAM7C,SAAWA,EACjB6C,EAAM/E,eAAiBA,EAEnBW,GACFuF,EAAWvF,GAKboE,EAAM9E,4BAA8BA,EAEpC8E,EAAMhF,WAAaA,EAEnBgF,EAAM5C,UAAYA,EAClB4C,EAAMvC,aAAeA,EACrBuC,EAAM7B,aAAeA,EAErB6B,EAAMtB,WAAaA,EACnBsB,EAAMrB,cAAgBA,EACtBqB,EAAMlB,cAAgBA,EAEtBkB,EAAMjB,iBAAmBA,EACzBiB,EAAM/B,oBAAsBA,EAC5B+B,EAAMvB,oBAAsBA,EAE5BuB,EAAM5D,WAAaA,EAEnB4D,EAAM0B,QAAUA,EAChB1B,EAAM9D,oBAAsBA,EA4b9B3E,GAAOJ,QAAU4E,IACdhD,QAAU,UAAUiB,OAAS,SAAS8H,uBAAuB,yBAAyBC,GAAG,SAASlL,EAAQU,EAAOJ,GACpH,YAEAN,GAAQ,kBACRA,EAAQ,mBACRA,EAAQ,2BACRA,EAAQ,0BACLwC,kBAAkB,EAAE2I,uBAAuB,EAAEC,0BAA0B,EAAEvI,iBAAiB,IAAIwI,GAAG,SAASrL,EAAQU,EAAOJ,GAC5H,YAOA,SAAS+B,GAAOiJ,GAEdA,EACGC,MAAM,gBACLC,IAAK,IACLC,YAAc,mCACd7G,WAAa,2BAXnB,GAAI1C,GAAUlC,EAAQ,UAEtBkC,GAAQxB,OAAO,WACZ2B,OAAOA,GAYVA,EAAOE,SAAW,oBACfL,QAAU,YAAYwJ,GAAG,SAAS1L,EAAQU,EAAOJ,GACpD,YAUA,SAASqL,GAAYnI,EACAoI,EACAC,EACAC,EACApI,EACAqI,EACAC,EACAhK,EACA2B,EACAsI,EACAC,GA2BnB,QAASC,KACPH,EAAW,aAAaI,SAG1B,QAASxI,KACPyI,GAAmBJ,EAAQK,KAAOL,EAAQM,eAAiBF,iBAAmBnK,EAAQsK,KACtFC,GAAmBR,EAAQK,KAAOL,EAAQM,eAAiBE,iBAAmBvK,EAAQsK,KACtFE,EAAOT,EAAQS,MAAQxK,EAAQsK,KAC/BG,EAAaV,EAAQU,YAAczK,EAAQsK,KAE3C7I,EAAOG,IAAIJ,EAAOtB,sBAAuBlB,EAAE0L,SAASC,EAAuBjB,EAA2BkB,OACtG/I,EAAGF,UAGL,QAASgJ,KACP9I,EAAGF,UACEE,EAAGgJ,cACNhJ,EAAGqB,OAIP,QAASA,KACP,IACE5B,EAAoB4B,OACpBrB,EAAGgJ,aAAevI,OAClB0H,EAAKc,MAAM,uBACX,MAAOxN,GACPuE,EAAGgJ,aAAe,gBAAkBvN,EAAEwL,QACtCkB,EAAK/G,MAAM,oCAAsC3F,EAAEwL,UAIvD,QAASnH,KACPE,EAAGC,aAAeR,EAAoBQ,aAEpCD,EAAGgJ,aADDvJ,EAAoB2B,MACJ,kBAAoB3B,EAAoB2B,MAAM6F,QAE9CxG,OAEpByI,IAGF,QAASA,KACP,GAAIxH,GAAOjC,EAAoBmC,eAC3BuH,EAAO,GAAIR,IAAMjH,IAAQ0H,KAAM,oBACnCV,GAAgB1I,EAAGqJ,eACnBrJ,EAAGqJ,cAAgBf,EAAgBa,GAIrC,QAAStG,KACPiF,IACGwB,KAAK,SAASC,GACb9J,EAAoBQ,aAAa4C,aAAa0G,EAAatG,OAAQsG,EAAazG,SAChFgG,IACAlJ,EAAO4J,WAAW7J,EAAOtB,yBAI/B,QAAS0F,KACPgE,IACGuB,KAAK,SAASC,GACb9J,EAAoBQ,aAAa8D,cAAcwF,EAAanH,QAASmH,EAAazG,SAClFgG,IACAlJ,EAAO4J,WAAW7J,EAAOtB,yBAI/B,QAASoL,KACPzB,EAAU0B,KAAKC,GACZL,KAAK,WACJ7J,EAAoBqC,YACpBgH,IACA7K,EAAO2L,GAAG,gBACVhK,EAAO4J,WAAW7J,EAAOtB,uBACzB2B,EAAG6J,SAASxB,UACX,WACDrI,EAAG6J,SAASxB,WAIlB,QAASyB,GAAUC,GACjB,GAAKA,GAAUA,EAAMtN,OAArB,CAEA,GAAIuN,GAAS,GAAIpB,EACjBoB,GAAOC,OAAS,WACdC,EAAkBF,EAAOG,SAE3BH,EAAOI,WAAWL,EAAM,IACxB/J,EAAG6J,SAASxB,UAGd,QAAS6B,GAAkBxI,GACzBjC,EAAoBgC,aAAaC,GACjCoH,IACA7K,EAAO2L,GAAG,gBACVhK,EAAO4J,WAAW7J,EAAOtB,uBAzH3B,GAAI2B,GAAKY,IAETZ,GAAG6J,UACDxB,OAAQD,GAGVpI,EAAGH,KAAOA,EACVG,EAAG6C,aAAeA,EAClB7C,EAAG+D,cAAgBA,EACnB/D,EAAGyJ,eAAiBA,EACpBzJ,EAAG8J,UAAYA,EACf9J,EAAGqB,KAAOA,EACVrB,EAAGF,QAAUA,CAEb,IAKIwI,GAAiBI,EAAiBC,EAAMC,EALxCe,EAAwB3B,EAAUqC,UACnCC,MAAM,oBACNC,QAAQ,sFACRC,GAAG,MAAMC,OAAO,SAInB5K,KAzCF,CAAA,GAAI1B,GAAUlC,EAAQ,WAClBkB,EAAIlB,EAAQ,SACGA,GAAQ,iCAE3BkC,EAAQxB,OAAO,WACZiI,MAAM,8BAA+BmE,KAAM,MAC3ClI,WAAW,cAAe+G,GA0I7BA,EAAYpJ,SAAW,sBAAuB,6BAA8B,yBAA0B,0BAA2B,SAAU,YAAa,aAAc,SAAU,SAAU,UAAW,UAClMkM,gCAAgC,EAAEvM,QAAU,UAAUiB,OAAS,WAAWuL,GAAG,SAAS1O,EAAQU,EAAOJ,GACxG,YASA,SAASmD,GAAYkL,GASnB,QAASzK,GAAaE,GACpB,MAAOuK,GAAWvK,GAGpB,QAASG,GAAiBD,GACxB,GAAIsK,MACAC,IAwBJ,OAtBA3M,GAAQwF,QAAQpD,EAAO,SAASwK,GAC9B,GACIC,GADAC,EAAcH,EAAcC,EAAEC,OAAOvI,GAErBhC,UAAhBwK,IACFA,EAAcJ,EAAWpO,OACzBuO,GAAUA,OAAQD,EAAEC,OAAQzK,UAC5BsK,EAAW1H,KAAK6H,GAChBF,EAAcC,EAAEC,OAAOvI,IAAMwI,GAE/BD,EAASH,EAAWI,GACpBD,EAAOzK,MAAM4C,MAAM+H,SAAUH,EAAEG,SAAUC,OAAQJ,EAAEI,WAGrDhN,EAAQwF,QAAQkH,EAAY,SAASE,GACnCA,EAAExK,MAAM6K,KAAK,SAASC,EAAIC,GACxB,MAAOD,GAAGH,SAAS7N,KAAKkO,cAAcD,EAAGJ,SAAS7N,UAGtDwN,EAAWO,KAAK,SAASC,EAAIC,GAC3B,MAAOD,GAAGL,OAAO3N,KAAKkO,cAAcD,EAAGN,OAAO3N,QAGzCwN,EArCT,OACE1K,aAAcA,EACdK,iBAAkBA,GAXtB,GAAIrC,GAAUlC,EAAQ,UAEtBkC,GACGxB,OAAO,WACLoF,QAAQ,cAAerC,GA8C5BA,EAAYlB,SAAW,gBACpBL,QAAU,YAAYqN,GAAG,SAASvP,EAAQU,EAAOJ,GACpD,YAkDA,SAASkP,GAAkBC,GAKzB,QAASC,GAAMtL,GACb,IAAKA,GAA4C,IAA1BA,EAAe5D,OACpC,QAEF,IAAImP,GAAWC,EAAgBxL,EAC/B,KAAKyL,EAAkBF,GACrB,QAEF,IAAIG,GAAQC,EAAuBJ,GAC/BK,EAAeC,EAAoBH,GACnCI,EAAavB,EAAWqB,GACxB1L,EAAQ6L,EAAYD,EAAYJ,EACpC,OAAOxL,GAGT,QAASsL,GAAgBxL,GACvB,GAAIuL,KAgBJ,OAfAzN,GAAQwF,QAAQtD,EAAgB,SAASuC,GACvC,GAAI+C,GAAIiG,EAAShJ,EAAEK,OAAOR,GAChBhC,UAANkF,IACFA,GAAK1C,OAAQL,EAAEK,OAAQoJ,QAAS,GAAIpK,GAAQ,IAC5C2J,EAAShJ,EAAEK,OAAOR,IAAMkD,EAE1B,IAAIpB,GAAO,GAAItC,GAAQW,EAAE2B,MACrBC,EAAQ,GAAIvC,GAAQW,EAAE4B,MAC1BmB,GAAE0G,QAAU1G,EAAE0G,QAAQ7G,IAAIhB,EAAMkB,SAASnB,MAG3CpG,EAAQwF,QAAQiI,EAAU,SAASjG,GACjCA,EAAE0G,QAAU1G,EAAE0G,QAAQxH,aAGjB+G,EAGT,QAASE,GAAkBF,GACzB,GAAIzB,IAAS,CAMb,OALAhM,GAAQwF,QAAQiI,EAAU,SAASjG,GACf,IAAdA,EAAE0G,UACJlC,GAAS,KAGNA,EAGT,QAAS6B,GAAuBJ,GAC9B,GAAIU,MACAC,IAUJ,OARApO,GAAQwF,QAAQiI,EAAU,SAASjG,GAC7BA,EAAE0G,SAAW,EACfE,EAAUpJ,KAAKwC,GAEf2G,EAAQnJ,KAAKwC,MAKf2G,QAASA,EACTC,UAAWA,GAIf,QAASL,GAAoBH,GAM3B,IAAK,GALDhB,GAAIgB,EAAMO,QAAQ7P,OAClB+P,EAAIT,EAAMQ,UAAU9P,OAGpBkJ,KACKzJ,EAAI,EAAO6O,EAAJ7O,EAAOA,IACrByJ,EAAEzJ,GAAK,GAAK+F,GAAQ8J,EAAMO,QAAQpQ,GAAGmQ,SAAUtG,SAAS,KAAKlB,UAE/D,KAAK,GAAI3I,GAAI,EAAOsQ,EAAJtQ,EAAOA,IACrByJ,EAAEoF,EAAI7O,GAAK,GAAK+F,GAAQ8J,EAAMQ,UAAUrQ,GAAGmQ,SAAUtG,SAAS,MAAMlB,UAOtE,KAAK,GAHD4H,GAAIC,EAAW3B,EAAIyB,EAAGzB,EAAEyB,GAGnBtQ,EAAI,EAAO6O,EAAJ7O,EAAOA,IACrB,IAAK,GAAIyQ,GAAIzQ,EAAEsQ,GAAQtQ,EAAE,GAAGsQ,EAAVG,EAAaA,IAC7BF,EAAEvQ,GAAGyQ,GAAK,CAKd,KAAK,GAAIzQ,GAAI6O,EAAOyB,EAAEzB,EAAN7O,IAAWA,EACzB,IAAK,GAAIyQ,GAAKzQ,EAAE6O,EAAQA,EAAEyB,EAANG,EAASA,GAAKH,EAChCC,EAAEvQ,GAAGyQ,GAAK,CAId,QACEF,EAAGA,EACH9G,EAAGA,GAIP,QAAS+G,GAAWE,EAAMC,GAExB,IAAK,GADDJ,MACKvQ,EAAI,EAAO0Q,EAAJ1Q,EAAUA,IAAK,CAC7BuQ,EAAEvQ,KACF,KAAK,GAAIyQ,GAAI,EAAOE,EAAJF,EAAUA,IACxBF,EAAEvQ,GAAGyQ,GAAK,EAGd,MAAOF,GAIT,QAAS7B,GAAWqB,GAClB,GAAIa,GAAWpB,EAAkBO,GAC7Bc,EAAUD,EAASE,kBACnBC,EAAcH,EAASI,qBAE3B,IAAoB,IAAhBD,EACF,MAAOH,GAASK,OAKlB,IAAIC,GAAeC,EAAOC,QAAQC,SAClCH,GAAaI,KAAK,SAElB,IAAIC,EACJ,GAAG,CAQD,IAAK,GANDhB,GAAItO,EAAQuP,KAAKzB,EAAaQ,GAC9B9G,EAAIsG,EAAatG,EAIjBgI,KACKzR,EAAI,EAAO6Q,EAAJ7Q,EAAaA,IAC3ByR,EAAWzR,GAAKA,CAGlBuR,KACA,KAAK,GAAIvR,GAAI,EAAO+Q,EAAJ/Q,EAAiBA,IAAK,CACpC,GAAI0R,GAAeP,EAAOQ,QAAQ,EAAGF,EAAWlR,OAAO,GAAG2Q,EAC1DK,GAAYtK,KAAKwK,EAAWC,IAC5BD,EAAWG,OAAOF,EAAc,GAKlC,IAAK,GAAI1R,GAAI,EAAGA,EAAIuQ,EAAEhQ,OAAQP,IAC5B,IAAK,GAAIyQ,GAAI,EAAGA,EAAIc,EAAYhR,OAAQkQ,IACtCF,EAAEvQ,GAAGuR,EAAYd,IAAM,CAM3BG,GAAWpB,GAAmBe,EAAGA,EAAG9G,EAAGA,WAE/BoI,EAAcjB,EAASK,SAGjC,OAAOL,GAASK,QAGlB,QAASY,GAAcC,GACrB,IAAKA,EACH,OAAO,CAET,KAAK,GAAI9R,GAAI,EAAGA,EAAI8R,EAAOvR,OAAQP,IACjC,GAAI8R,EAAO9R,GAAK,EACd,OAAO,CAGX,QAAO,EAGT,QAASkQ,GAAYD,EAAYJ,GAG/B,IAAK,GAFDxL,MAEKrE,EAAI,EAAGA,EAAIiQ,EAAW1P,OAAQP,IACrC,GAAsB,IAAlBiQ,EAAWjQ,GAAU,CACvB,GAAI+R,GAAYC,KAAKC,MAAMjS,EAAE6P,EAAMQ,UAAU9P,QACzC2R,EAAclS,EAAI6P,EAAMQ,UAAU9P,OAAOwR,EACzC9C,EAAS,GAAKlJ,GAAQkK,EAAWjQ,IAAK2J,SAAS,KAAKhB,WACpDwJ,GAAQrD,OAAQe,EAAMO,QAAQ2B,GAAWhL,OAAQiI,SAAUa,EAAMQ,UAAU6B,GAAanL,OAAQkI,OAAQA,EAC5G5K,GAAM4C,KAAKkL,GAIf,MAAO9N,GA/LT,MAAOoL,GAlDT,GAAIxN,GAAUlC,EAAQ,WAClBgG,EAAUhG,EAAQ,wBAClBoR,EAASpR,EAAQ,YAErBkC,GACGxB,OAAO,WACLoF,QAAQ,aAAc0J,GA8O3BA,EAAkBjN,SAAW,uBAC1BL,QAAU,UAAUmQ,YAAY,YAAYpH,uBAAuB,yBAAyBqH,IAAI,SAAStS,EAAQU,EAAOJ,GAC3H,YAEAN,GAAQ,mBACRA,EAAQ,2BACRA,EAAQ,iBACRA,EAAQ,oBACLuS,iBAAiB,EAAEC,gBAAgB,EAAEC,kBAAkB,GAAGC,0BAA0B,KAAKC,IAAI,SAAS3S,EAAQU,EAAOJ,GACxH,YAQA,SAASmP,KACP,MAAOC,GAPT,GAAIA,GAAQ1P,EAAQ,mBAChBkC,EAAUlC,EAAQ,UAEtBkC,GAAQxB,OAAO,WACdoF,QAAQ,oBAAqB2J,KAK3BgD,kBAAkB,GAAGvQ,QAAU,YAAY0Q,IAAI,SAAS5S,EAAQU,EAAOJ,GAC1E,YAGA,SAASoP,GAAMmD,GA+Bd,QAASC,KACL,IAAKD,IAAUA,EAAMrC,IAAMqC,EAAMnJ,EAChC,KAAM,4CAGP,IAAImJ,EAAMrC,EAAEhQ,OAAS,GAAKqS,EAAMrC,EAAE,GAAGhQ,OAAS,EAC7C,KAAM,8CAGP,IAAIqS,EAAMrC,EAAEhQ,QAAUqS,EAAMnJ,EAAElJ,OAC7B,KAAM,wEAIX,QAASuS,KACRC,EAAaC,EAAWJ,EAAMrC,GAC9B0C,EAAcC,EAAUN,EAAMnJ,GAE9B0J,EAAIJ,EAAWxS,OACfd,EAAIsT,EAAW,GAAGxS,OAElB6S,IACA,KAAK,GAAIpT,GAAI,EAAOmT,EAAJnT,EAAOA,IACtBoT,EAAmBpT,GAAKA,CAGzBqT,KACA,KAAK,GAAIrT,GAAI,EAAOmT,EAAJnT,EAAOA,IAAK,CAC3BqT,EAAcrT,GAAK,CACnB,KAAK,GAAIyQ,GAAI,EAAOhR,EAAJgR,EAAOA,IAAK,CAC3B,GAAI6C,GAAUtB,KAAKuB,IAAIR,EAAW/S,GAAGyQ,GACjC6C,GAAUD,EAAcrT,KAC3BqT,EAAcrT,GAAKsT,IAKtBE,IACA,KAAK,GAAI/C,GAAI,EAAOhR,EAAJgR,EAAOA,IACtB+C,EAAmB/C,GAAKA,EAI1B,QAASgD,KAIR,IAHA,GAAIC,GAAW,EACXC,KAEcR,EAAE,EAAbO,GAAgB,CAMtB,IAAK,GAFDE,GAAW,EACXC,EAAyBH,EACpB1T,EAAI0T,EAAcP,EAAJnT,IAASA,EAAG,CAClC,GAAI8T,GAASV,EAAmBpT,GAC5B+T,EAASP,EAAmBE,GAC5BM,EAAQhC,KAAKuB,IAAIR,EAAWe,GAAQC,GAAQV,EAAcS,GAE1DE,GAAQJ,IACXA,EAAWI,EACXH,EAAyB7T,GAM3B,GAAiB,IAAb4T,EAAgB,CACnB,GAAIK,GAAsBT,EAAmBE,EAC7CC,GAAmBM,IAAuB,CAK1C,KAFA,GAAIjU,GAAI0T,EACJQ,EAAsBD,EACnBC,GAAuBD,GAA2BxU,EAAE,EAANO,KAClDA,EACG2T,EAAmBH,EAAmBxT,MAC1CkU,EAAsBV,EAAmBxT,GAI3C,IAAIkU,GAAuBD,EAAqB,CAC/CT,EAAmBE,GAAYQ,EAC/BV,EAAmBxT,GAAKiU,CACxB,UAGA,OAIF,GAAIE,GAAOf,EAAmBM,EAC9BN,GAAmBM,GAAYN,EAAmBS,GAClDT,EAAmBS,GAA0BM,CAG7C,IAAIC,GAAchB,EAAmBM,GACjCW,EAAcb,EAAmBE,EACrC,KAAK1T,EAAI0T,EAAW,EAAOP,EAAJnT,IAASA,EAAG,CAIlC,IAAK,GAHD8T,GAASV,EAAmBpT,GAC5BsU,EAAOvB,EAAWe,GAAQO,GAAetB,EAAWqB,GAAaC,GAE5D5D,EAAIiD,EAAW,EAAOjU,EAAJgR,IAASA,EAAG,CACtC,GAAI8D,GAAWf,EAAmB/C,EAClCsC,GAAWe,GAAQS,GAAYxB,EAAWe,GAAQS,GAAYD,EAAOvB,EAAWqB,GAAaG,GAG9FxB,EAAWe,GAAQO,GAAe,EAClCpB,EAAYa,GAAUb,EAAYa,GAAUQ,EAAOrB,EAAYmB,GAGhEV,KAKF,QAASc,KAER,GAAIC,EACJ,KAAKA,EAAazC,KAAK0C,IAAIvB,EAAG1T,GAAK,EAAGgV,EAAa,IAAKA,EAAY,CACnE,GAAIL,GAAchB,EAAmBqB,GACjCJ,EAAcb,EAAmBiB,EAErC,IAA6C,IAAzC1B,EAAWqB,GAAaC,GAI5B,IAAK,GAAIrU,GAAIyU,EAAa,EAAGzU,EAAI,KAAMA,EAAG,CAGzC,IAAK,GADDsU,GAAOvB,EAAWK,EAAmBpT,IAAIwT,EAAmBiB,IAAa1B,EAAWK,EAAmBqB,IAAajB,EAAmBiB,IAClIhE,EAAI,EAAOhR,EAAJgR,IAASA,EACxBsC,EAAWK,EAAmBpT,IAAIwT,EAAmB/C,KAAO6D,EAAKvB,EAAWK,EAAmBqB,IAAajB,EAAmB/C,GAGhIwC,GAAYG,EAAmBpT,KAAOsU,EAAKrB,EAAYG,EAAmBqB,KAK5E,IAAKA,EAAa,EAAGA,EAAazC,KAAK0C,IAAIvB,EAAG1T,KAAMgV,EAEnD,GAAmF,IAA/E1B,EAAWK,EAAmBqB,IAAajB,EAAmBiB,IAAlE,CAKA,IAAK,GADDE,GAAM5B,EAAWK,EAAmBqB,IAAajB,EAAmBiB,IAC/DhE,EAAI,EAAOhR,EAAJgR,IAASA,EACxBsC,EAAWK,EAAmBqB,IAAahE,GAAKsC,EAAWK,EAAmBqB,IAAahE,GAAGkE,CAE/F1B,GAAYG,EAAmBqB,IAAexB,EAAYG,EAAmBqB,IAAaE,GAK5F,QAASC,KACRC,EAAO,CACP,IAAI7U,GAAEyQ,CAENqE,GACA,IAAKrE,EAAE,EAAKhR,EAAFgR,IAAOA,EAAG,CAEnB,IAAKzQ,EAAE,EAAKmT,EAAFnT,IAAOA,EAAG,CACnB,GAAIA,GAAKyQ,GAAkE,IAA7DsC,EAAWK,EAAmBpT,IAAIwT,EAAmB/C,IAClE,KAAMqE,EAEF,IAAI9U,GAAKyQ,GAAiE,GAA5DsC,EAAWK,EAAmBpT,IAAIwT,EAAmB/C,IACvE,KAAMqE,KAGND,GAIJ,QAASE,KAIR,IAAK,GAFDC,IAAW,EAENhV,EAAI6U,EAAU1B,EAAJnT,IAASA,EAC3B,GAA2C,IAAvCiT,EAAYG,EAAmBpT,IAAW,CAC7CgV,GAAW,CACX,OAIS7B,EAAP0B,IAAaG,EAChBC,EAAoB,EACVJ,GAAQpV,GAAMoV,GAAQ1B,IAAK6B,EAEpBvV,EAAPoV,IAAaA,GAAQ1B,GAAK6B,KACpCC,EAAoBC,OAAOC,WAF3BF,EAAoB,EAMtB,QAASG,KACR,GAA0B,IAAtBH,EACHhE,EAAU1M,WACJ,CACN0M,EAAUoE,EAAU5V,EACpB,KAAK,GAAIO,GAAI,EAAO6U,EAAJ7U,IAAYA,EAC3BiR,EAAQuC,EAAmBxT,IAAMiT,EAAYG,EAAmBpT,KAnOnE,GAAI+S,GAAYE,EAAahC,EACzBkC,EAAG1T,EAAGoV,EAAMI,EAOZ7B,EAAoBI,EAAoBH,CAU5C,OARAR,KACAC,IACAW,IACAe,IACAI,IACAG,IACAK,KAGCnE,QAASA,EACTqE,kBAAmBnC,EACnBrC,kBAAmBrR,EACnBoV,KAAMA,EACN7D,sBAAuBvR,EAAIoV,EAC3BI,kBAAmBA,GAiNrB,QAASI,GAAUE,GAEjB,IAAK,GADDC,MACKxV,EAAI,EAAOuV,EAAJvV,EAAUA,IACzBwV,EAAMxV,GAAK,CAEZ,OAAOwV,GAGT,QAAStC,GAAUN,GAClB,MAAOA,GAAM6C,QAGd,QAASzC,GAAWJ,GAEnB,IAAK,GADDpB,MACKxR,EAAI,EAAGA,EAAI4S,EAAMrS,OAAQP,IACjCwR,EAAKxR,GAAK4S,EAAM5S,GAAGyV,OAEpB,OAAOjE,GAIR/Q,EAAOJ,QAAUoP,OACXiG,IAAI,SAAS3V,EAAQU,EAAOJ,GAClC,YAQA,SAASwL,GAAwBC,GAI/B,QAAS6J,KACP,MAAO7J,GAAU0B,MACfhC,YAAa,sCACb7G,WAAYiR,EACZC,aAAc,OANlB,MAAOF,GAaT,QAASC,GAAiB9J,GAUxB,QAASnI,KACPG,EAAGoC,SACD/E,KAAMoD,OACNuD,QAAS,SAEXhE,EAAG8C,SACDM,sBAAsB,GAI1B,QAASoH,KACPxC,EAAUgK,MAAM5P,QAASpC,EAAGoC,QAASU,QAAS9C,EAAG8C,UAGnD,QAAS2H,KACPzC,EAAUyC,SAxBZ,GAAIzK,GAAKY,IAETZ,GAAGwK,GAAKA,EACRxK,EAAGyK,OAASA,EACZzK,EAAGH,KAAOA,EAEVA,IA5BF,GAAI1B,GAAUlC,EAAQ,UAEtBkC,GAAQxB,OAAO,WACdoF,QAAQ,0BAA2BgG,GAgBpCA,EAAwBvJ,SAAW,aA8BnCsT,EAAiBtT,SAAW,eACzBL,QAAU,YAAY8T,IAAI,SAAShW,EAAQU,EAAOJ,GACrD,YASA,SAAS2V,GAAkBzS,EAAqBC,EAAaC,EAAQqI,EAAW9J,EAAcD,EAAQ2B,GAgBpG,QAASC,KACPG,EAAGC,aAAeR,EAAoBQ,aACtCD,EAAGoC,QAAUpC,EAAGC,aAAa6D,WAAW5F,EAAauE,IACrDzC,EAAGmS,iBACHnS,EAAGoS,sBAAuB,EAC1BC,IAEAzS,EAAOG,IAAIJ,EAAOtB,sBAAuB,SAASiU,GAC5CA,EAAMC,aAAe3S,GACvBI,EAAGqS,kBAKT,QAASA,KACPrS,EAAGoC,QAAQkB,YACXtD,EAAGmS,cAAgBK,IACnBxS,EAAGE,cAAgBC,IACnBH,EAAGuF,KAAOvF,EAAGoC,QAAQsC,UACrB1E,EAAGyS,YAAczS,EAAGoC,QAAQ0C,iBAC5BlF,EAAOe,MAAMhB,EAAOtB,uBAGtB,QAASmU,KACP,GAAIpV,KAWJ,OATAe,GAAQwF,QAAQ3D,EAAGC,aAAayC,QAAS,SAASO,GAChD7F,EAAI6F,EAAOR,KAAM,EACjBtE,EAAQwF,QAAQ3D,EAAGoC,QAAQwB,oBAAqB,SAAShB,GACnDA,EAAEK,OAAOS,OAAOT,KAClB7F,EAAI6F,EAAOR,KAAM,OAKhBrF,EAGT,QAASsV,GAAiBzP,EAAQkP,GAC5BA,EACFnS,EAAGC,aAAaoD,qBAAqBjB,QAASpC,EAAGoC,QAASa,OAAQA,IAElEjD,EAAGC,aAAa4D,qBAAqBzB,QAASpC,EAAGoC,QAASa,OAAQA,IAEpEoP,IAGF,QAASnO,KACP8D,EAAU0B,KAAKiJ,GACZrJ,KAAKsJ,GAGV,QAASA,KACP5S,EAAGC,aAAaiE,cAAclE,EAAGoC,SACjCxC,EAAOe,MAAMhB,EAAOtB,uBACpBJ,EAAO2L,GAAG,gBAGZ,QAASzJ,KACP,GAAIH,EAAGoC,QAAQhC,aAAc,CAC3B,GAAIG,GAAQb,EAAYS,aAAaH,EAAGoC,QAAQwB,oBAChD,OAAOlE,GAAYc,iBAAiBD,IA5ExC,GAAIP,GAAKY,KAEL+R,EAAuB3K,EAAUqC,UAClCE,QAAQ,+BACRC,GAAG,MAAMC,OAAO,SAEnBzK,GAAGH,KAAOA,EACVG,EAAG0S,iBAAmBA,EACtB1S,EAAGqS,cAAgBA,EACnBrS,EAAGkE,cAAgBA,EAEnBrE,IAnBF,GACI1B,IADIlC,EAAQ,UACFA,EAAQ,WAEtBkC,GACGxB,OAAO,WACPkE,WAAW,oBAAqBqR,GAqFnCA,EAAkB1T,SAAW,sBAAuB,cAAe,SAAU,YAAa,eAAgB,SAAU,YAEjHL,QAAU,UAAUiB,OAAS,WAAWyT,IAAI,SAAS5W,EAAQU,EAAOJ,GACvE,YAEAN,GAAQ,kBACRA,EAAQ,yBACRA,EAAQ,6BACL6W,0BAA0B,GAAGC,wBAAwB,GAAGjU,iBAAiB,KAAKkU,IAAI,SAAS/W,EAAQU,EAAOJ,GAC7G,YAOA,SAAS+B,GAAOiJ,GAEfA,EACEC,MAAM,WACNC,IAAK,gBACHC,YAAa,+BACZ7G,WAAY,4BAXlB,GAAI1C,GAAUlC,EAAQ,UAEtBkC,GAAQxB,OAAO,WACb2B,OAAOA,GAYTA,EAAOE,SAAW,oBACfL,QAAU,YAAY8U,IAAI,SAAShX,EAAQU,EAAOJ,GACrD,YASA,SAAS8P,GAAQ6G,GACf,MAAO,UAAiBtO,GACtB,MAAIA,GAAQ,EACH,IAAMsO,EAAQ,UAAUtO,EAAO,KACpB,GAATA,EACFsO,EAAQ,UAAUtO,EAAO,KAEzBnE,QAdb,CAAA,GAAItC,GAAUlC,EAAQ,UACdA,GAAQ,UAEhBkC,EAAQxB,OAAO,WACZuF,OAAO,UAAWmK,GAcrBA,EAAQ7N,SAAW,aAChBL,QAAU,UAAUiB,OAAS,WAAW+T,IAAI,SAASlX,EAAQU,EAAOJ,GACvE,YAQA,SAASuL,GAAuBE,GAI9B,QAAS6J,KACP,MAAO7J,GAAU0B,MACfhC,YAAa,oCACb7G,WAAYiR,EACZC,aAAc,OANlB,MAAOF,GAaT,QAASC,GAAiB9J,GAUxB,QAASnI,KACPG,EAAGiD,QACD5F,KAAMoD,QAERT,EAAG8C,SACDM,sBAAsB,GAI1B,QAASoH,KACPxC,EAAUgK,MAAM/O,OAAQjD,EAAGiD,OAAQH,QAAS9C,EAAG8C,UAGjD,QAAS2H,KACPzC,EAAUyC,SAvBZ,GAAIzK,GAAKY,IAETZ,GAAGwK,GAAKA,EACRxK,EAAGyK,OAASA,EACZzK,EAAGH,KAAOA,EAEVA,IA5BF,GAAI1B,GAAUlC,EAAQ,UAEtBkC,GAAQxB,OAAO,WACdoF,QAAQ,yBAA0B+F,GAgBnCA,EAAuBtJ,SAAW,aA6BlCsT,EAAiBtT,SAAW,eACzBL,QAAU,YAAYiV,IAAI,SAASnX,EAAQU,EAAOJ,GACrD,YAEAN,GAAQ,kBACRA,EAAQ,wBACRA,EAAQ,0BACRA,EAAQ,sBACLoX,mBAAmB,GAAGC,yBAAyB,GAAGC,uBAAuB,GAAGzU,iBAAiB,KAAK0U,IAAI,SAASvX,EAAQU,EAAOJ,GACjI,YAQA,SAASkX,GAAiBhU,EAAqBC,EAAaC,EAAQ1B,EAAQC,EAAc8J,EAAWpI,EAAQuI,GAc3G,QAAStI,KACPG,EAAGC,aAAeR,EAAoBQ,aACtCD,EAAGiD,OAASjD,EAAGC,aAAauC,UAAUtE,EAAauE,IAEnD3C,IAEA4T,EAAsB1L,EAAUqC,UAC7BE,QAAQ,8BACRC,GAAG,MAAMC,OAAO,UAEnB7K,EAAOG,IAAIJ,EAAOtB,sBAAuB2B,EAAGF,SAG9C,QAASA,KACPE,EAAGmS,cAAgBK,IACnBxS,EAAGuF,KAAOvF,EAAGiD,OAAOyB,UACpB1E,EAAGyS,YAAczS,EAAGiD,OAAO6B,iBAC3B9E,EAAGqM,QAAUrM,EAAGiD,OAAOgC,YACvB,IAAI0O,GAAaxT,GACjBH,GAAG4T,SAAWD,EAAWE,KACzB7T,EAAGO,MAAQoT,EAAWpT,MAGxB,QAASiS,KACP,GAAIpV,KAWJ,OATAD,GAAEwG,QAAQ3D,EAAGC,aAAasC,SAAU,SAASH,GAC3ChF,EAAIgF,EAAQK,KAAM,EAClBtF,EAAEwG,QAAQ3D,EAAGiD,OAAOW,oBAAqB,SAASzB,GAC5CA,EAAGC,QAAQsB,OAAOtB,KACpBhF,EAAIgF,EAAQK,KAAM,OAKjBrF,EAGT,QAASiV,GAAcjQ,GACrBA,EAAQkB,YACRxD,IACAF,EAAOe,MAAMhB,EAAOtB,uBAGtB,QAASqU,GAAiBtQ,EAAS+P,GAC7BA,EACFnS,EAAGC,aAAaoD,qBAAqBjB,QAASA,EAASa,OAAQjD,EAAGiD,SAElEjD,EAAGC,aAAa4D,qBAAqBzB,QAASA,EAASa,OAAQjD,EAAGiD,SAEpEjD,EAAGqS,cAAcjQ,GAGnB,QAASjC,KACP,GAAIgK,IACF0J,KAAMpT,OACNF,MAAOE,OAGT,KAAKT,EAAGC,aAAaG,aAEnB,MADA+J,GAAO0J,KAAO,aACP1J,CAGT,IAAInK,EAAGqM,QAAU,EACflC,EAAO0J,KAAO,aACT,CAAA,KAAI7T,EAAGqM,QAAU,GAItB,MADAlC,GAAO0J,KAAO,UACP1J,CAHPA,GAAO0J,KAAO,WAMhB,GAAIC,IACF9I,OAAU,WACVE,SAAY,UAGV3K,EAAQb,EAAYS,aAAaH,EAAGC,aAAaK,8BAUrD,OATA6J,GAAO5J,MAAQpD,EAAEkI,MAAM9E,GACpB2B,OAAO,SAAS6I,GACf,MAAOA,GAAEZ,EAAO0J,MAAMnQ,OAAO1D,EAAGiD,UAEjC7F,IAAI,SAAS2N,GACZ,OAAQ9H,OAAQ8H,EAAE+I,EAAY3J,EAAO0J,OAAQ1I,OAAQJ,EAAEI,UAExDvG,QAEIuF,EAGT,QAAS5G,KACPyE,EAAU0B,KAAKgK,GACZpK,KAAKyK,GAGV,QAASA,KACP/T,EAAGC,aAAasD,aAAavD,EAAGiD,QAChCrD,EAAOe,MAAMhB,EAAOtB,uBACpBJ,EAAO2L,GAAG,gBAGZ,QAASoK,KACPpU,EAAOe,MAAMhB,EAAOtB,uBAnHtB,GACIqV,GADA1T,EAAKY,IAGTZ,GAAGH,KAAOA,EACVG,EAAGF,QAAUA,EACbE,EAAGqS,cAAgBA,EACnBrS,EAAG0S,iBAAmBA,EACtB1S,EAAGuD,aAAeA,EAClBvD,EAAGgU,aAAeA,EAElBnU,IAlBF,GAAI1B,GAAUlC,EAAQ,WAClBkB,EAAIlB,EAAQ,SAEhBkC,GAAQxB,OAAO,WACZkE,WAAW,mBAAoB4S,GA0HlCA,EAAiBjV,SAAW,sBAAuB,cAAe,SAAU,SAAU,eAAgB,YAAa,SAAU,UAE1HL,QAAU,UAAUiB,OAAS,WAAW6U,IAAI,SAAShY,EAAQU,EAAOJ,GACvE,YAOA,SAAS+B,GAAOiJ,GAEdA,EACGC,MAAM,UACLC,IAAK,eACLC,YAAa,6BACb7G,WAAY,2BAXlB,GAAI1C,GAAUlC,EAAQ,UAEtBkC,GAAQxB,OAAO,WACZ2B,OAAOA,GAYVA,EAAOE,SAAW,oBACfL,QAAU,YAAY+V,IAAI,SAASjY,EAAQU,EAAOJ,GACrD,YAOA,SAAS+B,GAAO6V,GAEdA,EAAmBC,UAAU,KAP/B,GAAIjW,GAAUlC,EAAQ,UAEtBkC,GAAQxB,OAAO,WACb2B,OAAOA,GAOTA,EAAOE,SAAW,wBACfL,QAAU,YAAYkW,IAAI,SAASpY,EAAQU,EAAOJ,GACrD,YAEAN,GAAQ,6BACLqY,0BAA0B,KAAKC,IAAI,SAAStY,EAAQU,EAAOJ,GAC9D,YAUA,SAASiY,GAAWtB,GAOlB,QAASuB,GAAK7U,EAAQ8U,EAAOC,EAAQC,GAQnC,QAASC,KAELH,EAAMI,IADJF,EAAQG,OACAC,EAAYJ,EAAQK,aAEpBL,EAAQM,YAItB,QAASC,KACPP,EAAQQ,UAhBVR,EAAQS,YAAYC,MAAQC,EAC5BX,EAAQY,SAASrS,KAAKsS,GACtBb,EAAQc,YAAYC,QAAQX,GAE5BN,EAAMkB,GAAG,OAAQT,GACjBP,EAAQQ,QAAUP,EAepB,QAASU,GAAc3Q,GACrB,MAAY,GAARA,GACK,GAEA,EAIX,QAASoQ,GAAYpQ,GACnB,MAAcnE,UAAVmE,GAAiC,OAAVA,EAClB,GAEAsO,EAAQ,UAAUtO,EAAO,GAIpC,QAAS6Q,GAAW7Q,GAClB,MAAO,IAAI3C,GAAQ2C,GAAOC,WA5C5B,OACEgR,SAAU,IACV5Z,QAAS,UACTwY,KAAMA,GAZV,GAAItW,GAAUlC,EAAQ,WAElBgG,GADIhG,EAAQ,UACFA,EAAQ,wBAEtBkC,GAAQxB,OAAO,WACZmZ,UAAU,aAActB,GAoD3BA,EAAWhW,SAAW,aAEnBL,QAAU,UAAUiB,OAAS,SAAS8H,uBAAuB,8BAA8B","file":"debt.js","sourcesContent":["(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error(\"Cannot find module '\"+o+\"'\");throw f.code=\"MODULE_NOT_FOUND\",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\nrequire(\"angular-material\");\r\nrequire(\"angular-route\");\r\nrequire(\"angular-ui-router\");\r\nrequire(\"angular-local-storage\");\r\nrequire(\"ng-mfb\");\r\nrequire(\"ng-file-upload\");\r\n\r\nvar _ = require(\"lodash\");\r\n\r\nangular\r\n  .module(\"debtApp\", [\"ngMaterial\", \"ui.router\", \"LocalStorageModule\", \"ng-mfb\", \"ngFileUpload\"])\r\n  .constant(\"events\", {\r\n    BALANCE_SHEET_UPDATED: \"balance sheet updated\"\r\n  })\r\n  .config(configureLocalStorage)\r\n  .config(configureIcons)\r\n  .config(hrefSanitization)\r\n  .run(makeStateAvailableInScope);\r\n\r\nrequire(\"./debt-app-ctrl\");\r\nrequire(\"./route-config\");\r\nrequire(\"./debts\");\r\nrequire(\"./balance-sheet\");\r\nrequire(\"./persons\");\r\nrequire(\"./expenses\");\r\nrequire(\"./utils\");\r\n\r\nfunction configureLocalStorage(localStorageServiceProvider) {\r\n  localStorageServiceProvider.setPrefix(\"debtApp\");\r\n}\r\nconfigureLocalStorage.$inject = [\"localStorageServiceProvider\"];\r\n\r\nfunction configureIcons($mdIconProvider) {\r\n  \r\n  var spriteNames = ['action', 'alert', 'content', 'navigation'];\r\n  \r\n  var spriteProps = _.map(spriteNames, function(name) {\r\n    var fileName = 'svg-sprite-' + name + '.svg';\r\n    return {\r\n      filePath: 'resources/icons/' + fileName,\r\n      spriteName: name\r\n    };\r\n  });\r\n\r\n  _.each(spriteProps, function(prop) {\r\n    $mdIconProvider.iconSet(prop.spriteName, prop.filePath);\r\n  });\r\n\r\n}\r\nconfigureIcons.$inject = [\"$mdIconProvider\"];\r\n\r\nfunction hrefSanitization($compileProvider) {\r\n  $compileProvider.aHrefSanitizationWhitelist(/^(blob||https?):/);\r\n}\r\nhrefSanitization.$inject = [\"$compileProvider\"];\r\n\r\n// Injection of $state may trigger a GET, which can show as an \r\n// \"Unexpected request\" error in your test. Workaround is to \r\n// $provide a mock $state to Angular.\r\nfunction makeStateAvailableInScope($rootScope, $state, $stateParams) {\r\n  $rootScope.$state = $state;\r\n  $rootScope.$stateParams = $stateParams;\r\n}\r\nmakeStateAvailableInScope.$inject = [\"$rootScope\", \"$state\", \"$stateParams\"];\r\n\n},{\"./balance-sheet\":5,\"./debt-app-ctrl\":7,\"./debts\":10,\"./expenses\":15,\"./persons\":19,\"./route-config\":22,\"./utils\":23,\"angular\":\"angular\",\"angular-local-storage\":\"angular-local-storage\",\"angular-material\":\"angular-material\",\"angular-route\":\"angular-route\",\"angular-ui-router\":\"angular-ui-router\",\"lodash\":\"lodash\",\"ng-file-upload\":\"ng-file-upload\",\"ng-mfb\":\"ng-mfb\"}],2:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar _ = require(\"lodash\");\r\nvar angular = require(\"angular\");\r\n\r\nangular.module(\"debtApp\")\r\n  .controller(\"BalanceSheetCtrl\", BalanceSheetCtrl);\r\n\r\nfunction BalanceSheetCtrl(balanceSheetService, debtService, events, $scope) {\r\n  var vm = this;\r\n  \r\n  vm.init = init;\r\n  vm.refresh = refresh;\r\n  vm.updateSheet = updateSheet;\r\n  \r\n  init();\r\n  \r\n  /////////////////////////////////////////////////////////////\r\n  \r\n  function init() {\r\n    refresh();\r\n    $scope.$on(events.BALANCE_SHEET_UPDATED, vm.refresh);\r\n  }\r\n  \r\n  function refresh() {\r\n    vm.balanceSheet = balanceSheetService.balanceSheet;\r\n    vm.debtsByDebtor = computeDebts();\r\n  }\r\n  \r\n  function computeDebts() {\r\n    if (vm.balanceSheet.isBalanced()) {\r\n      var participations = vm.balanceSheet.getNonSettledParticipations();\r\n      var debts = debtService.computeDebts(participations);\r\n      return debtService.organizeByDebtor(debts);\r\n    } else {\r\n      return undefined;\r\n    }\r\n  }\r\n\r\n  function updateSheet() {\r\n    $scope.$emit(events.BALANCE_SHEET_UPDATED);\r\n  }\r\n}\r\nBalanceSheetCtrl.$inject = [\"balanceSheetService\", \"debtService\", \"events\", \"$scope\"];\n},{\"angular\":\"angular\",\"lodash\":\"lodash\"}],3:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar _ = require(\"lodash\");\r\nvar angular = require(\"angular\");\r\nvar BalanceSheet = require('./balance-sheet');\r\n\r\nangular.module(\"debtApp\")\r\n.factory(\"balanceSheetService\", balanceSheetService);\r\n\r\nfunction balanceSheetService(localStorageService) {\r\n  \r\n  var service = {\r\n    balanceSheet: undefined,\r\n    error: undefined,\r\n    save: save,\r\n    loadFromJson: loadFromJson,\r\n    exportToJson: exportToJson,\r\n    createNew: createNew,\r\n    init: init\r\n  };\r\n  service.init();\r\n  \r\n  return service;\r\n  \r\n  \r\n  function init() {\r\n    var data = localStorageService.get(\"balanceSheetData\");\r\n    try {\r\n      service.balanceSheet = new BalanceSheet(data);\r\n      service.error = undefined;\r\n    } catch (e) {\r\n      service.error = e;\r\n    }\r\n  }\r\n\r\n  function save() {\r\n    if (!service.balanceSheet) {\r\n      throw service.error;\r\n    }\r\n\r\n    try {\r\n      service.balanceSheet.throwErrorIfInvalid();\r\n    } catch (e) {\r\n      service.error = e;\r\n      throw e;\r\n    }\r\n\r\n    localStorageService.set(\"balanceSheetData\", service.balanceSheet.exportData());\r\n    service.error = undefined;\r\n  }\r\n  \r\n  function loadFromJson(json) {\r\n    var data = angular.fromJson(json);\r\n    service.balanceSheet = new BalanceSheet(data);\r\n    save();\r\n  }\r\n  \r\n  function exportToJson() {\r\n    var data = service.balanceSheet.exportData(); \r\n    return angular.toJson(data);\r\n  }\r\n\r\n  function createNew() {\r\n    service.balanceSheet = new BalanceSheet();\r\n    service.save();\r\n  }\r\n\r\n}\r\nbalanceSheetService.$inject = [\"localStorageService\"];\r\n\r\n\r\n\n},{\"./balance-sheet\":4,\"angular\":\"angular\",\"lodash\":\"lodash\"}],4:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar _ = require('lodash');\r\nvar angular = require(\"angular\");\r\nvar Decimal = require(\"simple-decimal-money\");\r\n\r\nvar BalanceSheet = function(data) {\r\n\r\n  var _this = this;\r\n\r\n  // Data\r\n\r\n  var persons = [];\r\n  var expenses = [];\r\n  var participations = [];\r\n  var idSequence = 1;\r\n\r\n  _this.name = \"New sheet\";\r\n  _this.persons = persons;\r\n  _this.expenses = expenses;\r\n  _this.participations = participations;\r\n\r\n  if (data) {\r\n    importData(data);\r\n  }\r\n\r\n  // Methods\r\n\r\n  _this.getNonSettledParticipations = getNonSettledParticipations;\r\n\r\n  _this.isBalanced = isBalanced;\r\n\r\n  _this.getPerson = getPerson;\r\n  _this.createPerson = createPerson;\r\n  _this.removePerson = removePerson;\r\n\r\n  _this.getExpense = getExpense;\r\n  _this.createExpense = createExpense;\r\n  _this.removeExpense = removeExpense;\r\n\r\n  _this.getParticipation = getParticipation;\r\n  _this.createParticipation = createParticipation;\r\n  _this.removeParticipation = removeParticipation;\r\n\r\n  _this.exportData = exportData;\r\n\r\n  _this.isValid = isValid;\r\n  _this.throwErrorIfInvalid = throwErrorIfInvalid;\r\n\r\n  /////////////////////////////////////\r\n\r\n\r\n  function getNonSettledParticipations() {\r\n    return _.filter(participations, function(pt) {\r\n      return !pt.expense.settled;\r\n    });\r\n  }\r\n\r\n  function isBalanced() {\r\n    return _.reduce(expenses, function(isBalanced, e) {\r\n      return isBalanced && (e.settled || e.isBalanced());\r\n    }, true);\r\n  }\r\n\r\n\r\n  function getPerson(id) {\r\n    return _(persons).find(function(p) {\r\n      return p.id == id;\r\n    });\r\n  }\r\n\r\n\r\n  function createPerson(data, options) {\r\n    data = _.extend({\r\n      name: \"Person \" + (persons.length + 1)\r\n    }, data);\r\n\r\n    options = _.extend({}, options);\r\n\r\n    if (data.id === undefined) {\r\n      data.id = idSequence;\r\n      idSequence = idSequence + 1;\r\n    }\r\n\r\n    var person = new Person(data);\r\n    persons.push(person);\r\n\r\n    if (options.createParticipations === true) {\r\n      _.each(expenses, function(e) {\r\n        if (!e.settled) {\r\n          createParticipation({person: person, expense: e});\r\n          e.shareCost();\r\n        }\r\n      });\r\n    }\r\n\r\n    return person;\r\n  }\r\n\r\n  function removePerson(toRemove) {\r\n    toRemove = getPerson(toRemove.id);\r\n\r\n    if (!toRemove) return;\r\n\r\n    _.remove(persons, function(e) {\r\n      return e.equals(toRemove);\r\n    });\r\n\r\n    _.forEach(toRemove.getParticipations(), function(pt) {\r\n      removeParticipation(pt);\r\n    });\r\n  }\r\n\r\n  function getExpense(id) {\r\n    return _(expenses).find(function(e) {\r\n      return e.id == id;\r\n    });\r\n  }\r\n\r\n  function createExpense(data, options) {\r\n    data = _.extend({\r\n      name: \"Expense \" + (expenses.length + 1),\r\n      sharing: \"equal\",\r\n      settled: false\r\n    }, data);\r\n\r\n    options = _.extend({}, options);\r\n\r\n    if (data.id === undefined) {\r\n      data.id = idSequence;\r\n      idSequence = idSequence + 1;\r\n    }\r\n\r\n    var expense = new Expense(data);\r\n    expenses.push(expense);\r\n\r\n    if (options.createParticipations === true) {\r\n      _.each(persons, function(p) {\r\n        createParticipation({person: p, expense: expense});\r\n      });\r\n    }\r\n\r\n    return expense;\r\n  }\r\n\r\n  function removeExpense(toRemove) {\r\n    toRemove = getExpense(toRemove.id);\r\n\r\n    if (!toRemove) return;\r\n\r\n    _.remove(expenses, function(e) {\r\n      return e.equals(toRemove);\r\n    });\r\n\r\n    _.forEach(toRemove.getParticipations(), function(pt) {\r\n      removeParticipation(pt);\r\n    });\r\n  }\r\n\r\n\r\n  function getParticipation(criteria) {\r\n    var toSeek = new Participation(criteria);\r\n    return _(participations).find(function(pt) {\r\n      return toSeek.equals(pt);\r\n    });\r\n  }\r\n\r\n  function createParticipation(data) {\r\n    if (getParticipation(data)) {\r\n      throw \"Duplicate participation\";\r\n    }\r\n\r\n    data = _.extend({\r\n      paid: 0,\r\n      share: 0\r\n    }, data);\r\n\r\n    var participation = new Participation(data);\r\n    participations.push(participation);\r\n\r\n    participation.expense.shareCost();\r\n\r\n    return participation;\r\n  }\r\n\r\n  function removeParticipation(toRemove) {\r\n    toRemove = getParticipation(toRemove);\r\n\r\n    if (!toRemove) return;\r\n\r\n    _.remove(participations, function(pt) {\r\n      return pt.equals(toRemove);\r\n    });\r\n\r\n    toRemove.expense.shareCost();\r\n  }\r\n\r\n\r\n  function Person(data) {\r\n    var _this = this;\r\n\r\n    _.extend(_this, data);\r\n\r\n    // Methods\r\n\r\n    _this.equals = equals;\r\n    _this.getCost = getCost;\r\n    _this.getSumOfShares = getSumOfShares;\r\n    _this.getBalance = getBalance;\r\n    _this.isBalanced = isBalanced;\r\n    _this.getParticipations = getParticipations;\r\n\r\n    ///////////////////////////////////////\r\n\r\n    var _myParticipations = _.chain(participations)\r\n      .filter(function(pt) {\r\n        return _this.equals(pt.person);\r\n      });\r\n\r\n    var _nonSettledParticipations = _myParticipations\r\n      .filter(function(pt) {\r\n        return !pt.expense.settled;\r\n      });\r\n\r\n    var _cost = _nonSettledParticipations\r\n      .filter(function(pt) {\r\n        return !pt.expense.settled;\r\n      })\r\n      .map(\"paid\").reduce(function(cost, paid) {\r\n        return cost.add(paid);\r\n      }, new Decimal(0));\r\n\r\n    var _sumOfShares = _nonSettledParticipations\r\n      .map(\"share\").reduce(function(sum, share) {\r\n        return sum.add(share);\r\n      }, new Decimal(0));\r\n\r\n    var _balance = _nonSettledParticipations\r\n      .map(function(pt) {\r\n        return (new Decimal(pt.share)).subtract(pt.paid);\r\n      })\r\n      .reduce(function(sum, b) {\r\n        return sum.add(b);\r\n      }, new Decimal(0));\r\n\r\n\r\n    function getCost() {\r\n      return _cost.value().toNumber();\r\n    }\r\n\r\n    function getSumOfShares() {\r\n      return _sumOfShares.value().toNumber();\r\n    }\r\n\r\n    function isBalanced() {\r\n      return _balance.value().toNumber() === 0;\r\n    }\r\n\r\n    function getBalance() {\r\n      return _balance.value().toNumber();\r\n    }\r\n\r\n    function getParticipations() {\r\n      return _myParticipations.value();\r\n    }\r\n\r\n    function equals(other) {\r\n      return (other instanceof Person) && (other.id === _this.id);\r\n    }\r\n\r\n  }\r\n\r\n\r\n  function Expense(data) {\r\n    var _this = this;\r\n\r\n    // Data\r\n\r\n    _.extend(_this, data);\r\n\r\n    // Methods\r\n\r\n    _this.getCost = getCost;\r\n    _this.getSumOfShares = getSumOfShares;\r\n    _this.getBalance = getBalance;\r\n    _this.isBalanced = isBalanced;\r\n    _this.getParticipations = getParticipations;\r\n    _this.shareCost = shareCost;\r\n    _this.equals = equals;\r\n\r\n    ///////////////////////////////////////\r\n\r\n    var _myParticipations = _.chain(participations).filter(function(p) {\r\n      return _this.equals(p.expense);\r\n    });\r\n\r\n    var _cost = _myParticipations\r\n      .map(\"paid\").reduce(function(cost, paid) {\r\n        return cost.add(paid);\r\n      }, new Decimal(0));\r\n\r\n    var _sumOfShares = _myParticipations\r\n      .map(\"share\").reduce(function(sum, share) {\r\n        return sum.add(share);\r\n      }, new Decimal(0));\r\n\r\n    var _balance = _myParticipations\r\n      .map(function(pt) {\r\n        return (new Decimal(pt.share)).subtract(pt.paid);\r\n      })\r\n      .reduce(function(sum, b) {\r\n        return sum.add(b);\r\n      }, new Decimal(0));\r\n\r\n\r\n    function getCost() {\r\n      return _cost.value().toNumber();\r\n    }\r\n\r\n    function getSumOfShares() {\r\n      return _sumOfShares.value().toNumber();\r\n    }\r\n\r\n    function isBalanced() {\r\n      return _balance.value().toNumber() === 0;\r\n    }\r\n\r\n    function getBalance() {\r\n      return _balance.value().toNumber();\r\n    }\r\n\r\n    function getParticipations() {\r\n      return _myParticipations.value();\r\n    }\r\n\r\n    function shareCost() {\r\n      if (_this.sharing === \"equal\") {\r\n        shareEqually();\r\n      }\r\n    }\r\n\r\n    function shareEqually() {\r\n      var participations = _this.getParticipations();\r\n      if (participations.length === 0) {\r\n        return;\r\n      }\r\n\r\n      var cost = new Decimal(_this.getCost());\r\n      var share = cost.divideBy(participations.length);\r\n      var lastShare = cost.subtract(share.multiply(participations.length - 1));\r\n\r\n      _.forEach(participations, function(p, i) {\r\n        if (i < participations.length - 1) {\r\n          p.share = share.toNumber();\r\n        }\r\n      });\r\n      _.last(participations).share = lastShare.toNumber();\r\n    }\r\n\r\n    function equals(other) {\r\n      return (other instanceof Expense) && (other.id === _this.id);\r\n    }\r\n\r\n  }\r\n\r\n\r\n  function Participation(data) {\r\n    var _this = this;\r\n\r\n    if (!data || !data.person || !data.expense) {\r\n      throw \"Undefined participation\";\r\n    }\r\n\r\n    // Data\r\n\r\n    _.extend(this, data);\r\n\r\n    // Methods\r\n\r\n    this.equals = equals;\r\n\r\n\r\n    ///////////////////////////////////////\r\n\r\n    function equals(other) {\r\n      return (other instanceof Participation) && _this.expense.equals(other.expense) && _this.person.equals(other.person);\r\n    }\r\n  }\r\n\r\n\r\n  function exportData() {\r\n    var isNotFunction = _.negate(_.isFunction);\r\n    var data = _.pick(_this, isNotFunction);\r\n    data.persons = _.map(persons, function(p) {\r\n      return _.pick(p, isNotFunction);\r\n    });\r\n    data.expenses = _.map(expenses, function(e) {\r\n      return _.pick(e, isNotFunction);\r\n    });\r\n    data.participations = _.map(participations, function(pt) {\r\n      return {personId: pt.person.id, expenseId: pt.expense.id, paid: pt.paid, share: pt.share};\r\n    });\r\n    return data;\r\n  }\r\n\r\n  function importData(data) {\r\n    idSequence = _([])\r\n        .concat(data.persons)\r\n        .concat(data.expenses)\r\n        .pluck(\"id\")\r\n        .max() + 1;\r\n    if (idSequence == -Infinity) {\r\n      idSequence = 1;\r\n    }\r\n\r\n    var separately = {persons: true, expenses: true, participations: true};\r\n    _.extend(_this, _.pick(data, function(value, key) {\r\n      return !separately[key];\r\n    }));\r\n\r\n    _.each(data.persons, function(p) {\r\n      createPerson(p);\r\n    });\r\n\r\n    _.each(data.expenses, function(e) {\r\n      createExpense(e);\r\n    });\r\n\r\n    _.each(data.participations, function(p) {\r\n      var person = getPerson(p.personId);\r\n      var expense = getExpense(p.expenseId);\r\n      createParticipation({person: person, expense: expense, paid: p.paid, share: p.share});\r\n    });\r\n\r\n    throwErrorIfInvalid();\r\n  }\r\n\r\n  function isValid() {\r\n    try {\r\n      throwErrorIfInvalid();\r\n      return true;\r\n    } catch (e) {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  function throwErrorIfInvalid() {\r\n\r\n    _.each(persons, function(p) {\r\n      if (!_.isNumber(p.id)) {\r\n        throw new Error(\"Person has no id\");\r\n      }\r\n    });\r\n\r\n    _.each(expenses, function(e) {\r\n      if (!_.isNumber(e.id)) {\r\n        throw new Error(\"Expense has no id\");\r\n      }\r\n    });\r\n\r\n    var idToEntity = {};\r\n    _.each(persons, function(p) {\r\n      idToEntity[p.id] = p;\r\n    });\r\n    _.each(expenses, function(e) {\r\n      idToEntity[e.id] = e;\r\n    });\r\n    _.each(participations, function(pt) {\r\n      if (!pt.person) {\r\n        throw new Error(\"Participation has no person\");\r\n      }\r\n      if (!idToEntity[pt.person.id]) {\r\n        throw new Error(\"Participation person is unknown\");\r\n      }\r\n      if (!pt.expense) {\r\n        throw new Error(\"Participation has no expense\");\r\n      }\r\n      if (!idToEntity[pt.expense.id]) {\r\n        throw new Error(\"Participation expense is unknown\");\r\n      }\r\n    });\r\n\r\n  }\r\n\r\n  function Error(message) {\r\n    this.message = message;\r\n  }\r\n\r\n};\r\n\r\n\r\nmodule.exports = BalanceSheet;\n},{\"angular\":\"angular\",\"lodash\":\"lodash\",\"simple-decimal-money\":\"simple-decimal-money\"}],5:[function(require,module,exports){\n\"use strict\";\r\n\r\nrequire(\"./route-config\");\r\nrequire(\"./balance-sheet\");\r\nrequire(\"./balance-sheet-service\");\r\nrequire(\"./balance-sheet-ctrl\");\n},{\"./balance-sheet\":4,\"./balance-sheet-ctrl\":2,\"./balance-sheet-service\":3,\"./route-config\":6}],6:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\n\r\nangular.module(\"debtApp\")\r\n  .config(config);\r\n\r\nfunction config($stateProvider) {\r\n\r\n  $stateProvider\r\n    .state(\"balanceSheet\", {\r\n      url: \"/\",\r\n      templateUrl : \"balance-sheet/balance-sheet.html\",\r\n      controller : \"BalanceSheetCtrl as vm\"\r\n    });\r\n  \r\n}\r\nconfig.$inject = [\"$stateProvider\"];\n},{\"angular\":\"angular\"}],7:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\nvar _ = require(\"lodash\");\r\nvar BalanceSheet = require('./balance-sheet/balance-sheet');\r\n\r\nangular.module(\"debtApp\")\r\n  .value(\"balanceSheetSaveCtrlConfig\", {wait: 500})\r\n  .controller(\"DebtAppCtrl\", DebtAppCtrl);\r\n\r\nfunction DebtAppCtrl(balanceSheetService,\r\n                     balanceSheetSaveCtrlConfig,\r\n                     openCreatePersonDialog,\r\n                     openCreateExpenseDialog,\r\n                     events,\r\n                     $mdDialog,\r\n                     $mdSidenav,\r\n                     $state,\r\n                     $scope,\r\n                     $window,\r\n                     $log) {\r\n\r\n  var vm = this;\r\n\r\n  vm.mainMenu = {\r\n    toggle: toggleMenu\r\n  };\r\n\r\n  vm.init = init;\r\n  vm.createPerson = createPerson;\r\n  vm.createExpense = createExpense;\r\n  vm.createNewSheet = createNewSheet;\r\n  vm.loadSheet = loadSheet;\r\n  vm.save = save;\r\n  vm.refresh = refresh;\r\n\r\n  var confirmCreateNewSheet = $mdDialog.confirm()\r\n    .title(\"Create new sheet\")\r\n    .content(\"The current sheet will be discarded. Please consider exporting it first. Continue?\")\r\n    .ok(\"Ok\").cancel(\"Cancel\");\r\n\r\n  var createObjectURL, revokeObjectURL, Blob, FileReader;\r\n\r\n  init();\r\n\r\n  /////////////////////////////////////////////////////////////\r\n\r\n  function toggleMenu() {\r\n    $mdSidenav(\"main-menu\").toggle();\r\n  }\r\n\r\n  function init() {\r\n    createObjectURL = ($window.URL || $window.webkitURL || {}).createObjectURL || angular.noop;\r\n    revokeObjectURL = ($window.URL || $window.webkitURL || {}).revokeObjectURL || angular.noop;\r\n    Blob = $window.Blob || angular.noop;\r\n    FileReader = $window.FileReader || angular.noop;\r\n\r\n    $scope.$on(events.BALANCE_SHEET_UPDATED, _.debounce(onBalanceSheetUpdated, balanceSheetSaveCtrlConfig.wait));\r\n    vm.refresh();\r\n  }\r\n\r\n  function onBalanceSheetUpdated() {\r\n    vm.refresh();\r\n    if (!vm.errorMessage) {\r\n      vm.save();\r\n    }\r\n  }\r\n\r\n  function save() {\r\n    try {\r\n      balanceSheetService.save();\r\n      vm.errorMessage = undefined;\r\n      $log.debug(\"Balance sheet saved\");\r\n    } catch (e) {\r\n      vm.errorMessage = \"Cannot save: \" + e.message;\r\n      $log.error(\"Error when saving balance sheet: \" + e.message);\r\n    }\r\n  }\r\n\r\n  function refresh() {\r\n    vm.balanceSheet = balanceSheetService.balanceSheet;\r\n    if (balanceSheetService.error) {\r\n      vm.errorMessage = \"Invalid sheet: \" + balanceSheetService.error.message;\r\n    } else {\r\n      vm.errorMessage = undefined;\r\n    }\r\n    updateJsonExportUrl();\r\n  }\r\n\r\n  function updateJsonExportUrl() {\r\n    var json = balanceSheetService.exportToJson();\r\n    var blob = new Blob([json], {type: \"application/json\"});\r\n    revokeObjectURL(vm.jsonExportUrl);\r\n    vm.jsonExportUrl = createObjectURL(blob);\r\n  }\r\n\r\n\r\n  function createPerson() {\r\n    openCreatePersonDialog()\r\n      .then(function(dialogResult) {\r\n        balanceSheetService.balanceSheet.createPerson(dialogResult.person, dialogResult.options);\r\n        onBalanceSheetUpdated();\r\n        $scope.$broadcast(events.BALANCE_SHEET_UPDATED);\r\n      });\r\n  }\r\n\r\n  function createExpense() {\r\n    openCreateExpenseDialog()\r\n      .then(function(dialogResult) {\r\n        balanceSheetService.balanceSheet.createExpense(dialogResult.expense, dialogResult.options);\r\n        onBalanceSheetUpdated();\r\n        $scope.$broadcast(events.BALANCE_SHEET_UPDATED);\r\n      });\r\n  }\r\n\r\n  function createNewSheet() {\r\n    $mdDialog.show(confirmCreateNewSheet)\r\n      .then(function() {\r\n        balanceSheetService.createNew();\r\n        onBalanceSheetUpdated();\r\n        $state.go(\"balanceSheet\");\r\n        $scope.$broadcast(events.BALANCE_SHEET_UPDATED);\r\n        vm.mainMenu.toggle();\r\n      }, function() {\r\n        vm.mainMenu.toggle();\r\n      });\r\n  }\r\n\r\n  function loadSheet(files) {\r\n    if (!files || !files.length) return;\r\n\r\n    var reader = new FileReader();\r\n    reader.onload = function() {\r\n      loadSheetFromJson(reader.result);\r\n    };\r\n    reader.readAsText(files[0]);\r\n    vm.mainMenu.toggle();\r\n  }\r\n\r\n  function loadSheetFromJson(json) {\r\n    balanceSheetService.loadFromJson(json);\r\n    onBalanceSheetUpdated();\r\n    $state.go(\"balanceSheet\");\r\n    $scope.$broadcast(events.BALANCE_SHEET_UPDATED);\r\n  }\r\n}\r\nDebtAppCtrl.$inject = [\"balanceSheetService\", \"balanceSheetSaveCtrlConfig\", \"openCreatePersonDialog\", \"openCreateExpenseDialog\", \"events\", \"$mdDialog\", \"$mdSidenav\", \"$state\", \"$scope\", \"$window\", \"$log\"];\n},{\"./balance-sheet/balance-sheet\":4,\"angular\":\"angular\",\"lodash\":\"lodash\"}],8:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\n\r\nangular\r\n  .module(\"debtApp\")\r\n    .factory(\"debtService\", debtService);\r\n\r\n\r\nfunction debtService(solveDebts) {\r\n  \r\n  return {\r\n    computeDebts: computeDebts,\r\n    organizeByDebtor: organizeByDebtor\r\n  };\r\n  \r\n  /////////////////////////////////////////\r\n  \r\n  function computeDebts(participations) {\r\n    return solveDebts(participations);\r\n  } \r\n  \r\n  function organizeByDebtor(debts) {\r\n    var debtorList = [];\r\n    var debtorIndices = {};\r\n    \r\n    angular.forEach(debts, function(d) {\r\n      var debtorIndex = debtorIndices[d.debtor.id];\r\n      var debtor;\r\n      if (debtorIndex === undefined) {\r\n        debtorIndex = debtorList.length;\r\n        debtor = {debtor: d.debtor, debts: []};\r\n        debtorList.push(debtor);\r\n        debtorIndices[d.debtor.id] = debtorIndex;\r\n      }\r\n      debtor = debtorList[debtorIndex];\r\n      debtor.debts.push({creditor: d.creditor, amount: d.amount});\r\n    });\r\n    \r\n    angular.forEach(debtorList, function(d) {\r\n      d.debts.sort(function(d1, d2) {\r\n        return d1.creditor.name.localeCompare(d2.creditor.name);\r\n      });\r\n    });\r\n    debtorList.sort(function(d1, d2) {\r\n      return d1.debtor.name.localeCompare(d2.debtor.name);\r\n    });\r\n    \r\n    return debtorList;\r\n  }\r\n  \r\n}\r\ndebtService.$inject = [\"solveDebts\"];\n},{\"angular\":\"angular\"}],9:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\nvar Decimal = require(\"simple-decimal-money\");\r\nvar Random = require(\"random-js\");\r\n\r\nangular\r\n  .module(\"debtApp\")\r\n    .factory(\"solveDebts\", debtSolverFactory);\r\n\r\n\r\n\r\n\r\n/**\r\n * A function that computes debts from given expense participations.\r\n *  \r\n * We form a linear system Ax = b. A is a binary matrix with size (d+c)*(d*c),\r\n * where d is the number of debtors and c is the number of creditors. Columns of A \r\n * are ordered so that x[c*i + j] is the value of the debt owed by debtor i to creditor j.\r\n * \r\n * Elements of b are balances - converted to non-negative - of the debtors and the creditors \r\n * with the following correspondence:\r\n * \r\n * b[0]: first debtor\r\n * ... \r\n * b[d-1]: last debtor\r\n * b[d] = first creditor\r\n * ... \r\n * b[d+c-1] = last creditor\r\n * \r\n * The coefficient matrix A is constructed so that for each person i, we have equation\r\n * where total value of debts to paid by i (if i is a debtor) or to i (if i is a creditor) equals i's \r\n * non-negative balance.\r\n * \r\n * Rows of A indexed between [0, d-1] represent the debtors in the order \r\n * of debtors> list. Rows of A indexed between [d, d+c-1] represent the \r\n * creditors in the order of creditors list.\r\n * \r\n * Ideally, we would like to find the sparsest (most 0's) solution x to Ax = b\r\n * in case the system is underdetermined and has an infinite number of solutions.\r\n * \r\n * This problem, posed as min ||x||_0  s.t. Ax = b, x >= 0, where ||x||_0 is the number\r\n * of non-zero elements, is in general an NP-hard problem. There is some amount of literature\r\n * about the problem (keywords: sparse nonnegative solution of underdetermined linear equations).\r\n * The problem is usually approximated as convex optimization problem by minimizing L1-norm (sum of \r\n * absolute value) instead. One option could be to use the cassowary javascript library.\r\n * \r\n * In this function we find a non-negative x using Gaussian elimination and setting random combinations \r\n * of free variables to zero until we find a non-negative solution.\r\n */\r\nfunction debtSolverFactory(solveLinearSystem) {\r\n  \r\n  return solve;\r\n  \r\n  \r\n  function solve(participations) {\r\n    if (!participations || participations.length === 0) {\r\n      return [];\r\n    }\r\n    var balances = computeBalances(participations);\r\n    if (!hasNonZeroBalance(balances)) {\r\n      return [];\r\n    }\r\n    var roles = getDebtorsAndCreditors(balances);\r\n    var linearSystem = createDebtEquations(roles);\r\n    var debtVector = solveDebts(linearSystem);\r\n    var debts = createDebts(debtVector, roles);\r\n    return debts;\r\n  }\r\n  \r\n  function computeBalances(participations) {\r\n    var balances = {};\r\n    angular.forEach(participations, function(p) {\r\n      var b = balances[p.person.id];\r\n      if (b === undefined) {\r\n        b = {person: p.person, balance: new Decimal(0)};\r\n        balances[p.person.id] = b;\r\n      }\r\n      var paid = new Decimal(p.paid);\r\n      var share = new Decimal(p.share);\r\n      b.balance = b.balance.add(share.subtract(paid));\r\n    });\r\n\r\n    angular.forEach(balances, function(b) {\r\n      b.balance = b.balance.toNumber();\r\n    });\r\n    \r\n    return balances;\r\n  }\r\n  \r\n  function hasNonZeroBalance(balances) {\r\n    var result = false;\r\n    angular.forEach(balances, function(b) {\r\n      if (b.balance !== 0) {\r\n        result = true;\r\n      }\r\n    });\r\n    return result;\r\n  }\r\n  \r\n  function getDebtorsAndCreditors(balances) {\r\n    var debtors = [];\r\n    var creditors = [];\r\n    \r\n    angular.forEach(balances, function(b) {\r\n      if (b.balance <= 0) {\r\n        creditors.push(b);\r\n      } else {\r\n        debtors.push(b);\r\n      }\r\n    });\r\n    \r\n    return {\r\n      debtors: debtors,\r\n      creditors: creditors\r\n    };\r\n  }\r\n  \r\n  function createDebtEquations(roles) {\r\n    var d = roles.debtors.length;\r\n    var c = roles.creditors.length;\r\n    \r\n    // Right-hand side vector, creditor balances converted to non-negative to allow binary coefficients\r\n    var b = []; \r\n    for (var i = 0; i < d; i++) {\r\n      b[i] = (new Decimal(roles.debtors[i].balance)).multiply(100).toNumber();\r\n    }\r\n    for (var i = 0; i < c; i++) {\r\n      b[d + i] = (new Decimal(roles.creditors[i].balance)).multiply(-100).toNumber();\r\n    }\r\n    \r\n    // Coefficient matrix\r\n    var A = initMatrix(d + c, d*c); \r\n    \r\n    // Coefficients of equations \"sum of debts paid by debtor = debtor's balance\"\r\n    for (var i = 0; i < d; i++) {\r\n      for (var j = i*c; j < (i+1)*c; j++) {\r\n        A[i][j] = 1;\r\n      }\r\n    }\r\n    \r\n    // Coefficients of equations \"sum debts received by creditor = creditor's balance\"\r\n    for (var i = d; i < c+d; ++i) {\r\n      for (var j = (i-d); j < d*c; j += c) {\r\n        A[i][j] = 1;\r\n      }\r\n    } \r\n    \r\n    return {\r\n      A: A,\r\n      b: b\r\n    };\r\n  }\r\n  \r\n  function initMatrix(rows, cols) {\r\n    var A = [];\r\n    for (var i = 0; i < rows; i++) {\r\n      A[i] = [];\r\n      for (var j = 0; j < cols; j++) {\r\n        A[i][j] = 0;\r\n      }\r\n    }\r\n    return A;\r\n  }\r\n  \r\n  // Solve debts, ensuring a non-negative solution \r\n  function solveDebts(linearSystem) {\r\n    var solution = solveLinearSystem(linearSystem);\r\n    var numVars = solution.numberOfVariables;\r\n    var numFreeVars = solution.numberOfFreeVariables;\r\n    \r\n    if (numFreeVars === 0) {\r\n      return solution.xVector;\r\n    }\r\n\r\n    // Known seed so we always get the same result from\r\n    // the same system.\r\n    var randomEngine = Random.engines.mt19937();\r\n    randomEngine.seed(20150312);\r\n\r\n    var toEliminate;\r\n    do {\r\n      \r\n      var A = angular.copy(linearSystem.A);\r\n      var b = linearSystem.b;\r\n      \r\n      // Pick random numFreeVars variables for elimination\r\n      \r\n      var candidates = [];\r\n      for (var i = 0; i < numVars; i++) {\r\n        candidates[i] = i;\r\n      }\r\n      \r\n      toEliminate = [];\r\n      for (var i = 0; i < numFreeVars; i++) {\r\n        var candidateIdx = Random.integer(0, candidates.length-1)(randomEngine);\r\n        toEliminate.push(candidates[candidateIdx]);\r\n        candidates.splice(candidateIdx, 1);\r\n      }\r\n      \r\n      // Eliminate the chosen variables by setting their coefficients to zero\r\n      \r\n      for (var i = 0; i < A.length; i++) {\r\n        for (var j = 0; j < toEliminate.length; j++) {\r\n          A[i][toEliminate[j]] = 0;\r\n        }\r\n      }\r\n\r\n      // Solve the updated system\r\n      \r\n      solution = solveLinearSystem({A: A, b: b});\r\n      \r\n    } while (!isNonNegative(solution.xVector));\r\n\r\n    \r\n    return solution.xVector;\r\n  }\r\n  \r\n  function isNonNegative(vector) {\r\n    if (!vector) {\r\n      return false;\r\n    }\r\n    for (var i = 0; i < vector.length; i++) {\r\n      if (vector[i] < 0) {\r\n        return false;\r\n      }\r\n    }\r\n    return true;\r\n  }\r\n  \r\n  function createDebts(debtVector, roles) {\r\n    var debts = [];\r\n\r\n    for (var i = 0; i < debtVector.length; i++) {\r\n      if (debtVector[i] !== 0) {\r\n        var debtorIdx = Math.floor(i/roles.creditors.length);\r\n        var creditorIdx = i - roles.creditors.length*debtorIdx;\r\n        var amount = (new Decimal(debtVector[i])).divideBy(100).toNumber();\r\n        var debt = {debtor: roles.debtors[debtorIdx].person, creditor: roles.creditors[creditorIdx].person, amount: amount};\r\n        debts.push(debt);\r\n      }\r\n    }\r\n    \r\n    return debts;\r\n  }\r\n}\r\ndebtSolverFactory.$inject = [\"solveLinearSystem\"];  \n},{\"angular\":\"angular\",\"random-js\":\"random-js\",\"simple-decimal-money\":\"simple-decimal-money\"}],10:[function(require,module,exports){\n\"use strict\";\r\n\r\nrequire(\"./lin-eq-solver\");\r\nrequire(\"./lin-eq-solver-factory\");\r\nrequire(\"./debt-solver\");\r\nrequire(\"./debt-service\");\n},{\"./debt-service\":8,\"./debt-solver\":9,\"./lin-eq-solver\":12,\"./lin-eq-solver-factory\":11}],11:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar solve = require(\"./lin-eq-solver\");\r\nvar angular = require(\"angular\");\r\n\r\nangular.module(\"debtApp\")\r\n.factory(\"solveLinearSystem\", solveLinearSystem);\r\n\r\nfunction solveLinearSystem() {\r\n  return solve;\r\n}\n},{\"./lin-eq-solver\":12,\"angular\":\"angular\"}],12:[function(require,module,exports){\n\"use strict\";\r\n\r\n\r\nfunction solve(input) {\r\n\t// Internal copies of the linear system and its dimensions\r\n\tvar coefMatrix, constVector, xVector;\r\n\tvar m, n, rank, numberOfSolutions;\r\n\t\r\n\t// With these we can \"virtually\" rearrange the rows and columns\r\n\t// for better numerical stability in the variable elimination phases.\r\n\t// At step i, row index pivotToEquationMap[i] is the pivot equation and\r\n\t// it is used for eliminating variable index pivotToVariableMap[i] from all the\r\n\t// other equations.\r\n\tvar pivotToEquationMap, pivotToVariableMap, equationScale;\r\n\t\r\n\tvalidate();\r\n\tinitialize();\r\n\ttransformToRowEchelonForm();\r\n\treduceRowEchelonForm();\r\n\tdetermineRank();\r\n\tdetermineNumberOfSolutions();\r\n\tdetermineSolution();\r\n\r\n\treturn {\r\n\t\txVector: xVector,\r\n\t\tnumberOfEquations: m,\r\n\t\tnumberOfVariables: n,\r\n\t\trank: rank,\r\n\t\tnumberOfFreeVariables: n - rank,\r\n\t\tnumberOfSolutions: numberOfSolutions\r\n\t};\r\n\t\r\n\t/////////////////////////////////////////////////////////////\r\n\t\r\n\tfunction validate() {\r\n    \tif (!input || !input.A || !input.b) {\r\n    \t\tthrow \"Null matrix A or vector b in system Ax = b\";\r\n    \t}\r\n    \t\r\n    \tif (input.A.length < 1 || input.A[0].length < 1) {\r\n    \t\tthrow \"Matrix A in Ax = b has no rows or no columns\";\r\n    \t}\r\n\t\t\r\n    \tif (input.A.length != input.b.length) {\r\n    \t\tthrow \"The dimensions of the matrix and the constant vector are incompatible\"; \r\n    \t}\r\n\t}\r\n\r\n\tfunction initialize() {\r\n\t\tcoefMatrix = copyMatrix(input.A);\r\n\t\tconstVector = copyArray(input.b);\r\n\t\t\r\n\t\tm = coefMatrix.length;\r\n\t\tn = coefMatrix[0].length;\r\n\r\n\t\tpivotToEquationMap = [];\r\n\t\tfor (var i = 0; i < m; i++) {\r\n\t\t\tpivotToEquationMap[i] = i;\r\n\t\t}\r\n\t\t\r\n\t\tequationScale = [];\r\n\t\tfor (var i = 0; i < m; i++) {\r\n\t\t\tequationScale[i] = 0;\r\n\t\t\tfor (var j = 0; j < n; j++) {\r\n\t\t\t\tvar abscoef = Math.abs(coefMatrix[i][j]);\r\n\t\t\t\tif (abscoef > equationScale[i]) {\r\n\t\t\t\t\tequationScale[i] = abscoef;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tpivotToVariableMap = [];\r\n\t\tfor (var j = 0; j < n; j++) {\r\n\t\t\tpivotToVariableMap[j] = j;\r\n\t\t}\r\n\t}\r\n\r\n\tfunction transformToRowEchelonForm() {\r\n\t\tvar pivotIdx = 0; \r\n\t\tvar knownFreeVariables = [];\r\n\t\t\r\n\t\twhile (pivotIdx < m-1) { \r\n\r\n\t\t\t// Choose the best pivot-equation for eliminating variable pivotToVariableMap[pivotIdx] \r\n\t\t\t// from equations equations not yet used as pivot equations.\r\n\t\t\tvar maxRatio = 0;\r\n\t\t\tvar bestPivotEquationIndex = pivotIdx;\r\n\t\t\tfor (var i = pivotIdx; i < m; ++i) {\r\n\t\t\t\tvar rowIdx = pivotToEquationMap[i];\r\n\t\t\t\tvar colIdx = pivotToVariableMap[pivotIdx];\r\n\t\t\t\tvar ratio = Math.abs(coefMatrix[rowIdx][colIdx]/equationScale[rowIdx]);\r\n\t\r\n\t\t\t\tif (ratio > maxRatio) {\r\n\t\t\t\t\tmaxRatio = ratio;\r\n\t\t\t\t\tbestPivotEquationIndex = i;\t\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t// If maxRatio == 0, the coefficient of variable pivotToVariableMap[pivotIdx] is 0 in all the rest of the equations. \r\n\t\t\t// That is pivotToVariableMap[pivotIdx] is a free variable. Find the next suitable variable.\r\n\t\t\tif (maxRatio === 0) {\r\n\t\t\t\tvar currPivotVaribleIdx = pivotToVariableMap[pivotIdx];\r\n\t\t\t\tknownFreeVariables[currPivotVaribleIdx] = true;     \r\n\t\t\t\t\r\n\t\t\t\t// The next one must not be a free variable.\r\n\t\t\t\tvar i = pivotIdx;\r\n\t\t\t\tvar newPivotVariableIdx = currPivotVaribleIdx;\r\n\t\t\t\twhile (newPivotVariableIdx == currPivotVaribleIdx && i < n-1) {\r\n\t\t\t\t\t++i;\r\n\t\t\t\t\tif (!knownFreeVariables[pivotToVariableMap[i]]) {\r\n\t\t\t\t\t\tnewPivotVariableIdx = pivotToVariableMap[i];\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (newPivotVariableIdx != currPivotVaribleIdx) {\r\n\t\t\t\t\tpivotToVariableMap[pivotIdx] = newPivotVariableIdx;\r\n\t\t\t\t\tpivotToVariableMap[i] = currPivotVaribleIdx;\r\n\t\t\t\t\tcontinue;\r\n\t\t\t\t} else { \r\n\t\t\t\t\t// Could not find a suitable variable. This means the row echelon form is ready.\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\r\n\t\t\tvar temp = pivotToEquationMap[pivotIdx];\r\n\t\t\tpivotToEquationMap[pivotIdx] = pivotToEquationMap[bestPivotEquationIndex];\r\n\t\t\tpivotToEquationMap[bestPivotEquationIndex] = temp;     \r\n\t\t\t\r\n\t\t\t// Elimination phase\r\n\t\t\tvar pivotRowIdx = pivotToEquationMap[pivotIdx];\r\n\t\t\tvar pivotColIdx = pivotToVariableMap[pivotIdx];\r\n\t\t\tfor (i = pivotIdx + 1; i < m; ++i) {\r\n\t\t\t\tvar rowIdx = pivotToEquationMap[i];\r\n\t\t\t\tvar mult = coefMatrix[rowIdx][pivotColIdx] / coefMatrix[pivotRowIdx][pivotColIdx];\r\n\r\n\t\t\t\tfor (var j = pivotIdx + 1; j < n; ++j) {\r\n\t\t\t\t\tvar colIndex = pivotToVariableMap[j];\r\n\t\t\t\t\tcoefMatrix[rowIdx][colIndex] = coefMatrix[rowIdx][colIndex] - mult * coefMatrix[pivotRowIdx][colIndex];\r\n\t\t\t\t}\r\n\r\n\t\t\t\tcoefMatrix[rowIdx][pivotColIdx] = 0;\r\n\t\t\t\tconstVector[rowIdx] = constVector[rowIdx] - mult * constVector[pivotRowIdx];\r\n\t\t\t}\r\n\r\n\t\t\tpivotIdx++;\r\n\t\t\t\r\n\t\t}\r\n\t}\r\n\r\n\tfunction reduceRowEchelonForm() {\r\n\t\t// Eliminate pivot variables from previous pivot equations by going through the pivot steps in reverse order.\r\n\t\tvar pivotIndex;\r\n\t\tfor (pivotIndex = Math.min(m, n) - 1; pivotIndex > 0; --pivotIndex) {\r\n\t\t\tvar pivotRowIdx = pivotToEquationMap[pivotIndex];\r\n\t\t\tvar pivotColIdx = pivotToVariableMap[pivotIndex];\r\n\t\t\t\r\n\t\t\tif (coefMatrix[pivotRowIdx][pivotColIdx] === 0) {\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tfor (var i = pivotIndex - 1; i > -1; --i) {\r\n\t\t\t\t\r\n\t\t\t\tvar mult = coefMatrix[pivotToEquationMap[i]][pivotToVariableMap[pivotIndex]]/coefMatrix[pivotToEquationMap[pivotIndex]][pivotToVariableMap[pivotIndex]];\r\n\t\t\t\tfor (var j = 0; j < n; ++j) {\r\n\t\t\t\t\tcoefMatrix[pivotToEquationMap[i]][pivotToVariableMap[j]] -= mult*coefMatrix[pivotToEquationMap[pivotIndex]][pivotToVariableMap[j]];\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tconstVector[pivotToEquationMap[i]] -= mult*constVector[pivotToEquationMap[pivotIndex]];\r\n\t\t\t}            \t\t\r\n\t\t}\r\n\t\t\r\n\t\t// Normalize the coeffients in each row and the rhs value by the coeffient of the pivot variable in the row\r\n\t\tfor (pivotIndex = 0; pivotIndex < Math.min(m, n); ++pivotIndex) {\r\n\t\t\t\r\n\t\t\tif (coefMatrix[pivotToEquationMap[pivotIndex]][pivotToVariableMap[pivotIndex]] === 0) {\r\n\t\t\t\tcontinue; \r\n\t\t\t}\r\n\r\n\t\t\tvar div = coefMatrix[pivotToEquationMap[pivotIndex]][pivotToVariableMap[pivotIndex]];\r\n\t\t\tfor (var j = 0; j < n; ++j) {\r\n\t\t\t\tcoefMatrix[pivotToEquationMap[pivotIndex]][j] = coefMatrix[pivotToEquationMap[pivotIndex]][j]/div;\r\n\t\t\t}\r\n\t\t\tconstVector[pivotToEquationMap[pivotIndex]] = constVector[pivotToEquationMap[pivotIndex]]/div;\r\n\t\t}\r\n\t\t\r\n\t}\r\n\r\n\tfunction determineRank() {\r\n\t\trank = 0;\r\n\t\tvar i,j;\r\n\t\t\r\n\t\tcolumns: \r\n\t\tfor (j=0; j<n; ++j) {\r\n\t\t\trows:\r\n\t\t\tfor (i=0; i<m; ++i) { \r\n\t\t\t\tif (i != j && coefMatrix[pivotToEquationMap[i]][pivotToVariableMap[j]] !== 0) {\r\n\t\t\t\t\tbreak columns;\r\n\t\t\t\t}\r\n\t\t\t\telse if (i == j && coefMatrix[pivotToEquationMap[i]][pivotToVariableMap[j]] != 1) {\r\n\t\t\t\t\tbreak columns;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t++rank;\r\n\t\t}\r\n\t}\r\n\r\n\tfunction determineNumberOfSolutions() {\r\n\t\t\r\n\t\tvar b2IsZero = true;\r\n\r\n\t\tfor (var i = rank; i < m; ++i) {\r\n\t\t\tif (constVector[pivotToEquationMap[i]] !== 0) {\r\n\t\t\t\tb2IsZero = false;\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tif (rank < m && !b2IsZero) {\r\n\t\t\tnumberOfSolutions = 0;\r\n\t\t} else if (rank == n && (rank == m || b2IsZero)) {\r\n\t\t\tnumberOfSolutions = 1;\r\n\t\t} else if (rank < n && (rank == m || b2IsZero)) {\r\n\t\t\tnumberOfSolutions = Number.MAX_VALUE;\r\n\t\t}\r\n\t}\r\n\r\n\tfunction determineSolution() {\r\n\t\tif (numberOfSolutions === 0) {\r\n\t\t\txVector = undefined;\r\n\t\t} else {\r\n\t\t\txVector = initArray(n);\r\n\t\t\tfor (var i = 0; i < rank; ++i) {\r\n\t\t\t\txVector[pivotToVariableMap[i]] = constVector[pivotToEquationMap[i]];\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction initArray(size) {\r\n\t\tvar array = [];\r\n\t\tfor (var i = 0; i < size; i++) {\r\n\t\t\tarray[i] = 0;\r\n\t\t}\r\n\t\treturn array;\r\n\t}\r\n\t\r\nfunction copyArray(input) {\r\n\treturn input.slice();\r\n}\r\n\r\nfunction copyMatrix(input) {\r\n\tvar copy = [];\r\n\tfor (var i = 0; i < input.length; i++) {\r\n\t\tcopy[i] = input[i].slice();\r\n\t}\r\n\treturn copy;\r\n}\r\n\t\r\n\r\nmodule.exports = solve;\n},{}],13:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\n\r\nangular.module(\"debtApp\")\r\n.factory(\"openCreateExpenseDialog\", openCreateExpenseDialog);\r\n\r\n\r\nfunction openCreateExpenseDialog($mdDialog) {\r\n  \r\n  return open;\r\n  \r\n  function open() {\r\n    return $mdDialog.show({\r\n      templateUrl: \"expenses/create-expense-dialog.html\",\r\n      controller: DialogController,\r\n      controllerAs: \"vm\"\r\n    });\r\n  }\r\n  \r\n}\r\nopenCreateExpenseDialog.$inject = [\"$mdDialog\"];\r\n\r\nfunction DialogController($mdDialog) {\r\n  var vm = this;\r\n  \r\n  vm.ok = ok;\r\n  vm.cancel = cancel;\r\n  vm.init = init;\r\n  \r\n  init();\r\n  \r\n  \r\n  function init() {\r\n    vm.expense = {\r\n      name: undefined,\r\n      sharing: \"equal\"\r\n    };\r\n    vm.options = {\r\n      createParticipations: true\r\n    };\r\n  }\r\n\r\n  function ok() {\r\n    $mdDialog.hide({expense: vm.expense, options: vm.options});\r\n  }\r\n  \r\n  function cancel() {\r\n    $mdDialog.cancel();\r\n  }\r\n}\r\nDialogController.$inject = [\"$mdDialog\"];\n},{\"angular\":\"angular\"}],14:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar _ = require('lodash');\r\nvar angular = require(\"angular\");\r\n\r\nangular\r\n  .module(\"debtApp\")\r\n  .controller(\"ExpenseDetailCtrl\", ExpenseDetailCtrl);\r\n\r\nfunction ExpenseDetailCtrl(balanceSheetService, debtService, events, $mdDialog, $stateParams, $state, $scope) {\r\n  var vm = this;\r\n\r\n  var confirmRemoveExpense = $mdDialog.confirm()\r\n    .content(\"Really delete this expense?\")\r\n    .ok(\"Ok\").cancel(\"Cancel\");\r\n\r\n  vm.init = init;\r\n  vm.setParticipation = setParticipation;\r\n  vm.updateExpense = updateExpense;\r\n  vm.removeExpense = removeExpense;\r\n\r\n  init();\r\n\r\n  /////////////////////////////////////////////////////////////\r\n\r\n  function init() {\r\n    vm.balanceSheet = balanceSheetService.balanceSheet;\r\n    vm.expense = vm.balanceSheet.getExpense($stateParams.id);\r\n    vm.isParticipant = {};\r\n    vm.everyoneParticipates = true;\r\n    updateExpense();\r\n\r\n    $scope.$on(events.BALANCE_SHEET_UPDATED, function(event) {\r\n      if (event.targetScope != $scope) {\r\n        vm.updateExpense();\r\n      }\r\n    });\r\n  }\r\n\r\n  function updateExpense() {\r\n    vm.expense.shareCost();\r\n    vm.isParticipant = getParticipationMap();\r\n    vm.debtsByDebtor = computeDebts();\r\n    vm.cost = vm.expense.getCost();\r\n    vm.sumOfShares = vm.expense.getSumOfShares();\r\n    $scope.$emit(events.BALANCE_SHEET_UPDATED);\r\n  }\r\n\r\n  function getParticipationMap() {\r\n    var map = {};\r\n\r\n    angular.forEach(vm.balanceSheet.persons, function(person) {\r\n      map[person.id] = false;\r\n      angular.forEach(vm.expense.getParticipations(), function(p) {\r\n        if (p.person.equals(person)) {\r\n          map[person.id] = true;\r\n        }\r\n      });\r\n    });\r\n\r\n    return map;\r\n  }\r\n\r\n  function setParticipation(person, isParticipant) {\r\n    if (isParticipant) {\r\n      vm.balanceSheet.createParticipation({expense: vm.expense, person: person});\r\n    } else {\r\n      vm.balanceSheet.removeParticipation({expense: vm.expense, person: person});\r\n    }\r\n    updateExpense();\r\n  }\r\n\r\n  function removeExpense() {\r\n    $mdDialog.show(confirmRemoveExpense)\r\n      .then(doRemoveExpense);\r\n  }\r\n\r\n  function doRemoveExpense() {\r\n    vm.balanceSheet.removeExpense(vm.expense);\r\n    $scope.$emit(events.BALANCE_SHEET_UPDATED);\r\n    $state.go(\"balanceSheet\");\r\n  }\r\n\r\n  function computeDebts() {\r\n    if (vm.expense.isBalanced()) {\r\n      var debts = debtService.computeDebts(vm.expense.getParticipations());\r\n      return debtService.organizeByDebtor(debts);\r\n    }\r\n  }\r\n\r\n\r\n}\r\nExpenseDetailCtrl.$inject = [\"balanceSheetService\", \"debtService\", \"events\", \"$mdDialog\", \"$stateParams\", \"$state\", \"$scope\"];\r\n\n},{\"angular\":\"angular\",\"lodash\":\"lodash\"}],15:[function(require,module,exports){\n\"use strict\";\r\n\r\nrequire(\"./route-config\");\r\nrequire(\"./expense-detail-ctrl\");\r\nrequire(\"./create-expense-dialog\");\n},{\"./create-expense-dialog\":13,\"./expense-detail-ctrl\":14,\"./route-config\":16}],16:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\n\r\nangular.module(\"debtApp\")\r\n\t.config(config);\r\n\r\nfunction config($stateProvider) {\r\n\r\n\t$stateProvider\r\n\t\t.state(\"expense\", {\r\n\t\t\turl: \"/expenses/:id\",\r\n\t    templateUrl: \"expenses/expense-detail.html\",\r\n      controller: \"ExpenseDetailCtrl as vm\"\r\n\t\t})\r\n\t\t;\r\n}\r\nconfig.$inject = [\"$stateProvider\"];\n},{\"angular\":\"angular\"}],17:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\nvar _ = require('lodash');\r\n\r\nangular.module(\"debtApp\")\r\n  .filter(\"balance\", balance);\r\n\r\n\r\nfunction balance($filter) {\r\n  return function balance(value) {\r\n    if (value > 0) {\r\n      return \"+\" + $filter(\"number\")(value, \"2\");\r\n    } else if (value <= 0) {\r\n      return $filter(\"number\")(value, \"2\");\r\n    } else {\r\n      return undefined;\r\n    }\r\n  };\r\n}\r\nbalance.$inject = [\"$filter\"];\n},{\"angular\":\"angular\",\"lodash\":\"lodash\"}],18:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\n\r\nangular.module(\"debtApp\")\r\n.factory(\"openCreatePersonDialog\", openCreatePersonDialog);\r\n\r\n\r\nfunction openCreatePersonDialog($mdDialog) {\r\n  \r\n  return open;\r\n  \r\n  function open() {\r\n    return $mdDialog.show({\r\n      templateUrl: \"persons/create-person-dialog.html\",\r\n      controller: DialogController,\r\n      controllerAs: \"vm\"\r\n    });\r\n  }\r\n  \r\n}\r\nopenCreatePersonDialog.$inject = [\"$mdDialog\"];\r\n\r\nfunction DialogController($mdDialog) {\r\n  var vm = this;\r\n  \r\n  vm.ok = ok;\r\n  vm.cancel = cancel;\r\n  vm.init = init;\r\n  \r\n  init();\r\n  \r\n  \r\n  function init() {\r\n    vm.person = {\r\n      name: undefined\r\n    };\r\n    vm.options = {\r\n      createParticipations: true\r\n    };\r\n  }\r\n\r\n  function ok() {\r\n    $mdDialog.hide({person: vm.person, options: vm.options});\r\n  }\r\n  \r\n  function cancel() {\r\n    $mdDialog.cancel();\r\n  }\r\n}\r\nDialogController.$inject = [\"$mdDialog\"];\n},{\"angular\":\"angular\"}],19:[function(require,module,exports){\n\"use strict\";\r\n\r\nrequire(\"./route-config\");\r\nrequire(\"./person-detail-ctrl\");\r\nrequire(\"./create-person-dialog\");\r\nrequire(\"./balance-filter\");\n},{\"./balance-filter\":17,\"./create-person-dialog\":18,\"./person-detail-ctrl\":20,\"./route-config\":21}],20:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\nvar _ = require('lodash');\r\n\r\nangular.module(\"debtApp\")\r\n  .controller(\"PersonDetailCtrl\", PersonDetailCtrl);\r\n\r\nfunction PersonDetailCtrl(balanceSheetService, debtService, events, $state, $stateParams, $mdDialog, $scope, $log) {\r\n\r\n  var vm = this;\r\n  var confirmRemovePerson;\r\n\r\n  vm.init = init;\r\n  vm.refresh = refresh;\r\n  vm.updateExpense = updateExpense;\r\n  vm.setParticipation = setParticipation;\r\n  vm.removePerson = removePerson;\r\n  vm.updatePerson = updatePerson;\r\n\r\n  init();\r\n\r\n  function init() {\r\n    vm.balanceSheet = balanceSheetService.balanceSheet;\r\n    vm.person = vm.balanceSheet.getPerson($stateParams.id);\r\n\r\n    refresh();\r\n\r\n    confirmRemovePerson = $mdDialog.confirm()\r\n      .content(\"Really delete this person?\")\r\n      .ok(\"Ok\").cancel(\"Cancel\");\r\n\r\n    $scope.$on(events.BALANCE_SHEET_UPDATED, vm.refresh);\r\n  }\r\n\r\n  function refresh() {\r\n    vm.isParticipant = getParticipationMap();\r\n    vm.cost = vm.person.getCost();\r\n    vm.sumOfShares = vm.person.getSumOfShares();\r\n    vm.balance = vm.person.getBalance();\r\n    var debtResult = computeDebts();\r\n    vm.debtRole = debtResult.role;\r\n    vm.debts = debtResult.debts;\r\n  }\r\n\r\n  function getParticipationMap() {\r\n    var map = {};\r\n\r\n    _.forEach(vm.balanceSheet.expenses, function(expense) {\r\n      map[expense.id] = false;\r\n      _.forEach(vm.person.getParticipations(), function(pt) {\r\n        if (pt.expense.equals(expense)) {\r\n          map[expense.id] = true;\r\n        }\r\n      });\r\n    });\r\n\r\n    return map;\r\n  }\r\n\r\n  function updateExpense(expense) {\r\n    expense.shareCost();\r\n    refresh();\r\n    $scope.$emit(events.BALANCE_SHEET_UPDATED);\r\n  }\r\n\r\n  function setParticipation(expense, isParticipant) {\r\n    if (isParticipant) {\r\n      vm.balanceSheet.createParticipation({expense: expense, person: vm.person});\r\n    } else {\r\n      vm.balanceSheet.removeParticipation({expense: expense, person: vm.person});\r\n    }\r\n    vm.updateExpense(expense);\r\n  }\r\n\r\n  function computeDebts() {\r\n    var result = {\r\n      role: undefined,\r\n      debts: undefined\r\n    };\r\n\r\n    if (!vm.balanceSheet.isBalanced()) {\r\n      result.role = \"unbalanced\";\r\n      return result;\r\n    }\r\n\r\n    if (vm.balance > 0) {\r\n      result.role = \"debtor\";\r\n    } else if (vm.balance < 0) {\r\n      result.role = \"creditor\";\r\n    } else {\r\n      result.role = \"settled\";\r\n      return result;\r\n    }\r\n\r\n    var counterRole = {\r\n      \"debtor\": \"creditor\",\r\n      \"creditor\": \"debtor\"\r\n    };\r\n\r\n    var debts = debtService.computeDebts(vm.balanceSheet.getNonSettledParticipations());\r\n    result.debts = _.chain(debts)\r\n      .filter(function(d) {\r\n        return d[result.role].equals(vm.person);\r\n      })\r\n      .map(function(d) {\r\n        return {person: d[counterRole[result.role]], amount: d.amount};\r\n      })\r\n      .value();\r\n\r\n    return result;\r\n  }\r\n\r\n  function removePerson() {\r\n    $mdDialog.show(confirmRemovePerson)\r\n      .then(doRemovePerson);\r\n  }\r\n\r\n  function doRemovePerson() {\r\n    vm.balanceSheet.removePerson(vm.person);\r\n    $scope.$emit(events.BALANCE_SHEET_UPDATED);\r\n    $state.go(\"balanceSheet\");\r\n  }\r\n\r\n  function updatePerson() {\r\n    $scope.$emit(events.BALANCE_SHEET_UPDATED);\r\n  }\r\n}\r\nPersonDetailCtrl.$inject = [\"balanceSheetService\", \"debtService\", \"events\", \"$state\", \"$stateParams\", \"$mdDialog\", \"$scope\", \"$log\"];\r\n\n},{\"angular\":\"angular\",\"lodash\":\"lodash\"}],21:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\n\r\nangular.module(\"debtApp\")\r\n  .config(config);\r\n\r\nfunction config($stateProvider) {\r\n\r\n  $stateProvider\r\n    .state(\"person\", {\r\n      url: \"/persons/:id\",\r\n      templateUrl: \"persons/person-detail.html\",\r\n      controller: \"PersonDetailCtrl as vm\"\r\n    })\r\n    ;\r\n}\r\nconfig.$inject = [\"$stateProvider\"];\n},{\"angular\":\"angular\"}],22:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\n\r\nangular.module(\"debtApp\")\r\n\t.config(config);\r\n\r\nfunction config($urlRouterProvider) {\r\n  \r\n  $urlRouterProvider.otherwise(\"/\");\r\n  \r\n}\r\nconfig.$inject = [\"$urlRouterProvider\"];\n},{\"angular\":\"angular\"}],23:[function(require,module,exports){\n\"use strict\";\r\n\r\nrequire(\"./money-input-directive\");\n},{\"./money-input-directive\":24}],24:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\nvar _ = require(\"lodash\");\r\nvar Decimal = require(\"simple-decimal-money\");\r\n\r\nangular.module(\"debtApp\")\r\n  .directive(\"moneyInput\", moneyInput);\r\n\r\n\r\nfunction moneyInput($filter) {\r\n  return {\r\n    restrict: \"A\",\r\n    require: \"ngModel\",\r\n    link: link\r\n  };\r\n\r\n  function link($scope, iElem, iAttrs, ngModel) {\r\n    ngModel.$validators.money = validateMoney;\r\n    ngModel.$parsers.push(parseMoney);\r\n    ngModel.$formatters.unshift(formatMoney);\r\n\r\n    iElem.on(\"blur\", handleBlur);\r\n    ngModel.$render = render;\r\n\r\n    function render() {\r\n      if (ngModel.$valid) {\r\n        iElem.val(formatMoney(ngModel.$modelValue));\r\n      } else {\r\n        iElem.val(ngModel.$viewValue);\r\n      }\r\n    }\r\n\r\n    function handleBlur() {\r\n      ngModel.$render();\r\n    }\r\n  }\r\n\r\n  function validateMoney(value) {\r\n    if (value < 0) {\r\n      return false;\r\n    } else {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  function formatMoney(value) {\r\n    if (value === undefined || value === null) {\r\n      return \"\";\r\n    } else {\r\n      return $filter(\"number\")(value, 2);\r\n    }\r\n  }\r\n\r\n  function parseMoney(value) {\r\n    return new Decimal(value).toNumber();\r\n  }\r\n\r\n}\r\nmoneyInput.$inject = [\"$filter\"];\r\n\n},{\"angular\":\"angular\",\"lodash\":\"lodash\",\"simple-decimal-money\":\"simple-decimal-money\"}]},{},[1]);\n"],"sourceRoot":"/source/"}