{"version":3,"sources":["debt.js"],"names":["e","t","n","r","s","o","u","a","require","i","f","Error","code","l","exports","call","length",1,"module","BalanceSheetCtrl","balanceSheetService","debtService","events","$scope","$log","init","refresh","$on","BALANCE_SHEET_UPDATED","vm","balanceSheet","debtsByDebtor","computeDebts","debtComputationError","undefined","error","isBalanced","participations","getNonSettledParticipations","debts","currency","organizeByDebtor","updateSheet","$emit","this","$inject","angular","controller","lodash",2,"localStorageService","data","get","service","BalanceSheet","save","ReferenceError","throwErrorIfInvalid","set","exportData","loadFromJson","json","fromJson","exportToJson","toJson","createNew","factory","./balance-sheet",3,"_","Decimal","CurrencyConversionError","filter","pt","expense","settled","reduce","expenses","getPerson","id","persons","find","p","createPerson","options","extend","name","idSequence","person","Person","push","createParticipations","each","createParticipation","shareCost","removePerson","toRemove","remove","equals","forEach","getParticipations","removeParticipation","getExpense","createExpense","sharing","Expense","removeExpense","getParticipation","criteria","toSeek","Participation","paid","share","participation","currenciesEnabled","exchangeRates","getExchangeRates","cloneDeep","getCurrencies","chain","getExchangeRateCurrencies","concat","getExpenseCurrencies","_this","uniq","sort","value","result","er","fixed","variable","map","computedCurrency","addOrUpdateExchangeRate","quotation","validateQuotation","removeExchangeRate","updateBalanceSheetCurrencyIfNeeded","isString","trim","TypeError","isNumber","rate","RangeError","cleanUpCurrency","cleanUpCurrencyPair","currencyPair","clone","updateExpenseCurrenciesIfNeeded","convertCurrency","toConvert","toNumber","EXCHANGE_RATE_DECIMALS","searchPair","inverseQuotation","multiply","divideBy","tryToConvertCurrency","NaN","getConvertibleCurrencies","fromCurrencies","toCurrency","isArray","convertible","c","getNonConvertibleCurrencies","difference","currencies","indexOf","throwErrorIfInvalidExpenseCurrencies","ex","getTotal","participationMapping","_nonSettledParticipations","total","add","_sheet","getCost","getPaid","getSumOfShares","getShare","getBalance","subtract","_myParticipations","other","isNotFunction","negate","isFunction","pickBy","shareEqually","cost","lastShare","last","getCurrencyConversionFunction","strictConversion","getValue","propName","convert","expenseParticipations","thisValueConverted","originalSum","sum","prt","convertedSum","sumOfConverted","delta","personId","expenseId","importData","max","isNaN","separately","q","key","isValid","idToEntity","./currency-conversion-error","simple-decimal-money",4,"message","temp","apply","arguments","stack","prototype","Object","create","constructor","writable","configurable",5,"./balance-sheet-ctrl","./balance-sheet-service","./route-config",6,"config","$stateProvider","state","url","views","templateUrl","floatingButton",7,"CurrencyListCtrl","$mdDialog","openExchangeRateDialog","show","then","updateExchangeRate","exchangeRate","ExchangeRateDialogCtrl","ok","hide","cancel",8,"./currency-list-ctrl",9,10,"DebtAppCtrl","debounce","balanceSheetSaveInterval","openCreatePersonDialog","openCreateExpenseDialog","fileService","$mdSidenav","$state","toggleMenu","toggle","balanceSheetUpdated","ERROR","handleErrorEvent","findExpensesWithInvalidCurrencies","errorMessage","tryToSave","nonConvertible","messageTemplate","template","currencyWord","currencyList","balanceSheetCurrency","index","event","dialogResult","$broadcast","createNewSheet","confirmCreateNewSheet","go","mainMenu","loadSheet","files","isSupported","file","readAsText","loadSheetFromJson","exportSheet","saveAsFile","showHelp","close","confirm","title","content","constant",11,"configureLocalStorage","localStorageServiceProvider","setPrefix","configureIcons","$mdIconProvider","spriteNames","spriteProps","fileName","filePath","spriteName","prop","iconSet","hrefSanitization","$compileProvider","aHrefSanitizationWhitelist","decorateExceptionHandler","$provide","decorator","$delegate","$injector","exception","cause","$rootScope","makeStateAvailableInScope","$stateParams","run","./balance-sheet/currency-conversion-error","./currencies","./debt-app-ctrl","./debts","./expenses","./persons","./utils","angular-local-storage","angular-material","angular-route","angular-ui-router","ng-file-upload","ng-mfb",12,"solveDebts","debt","debtorList","debtorIndices","d","debtor","debtorIndex","omit","d1","d2","creditor","localeCompare",13,"debtSolverFactory","solveLinearSystem","solve","balances","computeBalances","isEveryoneBalanced","isSystemBalanced","roles","getDebtorsAndCreditors","linearSystem","createDebtEquations","debtVector","createDebts","b","balance","every","debtors","creditors","A","initMatrix","j","rows","cols","solution","numberOfSolutions","numVars","numberOfVariables","numFreeVars","numberOfFreeVariables","xVector","randomEngine","Random","engines","mt19937","seed","toEliminate","copy","candidates","candidateIdx","integer","splice","isNonNegative","vector","debtorIdx","Math","floor","creditorIdx","amount","random-js",14,"./debt-service","./debt-solver","./lin-eq-solver","./lin-eq-solver-factory",15,16,"input","validate","initialize","coefMatrix","copyMatrix","constVector","copyArray","m","pivotToEquationMap","equationScale","abscoef","abs","pivotToVariableMap","transformToRowEchelonForm","pivotIdx","knownFreeVariables","maxRatio","bestPivotEquationIndex","rowIdx","colIdx","ratio","currPivotVaribleIdx","newPivotVariableIdx","pivotRowIdx","pivotColIdx","mult","colIndex","reduceRowEchelonForm","pivotIndex","min","div","determineRank","rank","columns","determineNumberOfSolutions","b2IsZero","Number","MAX_VALUE","determineSolution","initArray","numberOfEquations","size","array","slice",17,"open","DialogController","controllerAs",18,"ExpenseDetailCtrl","debtCalculationInterval","$timeout","isParticipant","everyoneParticipates","updateExpense","targetScope","getParticipationMap","sumOfShares","computeDebtsDebounced","setParticipation","confirmRemoveExpense","doRemoveExpense","setCurrency",19,"./create-expense-dialog","./expense-detail-ctrl",20,21,22,"./create-person-dialog","./person-detail-ctrl",23,"PersonDetailCtrl","confirmRemovePerson","role","counterRole","doRemovePerson","updatePerson","debtResult","debtRole",24,25,"$urlRouterProvider","otherwise",26,"$filter",27,"debounceFactory","func","wait","scope","invokeApply","timer","context","args","Array",28,"$q","$window","blob","deferred","defer","reader","FileReader","onload","resolve","onerror","promise","dataArray","Blob","fileSaver","saveAs","blob-polyfill","node-safe-filesaver",29,"focus","restrict","link","iElem","iAttrs","focusExpr","shouldFocus","$eval","directive",30,"./balance-filter","./file-service","./focus-directive","./money-filter","./money-input-directive",31,"money",32,"moneyInput","ngModel","render","val","$valid","formatMoney","$modelValue","$viewValue","handleBlur","$render","$validators","validateMoney","$parsers","parseMoney","$formatters","unshift","on",33,"tryCatch","expression","errorResult"],"mappings":"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","file":"debt.js","sourcesContent":["(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error(\"Cannot find module '\"+o+\"'\");throw f.code=\"MODULE_NOT_FOUND\",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar _ = require(\"lodash\");\r\nvar angular = require(\"angular\");\r\n\r\nangular.module(\"debtApp\")\r\n  .controller(\"BalanceSheetCtrl\", BalanceSheetCtrl);\r\n\r\nfunction BalanceSheetCtrl(balanceSheetService, debtService, events, $scope, $log) {\r\n  var vm = this;\r\n  \r\n  vm.init = init;\r\n  vm.refresh = refresh;\r\n  vm.updateSheet = updateSheet;\r\n  \r\n  init();\r\n  \r\n  /////////////////////////////////////////////////////////////\r\n  \r\n  function init() {\r\n    refresh();\r\n    $scope.$on(events.BALANCE_SHEET_UPDATED, vm.refresh);\r\n  }\r\n  \r\n  function refresh() {\r\n    vm.balanceSheet = balanceSheetService.balanceSheet;\r\n    try {\r\n      vm.debtsByDebtor = computeDebts();\r\n      vm.debtComputationError = undefined;\r\n    } catch (e) {\r\n      $log.error(e);\r\n      vm.debtsByDebtor = undefined;\r\n      vm.debtComputationError = \"Cannot compute debts\";\r\n    }\r\n  }\r\n  \r\n  function computeDebts() {\r\n    if (vm.balanceSheet.isBalanced()) {\r\n      var participations = vm.balanceSheet.getNonSettledParticipations();\r\n      var debts = debtService.computeDebts(participations, vm.balanceSheet.currency);\r\n      return debtService.organizeByDebtor(debts);\r\n    } else {\r\n      return undefined;\r\n    }\r\n  }\r\n\r\n  function updateSheet() {\r\n    $scope.$emit(events.BALANCE_SHEET_UPDATED);\r\n  }\r\n}\n},{\"angular\":\"angular\",\"lodash\":\"lodash\"}],2:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\nvar BalanceSheet = require('./balance-sheet');\r\n\r\nangular.module(\"debtApp\")\r\n  .factory(\"balanceSheetService\", balanceSheetService);\r\n\r\nfunction balanceSheetService(localStorageService) {\r\n\r\n  var service = {\r\n    balanceSheet: undefined,\r\n    save: save,\r\n    loadFromJson: loadFromJson,\r\n    exportToJson: exportToJson,\r\n    createNew: createNew,\r\n    init: init\r\n  };\r\n\r\n  return service;\r\n\r\n\r\n  function init() {\r\n    var data = localStorageService.get(\"balanceSheetData\");\r\n    service.balanceSheet = new BalanceSheet(data);\r\n  }\r\n\r\n  function save() {\r\n    if (!service.balanceSheet) {\r\n      throw new ReferenceError(\"No balance valid balance sheet\");\r\n    }\r\n    service.balanceSheet.throwErrorIfInvalid();\r\n    localStorageService.set(\"balanceSheetData\", service.balanceSheet.exportData());\r\n  }\r\n\r\n  function loadFromJson(json) {\r\n    var data = angular.fromJson(json);\r\n    var balanceSheet = new BalanceSheet(data);\r\n    balanceSheet.throwErrorIfInvalid();\r\n    service.balanceSheet = balanceSheet;\r\n    save();\r\n  }\r\n\r\n  function exportToJson() {\r\n    var data = service.balanceSheet.exportData();\r\n    return angular.toJson(data);\r\n  }\r\n\r\n  function createNew() {\r\n    service.balanceSheet = new BalanceSheet();\r\n    service.save();\r\n  }\r\n\r\n}\r\n\r\n\r\n\n},{\"./balance-sheet\":3,\"angular\":\"angular\"}],3:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar _ = require('lodash');\r\nvar angular = require(\"angular\");\r\nvar Decimal = require(\"simple-decimal-money\");\r\nvar CurrencyConversionError = require(\"./currency-conversion-error\");\r\n\r\nvar BalanceSheet = function(data) {\r\n\r\n  var _this = this;\r\n  var _sheet = this;\r\n\r\n  var EXCHANGE_RATE_DECIMALS = 4;\r\n\r\n  // Data\r\n\r\n  var persons = [];\r\n  var expenses = [];\r\n  var participations = [];\r\n\r\n  var exchangeRates = [];\r\n\r\n  var idSequence = 1;\r\n\r\n  _this.name = \"New sheet\";\r\n  _this.currency = undefined;\r\n  _this.persons = persons;\r\n  _this.expenses = expenses;\r\n  _this.participations = participations;\r\n\r\n  if (data) {\r\n    importData(data);\r\n  }\r\n\r\n  // Methods\r\n\r\n  _this.getNonSettledParticipations = getNonSettledParticipations;\r\n\r\n  _this.isBalanced = isBalanced;\r\n\r\n  _this.getPerson = getPerson;\r\n  _this.createPerson = createPerson;\r\n  _this.removePerson = removePerson;\r\n\r\n  _this.getExpense = getExpense;\r\n  _this.createExpense = createExpense;\r\n  _this.removeExpense = removeExpense;\r\n\r\n  _this.getParticipation = getParticipation;\r\n  _this.createParticipation = createParticipation;\r\n  _this.removeParticipation = removeParticipation;\r\n\r\n  _this.exportData = exportData;\r\n\r\n  _this.isValid = isValid;\r\n  _this.throwErrorIfInvalid = throwErrorIfInvalid;\r\n\r\n  _this.currenciesEnabled = currenciesEnabled;\r\n  _this.getExchangeRates = getExchangeRates;\r\n  _this.getCurrencies = getCurrencies;\r\n  _this.getExpenseCurrencies = getExpenseCurrencies;\r\n  _this.getExchangeRateCurrencies = getExchangeRateCurrencies;\r\n  _this.addOrUpdateExchangeRate = addOrUpdateExchangeRate;\r\n  _this.removeExchangeRate = removeExchangeRate;\r\n  _this.convertCurrency = convertCurrency;\r\n  _this.getConvertibleCurrencies = getConvertibleCurrencies;\r\n  _this.getNonConvertibleCurrencies = getNonConvertibleCurrencies;\r\n  _this.throwErrorIfInvalidExpenseCurrencies = throwErrorIfInvalidExpenseCurrencies;\r\n\r\n  /////////////////////////////////////\r\n\r\n\r\n  function getNonSettledParticipations() {\r\n    return _.filter(participations, function(pt) {\r\n      return !pt.expense.settled;\r\n    });\r\n  }\r\n\r\n  function isBalanced() {\r\n    return _.reduce(expenses, function(isBalanced, e) {\r\n      return isBalanced && (e.settled || e.isBalanced());\r\n    }, true);\r\n  }\r\n\r\n\r\n  function getPerson(id) {\r\n    return _(persons).find(function(p) {\r\n      return p.id == id;\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Creates a person.\r\n   *\r\n   * @param {Object} [data] - Person data\r\n   * @param {String} [data.name=Person <number>] - Person's name\r\n   * @param {Object} [options] - Options for creating a person\r\n   * @param {boolean} [options.createParticipations=true] - Whether the person is set to participate in all existing expenses\r\n   * @returns {Person} - The created Person object\r\n   */\r\n  function createPerson(data, options) {\r\n    data = _.extend({\r\n      name: \"Person \" + (persons.length + 1)\r\n    }, data);\r\n\r\n    options = _.extend({}, options);\r\n\r\n    if (data.id === undefined) {\r\n      data.id = idSequence;\r\n      idSequence = idSequence + 1;\r\n    }\r\n\r\n    var person = new Person(data);\r\n    persons.push(person);\r\n\r\n    if (options.createParticipations === true) {\r\n      _.each(expenses, function(e) {\r\n        if (!e.settled) {\r\n          createParticipation({person: person, expense: e});\r\n          e.shareCost();\r\n        }\r\n      });\r\n    }\r\n\r\n    return person;\r\n  }\r\n\r\n  function removePerson(toRemove) {\r\n    toRemove = getPerson(toRemove.id);\r\n\r\n    if (!toRemove) return;\r\n\r\n    _.remove(persons, function(e) {\r\n      return e.equals(toRemove);\r\n    });\r\n\r\n    _.forEach(toRemove.getParticipations(), function(pt) {\r\n      removeParticipation(pt);\r\n    });\r\n  }\r\n\r\n  function getExpense(id) {\r\n    return _(expenses).find(function(e) {\r\n      return e.id == id;\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Creates an expense.\r\n   *\r\n   * @param {Object} [data] - Expense data\r\n   * @param {String} [data.name=Expense <number>] - Expense's name\r\n   * @param {String} [data.currency] - The currency the expense was paid in\r\n   * @param {Object} [options] - Options for creating an expense\r\n   * @param {boolean} [options.createParticipations=true] - Whether all existing persons are set to participate in the expense\r\n   * @returns {Expense} - The created Expense object\r\n   */\r\n  function createExpense(data, options) {\r\n    data = _.extend({\r\n      name: \"Expense \" + (expenses.length + 1),\r\n      sharing: \"equal\",\r\n      settled: false,\r\n      currency: undefined\r\n    }, data);\r\n\r\n    options = _.extend({}, options);\r\n\r\n    if (data.id === undefined) {\r\n      data.id = idSequence;\r\n      idSequence = idSequence + 1;\r\n    }\r\n\r\n    var expense = new Expense(data);\r\n    expenses.push(expense);\r\n\r\n    if (options.createParticipations === true) {\r\n      _.each(persons, function(p) {\r\n        createParticipation({person: p, expense: expense});\r\n      });\r\n    }\r\n\r\n    return expense;\r\n  }\r\n\r\n  function removeExpense(toRemove) {\r\n    toRemove = getExpense(toRemove.id);\r\n\r\n    if (!toRemove) return;\r\n\r\n    _.remove(expenses, function(e) {\r\n      return e.equals(toRemove);\r\n    });\r\n\r\n    _.forEach(toRemove.getParticipations(), function(pt) {\r\n      removeParticipation(pt);\r\n    });\r\n  }\r\n\r\n\r\n  function getParticipation(criteria) {\r\n    var toSeek = new Participation(criteria);\r\n    return _(participations).find(function(pt) {\r\n      return toSeek.equals(pt);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Creates a participation of a Person to an Expense.\r\n   *\r\n   * @param {Object} data - Participation data\r\n   * @param {Person} data.person - The participant person\r\n   * @param {Expense} data.expense - The expense to participate in\r\n   * @param {number} [data.paid=0] - How much the person has paid for the expense (in the expense currency)\r\n   * @param {number} [data.share=0] - The person's share of the expense's total cost (in the expense currency)\r\n   * @returns {Participation} - The created Participation object\r\n   */\r\n  function createParticipation(data) {\r\n    if (getParticipation(data)) {\r\n      throw new Error(\"Duplicate participation\");\r\n    }\r\n\r\n    data = _.extend({\r\n      paid: 0,\r\n      share: 0\r\n    }, data);\r\n\r\n    var participation = new Participation(data);\r\n    participations.push(participation);\r\n\r\n    participation.expense.shareCost();\r\n\r\n    return participation;\r\n  }\r\n\r\n  function removeParticipation(toRemove) {\r\n    toRemove = getParticipation(toRemove);\r\n\r\n    if (!toRemove) return;\r\n\r\n    _.remove(participations, function(pt) {\r\n      return pt.equals(toRemove);\r\n    });\r\n\r\n    toRemove.expense.shareCost();\r\n  }\r\n\r\n\r\n  /**\r\n   * @returns {boolean} Whether currencies are enabled in this balance sheet\r\n   */\r\n  function currenciesEnabled() {\r\n    return exchangeRates && exchangeRates.length > 0;\r\n  }\r\n  /**\r\n   * @return {string[]} copy of exchange rates in this sheet\r\n   */\r\n  function getExchangeRates() {\r\n    return _.cloneDeep(exchangeRates);\r\n  }\r\n\r\n  /**\r\n   * @return list of currencies in alphabetical order\r\n   */\r\n  function getCurrencies() {\r\n    return _.chain(getExchangeRateCurrencies())\r\n      .concat(getExpenseCurrencies(), _this.currency)\r\n      .uniq()\r\n      .sort()\r\n      .value();\r\n  }\r\n\r\n  function getExchangeRateCurrencies() {\r\n    return _.reduce(exchangeRates, function(result, er) {\r\n      result.push(er.fixed);\r\n      result.push(er.variable);\r\n      return result;\r\n    }, []);\r\n  }\r\n\r\n  function getExpenseCurrencies() {\r\n    return _.map(expenses, function(e) {\r\n      return e.computedCurrency();\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Adds or updates an exchange rate.\r\n   *\r\n   * @param {Object} quotation - The exchange rate object\r\n   * @param {string} quotation.fixed - The fixed currency symbol\r\n   * @param {string} quotation.variable - The variable currency symbol\r\n   * @param {number} quotation.rate - The rate: 1 unit of the fixed currency buys this amount of the variable currency. Must be a positive number with at most 4 decimals.\r\n   */\r\n  function addOrUpdateExchangeRate(quotation) {\r\n    validateQuotation(quotation);\r\n    removeExchangeRate(quotation);\r\n    exchangeRates.push(quotation);\r\n    updateBalanceSheetCurrencyIfNeeded();\r\n  }\r\n\r\n  function validateQuotation(quotation) {\r\n    if (!_.isString(quotation.fixed) || _.trim(quotation.fixed) === \"\") {\r\n      throw new TypeError(\"Fixed currency symbol must be a non-empty string\");\r\n    }\r\n    if (!_.isString(quotation.variable) || _.trim(quotation.variable) === \"\") {\r\n      throw new TypeError(\"Variable currency symbol must be a non-empty string\");\r\n    }\r\n    if (!_.isNumber(quotation.rate) || quotation.rate <= 0) {\r\n      throw new RangeError(\"Foreign currency rate must be a positive number\");\r\n    }\r\n  }\r\n\r\n  function cleanUpCurrency(currency) {\r\n    if (!currency) {\r\n      return undefined;\r\n    } else if (_.isString(currency) && _.trim(currency).length === 0) {\r\n      return undefined;\r\n    } else {\r\n      return _.trim(currency);\r\n    }\r\n  }\r\n\r\n  function cleanUpCurrencyPair(currencyPair) {\r\n    currencyPair = _.clone(currencyPair);\r\n    currencyPair.fixed = cleanUpCurrency(currencyPair.fixed);\r\n    currencyPair.variable = cleanUpCurrency(currencyPair.variable);\r\n    return currencyPair;\r\n  }\r\n\r\n  /**\r\n   * Removes an exchange rate.\r\n   *\r\n   * @param currencyPair - The currency pair to remove\r\n   * @param {string} currencyPair.fixed - The fixed currency symbol\r\n   * @param {string} currencyPair.variable - The variable currency symbol\r\n   */\r\n  function removeExchangeRate(currencyPair) {\r\n    if (!currencyPair) return;\r\n    currencyPair = cleanUpCurrencyPair(currencyPair);\r\n    _.remove(exchangeRates, {fixed: currencyPair.fixed, variable: currencyPair.variable});\r\n    updateBalanceSheetCurrencyIfNeeded();\r\n    updateExpenseCurrenciesIfNeeded();\r\n  }\r\n\r\n  /**\r\n   * Converts a value from one currency to another. Uses the inverse of an exchange\r\n   * rate if an inverse currency pair is found.\r\n   *\r\n   * @param {Object} toConvert - The data object\r\n   * @param {number} toConvert.value - The value to convert\r\n   * @param {string} toConvert.fixed - The currency of the value to be converted\r\n   * @param {string} toConvert.variable - The currency to convert the value to\r\n   * @return {number} - The value in the variable currency\r\n   */\r\n  function convertCurrency(toConvert) {\r\n    var rate;\r\n\r\n    if (!toConvert) {\r\n      throw new CurrencyConversionError(\"Undefined or null conversion data\");\r\n    }\r\n\r\n    toConvert = cleanUpCurrencyPair(toConvert);\r\n\r\n    if (toConvert.fixed == toConvert.variable) {\r\n      return new Decimal(toConvert.value).toNumber();\r\n    }\r\n\r\n    var quotation = _.find(exchangeRates, {fixed: toConvert.fixed, variable: toConvert.variable});\r\n\r\n    if (quotation) {\r\n      rate = new Decimal(quotation.rate, EXCHANGE_RATE_DECIMALS);\r\n    } else {\r\n      var searchPair = {variable: toConvert.fixed, fixed: toConvert.variable};\r\n      var inverseQuotation = _.find(exchangeRates, searchPair);\r\n      if (inverseQuotation) {\r\n        rate = new Decimal(1/inverseQuotation.rate, EXCHANGE_RATE_DECIMALS);\r\n      }\r\n    }\r\n\r\n    if (!rate) {\r\n      throw new CurrencyConversionError(\"Could not find an exchange rate for conversion '\" + toConvert.fixed + \"' -> '\" + toConvert.variable + \"'.\");\r\n    }\r\n\r\n    return new Decimal(toConvert.value*100).multiply(rate).divideBy(100).toNumber();\r\n  }\r\n\r\n  function tryToConvertCurrency(toConvert) {\r\n    try {\r\n      return convertCurrency(toConvert);\r\n    } catch (e) {\r\n      if (e instanceof CurrencyConversionError) {\r\n        return NaN;\r\n      } else {\r\n        throw e;\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns currencies that can be converted to the given currency.\r\n   *\r\n   * @param {string[]} fromCurrencies - Currencies to convert\r\n   * @param {string} toCurrency - Currency to convert to\r\n   * @returns {string[]} - Convertible currencies in fromCurrencies\r\n   */\r\n  function getConvertibleCurrencies(fromCurrencies, toCurrency) {\r\n    if (!_.isArray(fromCurrencies)) {\r\n      return [];\r\n    }\r\n\r\n    var convertible = [];\r\n    _.each(getCurrencies(), function(c) {\r\n      try {\r\n        convertCurrency({fixed: c, variable: toCurrency, value: 1});\r\n        convertible.push(c);\r\n      } catch (e) {}\r\n    });\r\n    return convertible;\r\n  }\r\n\r\n  /**\r\n   * Finds currencies that can not be converted to the given currency.\r\n   *\r\n   * @param {string[]} fromCurrencies - Currencies to convert\r\n   * @param {string} toCurrency - Currency to convert to\r\n   * @returns {string[]} - Non-convertible currencies\r\n   */\r\n  function getNonConvertibleCurrencies(fromCurrencies, toCurrency) {\r\n    return _.difference(fromCurrencies, getConvertibleCurrencies(fromCurrencies, toCurrency));\r\n  }\r\n\r\n\r\n  function updateBalanceSheetCurrencyIfNeeded() {\r\n    var currencies = getExchangeRateCurrencies();\r\n\r\n    if (exchangeRates.length === 0) {\r\n      _this.currency = undefined;\r\n    } else if (_this.currency === undefined || _.indexOf(currencies, _this.currency) === -1) {\r\n      _this.currency = exchangeRates[0].fixed;\r\n    }\r\n  }\r\n\r\n\r\n  function updateExpenseCurrenciesIfNeeded() {\r\n    var currencies = _.concat(getExchangeRateCurrencies(), _this.currency);\r\n    _.each(expenses, function(e) {\r\n      if (_.indexOf(currencies, e.currency) === -1) {\r\n        e.currency = _this.currency;\r\n      }\r\n    });\r\n  }\r\n\r\n  function throwErrorIfInvalidExpenseCurrencies() {\r\n    _.each(expenses, function(expense) {\r\n      try {\r\n        convertCurrency({fixed: expense.computedCurrency(), variable: _this.currency, value: 1});\r\n      } catch (ex) {\r\n        throw new CurrencyConversionError(\"Cannot convert currency '\" + expense.computedCurrency()  + \"' of '\" + expense.name + \"' to balance sheet's currency '\" + _this.currency + \"'\");\r\n      }\r\n    });\r\n  }\r\n\r\n\r\n  /**\r\n   * Creates a Person object.\r\n   *\r\n   * @param {Object} [data] - Initial data\r\n   * @param {number} [data.id] - Id\r\n   * @param {string} [data.name} - Name\r\n   * @constructor\r\n   */\r\n  function Person(data) {\r\n    var _this = this;\r\n\r\n    _.extend(_this, data);\r\n\r\n    // Methods\r\n\r\n    _this.computedCurrency = computedCurrency;\r\n    _this.equals = equals;\r\n    _this.getCost = getCost;\r\n    _this.getSumOfShares = getSumOfShares;\r\n    _this.getBalance = getBalance;\r\n    _this.isBalanced = isBalanced;\r\n    _this.getParticipations = getParticipations;\r\n    _this.exportData = exportData;\r\n\r\n    ///////////////////////////////////////\r\n\r\n    var _myParticipations = _.chain(participations)\r\n      .filter(function(pt) {\r\n        return _this.equals(pt.person);\r\n      });\r\n\r\n    var _nonSettledParticipations = _myParticipations\r\n      .filter(function(pt) {\r\n        return !pt.expense.settled;\r\n      });\r\n\r\n\r\n    function getTotal(participationMapping) {\r\n      return _nonSettledParticipations\r\n        .map(participationMapping)\r\n        .reduce(function(total, value) {\r\n          return total.add(value);\r\n        }, new Decimal(0))\r\n        .value()\r\n        .toNumber();\r\n    }\r\n\r\n    function computedCurrency() {\r\n      return _sheet.currency;\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param {string} [currency] - The currency in which to get the total (default: balance sheet's default currency)\r\n     * @returns {number} - The total amount this person has paid. NaN if cannot convert currency.\r\n     */\r\n    function getCost(currency) {\r\n      currency = currency || _this.computedCurrency();\r\n      return getTotal(function(pt) {\r\n        return pt.getPaid(currency);\r\n      });\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param {string} [currency] - The currency in which to get the total (default: balance sheet's default currency)\r\n     * @returns {number} - This person's total share of all the expenses. NaN if cannot convert currency.\r\n     */\r\n    function getSumOfShares(currency) {\r\n      currency = currency || _this.computedCurrency();\r\n      return getTotal(function(pt) {\r\n        return pt.getShare(currency);\r\n      });\r\n    }\r\n\r\n    /**\r\n     * Checks whether this person's costs and shares sum up to zero, i.e. the person neither\r\n     * owes money nor is owed money by anyone else.\r\n     *\r\n     * @returns {boolean} - Whether this person's costs and shares sum up to zero\r\n     */\r\n    function isBalanced() {\r\n      return getBalance() === 0;\r\n    }\r\n\r\n    /**\r\n     * Computes the difference between the total share and cost paid by this person.\r\n     * If the difference is negative, then the person's share is smaller than the costs\r\n     * she has paid, that is others owe her money.\r\n     *\r\n     * @param {string} [currency] - The currency in which to get the balance (default: balance sheet's default currency)\r\n     * @returns {number} - The difference between the total share and cost paid by this person. NaN if cannot convert currency.\r\n     */\r\n    function getBalance(currency) {\r\n      currency = currency || _this.computedCurrency();\r\n      return new Decimal( getSumOfShares(currency) ).subtract( getCost(currency) ).toNumber();\r\n    }\r\n\r\n    /**\r\n     * @returns {Participation[]} - The expense participations of this person\r\n     */\r\n    function getParticipations() {\r\n      return _myParticipations.value();\r\n    }\r\n\r\n    /**\r\n     * @param {Object} other - Another object\r\n     * @returns {boolean} - True if this person is equal to the other object\r\n     */\r\n    function equals(other) {\r\n      return (other instanceof Person) && (other.id === _this.id);\r\n    }\r\n\r\n    function exportData() {\r\n      var isNotFunction = _.negate(_.isFunction);\r\n      return _.extend(_.pickBy(_this, isNotFunction), {});\r\n    }\r\n\r\n  }\r\n\r\n\r\n  /**\r\n   * An expense.\r\n   *\r\n   * @param {object} [data] - Initial data\r\n   * @param {number} [data.id] - The expense's id\r\n   * @param {string} [data.name] - The expense's name\r\n   * @param {string} [data.sharing] -  The expense's cost sharing mode. Value \"equal\" = share costs equally. All other values mean custom sharing.\r\n   * @param {string} [data.currency] - The expense's currency\r\n   * @constructor\r\n   */\r\n  function Expense(data) {\r\n    var _this = this;\r\n\r\n    // Data\r\n    _.extend(_this, data);\r\n\r\n    // Methods\r\n    _this.computedCurrency = computedCurrency;\r\n    _this.getCost = getCost;\r\n    _this.getSumOfShares = getSumOfShares;\r\n    _this.getBalance = getBalance;\r\n    _this.isBalanced = isBalanced;\r\n    _this.getParticipations = getParticipations;\r\n    _this.shareCost = shareCost;\r\n    _this.equals = equals;\r\n    _this.exportData = exportData;\r\n\r\n    ///////////////////////////////////////\r\n\r\n    var _myParticipations = _.chain(participations).filter(function(p) {\r\n      return _this.equals(p.expense);\r\n    });\r\n\r\n\r\n    function getTotal(participationMapping, currency) {\r\n      var total = _myParticipations\r\n        .map(participationMapping)\r\n        .reduce(function(total, value) {\r\n          return total.add(value);\r\n        }, new Decimal(0))\r\n        .value()\r\n        .toNumber();\r\n\r\n      if (!currency || currency === _this.computedCurrency()) {\r\n        return total;\r\n      } else {\r\n        return tryToConvertCurrency({\r\n          value: total,\r\n          fixed: _this.computedCurrency(),\r\n          variable: currency\r\n        });\r\n      }\r\n    }\r\n\r\n\r\n    /**\r\n     * Gets the currency of this expense used for currency computations.\r\n     *\r\n     * @returns {string} - The currency of this expense\r\n     */\r\n    function computedCurrency() {\r\n      return _this.currency || _sheet.currency;\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param {string} [currency] - Currency in which to get the value. Default is this expense's currency or if undefined, the balance sheet's default currency.\r\n     * @return {number} The cost of this expense. NaN if cannot convert currency.\r\n     */\r\n    function getCost(currency) {\r\n      return getTotal(function(pt) {\r\n        return pt.paid;\r\n      }, currency);\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param {string} [currency] - Currency in which to get the value. Default is this expense's currency or if undefined, the balance sheet's default currency.\r\n     * @return {number} The sum of shares of this expense. NaN if cannot convert currency.\r\n     */\r\n    function getSumOfShares(currency) {\r\n      return getTotal(function(pt) {\r\n        return pt.share;\r\n      }, currency);\r\n    }\r\n\r\n    function isBalanced() {\r\n      return getBalance(_this.computedCurrency()) === 0;\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param {string} [currency] - Currency in which to get the value. Default is this expense's currency or if undefined, the balance sheet's default currency.\r\n     * @return {number} The balance of this expense. NaN if cannot convert currency.\r\n     */\r\n    function getBalance(currency) {\r\n      return new Decimal( getSumOfShares(currency) ).subtract( getCost(currency) ).toNumber();\r\n    }\r\n\r\n    function getParticipations() {\r\n      return _myParticipations.value();\r\n    }\r\n\r\n    function shareCost() {\r\n      if (_this.sharing === \"equal\") {\r\n        shareEqually();\r\n      }\r\n    }\r\n\r\n    function shareEqually() {\r\n      var participations = _this.getParticipations();\r\n      if (participations.length === 0) {\r\n        return;\r\n      }\r\n\r\n      var cost = new Decimal(_this.getCost());\r\n      var share = cost.divideBy(participations.length);\r\n      var lastShare = cost.subtract(share.multiply(participations.length - 1));\r\n\r\n      _.forEach(participations, function(p, i) {\r\n        if (i < participations.length - 1) {\r\n          p.share = share.toNumber();\r\n        }\r\n      });\r\n      _.last(participations).share = lastShare.toNumber();\r\n    }\r\n\r\n    function equals(other) {\r\n      return (other instanceof Expense) && (other.id === _this.id);\r\n    }\r\n\r\n    function exportData() {\r\n      var isNotFunction = _.negate(_.isFunction);\r\n      return _.extend(_.pickBy(_this, isNotFunction));\r\n    }\r\n\r\n  }\r\n\r\n  /**\r\n   * Creates a participation of a Person to an Expense.\r\n   *\r\n   * @param {Object} data - Participation data\r\n   * @param {Person} data.person - The participant person\r\n   * @param {Expense} data.expense - The expense to participate in\r\n   * @param {number} [data.paid=0] - How much the person has paid for the expense (in the expense currency)\r\n   * @param {number} [data.share=0] - The person's share of the expense's total cost (in the expense currency)\r\n   * @constructor\r\n   */\r\n  function Participation(data) {\r\n    var _this = this;\r\n\r\n    if (!data || !data.person || !data.expense) {\r\n      throw new ReferenceError(\"Undefined participation\");\r\n    }\r\n\r\n    // Data\r\n\r\n    _.extend(_this, data);\r\n\r\n    // Methods\r\n\r\n    _this.getPaid = getPaid;\r\n    _this.getShare = getShare;\r\n    _this.equals = equals;\r\n    _this.exportData = exportData;\r\n\r\n    ///////////////////////////////////////\r\n\r\n    function getCurrencyConversionFunction(options) {\r\n      if (options.strictConversion) {\r\n        return convertCurrency;\r\n      } else {\r\n        return tryToConvertCurrency;\r\n      }\r\n    }\r\n\r\n    /**\r\n     * Returns the value of property propName with currency conversion (if applicable) adjusted such\r\n     * that the expense is balanced in the target currency.\r\n     *\r\n     * @param {string} propName - The name of the monetary value property\r\n     * @param {string} currency - The target currency\r\n     * @param {object} options - Currrency conversion options\r\n     * @returns {number} - The property value with currency conversion\r\n     */\r\n    function getValue(propName, currency, options) {\r\n      if (!currency || currency === _this.expense.computedCurrency()) {\r\n        return _this[propName];\r\n      }\r\n\r\n      options = _.extend({strictConversion: false}, options);\r\n      var convert = getCurrencyConversionFunction(options);\r\n      var expenseParticipations = _this.expense.getParticipations();\r\n\r\n      if (_.last(expenseParticipations) === _this) {\r\n\r\n        var thisValueConverted = convert({\r\n          value: _this[propName],\r\n          fixed: _this.expense.computedCurrency(),\r\n          variable: currency\r\n        });\r\n\r\n        var originalSum = _.reduce(expenseParticipations, function(sum, prt) {\r\n          return sum.add(prt[propName]);\r\n        }, new Decimal(0)).toNumber();\r\n\r\n        var convertedSum = convert({\r\n          value: originalSum,\r\n          fixed: _this.expense.computedCurrency(),\r\n          variable: currency\r\n        });\r\n\r\n        var sumOfConverted = _.reduce(expenseParticipations, function(sum, prt) {\r\n          var value = convert({\r\n            value: prt[propName],\r\n            fixed: prt.expense.computedCurrency(),\r\n            variable: currency\r\n          });\r\n          return sum.add(value);\r\n        }, new Decimal(0));\r\n\r\n        var delta = sumOfConverted.subtract(convertedSum);\r\n\r\n        return new Decimal(thisValueConverted).subtract(delta).toNumber();\r\n\r\n      } else {\r\n\r\n        return convert({\r\n          value: _this[propName],\r\n          fixed: _this.expense.computedCurrency(),\r\n          variable: currency\r\n        });\r\n\r\n      }\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param {string} [currency] - Currency in which to get the payment. Default is expense's currency.\r\n     * @param {object} [options] - Options\r\n     * @param {boolean} [options.strictConversion] - True to throw error if currency conversion fails, false to return NaN. Default is false.\r\n     * @return {number} How much the person paid for the expense.\r\n     */\r\n    function getPaid(currency, options) {\r\n      return getValue(\"paid\", currency, options);\r\n    }\r\n\r\n    /**\r\n     *\r\n     * @param {string} [currency] - Currency in which to get the share. Default is expense's currency.\r\n     * @param {object} [options] - Options\r\n     * @param {boolean} [options.strictConversion] - True to throw error if currency conversion fails, false to return NaN. Default is false.\r\n     * @return {number} How much the person shares for the expense.\r\n     */\r\n    function getShare(currency, options) {\r\n      return getValue(\"share\", currency, options);\r\n    }\r\n\r\n    function equals(other) {\r\n      return (other instanceof Participation) && _this.expense.equals(other.expense) && _this.person.equals(other.person);\r\n    }\r\n\r\n    function exportData() {\r\n      return {personId: _this.person.id, expenseId: _this.expense.id, paid: _this.paid, share: _this.share};\r\n    }\r\n\r\n  }\r\n\r\n\r\n  function exportData() {\r\n    var isNotFunction = _.negate(_.isFunction);\r\n    var data = _.pickBy(_this, isNotFunction);\r\n    data.persons = _.map(persons, function(p) {\r\n      return p.exportData();\r\n    });\r\n    data.expenses = _.map(expenses, function(e) {\r\n      return e.exportData();\r\n    });\r\n    data.participations = _.map(participations, function(pt) {\r\n      return pt.exportData();\r\n    });\r\n    data.exchangeRates = getExchangeRates();\r\n    return data;\r\n  }\r\n\r\n  function importData(data) {\r\n    idSequence = _([])\r\n        .concat(data.persons)\r\n        .concat(data.expenses)\r\n        .map(\"id\")\r\n        .max() + 1;\r\n    if (_.isNaN(idSequence)) {\r\n      idSequence = 1;\r\n    }\r\n\r\n    var separately = {persons: true, expenses: true, participations: true, exchangeRates: true};\r\n\r\n    _.each(data.exchangeRates, function(q) {\r\n      addOrUpdateExchangeRate(q);\r\n    });\r\n\r\n    _.extend(_this, _.pickBy(data, function(value, key) {\r\n      return !separately[key];\r\n    }));\r\n\r\n    _.each(data.persons, function(p) {\r\n      createPerson(p);\r\n    });\r\n\r\n    _.each(data.expenses, function(e) {\r\n      createExpense(e);\r\n    });\r\n\r\n    _.each(data.participations, function(p) {\r\n      var person = getPerson(p.personId);\r\n      var expense = getExpense(p.expenseId);\r\n      createParticipation({person: person, expense: expense, paid: p.paid, share: p.share});\r\n    });\r\n\r\n    throwErrorIfInvalid();\r\n  }\r\n\r\n  function isValid() {\r\n    try {\r\n      throwErrorIfInvalid();\r\n      return true;\r\n    } catch (e) {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  function throwErrorIfInvalid() {\r\n\r\n    _.each(persons, function(p) {\r\n      if (!_.isNumber(p.id)) {\r\n        throw new Error(\"Person has no id\");\r\n      }\r\n    });\r\n\r\n    _.each(expenses, function(e) {\r\n      if (!_.isNumber(e.id)) {\r\n        throw new Error(\"Expense has no id\");\r\n      }\r\n    });\r\n\r\n    var idToEntity = {};\r\n    _.each(persons, function(p) {\r\n      idToEntity[p.id] = p;\r\n    });\r\n    _.each(expenses, function(e) {\r\n      idToEntity[e.id] = e;\r\n    });\r\n    _.each(participations, function(pt) {\r\n      if (!pt.person) {\r\n        throw new Error(\"Participation has no person\");\r\n      }\r\n      if (!idToEntity[pt.person.id]) {\r\n        throw new Error(\"Participation person is unknown\");\r\n      }\r\n      if (!pt.expense) {\r\n        throw new Error(\"Participation has no expense\");\r\n      }\r\n      if (!idToEntity[pt.expense.id]) {\r\n        throw new Error(\"Participation expense is unknown\");\r\n      }\r\n    });\r\n\r\n  }\r\n\r\n};\r\n\r\n\r\nmodule.exports = BalanceSheet;\n},{\"./currency-conversion-error\":4,\"angular\":\"angular\",\"lodash\":\"lodash\",\"simple-decimal-money\":\"simple-decimal-money\"}],4:[function(require,module,exports){\n\"use strict\";\r\n\r\nfunction CurrencyConversionError(message) {\r\n  var temp = Error.apply(this, arguments);\r\n  //temp.name = this.name = 'CurrencyConversionError';\r\n  this.stack = temp.stack;\r\n  this.message = temp.message;\r\n}\r\n\r\nCurrencyConversionError.prototype = Object.create(Error.prototype, {\r\n  constructor: {\r\n    value: CurrencyConversionError,\r\n    writable: true,\r\n    configurable: true\r\n  }\r\n});\r\n\r\nmodule.exports = CurrencyConversionError;\n},{}],5:[function(require,module,exports){\n\"use strict\";\r\n\r\nrequire(\"./route-config\");\r\nrequire(\"./balance-sheet\");\r\nrequire(\"./balance-sheet-service\");\r\nrequire(\"./balance-sheet-ctrl\");\r\nrequire(\"./currency-conversion-error\");\n},{\"./balance-sheet\":3,\"./balance-sheet-ctrl\":1,\"./balance-sheet-service\":2,\"./currency-conversion-error\":4,\"./route-config\":6}],6:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\n\r\nangular.module(\"debtApp\")\r\n  .config(config);\r\n\r\nfunction config($stateProvider) {\r\n\r\n  $stateProvider\r\n    .state(\"balanceSheet\", {\r\n      url: \"/\",\r\n      views: {\r\n        \"\": {\r\n          templateUrl : \"balance-sheet/balance-sheet.html\",\r\n          controller : \"BalanceSheetCtrl as vm\"\r\n        },\r\n        \"floatingButton\": {\r\n          templateUrl : \"balance-sheet/floating-button.html\"\r\n        }\r\n      }\r\n    });\r\n  \r\n}\n},{\"angular\":\"angular\"}],7:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\nvar _ = require('lodash');\r\n\r\nangular.module(\"debtApp\")\r\n  .controller(\"CurrencyListCtrl\", CurrencyListCtrl)\r\n  .controller(\"ExchangeRateDialogCtrl\", ExchangeRateDialogCtrl);\r\n\r\n\r\nfunction CurrencyListCtrl(balanceSheetService, events, $scope, $mdDialog) {\r\n  var vm = this;\r\n\r\n  vm.init = init;\r\n  vm.openExchangeRateDialog = openExchangeRateDialog;\r\n  vm.updateExchangeRate = updateExchangeRate;\r\n  vm.removeExchangeRate = removeExchangeRate;\r\n\r\n  init();\r\n\r\n  function init() {\r\n    vm.exchangeRates = balanceSheetService.balanceSheet.getExchangeRates();\r\n    vm.currencies = balanceSheetService.balanceSheet.getCurrencies();\r\n  }\r\n\r\n  function openExchangeRateDialog() {\r\n\r\n    return $mdDialog.show({\r\n      templateUrl: \"currencies/exchange-rate-dialog.html\",\r\n      controller: \"ExchangeRateDialogCtrl as vm\"\r\n    }).then(function(quotation) {\r\n      updateExchangeRate(quotation);\r\n    });\r\n\r\n  }\r\n\r\n  function updateExchangeRate(exchangeRate) {\r\n    balanceSheetService.balanceSheet.addOrUpdateExchangeRate(exchangeRate);\r\n    $scope.$emit(events.BALANCE_SHEET_UPDATED);\r\n    init();\r\n  }\r\n\r\n  function removeExchangeRate(exchangeRate) {\r\n    balanceSheetService.balanceSheet.removeExchangeRate(exchangeRate);\r\n    _.remove(vm.exchangeRates, exchangeRate);\r\n    $scope.$emit(events.BALANCE_SHEET_UPDATED);\r\n    init();\r\n  }\r\n\r\n}\r\n\r\nfunction ExchangeRateDialogCtrl($mdDialog) {\r\n  var vm = this;\r\n\r\n  vm.ok = ok;\r\n  vm.cancel = cancel;\r\n  vm.init = init;\r\n\r\n  init();\r\n\r\n  function init() {\r\n    vm.quotation = {};\r\n  }\r\n\r\n  function ok() {\r\n    $mdDialog.hide(vm.quotation);\r\n  }\r\n\r\n  function cancel() {\r\n    $mdDialog.cancel();\r\n  }\r\n\r\n}\n},{\"angular\":\"angular\",\"lodash\":\"lodash\"}],8:[function(require,module,exports){\n\"use strict\";\r\n\r\nrequire(\"./route-config\");\r\nrequire(\"./currency-list-ctrl\");\n},{\"./currency-list-ctrl\":7,\"./route-config\":9}],9:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\n\r\nangular.module(\"debtApp\")\r\n  .config(config);\r\n\r\nfunction config($stateProvider) {\r\n\r\n  $stateProvider\r\n    .state(\"currencies\", {\r\n      url: \"/currencies\",\r\n      views: {\r\n        \"\": {\r\n          controller: \"CurrencyListCtrl as vm\",\r\n          templateUrl: \"currencies/currencies.html\"\r\n        }\r\n      }\r\n    })\r\n  ;\r\n  \r\n}\n},{\"angular\":\"angular\"}],10:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\nvar _ = require(\"lodash\");\r\n\r\nangular.module(\"debtApp\")\r\n  .constant(\"balanceSheetSaveInterval\", 500)\r\n  .controller(\"DebtAppCtrl\", DebtAppCtrl);\r\n\r\nfunction DebtAppCtrl(balanceSheetService,\r\n                     debounce,\r\n                     balanceSheetSaveInterval,\r\n                     openCreatePersonDialog,\r\n                     openCreateExpenseDialog,\r\n                     fileService,\r\n                     events,\r\n                     $mdDialog,\r\n                     $mdSidenav,\r\n                     $state,\r\n                     $scope,\r\n                     $log) {\r\n\r\n  var vm = this;\r\n\r\n  vm.mainMenu = {\r\n    toggle: toggleMenu\r\n  };\r\n\r\n  vm.init = init;\r\n  vm.createPerson = createPerson;\r\n  vm.createExpense = createExpense;\r\n  vm.createNewSheet = createNewSheet;\r\n  vm.loadSheet = loadSheet;\r\n  vm.exportSheet = exportSheet;\r\n  vm.balanceSheetUpdated = balanceSheetUpdated;\r\n  vm.showHelp = showHelp;\r\n\r\n  var confirmCreateNewSheet = $mdDialog.confirm()\r\n    .title(\"Create new sheet\")\r\n    .content(\"The current sheet will be discarded. Please consider exporting it first. Continue?\")\r\n    .ok(\"Ok\").cancel(\"Cancel\");\r\n\r\n  init();\r\n\r\n  /////////////////////////////////////////////////////////////\r\n\r\n  function toggleMenu() {\r\n    $mdSidenav(\"main-menu\").toggle();\r\n  }\r\n\r\n  function init() {\r\n    $scope.$on(events.BALANCE_SHEET_UPDATED, debounce(function() {\r\n      vm.balanceSheetUpdated();\r\n    }), balanceSheetSaveInterval, $scope, true);\r\n    $scope.$on(events.ERROR, handleErrorEvent);\r\n    balanceSheetService.init();\r\n    vm.balanceSheet = balanceSheetService.balanceSheet;\r\n    findExpensesWithInvalidCurrencies();\r\n  }\r\n\r\n  function balanceSheetUpdated() {\r\n    vm.errorMessage = undefined;\r\n    tryToSave();\r\n    findExpensesWithInvalidCurrencies();\r\n  }\r\n\r\n  function tryToSave() {\r\n    try {\r\n      balanceSheetService.save();\r\n    } catch (e) {\r\n      $log.error(e);\r\n      vm.errorMessage = \"Cannot save: \" + e.message;\r\n    }\r\n  }\r\n\r\n  function findExpensesWithInvalidCurrencies() {\r\n    var nonConvertible = vm.balanceSheet.getNonConvertibleCurrencies(vm.balanceSheet.getExpenseCurrencies(), vm.balanceSheet.currency);\r\n\r\n    if (nonConvertible.length === 0 || vm.errorMessage) {\r\n      return;\r\n    }\r\n    var messageTemplate = _.template(\"Cannot convert <%= currencyWord %> <%= currencyList %> to balance sheet's currency <%= balanceSheetCurrency %>\");\r\n\r\n    var data = {\r\n      currencyWord: nonConvertible.length == 1 ? \"currency\" : \"currencies\",\r\n      currencyList: \"\",\r\n      balanceSheetCurrency: \"'\" + vm.balanceSheet.currency + \"'\"\r\n    };\r\n\r\n    _.each(nonConvertible, function(c, index) {\r\n      data.currencyList = data.currencyList + (index > 0 ? \", \" : \"\") + \"'\" + c + \"'\";\r\n    });\r\n\r\n    vm.errorMessage = messageTemplate(data);\r\n  }\r\n\r\n  function handleErrorEvent(event, error) {\r\n    vm.errorMessage = error.message;\r\n  }\r\n\r\n  function createPerson() {\r\n    openCreatePersonDialog()\r\n      .then(function(dialogResult) {\r\n        balanceSheetService.balanceSheet.createPerson(dialogResult.person, dialogResult.options);\r\n        vm.balanceSheetUpdated();\r\n        $scope.$broadcast(events.BALANCE_SHEET_UPDATED);\r\n      });\r\n  }\r\n\r\n  function createExpense() {\r\n    openCreateExpenseDialog()\r\n      .then(function(dialogResult) {\r\n        balanceSheetService.balanceSheet.createExpense(dialogResult.expense, dialogResult.options);\r\n        vm.balanceSheetUpdated();\r\n        $scope.$broadcast(events.BALANCE_SHEET_UPDATED);\r\n      });\r\n  }\r\n\r\n  function createNewSheet() {\r\n    $mdDialog.show(confirmCreateNewSheet)\r\n      .then(function() {\r\n        balanceSheetService.createNew();\r\n        vm.balanceSheetUpdated();\r\n        $state.go(\"balanceSheet\");\r\n        $scope.$broadcast(events.BALANCE_SHEET_UPDATED);\r\n        vm.mainMenu.toggle();\r\n      }, function() {\r\n        vm.mainMenu.toggle();\r\n      });\r\n  }\r\n\r\n  function loadSheet(files) {\r\n    if (!files || !files.length) return;\r\n\r\n    if (!fileService.isSupported()) {\r\n      vm.errorMessage = \"File operations not supported in this browser. Please consider a more modern browser.\";\r\n      return;\r\n    }\r\n\r\n    var file = files[0];\r\n    fileService.readAsText(file)\r\n      .then(function(result) {\r\n        loadSheetFromJson(result);\r\n      })\r\n      .catch(function() {\r\n        vm.errorMessage = \"Unable to read file\";\r\n      })\r\n      .finally(function() {\r\n        vm.mainMenu.toggle();\r\n      });\r\n  }\r\n\r\n  function loadSheetFromJson(json) {\r\n    balanceSheetService.loadFromJson(json);\r\n    vm.balanceSheetUpdated();\r\n    $state.go(\"balanceSheet\");\r\n    $scope.$broadcast(events.BALANCE_SHEET_UPDATED);\r\n  }\r\n\r\n  function exportSheet() {\r\n    if (!fileService.isSupported()) {\r\n      vm.errorMessage = \"File operations not supported in this browser. Please consider a more modern browser.\";\r\n      return;\r\n    }\r\n\r\n    var json = balanceSheetService.exportToJson();\r\n    try {\r\n      fileService.saveAsFile([json], balanceSheetService.balanceSheet.name + \".txt\");\r\n    } catch (e) {\r\n      vm.errorMessage = \"Error when saving file\";\r\n    }\r\n    vm.mainMenu.toggle();\r\n  }\r\n\r\n  function showHelp() {\r\n    $mdDialog.show({\r\n      templateUrl: \"help.html\",\r\n      controller: function($scope, $mdDialog) {\r\n        $scope.close = function() {\r\n          $mdDialog.hide();\r\n        };\r\n      }\r\n    });\r\n    vm.mainMenu.toggle();\r\n  }\r\n}\n},{\"angular\":\"angular\",\"lodash\":\"lodash\"}],11:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\nrequire(\"angular-material\");\r\nrequire(\"angular-route\");\r\nrequire(\"angular-ui-router\");\r\nrequire(\"angular-local-storage\");\r\nrequire(\"ng-mfb\");\r\nrequire(\"ng-file-upload\");\r\n\r\nvar _ = require(\"lodash\");\r\n\r\nangular\r\n  .module(\"debtApp\", [\"ngMaterial\", \"ui.router\", \"LocalStorageModule\", \"ng-mfb\", \"ngFileUpload\"])\r\n  .constant(\"events\", {\r\n    BALANCE_SHEET_UPDATED: \"balance sheet updated\",\r\n    ERROR: \"error\"\r\n  })\r\n  .constant(\"debtCalculationInterval\", 500)\r\n  .config(configureLocalStorage)\r\n  .config(configureIcons)\r\n  .config(hrefSanitization)\r\n  .config(decorateExceptionHandler)\r\n  .run(makeStateAvailableInScope);\r\n\r\nrequire(\"./debt-app-ctrl\");\r\nrequire(\"./route-config\");\r\nrequire(\"./debts\");\r\nrequire(\"./balance-sheet\");\r\nrequire(\"./persons\");\r\nrequire(\"./expenses\");\r\nrequire(\"./utils\");\r\nrequire(\"./currencies\");\r\n\r\nvar CurrencyConversionError = require(\"./balance-sheet/currency-conversion-error\");\r\n\r\nfunction configureLocalStorage(localStorageServiceProvider) {\r\n  localStorageServiceProvider.setPrefix(\"debtApp\");\r\n}\r\n\r\nfunction configureIcons($mdIconProvider) {\r\n  \r\n  var spriteNames = ['action', 'alert', 'content', 'navigation', 'editor'];\r\n  \r\n  var spriteProps = _.map(spriteNames, function(name) {\r\n    var fileName = 'svg-sprite-' + name + '.svg';\r\n    return {\r\n      filePath: 'resources/icons/' + fileName,\r\n      spriteName: name\r\n    };\r\n  });\r\n\r\n  _.each(spriteProps, function(prop) {\r\n    $mdIconProvider.iconSet(prop.spriteName, prop.filePath);\r\n  });\r\n\r\n}\r\n\r\nfunction hrefSanitization($compileProvider) {\r\n  $compileProvider.aHrefSanitizationWhitelist(/^(blob||https?):/);\r\n}\r\n\r\nfunction decorateExceptionHandler($provide, events) {\r\n  $provide.decorator('$exceptionHandler', function($delegate, $log, $injector) {\r\n    return function(exception, cause) {\r\n      $delegate(exception, cause);\r\n\r\n      var $rootScope = $injector.get('$rootScope');\r\n      $rootScope.$broadcast(events.ERROR, exception, cause);\r\n\r\n      if (exception instanceof CurrencyConversionError) {\r\n        var $state = $injector.get('$state');\r\n        $state.go(\"currencies\");\r\n      }\r\n\r\n    };\r\n  });\r\n}\r\n\r\n// Injection of $state may trigger a GET, which can show as an \r\n// \"Unexpected request\" error in your test. Workaround is to \r\n// $provide a mock $state to Angular.\r\nfunction makeStateAvailableInScope($rootScope, $state, $stateParams) {\r\n  $rootScope.$state = $state;\r\n  $rootScope.$stateParams = $stateParams;\r\n}\r\n\n},{\"./balance-sheet\":5,\"./balance-sheet/currency-conversion-error\":4,\"./currencies\":8,\"./debt-app-ctrl\":10,\"./debts\":14,\"./expenses\":19,\"./persons\":22,\"./route-config\":25,\"./utils\":30,\"angular\":\"angular\",\"angular-local-storage\":\"angular-local-storage\",\"angular-material\":\"angular-material\",\"angular-route\":\"angular-route\",\"angular-ui-router\":\"angular-ui-router\",\"lodash\":\"lodash\",\"ng-file-upload\":\"ng-file-upload\",\"ng-mfb\":\"ng-mfb\"}],12:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\nvar _ = require(\"lodash\");\r\n\r\nangular\r\n  .module(\"debtApp\")\r\n    .factory(\"debtService\", debtService);\r\n\r\n\r\nfunction debtService(solveDebts) {\r\n  \r\n  return {\r\n    computeDebts: computeDebts,\r\n    organizeByDebtor: organizeByDebtor\r\n  };\r\n  \r\n  /////////////////////////////////////////\r\n\r\n  function computeDebts(participations, currency) {\r\n    if (currency !== undefined) {\r\n      participations = _.map(participations, function(p) {\r\n        return {\r\n          person: p.person,\r\n          expense: p.expense,\r\n          paid: p.getPaid(currency, {strictConversion: true}),\r\n          share: p.getShare(currency, {strictConversion: true})\r\n        };\r\n      });\r\n    }\r\n\r\n    var debts = solveDebts(participations);\r\n\r\n    if (currency !== undefined) {\r\n      debts = _.map(debts, function(debt) {\r\n        return _.extend(debt, {currency: currency});\r\n      });\r\n    }\r\n\r\n    return debts;\r\n  } \r\n  \r\n  function organizeByDebtor(debts) {\r\n    var debtorList = [];\r\n    var debtorIndices = {};\r\n    \r\n    _.each(debts, function(d) {\r\n      var debtorIndex = debtorIndices[d.debtor.id];\r\n      var debtor;\r\n      if (debtorIndex === undefined) {\r\n        debtorIndex = debtorList.length;\r\n        debtor = {debtor: d.debtor, debts: []};\r\n        debtorList.push(debtor);\r\n        debtorIndices[d.debtor.id] = debtorIndex;\r\n      }\r\n      debtor = debtorList[debtorIndex];\r\n      debtor.debts.push(_.omit(d, \"debtor\")) ;\r\n    });\r\n\r\n    _.each(debtorList, function(d) {\r\n      d.debts.sort(function(d1, d2) {\r\n        return d1.creditor.name.localeCompare(d2.creditor.name);\r\n      });\r\n    });\r\n    debtorList.sort(function(d1, d2) {\r\n      return d1.debtor.name.localeCompare(d2.debtor.name);\r\n    });\r\n    \r\n    return debtorList;\r\n  }\r\n  \r\n}\n},{\"angular\":\"angular\",\"lodash\":\"lodash\"}],13:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\nvar Decimal = require(\"simple-decimal-money\");\r\nvar Random = require(\"random-js\");\r\nvar _ = require(\"lodash\");\r\n\r\nangular\r\n  .module(\"debtApp\")\r\n    .factory(\"solveDebts\", debtSolverFactory);\r\n\r\n\r\n\r\n\r\n/**\r\n * A function that computes debts from given expense participations.\r\n *\r\n * The input is an array of Participation objects in a BalanceSheet.\r\n *\r\n * Returns an array of debts:\r\n * [{debtor: <a Person object>, creditor: <a Person object>, amount: <float; how much the debtor owes the creditor>}, ...]\r\n *\r\n * We form a linear system Ax = b. A is a binary matrix with size (d+c)*(d*c),\r\n * where d is the number of debtors and c is the number of creditors. Columns of A \r\n * are ordered so that x[c*i + j] is the value of the debt owed by debtor i to creditor j.\r\n * \r\n * Elements of b are balances - converted to non-negative - of the debtors and the creditors \r\n * with the following correspondence:\r\n * \r\n * b[0]: first debtor\r\n * ... \r\n * b[d-1]: last debtor\r\n * b[d] = first creditor\r\n * ... \r\n * b[d+c-1] = last creditor\r\n * \r\n * The coefficient matrix A is constructed so that for each person i, we have equation\r\n * where total value of debts to paid by i (if i is a debtor) or to i (if i is a creditor) equals i's \r\n * non-negative balance.\r\n * \r\n * Rows of A indexed between [0, d-1] represent the debtors in the order \r\n * of debtors> list. Rows of A indexed between [d, d+c-1] represent the \r\n * creditors in the order of creditors list.\r\n * \r\n * Ideally, we would like to find the sparsest (most 0's) solution x to Ax = b\r\n * in case the system is underdetermined and has an infinite number of solutions.\r\n * \r\n * This problem, posed as min ||x||_0  s.t. Ax = b, x >= 0, where ||x||_0 is the number\r\n * of non-zero elements, is in general an NP-hard problem. There is some amount of literature\r\n * about the problem (keywords: sparse nonnegative solution of underdetermined linear equations).\r\n * The problem is usually approximated as convex optimization problem by minimizing L1-norm (sum of \r\n * absolute value) instead. One option could be to use the cassowary javascript library.\r\n * \r\n * In this function we find a non-negative x using Gaussian elimination and setting random combinations \r\n * of free variables to zero until we find a non-negative solution.\r\n */\r\nfunction debtSolverFactory(solveLinearSystem) {\r\n  \r\n  return solve;\r\n  \r\n  \r\n  function solve(participations) {\r\n    if (!participations || participations.length === 0) {\r\n      return [];\r\n    }\r\n\r\n    var balances = computeBalances(participations);\r\n    if (isEveryoneBalanced(balances)) {\r\n      return [];\r\n    }\r\n\r\n    if (!isSystemBalanced(balances)) {\r\n      throw new Error(\"Debt system is not balanced\");\r\n    }\r\n\r\n    var roles = getDebtorsAndCreditors(balances);\r\n    var linearSystem = createDebtEquations(roles);\r\n    var debtVector = solveDebts(linearSystem);\r\n    return createDebts(debtVector, roles);\r\n  }\r\n  \r\n  function computeBalances(participations) {\r\n    var balances = {};\r\n    angular.forEach(participations, function(p) {\r\n      var b = balances[p.person.id];\r\n      if (b === undefined) {\r\n        b = {person: p.person, balance: new Decimal(0)};\r\n        balances[p.person.id] = b;\r\n      }\r\n      var paid = new Decimal(p.paid);\r\n      var share = new Decimal(p.share);\r\n      b.balance = b.balance.add(share.subtract(paid));\r\n    });\r\n\r\n    angular.forEach(balances, function(b) {\r\n      b.balance = b.balance.toNumber();\r\n    });\r\n    \r\n    return balances;\r\n  }\r\n  \r\n  function isEveryoneBalanced(balances) {\r\n    return _.every(balances, {balance: 0});\r\n  }\r\n\r\n  function isSystemBalanced(balances) {\r\n    return _.reduce(balances, function(sum, b) {\r\n        return sum.add(b.balance);\r\n    }, new Decimal(0)).toNumber() === 0;\r\n  }\r\n  \r\n  function getDebtorsAndCreditors(balances) {\r\n    var debtors = [];\r\n    var creditors = [];\r\n    \r\n    angular.forEach(balances, function(b) {\r\n      if (b.balance <= 0) {\r\n        creditors.push(b);\r\n      } else {\r\n        debtors.push(b);\r\n      }\r\n    });\r\n    \r\n    return {\r\n      debtors: debtors,\r\n      creditors: creditors\r\n    };\r\n  }\r\n  \r\n  function createDebtEquations(roles) {\r\n    var d = roles.debtors.length;\r\n    var c = roles.creditors.length;\r\n    \r\n    // Right-hand side vector, creditor balances converted to non-negative to allow binary coefficients\r\n    var b = [];\r\n    _.each(roles.debtors, function(debtor, i) {\r\n      b[i] = (new Decimal(debtor.balance)).multiply(100).toNumber();\r\n    });\r\n    _.each(roles.creditors, function(creditor, i) {\r\n      b[d + i] = (new Decimal(creditor.balance)).multiply(-100).toNumber();\r\n    });\r\n    \r\n    // Coefficient matrix\r\n    var A = initMatrix(d + c, d*c); \r\n    \r\n    // Coefficients of equations \"sum of debts paid by debtor = debtor's balance\"\r\n    for (var i = 0; i < d; i++) {\r\n      for (var j = i*c; j < (i+1)*c; j++) {\r\n        A[i][j] = 1;\r\n      }\r\n    }\r\n    \r\n    // Coefficients of equations \"sum debts received by creditor = creditor's balance\"\r\n    for (var i = d; i < c+d; ++i) {\r\n      for (var j = (i-d); j < d*c; j += c) {\r\n        A[i][j] = 1;\r\n      }\r\n    } \r\n    \r\n    return {\r\n      A: A,\r\n      b: b\r\n    };\r\n  }\r\n  \r\n  function initMatrix(rows, cols) {\r\n    var A = [];\r\n    for (var i = 0; i < rows; i++) {\r\n      A[i] = [];\r\n      for (var j = 0; j < cols; j++) {\r\n        A[i][j] = 0;\r\n      }\r\n    }\r\n    return A;\r\n  }\r\n  \r\n  // Solve debts, ensuring a non-negative solution \r\n  function solveDebts(linearSystem) {\r\n    var solution = solveLinearSystem(linearSystem);\r\n    if (solution.numberOfSolutions === 0) {\r\n      throw new Error(\"Debt system has no solutions\");\r\n    }\r\n\r\n\r\n    var numVars = solution.numberOfVariables;\r\n    var numFreeVars = solution.numberOfFreeVariables;\r\n    \r\n    if (numFreeVars === 0) {\r\n      return solution.xVector;\r\n    }\r\n\r\n    // Known seed so we always get the same result from\r\n    // the same system.\r\n    var randomEngine = Random.engines.mt19937();\r\n    randomEngine.seed(20150312);\r\n\r\n    var toEliminate;\r\n    do {\r\n      \r\n      var A = angular.copy(linearSystem.A);\r\n      var b = linearSystem.b;\r\n      \r\n      // Pick random numFreeVars variables for elimination\r\n      \r\n      var candidates = [];\r\n      for (var i = 0; i < numVars; i++) {\r\n        candidates[i] = i;\r\n      }\r\n      \r\n      toEliminate = [];\r\n      for (var i = 0; i < numFreeVars; i++) {\r\n        var candidateIdx = Random.integer(0, candidates.length-1)(randomEngine);\r\n        toEliminate.push(candidates[candidateIdx]);\r\n        candidates.splice(candidateIdx, 1);\r\n      }\r\n      \r\n      // Eliminate the chosen variables by setting their coefficients to zero\r\n      \r\n      for (var i = 0; i < A.length; i++) {\r\n        for (var j = 0; j < toEliminate.length; j++) {\r\n          A[i][toEliminate[j]] = 0;\r\n        }\r\n      }\r\n\r\n      // Solve the updated system\r\n      \r\n      solution = solveLinearSystem({A: A, b: b});\r\n      \r\n    } while (!isNonNegative(solution.xVector));\r\n\r\n    \r\n    return solution.xVector;\r\n  }\r\n  \r\n  function isNonNegative(vector) {\r\n    if (!vector) {\r\n      return false;\r\n    }\r\n    for (var i = 0; i < vector.length; i++) {\r\n      if (vector[i] < 0) {\r\n        return false;\r\n      }\r\n    }\r\n    return true;\r\n  }\r\n  \r\n  function createDebts(debtVector, roles) {\r\n    var debts = [];\r\n\r\n    for (var i = 0; i < debtVector.length; i++) {\r\n      if (debtVector[i] !== 0) {\r\n        var debtorIdx = Math.floor(i/roles.creditors.length);\r\n        var creditorIdx = i - roles.creditors.length*debtorIdx;\r\n        var amount = (new Decimal(debtVector[i])).divideBy(100).toNumber();\r\n        var debt = {debtor: roles.debtors[debtorIdx].person, creditor: roles.creditors[creditorIdx].person, amount: amount};\r\n        debts.push(debt);\r\n      }\r\n    }\r\n    \r\n    return debts;\r\n  }\r\n}  \n},{\"angular\":\"angular\",\"lodash\":\"lodash\",\"random-js\":\"random-js\",\"simple-decimal-money\":\"simple-decimal-money\"}],14:[function(require,module,exports){\n\"use strict\";\r\n\r\nrequire(\"./lin-eq-solver\");\r\nrequire(\"./lin-eq-solver-factory\");\r\nrequire(\"./debt-solver\");\r\nrequire(\"./debt-service\");\n},{\"./debt-service\":12,\"./debt-solver\":13,\"./lin-eq-solver\":16,\"./lin-eq-solver-factory\":15}],15:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar solve = require(\"./lin-eq-solver\");\r\nvar angular = require(\"angular\");\r\n\r\nangular.module(\"debtApp\")\r\n.factory(\"solveLinearSystem\", solveLinearSystem);\r\n\r\nfunction solveLinearSystem() {\r\n  return solve;\r\n}\n},{\"./lin-eq-solver\":16,\"angular\":\"angular\"}],16:[function(require,module,exports){\n\"use strict\";\r\n\r\n\r\nfunction solve(input) {\r\n\t// Internal copies of the linear system and its dimensions\r\n\tvar coefMatrix, constVector, xVector;\r\n\tvar m, n, rank, numberOfSolutions;\r\n\t\r\n\t// With these we can \"virtually\" rearrange the rows and columns\r\n\t// for better numerical stability in the variable elimination phases.\r\n\t// At step i, row index pivotToEquationMap[i] is the pivot equation and\r\n\t// it is used for eliminating variable index pivotToVariableMap[i] from all the\r\n\t// other equations.\r\n\tvar pivotToEquationMap, pivotToVariableMap, equationScale;\r\n\t\r\n\tvalidate();\r\n\tinitialize();\r\n\ttransformToRowEchelonForm();\r\n\treduceRowEchelonForm();\r\n\tdetermineRank();\r\n\tdetermineNumberOfSolutions();\r\n\tdetermineSolution();\r\n\r\n\treturn {\r\n\t\txVector: xVector,\r\n\t\tnumberOfEquations: m,\r\n\t\tnumberOfVariables: n,\r\n\t\trank: rank,\r\n\t\tnumberOfFreeVariables: n - rank,\r\n\t\tnumberOfSolutions: numberOfSolutions\r\n\t};\r\n\t\r\n\t/////////////////////////////////////////////////////////////\r\n\t\r\n\tfunction validate() {\r\n    \tif (!input || !input.A || !input.b) {\r\n    \t\tthrow new TypeError(\"Null matrix A or vector b in system Ax = b\");\r\n    \t}\r\n    \t\r\n    \tif (input.A.length < 1 || input.A[0].length < 1) {\r\n    \t\tthrow new TypeError(\"Matrix A in Ax = b has no rows or no columns\");\r\n    \t}\r\n\t\t\r\n    \tif (input.A.length != input.b.length) {\r\n    \t\tthrow new RangeError(\"The dimensions of the matrix and the constant vector are incompatible\");\r\n    \t}\r\n\t}\r\n\r\n\tfunction initialize() {\r\n\t\tcoefMatrix = copyMatrix(input.A);\r\n\t\tconstVector = copyArray(input.b);\r\n\t\t\r\n\t\tm = coefMatrix.length;\r\n\t\tn = coefMatrix[0].length;\r\n\r\n\t\tpivotToEquationMap = [];\r\n\t\tfor (var i = 0; i < m; i++) {\r\n\t\t\tpivotToEquationMap[i] = i;\r\n\t\t}\r\n\t\t\r\n\t\tequationScale = [];\r\n\t\tfor (var i = 0; i < m; i++) {\r\n\t\t\tequationScale[i] = 0;\r\n\t\t\tfor (var j = 0; j < n; j++) {\r\n\t\t\t\tvar abscoef = Math.abs(coefMatrix[i][j]);\r\n\t\t\t\tif (abscoef > equationScale[i]) {\r\n\t\t\t\t\tequationScale[i] = abscoef;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tpivotToVariableMap = [];\r\n\t\tfor (var j = 0; j < n; j++) {\r\n\t\t\tpivotToVariableMap[j] = j;\r\n\t\t}\r\n\t}\r\n\r\n\tfunction transformToRowEchelonForm() {\r\n\t\tvar pivotIdx = 0; \r\n\t\tvar knownFreeVariables = [];\r\n\t\t\r\n\t\twhile (pivotIdx < m-1) { \r\n\r\n\t\t\t// Choose the best pivot-equation for eliminating variable pivotToVariableMap[pivotIdx] \r\n\t\t\t// from equations equations not yet used as pivot equations.\r\n\t\t\tvar maxRatio = 0;\r\n\t\t\tvar bestPivotEquationIndex = pivotIdx;\r\n\t\t\tfor (var i = pivotIdx; i < m; ++i) {\r\n\t\t\t\tvar rowIdx = pivotToEquationMap[i];\r\n\t\t\t\tvar colIdx = pivotToVariableMap[pivotIdx];\r\n\t\t\t\tvar ratio = Math.abs(coefMatrix[rowIdx][colIdx]/equationScale[rowIdx]);\r\n\t\r\n\t\t\t\tif (ratio > maxRatio) {\r\n\t\t\t\t\tmaxRatio = ratio;\r\n\t\t\t\t\tbestPivotEquationIndex = i;\t\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t// If maxRatio == 0, the coefficient of variable pivotToVariableMap[pivotIdx] is 0 in all the rest of the equations. \r\n\t\t\t// That is pivotToVariableMap[pivotIdx] is a free variable. Find the next suitable variable.\r\n\t\t\tif (maxRatio === 0) {\r\n\t\t\t\tvar currPivotVaribleIdx = pivotToVariableMap[pivotIdx];\r\n\t\t\t\tknownFreeVariables[currPivotVaribleIdx] = true;     \r\n\t\t\t\t\r\n\t\t\t\t// The next one must not be a free variable.\r\n\t\t\t\tvar i = pivotIdx;\r\n\t\t\t\tvar newPivotVariableIdx = currPivotVaribleIdx;\r\n\t\t\t\twhile (newPivotVariableIdx == currPivotVaribleIdx && i < n-1) {\r\n\t\t\t\t\t++i;\r\n\t\t\t\t\tif (!knownFreeVariables[pivotToVariableMap[i]]) {\r\n\t\t\t\t\t\tnewPivotVariableIdx = pivotToVariableMap[i];\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (newPivotVariableIdx != currPivotVaribleIdx) {\r\n\t\t\t\t\tpivotToVariableMap[pivotIdx] = newPivotVariableIdx;\r\n\t\t\t\t\tpivotToVariableMap[i] = currPivotVaribleIdx;\r\n\t\t\t\t\tcontinue;\r\n\t\t\t\t} else { \r\n\t\t\t\t\t// Could not find a suitable variable. This means the row echelon form is ready.\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\r\n\t\t\tvar temp = pivotToEquationMap[pivotIdx];\r\n\t\t\tpivotToEquationMap[pivotIdx] = pivotToEquationMap[bestPivotEquationIndex];\r\n\t\t\tpivotToEquationMap[bestPivotEquationIndex] = temp;     \r\n\t\t\t\r\n\t\t\t// Elimination phase\r\n\t\t\tvar pivotRowIdx = pivotToEquationMap[pivotIdx];\r\n\t\t\tvar pivotColIdx = pivotToVariableMap[pivotIdx];\r\n\t\t\tfor (i = pivotIdx + 1; i < m; ++i) {\r\n\t\t\t\tvar rowIdx = pivotToEquationMap[i];\r\n\t\t\t\tvar mult = coefMatrix[rowIdx][pivotColIdx] / coefMatrix[pivotRowIdx][pivotColIdx];\r\n\r\n\t\t\t\tfor (var j = pivotIdx + 1; j < n; ++j) {\r\n\t\t\t\t\tvar colIndex = pivotToVariableMap[j];\r\n\t\t\t\t\tcoefMatrix[rowIdx][colIndex] = coefMatrix[rowIdx][colIndex] - mult * coefMatrix[pivotRowIdx][colIndex];\r\n\t\t\t\t}\r\n\r\n\t\t\t\tcoefMatrix[rowIdx][pivotColIdx] = 0;\r\n\t\t\t\tconstVector[rowIdx] = constVector[rowIdx] - mult * constVector[pivotRowIdx];\r\n\t\t\t}\r\n\r\n\t\t\tpivotIdx++;\r\n\t\t\t\r\n\t\t}\r\n\t}\r\n\r\n\tfunction reduceRowEchelonForm() {\r\n\t\t// Eliminate pivot variables from previous pivot equations by going through the pivot steps in reverse order.\r\n\t\tvar pivotIndex;\r\n\t\tfor (pivotIndex = Math.min(m, n) - 1; pivotIndex > 0; --pivotIndex) {\r\n\t\t\tvar pivotRowIdx = pivotToEquationMap[pivotIndex];\r\n\t\t\tvar pivotColIdx = pivotToVariableMap[pivotIndex];\r\n\t\t\t\r\n\t\t\tif (coefMatrix[pivotRowIdx][pivotColIdx] === 0) {\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tfor (var i = pivotIndex - 1; i > -1; --i) {\r\n\t\t\t\t\r\n\t\t\t\tvar mult = coefMatrix[pivotToEquationMap[i]][pivotToVariableMap[pivotIndex]]/coefMatrix[pivotToEquationMap[pivotIndex]][pivotToVariableMap[pivotIndex]];\r\n\t\t\t\tfor (var j = 0; j < n; ++j) {\r\n\t\t\t\t\tcoefMatrix[pivotToEquationMap[i]][pivotToVariableMap[j]] -= mult*coefMatrix[pivotToEquationMap[pivotIndex]][pivotToVariableMap[j]];\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tconstVector[pivotToEquationMap[i]] -= mult*constVector[pivotToEquationMap[pivotIndex]];\r\n\t\t\t}            \t\t\r\n\t\t}\r\n\t\t\r\n\t\t// Normalize the coeffients in each row and the rhs value by the coeffient of the pivot variable in the row\r\n\t\tfor (pivotIndex = 0; pivotIndex < Math.min(m, n); ++pivotIndex) {\r\n\t\t\t\r\n\t\t\tif (coefMatrix[pivotToEquationMap[pivotIndex]][pivotToVariableMap[pivotIndex]] === 0) {\r\n\t\t\t\tcontinue; \r\n\t\t\t}\r\n\r\n\t\t\tvar div = coefMatrix[pivotToEquationMap[pivotIndex]][pivotToVariableMap[pivotIndex]];\r\n\t\t\tfor (var j = 0; j < n; ++j) {\r\n\t\t\t\tcoefMatrix[pivotToEquationMap[pivotIndex]][j] = coefMatrix[pivotToEquationMap[pivotIndex]][j]/div;\r\n\t\t\t}\r\n\t\t\tconstVector[pivotToEquationMap[pivotIndex]] = constVector[pivotToEquationMap[pivotIndex]]/div;\r\n\t\t}\r\n\t\t\r\n\t}\r\n\r\n\tfunction determineRank() {\r\n\t\trank = 0;\r\n\t\tvar i,j;\r\n\t\t\r\n\t\tcolumns: \r\n\t\tfor (j=0; j<n; ++j) {\r\n\t\t\trows:\r\n\t\t\tfor (i=0; i<m; ++i) { \r\n\t\t\t\tif (i != j && coefMatrix[pivotToEquationMap[i]][pivotToVariableMap[j]] !== 0) {\r\n\t\t\t\t\tbreak columns;\r\n\t\t\t\t}\r\n\t\t\t\telse if (i == j && coefMatrix[pivotToEquationMap[i]][pivotToVariableMap[j]] != 1) {\r\n\t\t\t\t\tbreak columns;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t++rank;\r\n\t\t}\r\n\t}\r\n\r\n\tfunction determineNumberOfSolutions() {\r\n\t\t\r\n\t\tvar b2IsZero = true;\r\n\r\n\t\tfor (var i = rank; i < m; ++i) {\r\n\t\t\tif (constVector[pivotToEquationMap[i]] !== 0) {\r\n\t\t\t\tb2IsZero = false;\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tif (rank < m && !b2IsZero) {\r\n\t\t\tnumberOfSolutions = 0;\r\n\t\t} else if (rank == n && (rank == m || b2IsZero)) {\r\n\t\t\tnumberOfSolutions = 1;\r\n\t\t} else if (rank < n && (rank == m || b2IsZero)) {\r\n\t\t\tnumberOfSolutions = Number.MAX_VALUE;\r\n\t\t}\r\n\t}\r\n\r\n\tfunction determineSolution() {\r\n\t\tif (numberOfSolutions === 0) {\r\n\t\t\txVector = undefined;\r\n\t\t} else {\r\n\t\t\txVector = initArray(n);\r\n\t\t\tfor (var i = 0; i < rank; ++i) {\r\n\t\t\t\txVector[pivotToVariableMap[i]] = constVector[pivotToEquationMap[i]];\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction initArray(size) {\r\n\t\tvar array = [];\r\n\t\tfor (var i = 0; i < size; i++) {\r\n\t\t\tarray[i] = 0;\r\n\t\t}\r\n\t\treturn array;\r\n\t}\r\n\t\r\nfunction copyArray(input) {\r\n\treturn input.slice();\r\n}\r\n\r\nfunction copyMatrix(input) {\r\n\tvar copy = [];\r\n\tfor (var i = 0; i < input.length; i++) {\r\n\t\tcopy[i] = input[i].slice();\r\n\t}\r\n\treturn copy;\r\n}\r\n\t\r\n\r\nmodule.exports = solve;\n},{}],17:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\n\r\nangular.module(\"debtApp\")\r\n.factory(\"openCreateExpenseDialog\", openCreateExpenseDialog);\r\n\r\n\r\nfunction openCreateExpenseDialog($mdDialog) {\r\n  \r\n  return open;\r\n  \r\n  function open() {\r\n    return $mdDialog.show({\r\n      templateUrl: \"expenses/create-expense-dialog.html\",\r\n      controller: DialogController,\r\n      controllerAs: \"vm\"\r\n    });\r\n  }\r\n  \r\n}\r\n\r\nfunction DialogController($mdDialog) {\r\n  var vm = this;\r\n  \r\n  vm.ok = ok;\r\n  vm.cancel = cancel;\r\n  vm.init = init;\r\n  \r\n  init();\r\n  \r\n  \r\n  function init() {\r\n    vm.expense = {\r\n      name: undefined,\r\n      sharing: \"equal\"\r\n    };\r\n    vm.options = {\r\n      createParticipations: true\r\n    };\r\n  }\r\n\r\n  function ok() {\r\n    $mdDialog.hide({expense: vm.expense, options: vm.options});\r\n  }\r\n  \r\n  function cancel() {\r\n    $mdDialog.cancel();\r\n  }\r\n}\n},{\"angular\":\"angular\"}],18:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar _ = require('lodash');\r\nvar angular = require(\"angular\");\r\n\r\nangular\r\n  .module(\"debtApp\")\r\n  .controller(\"ExpenseDetailCtrl\", ExpenseDetailCtrl);\r\n\r\nfunction ExpenseDetailCtrl(balanceSheetService,\r\n                           debtService,\r\n                           events,\r\n                           debounce,\r\n                           debtCalculationInterval,\r\n                           $mdDialog,\r\n                           $stateParams,\r\n                           $state,\r\n                           $scope,\r\n                           $timeout)\r\n{\r\n  var vm = this;\r\n\r\n  var confirmRemoveExpense = $mdDialog.confirm()\r\n    .content(\"Really delete this expense?\")\r\n    .ok(\"Ok\").cancel(\"Cancel\");\r\n\r\n  var computeDebtsDebounced = debounce(function() {\r\n    $timeout(function() {\r\n      vm.debtsByDebtor = computeDebts();\r\n    });\r\n  }, debtCalculationInterval);\r\n\r\n  vm.init = init;\r\n  vm.setParticipation = setParticipation;\r\n  vm.updateExpense = updateExpense;\r\n  vm.removeExpense = removeExpense;\r\n  vm.setCurrency = setCurrency;\r\n\r\n  init();\r\n\r\n  /////////////////////////////////////////////////////////////\r\n\r\n  function init() {\r\n    vm.balanceSheet = balanceSheetService.balanceSheet;\r\n    vm.expense = vm.balanceSheet.getExpense($stateParams.id);\r\n    vm.isParticipant = {};\r\n    vm.everyoneParticipates = true;\r\n    updateExpense();\r\n\r\n    $scope.$on(events.BALANCE_SHEET_UPDATED, function(event) {\r\n      if (event.targetScope != $scope) {\r\n        vm.updateExpense();\r\n      }\r\n    });\r\n  }\r\n\r\n  function updateExpense() {\r\n    vm.expense.shareCost();\r\n    vm.isParticipant = getParticipationMap();\r\n    vm.cost = vm.expense.getCost();\r\n    vm.sumOfShares = vm.expense.getSumOfShares();\r\n    vm.isBalanced = vm.expense.isBalanced();\r\n    $scope.$emit(events.BALANCE_SHEET_UPDATED);\r\n    computeDebtsDebounced();\r\n  }\r\n\r\n  function getParticipationMap() {\r\n    var map = {};\r\n\r\n    angular.forEach(vm.balanceSheet.persons, function(person) {\r\n      map[person.id] = false;\r\n      angular.forEach(vm.expense.getParticipations(), function(p) {\r\n        if (p.person.equals(person)) {\r\n          map[person.id] = true;\r\n        }\r\n      });\r\n    });\r\n\r\n    return map;\r\n  }\r\n\r\n  function setParticipation(person, isParticipant) {\r\n    if (isParticipant) {\r\n      vm.balanceSheet.createParticipation({expense: vm.expense, person: person});\r\n    } else {\r\n      vm.balanceSheet.removeParticipation({expense: vm.expense, person: person});\r\n    }\r\n    updateExpense();\r\n  }\r\n\r\n  function removeExpense() {\r\n    $mdDialog.show(confirmRemoveExpense)\r\n      .then(doRemoveExpense);\r\n  }\r\n\r\n  function doRemoveExpense() {\r\n    vm.balanceSheet.removeExpense(vm.expense);\r\n    $scope.$emit(events.BALANCE_SHEET_UPDATED);\r\n    $state.go(\"balanceSheet\");\r\n  }\r\n\r\n  function computeDebts() {\r\n    if (vm.expense.isBalanced()) {\r\n      var debts = debtService.computeDebts(vm.expense.getParticipations(), vm.expense.computedCurrency());\r\n      return debtService.organizeByDebtor(debts);\r\n    }\r\n  }\r\n\r\n  function setCurrency(currency) {\r\n    vm.expense.currency = currency;\r\n    $scope.$emit(events.BALANCE_SHEET_UPDATED);\r\n  }\r\n\r\n\r\n}\r\n\n},{\"angular\":\"angular\",\"lodash\":\"lodash\"}],19:[function(require,module,exports){\n\"use strict\";\r\n\r\nrequire(\"./route-config\");\r\nrequire(\"./expense-detail-ctrl\");\r\nrequire(\"./create-expense-dialog\");\n},{\"./create-expense-dialog\":17,\"./expense-detail-ctrl\":18,\"./route-config\":20}],20:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\n\r\nangular.module(\"debtApp\")\r\n\t.config(config);\r\n\r\nfunction config($stateProvider) {\r\n\r\n\t$stateProvider\r\n\t\t.state(\"expense\", {\r\n\t\t\turl: \"/expenses/:id\",\r\n\t\t\tviews: {\r\n\t\t\t\t\"\": {\r\n\t\t\t\t\ttemplateUrl: \"expenses/expense-detail.html\",\r\n\t\t\t\t\tcontroller: \"ExpenseDetailCtrl as vm\"\r\n\t\t\t\t},\r\n\t\t\t\t\"floatingButton\": {\r\n\t\t\t\t\ttemplateUrl: \"expenses/floating-button.html\"\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t})\r\n\t\t;\r\n}\n},{\"angular\":\"angular\"}],21:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\n\r\nangular.module(\"debtApp\")\r\n.factory(\"openCreatePersonDialog\", openCreatePersonDialog);\r\n\r\n\r\nfunction openCreatePersonDialog($mdDialog) {\r\n  \r\n  return open;\r\n  \r\n  function open() {\r\n    return $mdDialog.show({\r\n      templateUrl: \"persons/create-person-dialog.html\",\r\n      controller: DialogController,\r\n      controllerAs: \"vm\"\r\n    });\r\n  }\r\n  \r\n}\r\n\r\nfunction DialogController($mdDialog) {\r\n  var vm = this;\r\n  \r\n  vm.ok = ok;\r\n  vm.cancel = cancel;\r\n  vm.init = init;\r\n  \r\n  init();\r\n  \r\n  \r\n  function init() {\r\n    vm.person = {\r\n      name: undefined\r\n    };\r\n    vm.options = {\r\n      createParticipations: true\r\n    };\r\n  }\r\n\r\n  function ok() {\r\n    $mdDialog.hide({person: vm.person, options: vm.options});\r\n  }\r\n  \r\n  function cancel() {\r\n    $mdDialog.cancel();\r\n  }\r\n}\n},{\"angular\":\"angular\"}],22:[function(require,module,exports){\n\"use strict\";\r\n\r\nrequire(\"./route-config\");\r\nrequire(\"./person-detail-ctrl\");\r\nrequire(\"./create-person-dialog\");\n},{\"./create-person-dialog\":21,\"./person-detail-ctrl\":23,\"./route-config\":24}],23:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\nvar _ = require('lodash');\r\n\r\nangular.module(\"debtApp\")\r\n  .controller(\"PersonDetailCtrl\", PersonDetailCtrl);\r\n\r\nfunction PersonDetailCtrl(balanceSheetService,\r\n                          debtService,\r\n                          events,\r\n                          debounce,\r\n                          debtCalculationInterval,\r\n                          $state,\r\n                          $stateParams,\r\n                          $mdDialog,\r\n                          $scope,\r\n                          $timeout,\r\n                          $log) {\r\n\r\n  var vm = this;\r\n  var confirmRemovePerson;\r\n\r\n  var computeDebtsDebounced = debounce(function() {\r\n    $timeout(function() {\r\n      try {\r\n        var debtResult = computeDebts();\r\n        vm.debtRole = debtResult.role;\r\n        vm.debts = debtResult.debts;\r\n        vm.debtComputationError = undefined;\r\n      } catch (e) {\r\n        $log.error(e);\r\n        vm.debtRole = undefined;\r\n        vm.debts = undefined;\r\n        vm.debtComputationError = \"Cannot compute debts\";\r\n      }\r\n    });\r\n  }, debtCalculationInterval);\r\n\r\n  vm.init = init;\r\n  vm.refresh = refresh;\r\n  vm.updateExpense = updateExpense;\r\n  vm.setParticipation = setParticipation;\r\n  vm.removePerson = removePerson;\r\n  vm.updatePerson = updatePerson;\r\n\r\n  init();\r\n\r\n  function init() {\r\n    vm.balanceSheet = balanceSheetService.balanceSheet;\r\n    vm.person = vm.balanceSheet.getPerson($stateParams.id);\r\n\r\n    refresh();\r\n\r\n    confirmRemovePerson = $mdDialog.confirm()\r\n      .content(\"Really delete this person?\")\r\n      .ok(\"Ok\").cancel(\"Cancel\");\r\n\r\n    $scope.$on(events.BALANCE_SHEET_UPDATED, vm.refresh);\r\n  }\r\n\r\n  function refresh() {\r\n    vm.isParticipant = getParticipationMap();\r\n    vm.cost = vm.person.getCost();\r\n    vm.sumOfShares = vm.person.getSumOfShares();\r\n    vm.balance = vm.person.getBalance();\r\n    computeDebtsDebounced();\r\n  }\r\n\r\n  function getParticipationMap() {\r\n    var map = {};\r\n\r\n    _.forEach(vm.balanceSheet.expenses, function(expense) {\r\n      map[expense.id] = false;\r\n      _.forEach(vm.person.getParticipations(), function(pt) {\r\n        if (pt.expense.equals(expense)) {\r\n          map[expense.id] = true;\r\n        }\r\n      });\r\n    });\r\n\r\n    return map;\r\n  }\r\n\r\n  function updateExpense(expense) {\r\n    expense.shareCost();\r\n    refresh();\r\n    $scope.$emit(events.BALANCE_SHEET_UPDATED);\r\n  }\r\n\r\n  function setParticipation(expense, isParticipant) {\r\n    if (isParticipant) {\r\n      vm.balanceSheet.createParticipation({expense: expense, person: vm.person});\r\n    } else {\r\n      vm.balanceSheet.removeParticipation({expense: expense, person: vm.person});\r\n    }\r\n    vm.updateExpense(expense);\r\n  }\r\n\r\n  function computeDebts() {\r\n    var result = {\r\n      role: undefined,\r\n      debts: undefined\r\n    };\r\n\r\n    if (!vm.balanceSheet.isBalanced()) {\r\n      result.role = \"unbalanced\";\r\n      return result;\r\n    }\r\n\r\n    if (vm.balance > 0) {\r\n      result.role = \"debtor\";\r\n    } else if (vm.balance < 0) {\r\n      result.role = \"creditor\";\r\n    } else if (vm.balance === 0) {\r\n      result.role = \"settled\";\r\n      return result;\r\n    }\r\n\r\n    var counterRole = {\r\n      \"debtor\": \"creditor\",\r\n      \"creditor\": \"debtor\"\r\n    };\r\n\r\n    var debts = debtService.computeDebts(vm.balanceSheet.getNonSettledParticipations(), vm.person.computedCurrency());\r\n    result.debts = _.chain(debts)\r\n      .filter(function(d) {\r\n        return d[result.role].equals(vm.person);\r\n      })\r\n      .map(function(d) {\r\n        return {person: d[counterRole[result.role]], amount: d.amount, currency: d.currency};\r\n      })\r\n      .value();\r\n\r\n    return result;\r\n  }\r\n\r\n  function removePerson() {\r\n    $mdDialog.show(confirmRemovePerson)\r\n      .then(doRemovePerson);\r\n  }\r\n\r\n  function doRemovePerson() {\r\n    vm.balanceSheet.removePerson(vm.person);\r\n    $scope.$emit(events.BALANCE_SHEET_UPDATED);\r\n    $state.go(\"balanceSheet\");\r\n  }\r\n\r\n  function updatePerson() {\r\n    $scope.$emit(events.BALANCE_SHEET_UPDATED);\r\n  }\r\n}\r\n\n},{\"angular\":\"angular\",\"lodash\":\"lodash\"}],24:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\n\r\nangular.module(\"debtApp\")\r\n  .config(config);\r\n\r\nfunction config($stateProvider) {\r\n  $stateProvider\r\n    .state(\"person\", {\r\n      url: \"/persons/:id\",\r\n      views: {\r\n        \"\": {\r\n          templateUrl: \"persons/person-detail.html\",\r\n          controller: \"PersonDetailCtrl as vm\"\r\n        },\r\n        \"floatingButton\": {\r\n          templateUrl: \"persons/floating-button.html\"\r\n        }\r\n      }\r\n\r\n    });\r\n}\n},{\"angular\":\"angular\"}],25:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\n\r\nangular.module(\"debtApp\")\r\n\t.config(config);\r\n\r\nfunction config($urlRouterProvider) {\r\n  \r\n  $urlRouterProvider.otherwise(\"/\");\r\n  \r\n}\n},{\"angular\":\"angular\"}],26:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\nvar _ = require('lodash');\r\n\r\nangular.module(\"debtApp\")\r\n  .filter(\"balance\", balance);\r\n\r\n\r\nfunction balance($filter) {\r\n  return function balance(value) {\r\n    if (!_.isNumber(value) || isNaN(value)) {\r\n      return value;\r\n    }\r\n\r\n    if (value > 0) {\r\n      return \"+\" + $filter(\"number\")(value, \"2\");\r\n    } else {\r\n      return $filter(\"number\")(value, \"2\");\r\n    }\r\n  };\r\n}\n},{\"angular\":\"angular\",\"lodash\":\"lodash\"}],27:[function(require,module,exports){\n\"use strict\";\r\n\r\nangular.module(\"debtApp\")\r\n  .factory(\"debounce\", debounceFactory);\r\n\r\n\r\nfunction debounceFactory($timeout) {\r\n\r\n  return debounce;\r\n\r\n  /**\r\n   * Returns a function, that, as long as it continues to be invoked, will not be triggered.\r\n   * The function will be called after it stops being called for N milliseconds.\r\n   *\r\n   * @param {function} func - The function to \"debouncify\"\r\n   * @param {number} [wait=10] - The time to wait (milliseconds) after the last call until func is called\r\n   * @param {Scope} [scope] - Angular scope to call the function in\r\n   * @param {boolean} [invokeApply=false] - Should the function call trigger $digest\r\n   * @returns {function} - The debounced function\r\n   */\r\n  function debounce(func, wait, scope, invokeApply) {\r\n    var timer;\r\n\r\n    return function debounced() {\r\n      var context = scope,\r\n        args = Array.prototype.slice.call(arguments);\r\n\r\n      $timeout.cancel(timer);\r\n      timer = $timeout(function() {\r\n\r\n        timer = undefined;\r\n        func.apply(context, args);\r\n\r\n      }, wait || 10, invokeApply);\r\n    };\r\n  }\r\n\r\n}\r\n\r\n\r\n\n},{}],28:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\nvar fileSaver = require(\"node-safe-filesaver\");\r\nrequire(\"blob-polyfill\");\r\n\r\nangular.module(\"debtApp\")\r\n  .factory(\"fileService\", fileService);\r\n\r\n\r\nfunction fileService($q, $window) {\r\n\r\n  return {\r\n    readAsText: readAsText,\r\n    saveAsFile: saveAsFile,\r\n    isSupported: isSupported\r\n  };\r\n\r\n  function readAsText(blob) {\r\n    var deferred = $q.defer();\r\n\r\n    var reader = new $window.FileReader();\r\n    reader.onload = function() {\r\n      deferred.resolve(reader.result);\r\n    };\r\n    reader.onerror = function() {\r\n      deferred.resolve(reader.error);\r\n    };\r\n    reader.readAsText(blob);\r\n\r\n    return deferred.promise;\r\n  }\r\n\r\n  function saveAsFile(dataArray, fileName) {\r\n    var blob = new $window.Blob(dataArray, {});\r\n    fileSaver.saveAs(blob, fileName);\r\n  }\r\n\r\n  function isSupported() {\r\n    return $window.FileReader && $window.Blob;\r\n  }\r\n}\n},{\"angular\":\"angular\",\"blob-polyfill\":\"blob-polyfill\",\"node-safe-filesaver\":\"node-safe-filesaver\"}],29:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\n\r\nangular.module(\"debtApp\")\r\n  .directive(\"focus\", focus);\r\n\r\n\r\nfunction focus($timeout) {\r\n  return {\r\n    restrict: \"A\",\r\n    link: function($scope, iElem, iAttrs) {\r\n      var focusExpr = iAttrs.focus || 'true';\r\n      $timeout(function() {\r\n        var shouldFocus = $scope.$eval(focusExpr);\r\n        if (shouldFocus) {\r\n          iElem[0].focus();\r\n        }\r\n      }, 0);\r\n    }\r\n  };\r\n}\n},{\"angular\":\"angular\"}],30:[function(require,module,exports){\n\"use strict\";\r\n\r\nrequire(\"./money-input-directive\");\r\nrequire(\"./balance-filter\");\r\nrequire(\"./money-filter\");\r\nrequire(\"./file-service\");\r\nrequire(\"./focus-directive\");\n},{\"./balance-filter\":26,\"./file-service\":28,\"./focus-directive\":29,\"./money-filter\":31,\"./money-input-directive\":32}],31:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\nvar _ = require('lodash');\r\n\r\n\r\nangular.module(\"debtApp\")\r\n  .filter(\"money\", money);\r\n\r\n\r\nfunction money($filter) {\r\n  return function money(value) {\r\n    if (!_.isNumber(value) || isNaN(value)) {\r\n      return value;\r\n    }\r\n\r\n    return $filter(\"number\")(value, \"2\");\r\n  };\r\n}\n},{\"angular\":\"angular\",\"lodash\":\"lodash\"}],32:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\nvar Decimal = require(\"simple-decimal-money\");\r\n\r\nangular.module(\"debtApp\")\r\n  .directive(\"moneyInput\", moneyInput);\r\n\r\n\r\nfunction moneyInput($filter) {\r\n  return {\r\n    restrict: \"A\",\r\n    require: \"ngModel\",\r\n    link: link\r\n  };\r\n\r\n  function link($scope, iElem, iAttrs, ngModel) {\r\n    ngModel.$validators.money = validateMoney;\r\n    ngModel.$parsers.push(parseMoney);\r\n    ngModel.$formatters.unshift(formatMoney);\r\n\r\n    iElem.on(\"blur\", handleBlur);\r\n    ngModel.$render = render;\r\n\r\n    function render() {\r\n      if (ngModel.$valid) {\r\n        iElem.val(formatMoney(ngModel.$modelValue));\r\n      } else {\r\n        iElem.val(ngModel.$viewValue);\r\n      }\r\n    }\r\n\r\n    function handleBlur() {\r\n      ngModel.$render();\r\n    }\r\n  }\r\n\r\n  function validateMoney(value) {\r\n    if (value < 0) {\r\n      return false;\r\n    } else {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  function formatMoney(value) {\r\n    if (value === undefined || value === null) {\r\n      return \"\";\r\n    } else {\r\n      return $filter(\"number\")(value, 2);\r\n    }\r\n  }\r\n\r\n  function parseMoney(value) {\r\n    return new Decimal(value).toNumber();\r\n  }\r\n\r\n}\r\n\n},{\"angular\":\"angular\",\"simple-decimal-money\":\"simple-decimal-money\"}],33:[function(require,module,exports){\n\"use strict\";\r\n\r\nvar angular = require(\"angular\");\r\n\r\nangular.module(\"debtApp\")\r\n  .directive(\"tryCatch\", tryCatch);\r\n\r\nfunction tryCatch() {\r\n  return {\r\n    scope: {\r\n      expression: \"&\",\r\n      errorResult: \"@\"\r\n    },\r\n    template: '{{result}}',\r\n    link: link\r\n  };\r\n\r\n  function link($scope) {\r\n    try {\r\n      $scope.result = $scope.expression();\r\n    } catch (e) {\r\n      $scope.result = $scope.errorResult;\r\n    }\r\n  }\r\n}\n},{\"angular\":\"angular\"}]},{},[11,1,2,3,4,5,6,7,8,9,10,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33]);\n"],"sourceRoot":".."}